<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thinking Trader</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0B1120;
            height: 100vh;
            max-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* ── Слайдер ── */
        .slider-wrapper {
            display: flex;
            width: 300vw;
            height: 100vh;
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }
        .slider-wrapper.slide-1 { transform: translateX(0); }
        .slider-wrapper.slide-2 { transform: translateX(-33.333%); }
        .slider-wrapper.slide-3 { transform: translateX(-66.666%); }

        .slider-page {
            width: 100vw;
            height: 100vh;
            flex-shrink: 0;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 14px;
            position: relative;
        }

        /* Страница 1 */
        #slider-page-1 {
            padding: 14px 16px;
        }

        /* ── Навигация: точки ── */
        .slider-dots {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            pointer-events: auto;
        }
        .slider-dot {
            height: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.2);
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            width: 8px;
        }
        .slider-dot.active {
            width: 24px;
            background: linear-gradient(90deg, #6366F1, #8B5CF6);
        }

        /* ── Навигация: стрелки ── */
        .slider-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(99,102,241,0.15);
            border: 1px solid rgba(99,102,241,0.3);
            color: #818CF8;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.25s;
            user-select: none;
            backdrop-filter: blur(8px);
        }
        .slider-arrow:hover {
            background: rgba(99,102,241,0.3);
            border-color: #6366F1;
            color: white;
        }
        .slider-arrow.hidden { opacity: 0; pointer-events: none; }
        .slider-arrow-left { left: 12px; }
        .slider-arrow-right { right: 12px; }

        /* Глобальный скроллбар */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 6px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #4F46E5, #7C3AED); border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #6366F1, #8B5CF6); }
        * { scrollbar-width: thin; scrollbar-color: #4F46E5 rgba(255,255,255,0.03); }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 30% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 70% 50%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* ── Страница 2: Индикаторы ── */
        .page2-container {
            max-width: 1400px;
            width: 100%;
            height: 100%;
            max-height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }
        .page2-header {
            margin-bottom: 6px;
            padding-top: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .page2-title {
            font-size: 17px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #94A3B8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .page2-subtitle {
            font-size: 11px;
            color: #64748B;
            margin-top: 2px;
        }
        .page2-grid {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            column-count: 3;
            column-gap: 10px;
            padding-bottom: 0;
        }
        .page2-grid::-webkit-scrollbar { width: 4px; }
        .page2-grid::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 6px; }
        .page2-grid::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #4F46E5, #7C3AED); border-radius: 6px; }

        .ind-card {
            background: rgba(17, 25, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 8px;
            padding: 9px 10px 9px 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            position: relative;
            overflow: hidden;
            break-inside: avoid;
            margin-bottom: 10px;
        }
        .ind-card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #6366F1 0%, #8B5CF6 100%);
            border-radius: 0 2px 2px 0;
        }
        .ind-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ind-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            font-weight: 700;
            color: #CBD5E1;
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }
        .ind-icon { font-size: 14px; }
        .ind-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 8px;
            background: rgba(100,116,139,0.2);
            color: #64748B;
        }
        .ind-badge.bullish { background: rgba(16,185,129,0.15); color: #10B981; }
        .ind-badge.bearish { background: rgba(239,68,68,0.15); color: #EF4444; }
        .ind-badge.neutral { background: rgba(251,191,36,0.15); color: #FBBF24; }
        .ind-value-row {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }
        .ind-big-value {
            font-size: 20px;
            font-weight: 800;
            color: white;
            line-height: 1;
        }
        .ind-sub-value {
            font-size: 11px;
            color: #94A3B8;
        }
        .ind-bar-track {
            height: 5px;
            border-radius: 4px;
            background: rgba(255,255,255,0.07);
            position: relative;
            overflow: hidden;
        }
        .ind-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #6366F1, #8B5CF6);
            transition: width 0.6s ease;
        }
        .ind-rows {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        .ind-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .ind-row:last-child { border-bottom: none; }
        .ind-row-label { font-size: 11px; color: #94A3B8; }
        .ind-row-value { font-size: 12px; font-weight: 600; color: #CBD5E1; }
        .ind-row-value.green { color: #10B981; }
        .ind-row-value.red { color: #EF4444; }
        .ind-hint {
            font-size: 10px;
            color: #475569;
            padding-top: 2px;
            border-top: 1px solid rgba(255,255,255,0.04);
        }
        .ind-coming-soon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 0;
            opacity: 0.4;
        }
        .ind-coming-soon-icon { font-size: 22px; }
        .ind-coming-soon-text { font-size: 12px; color: #64748B; }
        .ind-two-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .ind-mini-val {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 8px 10px;
        }
        .ind-mini-label { font-size: 10px; color: #64748B; margin-bottom: 3px; }
        .ind-mini-num { font-size: 16px; font-weight: 700; color: white; }

        /* ── ATR Card ── */
        .ind-period {
            font-size: 10px;
            color: #475569;
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
        }
        .atr-body { display: flex; flex-direction: column; gap: 10px; }
        .atr-main { position: relative; min-height: 60px; }

        .atr-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 60px;
        }
        .atr-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(99,102,241,0.2);
            border-top-color: #6366F1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .atr-values { display: flex; flex-direction: column; gap: 5px; }
        .atr-chart-wrap {
            width: 100%;
            height: 26px;
            position: relative;
        }
        .atr-chart-wrap canvas { width: 100% !important; height: 26px !important; }
        /* ── EMA Card ── */
        .ema-signal-wrap { }
        .ema-signal {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px;
            padding: 6px 10px;
        }
        .ema-signal-icon {
            flex-shrink: 0;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ema-signal-icon svg { display: block; }
        .ema-signal-label {
            font-size: 12px;
            font-weight: 700;
            color: white;
        }
        .ema-signal-sub {
            font-size: 11px;
            color: #94A3B8;
            margin-top: 2px;
        }

        /* Шкала позиции цены между EMA */
        .ema-scale-wrap {
            margin-top: 3px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .ema-scale-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #64748B;
        }
        .ema-scale-track {
            position: relative;
            height: 10px;
            background: rgba(255,255,255,0.07);
            border-radius: 4px;
            overflow: visible;
        }
        .ema-scale-zone {
            position: absolute;
            top: 0; bottom: 0;
            border-radius: 4px;
            background: linear-gradient(90deg, rgba(99,102,241,0.3), rgba(139,92,246,0.3));
        }
        /* ── Stochastic RSI ── */
        .stoch-scale-wrap { display: flex; flex-direction: column; gap: 4px; }
        .stoch-scale-values {
            display: flex;
            gap: 8px;
        }
        .stoch-kd {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .stoch-k-dot, .stoch-d-dot {
            width: 7px; height: 7px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .stoch-k-dot { background: #6366F1; }
        .stoch-d-dot { background: #F59E0B; }
        .stoch-kd-label { font-size: 11px; color: #94A3B8; }
        .stoch-kd-val { font-size: 12px; font-weight: 700; color: white; }

        .stoch-track {
            position: relative;
            height: 7px;
            border-radius: 4px;
            display: flex;
            overflow: visible;
        }
        .stoch-zone { height: 100%; }
        .stoch-zone-low  { width: 20%; background: rgba(16,185,129,0.4); border-radius: 4px 0 0 4px; }
        .stoch-zone-mid  { width: 60%; background: rgba(100,116,139,0.15); }
        .stoch-zone-high { width: 20%; background: rgba(239,68,68,0.4); border-radius: 0 4px 4px 0; }

        .stoch-needle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px; height: 14px;
            border-radius: 50%;
            transition: left 0.6s ease;
            box-shadow: 0 0 6px rgba(0,0,0,0.6);
        }
        .stoch-needle-k { background: #6366F1; z-index: 2; }
        .stoch-needle-d { background: #F59E0B; z-index: 1; width: 11px; height: 11px; opacity: 0.9; }

        .stoch-scale-labels {
            display: flex;
            font-size: 10px;
            color: #64748B;
            margin-top: 2px;
        }
        .stoch-scale-labels span { flex: 1; text-align: center; }
        .stoch-scale-labels span:first-child { text-align: left; }
        .stoch-scale-labels span:last-child { text-align: right; }

        /* ── RSI Extended ── */
        .rsi-ext-wrap { display: flex; flex-direction: column; gap: 4px; }
        .rsi-ext-bars { display: flex; flex-direction: column; gap: 8px; }
        .rsi-ext-row {
            display: grid;
            grid-template-columns: 44px 1fr 36px;
            align-items: center;
            gap: 8px;
        }
        .rsi-ext-label {
            font-size: 11px;
            font-weight: 600;
            color: #94A3B8;
            white-space: nowrap;
        }
        .rsi-ext-track {
            position: relative;
            height: 7px;
            border-radius: 4px;
            display: flex;
            overflow: visible;
        }
        .rsi-ext-zone-os  { width: 30%; background: rgba(16,185,129,0.4); border-radius: 4px 0 0 4px; }
        .rsi-ext-zone-mid { width: 40%; background: rgba(100,116,139,0.12); }
        .rsi-ext-zone-ob  { width: 30%; background: rgba(239,68,68,0.4); border-radius: 0 4px 4px 0; }
        .rsi-ext-needle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 14px; height: 14px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 6px rgba(0,0,0,0.6);
            transition: left 0.6s ease;
            z-index: 2;
        }
        .rsi-ext-val {
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-align: right;
        }
        .rsi-ext-zone-labels {
            display: flex;
            font-size: 9px;
            color: #475569;
            padding: 0 0 0 44px; /* отступ под метку RSI X */
            margin-top: 1px;
        }
        .rsi-ext-zone-labels span { flex: 1; text-align: center; }
        .rsi-ext-zone-labels span:first-child { text-align: left; }
        /* ── Bollinger Bands ── */
        .bb-wrap { display: flex; flex-direction: column; gap: 8px; }

        .bb-pctb-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
        }
        .bb-pctb-label { font-size: 11px; color: #94A3B8; font-weight: 600; }
        .bb-pctb-val   { font-size: 18px; font-weight: 800; color: white; }

        .bb-track {
            position: relative;
            height: 7px;
            border-radius: 4px;
            display: flex;
            overflow: visible;
        }
        .bb-zone-low  { width: 20%; background: rgba(16,185,129,0.4); border-radius: 4px 0 0 4px; }
        .bb-zone-mid  { width: 60%; background: rgba(99,102,241,0.12); }
        .bb-zone-high { width: 20%; background: rgba(239,68,68,0.4);  border-radius: 0 4px 4px 0; }
        .bb-needle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 16px; height: 16px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 8px rgba(0,0,0,0.6);
            transition: left 0.6s ease, background 0.4s ease;
            z-index: 2;
        }
        .bb-track-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #475569;
            margin-top: 2px;
        }

        /* Ширина полос */
        .bb-bandwidth-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 8px;
            margin-top: 2px;
        }
        .bb-bw-label { font-size: 11px; color: #64748B; white-space: nowrap; }
        .bb-bw-val { font-size: 11px; font-weight: 700; color: #CBD5E1; white-space: nowrap; }
        .bb-bw-bar-wrap {
            height: 4px;
            background: rgba(255,255,255,0.06);
            border-radius: 4px;
            overflow: hidden;
        }
        .bb-bw-bar {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #6366F1, #8B5CF6);
            transition: width 0.6s ease;
        }
        /* ── MACD ── */
        .macd-hist-wrap {
            width: 100%;
            height: 44px;
            position: relative;
        }
        /* ── Fear & Greed ── */
        .fg-gauge-wrap {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .fg-gauge-container {
            position: relative;
            width: 180px;
            height: 105px;
        }
        .fg-gauge-container canvas {
            display: block;
        }
        .fg-gauge-center {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
            white-space: nowrap;
        }
        .fg-value {
            font-size: 24px;
            font-weight: 800;
            color: white;
            line-height: 1;
        }



        @media (max-width: 900px) {
            .page2-grid { column-count: 2; }
        }
        @media (max-width: 600px) {
            .page2-grid { column-count: 1; }
            .slider-arrow { display: none; }
        }

        .container {
            max-width: 100%;
            width: 100%;
            height: 100%;
            max-height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .header {
            margin-bottom: 12px;
            padding-top: 10px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ── Языковой переключатель ── */
        .lang-selector {
            position: relative;
        }
        .lang-trigger {
            display: flex; align-items: center; gap: 6px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            color: #94A3B8;
            font-size: 12px; font-weight: 600;
            transition: background 0.15s, border-color 0.15s;
            user-select: none;
        }
        .lang-trigger:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.12); }
        .lang-trigger .lang-flag { font-size: 14px; line-height: 1; }
        .lang-trigger .lang-arrow { font-size: 9px; color: #475569; transition: transform 0.2s; }
        .lang-selector.open .lang-arrow { transform: rotate(180deg); }
        .lang-dropdown {
            position: absolute; top: calc(100% + 6px); right: 0;
            background: #111928;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 4px;
            min-width: 120px;
            display: none;
            z-index: 999;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .lang-selector.open .lang-dropdown { display: block; }
        .lang-option {
            display: flex; align-items: center; gap: 8px;
            padding: 7px 10px;
            border-radius: 6px;
            cursor: pointer;
            color: #94A3B8;
            font-size: 12px; font-weight: 600;
            transition: background 0.15s, color 0.15s;
        }
        .lang-option:hover { background: rgba(255,255,255,0.06); color: #fff; }
        .lang-option.active { background: rgba(99,102,241,0.15); color: #818CF8; }
        .lang-option .lang-flag { font-size: 14px; }

        .logo {
            width: 48px;
            height: 36px;
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
        }

        .title h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #94A3B8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .content {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            display: grid;
            grid-template-columns: minmax(0,1fr) 560px 460px;
            grid-template-rows: 790px;
            gap: 10px;
        }

        /* ── Левая колонка: обёртка ── */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: visible;
        }

        /* ── Индикаторы в два столбца под графиком ── */
        .indicators-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            flex-shrink: 0;
        }

        /* ── Новостной виджет ── */
        .news-widget {
            background: linear-gradient(145deg, #111928 0%, #0F1728 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
            flex-shrink: 0;
            cursor: pointer;
            transition: opacity 0.3s ease, border-color 0.2s;
        }
        .news-widget:hover { border-color: rgba(99,102,241,0.4); }

        /* ── Market Pulse: Funding + OI ── */
        .market-pulse-bar {
            background: rgba(17,25,40,0.95);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            height: 40px;
            display: flex;
            align-items: center;
            padding: 0 14px;
            gap: 0;
            flex-shrink: 0;
        }
        .mp-section {
            display: flex;
            align-items: center;
            gap: 7px;
            flex: 1;
            min-width: 0;
        }
        .mp-divider {
            width: 1px;
            height: 20px;
            background: rgba(255,255,255,0.06);
            flex-shrink: 0;
            margin: 0 14px;
        }
        .mp-label {
            font-size: 10px;
            font-weight: 700;
            color: #475569;
            letter-spacing: 0.06em;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .mp-value {
            font-size: 15px;
            font-weight: 800;
            white-space: nowrap;
        }
        .mp-value-white { color: white; }
        .mp-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 4px;
            white-space: nowrap;
        }
        .mp-badge.pos { background: rgba(16,185,129,0.12); color: #10B981; border: 1px solid rgba(16,185,129,0.2); }
        .mp-badge.neg { background: rgba(239,68,68,0.12);  color: #EF4444; border: 1px solid rgba(239,68,68,0.2); }
        .mp-badge.neu { background: rgba(251,191,36,0.1);  color: #FBBF24; border: 1px solid rgba(251,191,36,0.15); }
        .mp-sub {
            font-size: 11px;
            color: #475569;
            white-space: nowrap;
        }

        /* ── Мини-тикер полоска ── */
        .mini-ticker-strip {
            background: rgba(17,25,40,0.95);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 0 12px;
            height: 36px;
            display: flex;
            align-items: center;
            gap: 0;
            overflow: hidden;
            flex-shrink: 0;
        }
        .mini-ticker-item {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            padding: 0 8px;
            border-right: 1px solid rgba(255,255,255,0.05);
            min-width: 0;
        }
        .mini-ticker-item:last-child { border-right: none; }
        .mini-ticker-sym {
            font-size: 11px;
            font-weight: 700;
            color: #94A3B8;
            white-space: nowrap;
        }
        .mini-ticker-price {
            font-size: 11px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            transition: opacity 0.3s;
        }
        .mini-ticker-chg {
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
            transition: opacity 0.3s;
        }
        .mini-ticker-chg.pos { color: #10B981; }
        .mini-ticker-chg.neg { color: #EF4444; }
        .mini-ticker-item.updating .mini-ticker-price,
        .mini-ticker-item.updating .mini-ticker-chg {
            opacity: 0;
        }

        /* ── Блок графика ── */
        .chart-column {
            background: rgba(17, 25, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .chart-column .chart-container { position: relative; height: 360px; width: 100%; overflow: hidden; }
        .chart-column #lwPriceChart { width: 100%; height: 100%; }
        .chart-coin-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* ── RSI блок ── */
        .rsi-block {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .rsi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .rsi-title {
            font-size: 12px;
            font-weight: 600;
            color: #94A3B8;
        }
        .rsi-period { color: #64748B; font-weight: 400; }
        .rsi-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 8px;
            background: rgba(100,116,139,0.2);
            color: #94A3B8;
        }
        .rsi-badge.oversold  { background: rgba(16,185,129,0.15); color: #10B981; }
        .rsi-badge.neutral   { background: rgba(251,191,36,0.15);  color: #FBBF24; }
        .rsi-badge.overbought{ background: rgba(239,68,68,0.15);   color: #EF4444; }

        .rsi-track {
            position: relative;
            height: 6px;
            border-radius: 4px;
            display: flex;
            overflow: visible;
        }
        .rsi-zone { height: 100%; }
        .rsi-zone-low  { width: 30%; background: rgba(16,185,129,0.35); border-radius: 4px 0 0 4px; }
        .rsi-zone-mid  { width: 40%; background: rgba(251,191,36,0.25); }
        .rsi-zone-high { width: 30%; background: rgba(239,68,68,0.35);  border-radius: 0 4px 4px 0; }

        .rsi-needle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 0 6px rgba(0,0,0,0.5);
            transition: left 0.6s ease;
            left: 50%;
        }
        .rsi-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #64748B;
        }
        .rsi-value-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }
        .rsi-value {
            font-size: 22px;
            font-weight: 800;
            color: white;
        }
        .rsi-hint {
            font-size: 11px;
            color: #64748B;
        }

        /* ── TP стратегия в блоке итого ── */
        .tp-strategy-divider {
            height: 1px;
            background: rgba(255,255,255,0.08);
            margin: 12px 0 10px;
        }
        .tp-strategy-body {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .tp-strategy-left {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .tp-strategy-label {
            font-size: 12px;
            font-weight: 600;
            color: #94A3B8;
        }
        .tp-strategy-hint {
            font-size: 10px;
            color: rgba(255,255,255,0.45);
        }
        .tp-strategy-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }
        .tp-strategy-profit {
            font-size: 16px;
            font-weight: 700;
            color: #10B981;
        }
        .tp-strategy-pct {
            font-size: 11px;
            color: #34D399;
        }

        /* ── TP / SL / RR карточка ── */
        .tpsl-card {
            background: rgba(17, 25, 40, 0.95);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .tpsl-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tpsl-title {
            font-size: 13px;
            font-weight: 700;
            color: #94A3B8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .tpsl-rr {
            font-size: 12px;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 8px;
            background: rgba(79,70,229,0.2);
            color: #818CF8;
        }
        .tpsl-levels {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .tpsl-row {
            display: grid;
            grid-template-columns: 10px 70px 1fr auto auto;
            align-items: center;
            gap: 8px;
        }
        .tpsl-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .tpsl-lbl {
            font-size: 12px;
            font-weight: 600;
            color: #94A3B8;
        }
        .tpsl-sub {
            font-size: 10px;
            color: #475569;
            font-weight: 400;
        }
        .tpsl-price {
            font-size: 13px;
            font-weight: 700;
            color: white;
        }
        .tpsl-pct {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
        }
        .tpsl-pct.positive { color: #10B981; }
        .tpsl-pct.negative { color: #EF4444; }
        .tpsl-profit {
            font-size: 12px;
            font-weight: 700;
            color: #10B981;
            text-align: right;
        }
        .tpsl-profit.negative { color: #EF4444; }
        .tpsl-divider {
            height: 1px;
            background: rgba(255,255,255,0.06);
            margin: 2px 0;
            grid-column: 1 / -1;
        }
        .tpsl-hint {
            font-size: 11px;
            color: #475569;
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-top: 10px;
        }

        /* RR selector */
        .rr-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .rr-selector-label {
            font-size: 11px;
            color: #64748B;
            white-space: nowrap;
        }
        .rr-btns {
            display: flex;
            gap: 6px;
        }
        .rr-btn {
            padding: 4px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.03);
            color: #64748B;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rr-btn:hover { border-color: #4F46E5; color: #818CF8; }
        .rr-btn.active { background: rgba(79,70,229,0.2); border-color: #4F46E5; color: #818CF8; }
        .metric-card {
            background: linear-gradient(135deg, rgba(79,70,229,0.12) 0%, rgba(17,25,40,0.95) 100%);
            border: 1px solid rgba(79,70,229,0.2);
            border-radius: 8px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .metric-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .metric-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 700;
            color: #94A3B8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .metric-icon { font-size: 16px; }
        .metric-period { color: #475569; font-weight: 400; text-transform: none; letter-spacing: 0; }
        .metric-card-body {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric-big-value {
            font-size: 28px;
            font-weight: 700;
            color: white;
            line-height: 1;
            min-width: 60px;
            flex-shrink: 0;
        }
        .metric-side {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .metric-hint {
            font-size: 12px;
            color: #64748B;
            padding-top: 4px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .zscore-block {
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .zscore-body {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .zscore-value {
            font-size: 28px;
            font-weight: 800;
            color: white;
            min-width: 64px;
            flex-shrink: 0;
        }
        .zscore-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }
        .zscore-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .zscore-label {
            font-size: 11px;
            color: #94A3B8;
        }
        .zscore-num {
            font-size: 12px;
            font-weight: 600;
            color: #94A3B8;
        }
        .zscore-prob {
            color: #818CF8;
        }

        /* ── Колонка 2: Калькулятор ── */
        .calc-section {
            background: rgba(17, 25, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: hidden;
            height: 790px;
            max-height: 790px;
            min-height: 0;
            min-width: 0;
        }
        .calc-section::-webkit-scrollbar { width: 4px; }
        .calc-section::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 6px; }
        .calc-section::-webkit-scrollbar-thumb { background: rgba(79,70,229,0.5); border-radius: 6px; }

        /* Строка вкладки + кнопка сброса */
        .tabs-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tabs-row .tab-buttons {
            flex: 1;
            margin-bottom: 0;
        }
        .tabs-row .btn-icon.danger {
            flex-shrink: 0;
            width: auto;
            height: auto;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            font-size: 16px;
            color: #EF4444;
        }
        .tabs-row .btn-icon.danger:hover {
            background: rgba(239, 68, 68, 0.15);
            border: none;
            color: #EF4444;
        }

        /* section-header в calc — без margin-bottom */
        .calc-section .section-header {
            margin-bottom: 0;
        }

        .btn-add-buy {
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(79, 70, 229, 0.15);
            border: 1px solid rgba(79, 70, 229, 0.3);
            color: #818CF8;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .btn-add-buy:hover {
            background: rgba(79, 70, 229, 0.3);
            border-color: #4F46E5;
            color: white;
        }

        /* Инпуты продажи — две колонки рядом */
        .sell-inputs-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        /* ── Новый дизайн таба Продажа ── */
        .sell-goal-panel {
            background: rgba(79,70,229,0.07);
            border: 1px solid rgba(79,70,229,0.2);
            border-radius: 8px;
            padding: 10px 12px;
            display: grid;
            grid-template-columns: 1fr 36px 1fr;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .sell-goal-divider {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: rgba(99,102,241,0.12);
            border: 1px solid rgba(99,102,241,0.2);
            display: flex; align-items: center; justify-content: center;
            color: #6366F1; font-size: 14px; justify-self: center;
        }
        /* ── Панель цели: floating label инпуты ── */
        .sell-goal-field {
            position: relative;
            min-width: 0;
        }
        .sell-goal-field label {
            position: absolute;
            top: 50%;
            left: 14px;
            transform: translateY(-50%);
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            pointer-events: none;
            transition: all 0.2s;
            white-space: nowrap;
            z-index: 2;
        }
        .sell-goal-field input:focus + label,
        .sell-goal-field input:not([data-empty="true"]) + label {
            top: -9px;
            left: 10px;
            transform: translateY(0);
            font-size: 9px;
            font-weight: 700;
            color: #6366F1;
            background: #111827;
            padding: 0 5px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .sell-goal-field input {
            width: 100%;
            background: rgba(0,0,0,0.25);
            border: 1px solid rgba(99,102,241,0.25);
            border-radius: 6px;
            outline: none;
            color: white;
            font-size: 18px;
            font-weight: 700;
            padding: 10px 10px 10px;
            font-family: inherit;
            letter-spacing: -0.01em;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .sell-goal-field input:focus {
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
        }
        .sell-goal-field input::placeholder { color: transparent; }

        /* ── Строки покупок: floating label ── */
        .buy-row-field {
            position: relative;
            min-width: 0;
        }
        .buy-row-field label {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            font-size: 12px;
            font-weight: 500;
            color: #334155;
            pointer-events: none;
            transition: all 0.18s;
            white-space: nowrap;
            z-index: 2;
        }
        .buy-row-field input:focus + label,
        .buy-row-field input:not([data-empty="true"]) + label {
            top: -7px;
            left: 8px;
            transform: translateY(0);
            font-size: 8px;
            font-weight: 700;
            color: #6366F1;
            background: #0B1120;
            padding: 0 4px;
            text-transform: uppercase;
            letter-spacing: 0.07em;
        }
        .buy-row-field input {
            width: 100%;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px;
            outline: none;
            color: #E2E8F0;
            font-size: 13px;
            font-weight: 600;
            padding: 10px 10px 6px;
            font-family: inherit;
            transition: border-color 0.18s;
        }
        .buy-row-field input:focus {
            border-color: rgba(99,102,241,0.5);
            color: white;
        }
        .buy-row-field input::placeholder { color: transparent; }

        .sell-buys-header {
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .sell-buys-label {
            font-size: 11px; font-weight: 700; color: #475569;
            text-transform: uppercase; letter-spacing: 0.08em;
            display: flex; align-items: center; gap: 7px;
        }
        .sell-buys-count {
            background: rgba(79,70,229,0.18); color: #818CF8;
            border-radius: 4px; padding: 1px 7px; font-size: 11px; font-weight: 700;
        }

        /* Компактная строка покупки */
        .buy-row {
            display: grid;
            grid-template-columns: 22px 1fr 1fr 48px 20px;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px;
            transition: border-color 0.18s;
            flex-shrink: 0;
        }
        .buy-row:hover { border-color: rgba(79,70,229,0.25); }
        .buy-row-num {
            width: 22px; height: 22px; border-radius: 4px;
            background: #4F46E5; color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; flex-shrink: 0;
        }
        .buy-row-coins {
            font-size: 11px; font-weight: 700; color: #10B981;
            text-align: right; white-space: nowrap;
        }
        .buy-row-coins.zero { color: #1E293B; }
        .buy-row-remove {
            width: 20px; height: 20px; border-radius: 4px;
            background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.15);
            color: #EF4444; font-size: 11px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s; flex-shrink: 0; opacity: 0;
        }
        .buy-row:hover .buy-row-remove { opacity: 1; }
        .buy-row-remove:hover { background: rgba(239,68,68,0.2); }

        .buys-rows-scroll {
            display: flex; flex-direction: column; gap: 6px;
            overflow-y: auto; flex: 1; min-height: 0;
        }
        .buys-rows-scroll::-webkit-scrollbar { width: 3px; }
        .buys-rows-scroll::-webkit-scrollbar-thumb { background: rgba(79,70,229,0.3); border-radius: 6px; }

        .buys-section {
            background: rgba(17, 25, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .section-header h2 {
            color: white;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header h2 span {
            background: #4F46E5;
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 8px;
        }

        .coin-selector-area {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .coin-select-wrapper { position: relative; }

        .coin-select-trigger {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 6px 10px 6px 8px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            user-select: none;
        }

        .coin-select-trigger:hover {
            border-color: #4F46E5;
            background: rgba(79, 70, 229, 0.1);
        }

        .coin-select-trigger img {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
        }

        .coin-select-trigger .arrow {
            margin-left: 4px;
            color: #64748B;
            font-size: 10px;
            transition: transform 0.2s;
        }

        .coin-select-trigger.open .arrow { transform: rotate(180deg); }

        /* ── Dropdown: desktop ── */
        .coin-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: #111827;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px;
            z-index: 500;
            width: 260px;
            box-shadow: 0 20px 48px rgba(0,0,0,0.6);
            /* анимация */
            opacity: 0;
            transform: translateY(-8px);
            pointer-events: none;
            transition: opacity 0.22s cubic-bezier(0.4,0,0.2,1),
                        transform 0.22s cubic-bezier(0.4,0,0.2,1);
        }
        .coin-dropdown.open {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .coin-dropdown-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 6px;
        }
        .coin-dropdown-search-icon {
            font-size: 13px;
            color: #475569;
            flex-shrink: 0;
        }
        .coin-dropdown-search input {
            background: none;
            border: none;
            outline: none;
            color: white;
            font-size: 13px;
            width: 100%;
            font-family: inherit;
        }
        .coin-dropdown-search input::placeholder { color: #475569; }
        .coin-dropdown-list {
            max-height: 280px;
            overflow-y: auto;
        }
        .coin-dropdown-list::-webkit-scrollbar { width: 4px; }
        .coin-dropdown-list::-webkit-scrollbar-track { background: transparent; }
        .coin-dropdown-list::-webkit-scrollbar-thumb { background: rgba(79,70,229,0.5); border-radius: 6px; }
        .coin-dropdown-empty {
            text-align: center;
            color: #475569;
            font-size: 12px;
            padding: 14px 0;
        }

        /* ── Bottom sheet: mobile overlay ── */
        .coin-sheet-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0);
            z-index: 900;
            transition: background 0.3s ease;
        }
        .coin-sheet-overlay.open { display: block; background: rgba(0,0,0,0.55); }

        .coin-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #111827;
            border-top: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px 8px 0 0;
            z-index: 1000;
            padding: 0 0 env(safe-area-inset-bottom, 12px);
            transform: translateY(100%);
            transition: transform 0.38s cubic-bezier(0.4,0,0.2,1);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }
        .coin-sheet.open { transform: translateY(0); }
        .coin-sheet-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 2px;
            margin: 12px auto 0;
            flex-shrink: 0;
        }
        .coin-sheet-header {
            padding: 10px 14px 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .coin-sheet-title {
            font-size: 16px;
            font-weight: 700;
            color: white;
        }
        .coin-sheet-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255,255,255,0.08);
            border: none;
            color: #94A3B8;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s;
        }
        .coin-sheet-close:hover { background: rgba(255,255,255,0.15); }
        .coin-sheet-search {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 10px 10px;
            margin: 0 16px 10px;
            flex-shrink: 0;
        }
        .coin-sheet-search input {
            background: none;
            border: none;
            outline: none;
            color: white;
            font-size: 15px;
            width: 100%;
            font-family: inherit;
        }
        .coin-sheet-search input::placeholder { color: #475569; }
        .coin-sheet-list {
            overflow-y: auto;
            flex: 1;
            padding: 0 8px 12px;
        }
        .coin-sheet-list::-webkit-scrollbar { display: none; }

        .coin-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .coin-option:hover { background: rgba(79, 70, 229, 0.15); }
        .coin-option.selected { background: rgba(79, 70, 229, 0.2); }

        .coin-option img {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .coin-option-info { display: flex; flex-direction: column; gap: 1px; }
        .coin-option-name { color: white; font-size: 13px; font-weight: 600; }
        .coin-option-symbol { color: #64748B; font-size: 11px; }

        .price-change-block {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .current-price {
            color: #4F46E5;
            font-weight: 600;
            background: rgba(79, 70, 229, 0.1);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
        }

        .price-change-badge {
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            display: none;
        }

        .price-change-badge.positive {
            background: rgba(16, 185, 129, 0.15);
            color: #10B981;
            display: block;
        }

        .price-change-badge.negative {
            background: rgba(239, 68, 68, 0.15);
            color: #EF4444;
            display: block;
        }

        .actions { display: flex; gap: 8px; }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            color: #94A3B8;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .btn-icon:hover {
            background: rgba(79, 70, 229, 0.2);
            border-color: #4F46E5;
            color: #4F46E5;
        }

        .btn-icon.danger { color: #EF4444; border-color: rgba(239, 68, 68, 0.3); }
        .btn-icon.danger:hover { background: rgba(239, 68, 68, 0.2); border-color: #EF4444; }

        .buys-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            flex: 1 1 auto;
            min-height: 0;
            margin-bottom: 16px;
        }

        .buys-grid::-webkit-scrollbar { width: 6px; }
        .buys-grid::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 6px; }
        .buys-grid::-webkit-scrollbar-thumb { background: rgba(79,70,229,0.5); border-radius: 6px; }

        .buy-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
        }

        .buy-card:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(79, 70, 229, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .card-title { display: flex; align-items: center; gap: 8px; }

        .card-number {
            background: #4F46E5;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
        }

        .card-label { color: white; font-weight: 500; font-size: 14px; }

        .btn-remove {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #EF4444;
            width: 26px;
            height: 26px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-remove:hover { background: rgba(239, 68, 68, 0.2); border-color: #EF4444; }

        .card-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .input-wrapper { position: relative; }

        /* ── Крестик очистки инпута ── */
        .input-clear-btn {
            position: absolute;
            right: 11px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: none;
            background: rgba(100,116,139,0.18);
            color: #64748B;
            font-size: 8px;
            font-weight: 800;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.15s, color 0.15s;
            z-index: 10;
            line-height: 1;
            padding: 0;
        }
        .input-clear-btn:hover {
            background: rgba(239,68,68,0.18);
            color: #EF4444;
        }
        input:not([data-empty="true"]) ~ .input-clear-btn { display: flex; }
        .input-wrapper input, .input-large input { padding-right: 38px !important; }

        /* крестик в панели цели — чуть правее, по центру */
        .sell-goal-field .input-clear-btn { right: 10px; }
        .sell-goal-field input { padding-right: 36px !important; }

        /* крестик в строках покупок */
        .buy-row-field .input-clear-btn { right: 8px; width: 16px; height: 16px; font-size: 7px; }

        .input-wrapper label {
            position: absolute;
            top: 12px;
            left: 16px;
            padding: 0 6px;
            font-size: 14px;
            font-weight: 500;
            color: #64748B;
            z-index: 5;
            transition: all 0.2s;
            pointer-events: none;
        }

        .input-wrapper input:focus + label,
        .input-wrapper input:not([data-empty="true"]) + label {
            top: -8px;
            left: 12px;
            font-size: 10px;
            font-weight: 600;
            color: #4F46E5;
            background: #0B1120;
            text-transform: uppercase;
        }

        .input-wrapper input {
            width: 100%;
            padding: 12px 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: #4F46E5;
            background: rgba(79, 70, 229, 0.1);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .coins-hint { font-size: 11px; color: #10B981; margin-top: 6px; padding-left: 16px; font-weight: 500; }
        .coins-hint span { color: #34D399; font-weight: 700; }

        .average-info {
            padding: 10px 14px;
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: auto;
        }

        .avg-item { display: flex; align-items: center; gap: 8px; }
        .avg-label { color: #94A3B8; font-size: 13px; }
        .avg-value { color: white; font-weight: 600; font-size: 15px; }

        .progress-to-goal {
            padding: 8px 10px;
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .progress-title {
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-percent {
            color: #4F46E5;
            font-size: 12px;
            font-weight: 700;
        }

        .progress-bar-bg {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .progress-bar-fill {
            height: 100%;
            background: #4F46E5;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-bar-fill.success {
            background: linear-gradient(90deg, #10B981, #34D399);
        }

        .progress-info {
            color: #64748B;
            font-size: 10px;
        }

        .results-section { 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            min-height: 0;
            overflow: hidden;
            height: 790px;
            max-height: 790px;
        }
        .results-top {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }
        .results-scroll {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            min-height: 0;
            padding-right: 4px;
        }
        .results-section::-webkit-scrollbar { width: 4px; }
        .results-section::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 6px; }
        .results-section::-webkit-scrollbar-thumb { background: rgba(79,70,229,0.5); border-radius: 6px; }

        /* Tabs */
        .tabs-container {
            background: rgba(17, 25, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .tab-buttons {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .tab-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: #64748B;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .tab-btn:hover { color: #94A3B8; }
        .tab-btn.active { background: #4F46E5; color: white; }

        .tab-content {
            display: none;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .tab-content.active { display: flex; }

        .sell-header { margin-bottom: 16px; }
        .sell-header h3 { color: white; font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .sell-header p { color: #64748B; font-size: 13px; }
        .sell-inputs { display: flex; flex-direction: column; gap: 12px; }

        .input-large { position: relative; }

        .input-large label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 20px;
            padding: 0 8px;
            font-size: 16px;
            font-weight: 500;
            color: #64748B;
            z-index: 5;
            transition: all 0.2s;
            pointer-events: none;
            background: transparent;
        }

        .input-large input:focus + label,
        .input-large input:not([data-empty="true"]) + label {
            top: -8px;
            transform: translateY(0);
            left: 16px;
            font-size: 11px;
            font-weight: 600;
            color: #4F46E5;
            background: #0B1120;
            text-transform: uppercase;
        }

        .input-large input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .input-large input:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3);
        }

        /* Long/Short toggle */
        .direction-toggle {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .direction-btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #64748B;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .direction-btn:hover { border-color: #4F46E5; }
        .direction-btn.active.long { background: rgba(16, 185, 129, 0.2); border-color: #10B981; color: #10B981; }
        .direction-btn.active.short { background: rgba(239, 68, 68, 0.2); border-color: #EF4444; color: #EF4444; }

        .chart-section {
            background: rgba(17, 25, 40, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            flex-shrink: 0;
        }

        .chart-header {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        
        .chart-period-buttons {
            display: flex;
            gap: 6px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 6px;
        }

        .period-btn {
            padding: 4px 10px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: #64748B;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover { color: #94A3B8; }
        .period-btn.active { background: #4F46E5; color: white; }

        .chart-type-toggle {
            display: flex; align-items: center; gap: 2px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 2px;
        }
        .chart-type-btn {
            background: none; border: none; cursor: pointer;
            color: #475569; padding: 5px 7px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s, color 0.15s;
        }
        .chart-type-btn.active { background: rgba(99,102,241,0.25); color: #818CF8; }
        .chart-type-btn:hover:not(.active) { color: #94A3B8; }

        .chart-title {
            display: flex; align-items: center; gap: 10px;
        }
        .chart-title h3 { color: white; font-size: 15px; font-weight: 600; white-space: nowrap; }
        .chart-source-toggle {
            display: flex; align-items: center; gap: 2px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px; padding: 2px;
        }
        .chart-source-btn {
            background: none; border: none; cursor: pointer;
            color: #475569; font-size: 11px; font-weight: 600;
            padding: 4px 10px; border-radius: 4px;
            transition: background 0.15s, color 0.15s; white-space: nowrap;
        }
        .chart-source-btn.active { background: rgba(99,102,241,0.25); color: #818CF8; }
        .chart-source-btn:hover:not(.active) { color: #94A3B8; }

        .chart-container { position: relative; height: 180px; width: 100%; }
        #lwPriceChart { width: 100%; height: 100%; }

        .chart-loading {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748B;
            font-size: 12px;
            background: rgba(17,25,40,0.8);
            z-index: 2;
            border-radius: 6px;
        }

        /* Main Result - контейнер для всех вариантов */
        .main-result {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 12px;
            flex-shrink: 0;
        }

        .result-label {
            color: rgba(255,255,255,0.7);
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .result-amount {
            font-size: 28px;
            font-weight: 800;
            color: white;
            line-height: 1;
            margin-bottom: 12px;
            word-break: break-word;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .stat-item { display: flex; flex-direction: column; gap: 2px; }
        .stat-label { font-size: 10px; color: rgba(255,255,255,0.6); text-transform: uppercase; margin-bottom: 2px; }

        .stat-value { font-size: 18px; font-weight: 700; color: white; line-height: 1.2; }
        .stat-value.positive { color: #34D399; }
        .stat-value.negative { color: #FBBF24; }
        .stat-value.danger { color: #EF4444; }

        .stat-value-rub {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255,255,255,0.4);
            margin-top: 3px;
            display: block;
            min-height: 16px;
        }
        .stat-value-rub.positive { color: rgba(52, 211, 153, 0.7); }
        .stat-value-rub.negative { color: rgba(251, 191, 36, 0.7); }

        .avg-price {
            grid-column: span 2;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .avg-price span:first-child { color: rgba(255,255,255,0.7); font-size: 11px; }
        .avg-price span:last-child { color: white; font-weight: 700; font-size: 14px; }

        /* Скрытые блоки результатов */
        .result-block {
            display: none;
        }
        .result-block.active {
            display: block;
        }

        /* Compound mode toggle */
        .compound-mode-toggle {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .compound-mode-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: #64748B;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .compound-mode-btn:hover { color: #94A3B8; }
        .compound-mode-btn.active { background: #4F46E5; color: white; }

        .compound-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .compound-loss input {
            border-color: rgba(239, 68, 68, 0.3) !important;
        }
        .compound-loss input:focus {
            border-color: #EF4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
        }
        .compound-loss input:focus + label,
        .compound-loss input:not([data-empty="true"]) + label {
            color: #EF4444 !important;
        }

        .goal-table {
            margin-top: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .goal-table-title {
            color: #94A3B8;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .goal-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }

        .goal-row:last-child { border-bottom: none; }

        .goal-row-label { color: #64748B; font-size: 13px; }
        .goal-row-label strong { color: #94A3B8; }

        .goal-row-value {
            background: rgba(79,70,229,0.15);
            border: 1px solid rgba(79,70,229,0.3);
            border-radius: 6px;
            padding: 4px 10px;
            color: #818CF8;
            font-size: 12px;
            font-weight: 700;
        }

        .goal-row-value.highlight {
            background: rgba(16,185,129,0.15);
            border-color: rgba(16,185,129,0.3);
            color: #10B981;
        }

        .goal-note {
            color: #374151;
            font-size: 10px;
            margin-top: 10px;
        }

        /* ── MacBook 16" (1500px) ── */
        @media (max-width: 1500px) {
            .content { grid-template-columns: 520px 1fr 360px; gap: 12px; }
            .container { max-width: 100%; padding: 0 16px; }
            .chart-column .chart-container { height: 200px; }
            .metric-card { padding: 14px 16px; gap: 10px; }
            .metric-big-value { font-size: 24px; }
            .result-amount { font-size: 36px; }
        }

        /* ── MacBook 13/14" (1280px) ── */
        @media (max-width: 1350px) {
            body { padding: 12px; }
            .content { grid-template-columns: 420px 1fr 320px; gap: 10px; }
            .container { max-width: 100%; }
            .header { margin-bottom: 12px; }
            .title h1 { font-size: 20px; }
            .logo { width: 36px; height: 36px; font-size: 18px; }

            /* Левая колонка */
            .chart-column { padding: 14px; border-radius: 8px; }
            .chart-column .chart-container { height: 170px; }
            .chart-title h3 { font-size: 13px; }
            .period-btn { padding: 4px 8px; font-size: 10px; }
            .coin-select-trigger { font-size: 11px; padding: 4px 10px 4px 5px; }
            .coin-select-trigger img { width: 18px; height: 18px; }
            .current-price { font-size: 12px; padding: 4px 10px; }
            .price-change-badge { font-size: 10px; padding: 4px 7px; }

            /* RSI / Z-Score карточки */
            .metric-card { padding: 12px 14px; gap: 8px; border-radius: 8px; }
            .metric-big-value { font-size: 22px; min-width: 48px; }
            .metric-card-title { font-size: 11px; }
            .rsi-badge { font-size: 10px; padding: 2px 8px; }
            .metric-hint { font-size: 10px; }
            .zscore-label { font-size: 10px; }
            .zscore-num { font-size: 11px; }

            /* Средняя колонка */
            .calc-section { padding: 14px; border-radius: 8px; gap: 12px; }
            .tab-btn { font-size: 10px; padding: 6px 8px; }
            .section-header h2 { font-size: 14px; }
            .btn-add-buy { font-size: 11px; padding: 6px 12px; }
            .buy-card { padding: 12px; border-radius: 6px; }
            .card-label { font-size: 12px; }
            .input-wrapper input { padding: 9px 12px; font-size: 12px; }
            .coins-hint { font-size: 9px; }
            .sell-inputs-row { gap: 8px; }
            .input-large input { padding: 10px 14px; font-size: 13px; }
            .input-large label { font-size: 13px; }

            /* Правая колонка */
            .results-section { gap: 8px; }
            .main-result { padding: 16px 18px; border-radius: 8px; }
            .result-label { font-size: 10px; margin-bottom: 6px; }
            .result-amount { font-size: 30px; margin-bottom: 10px; }
            .result-stats { gap: 10px; padding-top: 10px; }
            .stat-label { font-size: 9px; }
            .stat-value { font-size: 16px; }
            .avg-price { padding: 8px; margin-top: 4px; }
            .average-info { padding: 12px 14px; border-radius: 8px; gap: 8px; }
            .avg-label { font-size: 10px; }
            .avg-value { font-size: 12px; }
            .progress-to-goal { padding: 14px; border-radius: 8px; }
            .progress-title { font-size: 12px; }
            .progress-percent { font-size: 12px; }
            .tpsl-card { padding: 14px 16px; border-radius: 8px; gap: 10px; }
            .tpsl-title { font-size: 11px; }
            .tpsl-lbl { font-size: 11px; }
            .tpsl-price { font-size: 12px; }
            .tpsl-pct { font-size: 10px; }
            .tpsl-profit { font-size: 11px; }
        }

        @media (max-width: 900px) {
        body { 
            padding: 10px;
            overflow-y: auto;
            height: auto;
            align-items: flex-start;
        }
        
        .container { 
            max-width: 100%;
            height: auto;
        }
        
        .header { margin-bottom: 16px; padding-top: 0; }
        .logo { width: 42px; height: 42px; font-size: 20px; }
        .title h1 { font-size: 22px; }
        
        .content { 
            grid-template-columns: 1fr; 
            height: auto;
            gap: 10px;
        }
        
        .buys-section { 
            padding: 14px;
            border-radius: 8px;
            overflow: visible;
            min-height: auto;
        }

        .tabs-container, .chart-section, .main-result {
            padding: 14px;
            border-radius: 8px;
        }
        
        .buys-grid {
            overflow-y: visible;
            max-height: none;
            flex: none;
        }

        .results-section {
            overflow-y: visible;
            height: auto;
        }
        
        .section-header h2 { font-size: 16px; }
        .coin-select-trigger { font-size: 12px; padding: 5px 12px 5px 6px; }
        .coin-select-trigger img { width: 20px; height: 20px; }
        .current-price { font-size: 13px; padding: 5px 12px; }
        .price-change-badge { font-size: 11px; padding: 5px 8px; }
        
        .btn-icon { width: 32px; height: 32px; font-size: 16px; }
        
        .buy-card { padding: 14px; border-radius: 8px; }
        .card-number { width: 22px; height: 22px; font-size: 11px; }
        .card-label { font-size: 13px; }
        .input-wrapper input { padding: 11px 14px; font-size: 13px; }
        .coins-hint { font-size: 10px; }
        
        .progress-to-goal { 
            padding: 12px; 
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .progress-title { font-size: 14px; }
        .progress-percent { font-size: 14px; }
        .progress-bar-bg { height: 10px; margin-bottom: 10px; }
        .progress-info { font-size: 12px; }
        
        .average-info { 
            padding: 10px 12px; 
            gap: 8px;
            border-radius: 8px;
        }
        .avg-label { font-size: 11px; }
        .avg-value { font-size: 13px; }

        .tab-btn { font-size: 11px; padding: 7px 10px; }
        
        .sell-header h3 { font-size: 15px; }
        .sell-header p { font-size: 12px; }
        .input-large input { padding: 14px 18px; font-size: 15px; }
        .input-large label { font-size: 15px; }
        
        .chart-container { height: 180px; }
        .chart-loading { height: 180px; font-size: 12px; }
        .chart-title h3 { font-size: 15px; }
        .period-btn { padding: 5px 10px; font-size: 11px; }
        
        .main-result { padding: 20px; }
        .result-label { font-size: 11px; margin-bottom: 8px; }
        .result-amount { font-size: 32px; margin-bottom: 14px; }
        .result-stats { gap: 14px; padding-top: 14px; }
        .stat-label { font-size: 10px; }
        .stat-value { font-size: 18px; }
        .stat-value-rub { font-size: 11px; }
        .avg-price { padding: 10px; margin-top: 6px; }
        .avg-price span:first-child { font-size: 11px; }
        .avg-price span:last-child { font-size: 14px; }
    }

        /* ── Страница 3: Новости (новый дизайн) ── */
        .page3-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            z-index: 1;
            max-width: 100%;
        }

        /* === HEADER === */
        .page3-header {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
            padding: 0 0 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            margin-bottom: 8px;
        }
        .page3-logo {
            width: 32px; height: 32px;
            border-radius: 6px;
            background: linear-gradient(135deg, #6366F1, #8B5CF6);
            display: flex; align-items: center; justify-content: center;
            font-size: 15px; flex-shrink: 0;
        }
        .page3-title { font-size: 16px; font-weight: 800; color: white; line-height: 1.2; }
        .page3-subtitle { font-size: 10px; color: #64748B; }

        /* Search bar */
        .news-search-bar {
            flex: 1;
            max-width: 560px;
            margin-left: 8px;
            position: relative;
        }
        .news-search-bar input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.09);
            border-radius: 8px;
            padding: 7px 12px 7px 28px;
            font-size: 12px; color: #CBD5E1;
            outline: none; transition: border-color 0.2s;
        }
        .news-search-bar input::placeholder { color: #475569; }
        .news-search-bar input:focus { border-color: rgba(99,102,241,0.4); }
        .news-search-bar .news-search-icon {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            color: #475569; font-size: 13px; pointer-events: none;
        }
        .news-search-bar .news-search-hotkey {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 5px; padding: 1px 5px; font-size: 10px; color: #475569;
        }

        .page3-header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }

        .news-follow-btn {
            display: flex; align-items: center; gap: 5px;
            padding: 6px 10px; border-radius: 8px;
            background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.25);
            color: #818CF8; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .news-follow-btn:hover { background: rgba(99,102,241,0.22); color: #fff; }

        .news-refresh-btn {
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(99,102,241,0.12);
            border: 1px solid rgba(99,102,241,0.25);
            color: #818CF8; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .news-refresh-btn:hover { background: rgba(99,102,241,0.25); color: #fff; }
        .news-refresh-btn.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .news-live-dot {
            display: flex; align-items: center; gap: 5px;
            font-size: 10px; color: #475569;
        }
        .news-live-dot::before {
            content: '';
            width: 6px; height: 6px; border-radius: 50%;
            background: #10B981;
            animation: npulse 2s ease-in-out infinite;
        }
        @keyframes npulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }

        /* Filters */
        .news-filters {
            display: flex; align-items: center; gap: 5px;
            flex-shrink: 0; flex-wrap: nowrap;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 8px;
            overflow-x: auto;
        }
        .news-filters::-webkit-scrollbar { display: none; }
        .news-filter-label { font-size: 11px; font-weight: 700; color: #475569; white-space: nowrap; padding-right: 2px; }
        .news-filter-sep { color: rgba(255,255,255,0.15); font-size: 14px; padding: 0 4px; flex-shrink: 0; }
        .news-filter-btn {
            padding: 5px 10px; border-radius: 8px;
            font-size: 12px; font-weight: 600;
            cursor: pointer; border: 1px solid transparent;
            transition: all 0.2s;
            background: transparent; color: #64748B;
            white-space: nowrap;
        }
        .news-filter-btn:hover { color: #CBD5E1; }
        .news-filter-btn.active { background: rgba(255,255,255,0.07); color: #fff; border-color: rgba(255,255,255,0.1); }
        .news-filter-btn.bull.active { background: rgba(16,185,129,0.15); color:#10B981; border-color:rgba(16,185,129,0.3); }
        .news-filter-btn.bear.active { background: rgba(239,68,68,0.15); color:#EF4444; border-color:rgba(239,68,68,0.3); }
        .news-source-btn {
            padding: 4px 12px; border-radius: 8px;
            font-size: 11px; font-weight: 600;
            cursor: pointer; border: 1px solid transparent;
            transition: all 0.2s;
            background: transparent; color: #475569;
            white-space: nowrap;
        }
        .news-source-btn:hover { color: #94A3B8; }
        .news-source-btn.active { background: rgba(99,102,241,0.12); color: #818CF8; border-color: rgba(99,102,241,0.25); }

        /* ═══ MAIN GRID (3 cols) ═══ */
        .news-grid {
            flex: 1; min-height: 0;
            display: grid;
            grid-template-columns: minmax(0,1.8fr) minmax(0,2fr) minmax(0,0.9fr);
            gap: 10px;
        }
        .news-col { display: flex; flex-direction: column; gap: 8px; min-height: 0; overflow: hidden; }
        .news-col-label {
            font-size: 13px; font-weight: 700; color: #94A3B8;
            padding-left: 0; flex-shrink: 0;
        }
        .news-col-scroll {
            flex: 1; overflow-y: visible;
            display: flex; flex-direction: column; gap: 6px;
            padding-right: 2px;
        }

        /* ═══ LEFT COL: Featured + Trends ═══ */
        .news-featured-card {
            background: linear-gradient(145deg, #111928 0%, #0F1728 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            padding: 12px;
            flex-shrink: 0;
            position: relative; overflow: hidden;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.15s;
        }
        .news-featured-card:hover { border-color: rgba(99,102,241,0.4); }
        .news-featured-badges {
            display: flex; gap: 6px; margin-bottom: 10px;
        }
        .news-feat-badge {
            font-size: 11px; font-weight: 700; padding: 3px 9px; border-radius: 8px;
            display: flex; align-items: center; gap: 4px;
        }
        .news-feat-badge.main { background: rgba(251,191,36,0.15); color: #FBBF24; border: 1px solid rgba(251,191,36,0.25); }
        .news-feat-badge.tag { background: rgba(99,102,241,0.12); color: #818CF8; border: 1px solid rgba(99,102,241,0.2); }
        .news-feat-badge.bear { background: rgba(239,68,68,0.12); color: #EF4444; border: 1px solid rgba(239,68,68,0.2); }
        .news-feat-badge.bull { background: rgba(16,185,129,0.12); color: #10B981; border: 1px solid rgba(16,185,129,0.2); }
        .news-feat-badge.neutral { background: rgba(251,191,36,0.12); color: #FBBF24; border: 1px solid rgba(251,191,36,0.2); }
        .news-featured-title {
            font-size: 24px; font-weight: 800; color: #fff; line-height: 1.3;
            margin-bottom: 12px;
        }
        .news-featured-desc {
            font-size: 13px; color: #64748B; line-height: 1.65;
            margin-bottom: 14px;
        }
        .news-featured-btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 12px; border-radius: 6px;
            background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.25);
            color: #818CF8; font-size: 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
        }
        .news-featured-btn:hover { background: rgba(99,102,241,0.22); color: #fff; }

        /* Trends block — сетка 2×2 */
        .news-trends-card {
            background: rgba(15,23,42,0.8);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 8px;
            padding: 10px 12px;
            flex-shrink: 0;
            display: flex; flex-direction: column; gap: 0;
            overflow: hidden;
        }
        .news-trends-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 7px; flex-shrink: 0;
        }
        .news-trends-title {
            font-size: 13px; font-weight: 700; color: #CBD5E1;
            display: flex; align-items: center; gap: 6px;
        }
        .news-trends-sort {
            font-size: 11px; color: #475569; cursor: pointer;
        }
        .news-trends-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }
        .news-trend-grid-card {
            background: rgba(17,25,40,0.95);
            border: 1px solid rgba(255,255,255,0.07);
            border-left: 3px solid #6366F1;
            border-radius: 6px;
            padding: 8px 10px;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.15s;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .news-trend-grid-card .news-trend-grid-title { flex: 1; }
        .news-trend-grid-card .news-trend-grid-tag { margin-top: auto; padding-top: 6px; }
        /* Trends row layout */
        .news-trends-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 6px;
            overflow: hidden;
        }
        .news-trends-row:last-child { margin-bottom: 0; }
        .news-trends-smalls {
            display: flex; flex-direction: column; gap: 6px;
        }
        /* Big card — похожа на главную но компактнее */
        .news-big-card {
            background: linear-gradient(145deg, #111928 0%, #0F1728 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            padding: 10px 12px;
            cursor: pointer;
            transition: border-color 0.2s;
            display: flex; flex-direction: column;
            overflow: hidden;
        }
        .news-big-card:hover { border-color: rgba(99,102,241,0.4); }
        .news-big-card-title {
            font-size: 13px; font-weight: 700; color: #fff; line-height: 1.4;
            margin-top: 5px;
        }
        .news-big-card-desc {
            font-size: 11px; color: #64748B; line-height: 1.5;
            margin-top: 4px; flex: 1;
        }
        .news-big-card-tag {
            margin-top: auto; padding-top: 6px; align-self: flex-start;
        }
        .news-trend-grid-meta {
            display: flex; align-items: center; gap: 5px; flex-wrap: nowrap;
        }
        .news-trend-grid-source { font-size: 11px; font-weight: 700; color: #6366F1; white-space: nowrap; }
        .news-trend-grid-time { font-size: 10px; color: #475569; white-space: nowrap; }
        .news-trend-grid-title {
            font-size: 12px; font-weight: 600; color: #CBD5E1; line-height: 1.45;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        .news-trend-grid-tag {
            font-size: 10px; font-weight: 700; padding: 2px 7px; border-radius: 4px;
            background: rgba(99,102,241,0.1); color: #6366F1 !important;
            display: inline-block; align-self: flex-start;
            text-decoration: none;
        }
        .news-trend-badge {
            font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 6px;
            flex-shrink: 0; white-space: nowrap;
        }
        .news-trend-badge.bull { background: rgba(16,185,129,0.15); color: #10B981; }
        .news-trend-badge.bear { background: rgba(239,68,68,0.15); color: #EF4444; }
        .news-trend-badge.neutral { background: rgba(251,191,36,0.15); color: #FBBF24; }

        /* ═══ MIDDLE COL: Feed ═══ */
        .news-feed-header {
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .news-feed-sort {
            display: flex; align-items: center; gap: 6px;
            font-size: 11px; color: #475569; cursor: pointer;
            padding: 4px 10px; border-radius: 6px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06);
        }
        .news-feed-sort:hover { color: #CBD5E1; }

        .news-feed-wrap {
            flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;
            scrollbar-width: thin; scrollbar-color: #4F46E5 rgba(255,255,255,0.03);
        }
        .news-card {
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 6px;
            padding: 8px 12px;
            position: relative; overflow: hidden;
            flex-shrink: 0; cursor: pointer;
            transition: border-color 0.2s, transform 0.15s;
        }
        .news-card:hover { border-color: rgba(99,102,241,0.35); }
        .news-card::before { display: none; }

        .news-card-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
        .news-card-source-ico {
            width: 18px; height: 18px; border-radius: 5px;
            background: rgba(99,102,241,0.2);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; flex-shrink: 0; color: #818CF8;
        }
        .news-source { font-size: 12px; font-weight: 700; color: #CBD5E1; }
        .news-dot { font-size: 10px; color: #334155; }
        .news-time { font-size: 11px; color: #475569; }
        .news-sent-badge {
            margin-left: auto; font-size: 10px; font-weight: 700;
            padding: 2px 7px; border-radius: 6px;
        }
        .news-sent-badge.bull { background: rgba(16,185,129,0.15); color: #10B981; }
        .news-sent-badge.bear { background: rgba(239,68,68,0.15); color: #EF4444; }
        .news-sent-badge.neutral { background: rgba(251,191,36,0.15); color: #FBBF24; }

        .news-card-title-big { font-size: 14px; font-weight: 700; color: #fff; line-height: 1.4; margin-bottom: 0; }
        .news-card-title { font-size: 13px; font-weight: 600; color: #fff; line-height: 1.4; margin-bottom: 0; }
        .news-card-desc { display: none; }
        .news-card-desc-sm { display: none; }

        .news-card-footer {
            display: flex; align-items: center; gap: 8px;
            margin-top: 5px;
        }
        .news-tag-inline {
            font-size: 11px; padding: 2px 8px; border-radius: 4px;
            background: rgba(99,102,241,0.1); color: #6366F1;
            border: 1px solid rgba(99,102,241,0.15);
        }
        .news-card-stats {
            margin-left: auto; display: flex; align-items: center; gap: 10px;
            font-size: 11px; color: #475569;
        }
        .news-card-stat { display: flex; align-items: center; gap: 3px; }
        .news-tags { display: none; }
        .news-tag {
            font-size: 11px;
            padding: 2px 7px;
            border-radius: 6px;
            background: rgba(99, 102, 241, 0.12);
            color: #818CF8;
        }
        .news-read-more { display: none; }

        /* Pagination */
        .news-pagination {
            display: flex; align-items: center; justify-content: center; gap: 4px;
            flex-shrink: 0; padding: 6px 0 0 0;
        }
        .news-pag-btn {
            min-width: 28px; height: 28px; border-radius: 6px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07);
            color: #64748B; font-size: 12px; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; padding: 0 8px;
        }
        .news-pag-btn:hover { background: rgba(99,102,241,0.12); color: #818CF8; }
        .news-pag-btn.active { background: rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.35); color: #818CF8; }

        /* ═══ RIGHT COL ═══ */
        .news-stat-card {
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 6px; padding: 10px 12px;
            flex-shrink: 0;
        }
        .news-stat-label { font-size: 11px; font-weight: 700; color: #CBD5E1; margin-bottom: 8px; text-transform: none; letter-spacing: 0; }

        .news-sent-row { display: flex; align-items: center; gap: 7px; margin-bottom: 4px; }
        .news-sent-name { font-size: 11px; color: #64748B; width: 90px; flex-shrink: 0; font-weight: 600; }
        .news-sent-track { flex: 1; height: 4px; border-radius: 3px; background: rgba(255,255,255,0.06); overflow: hidden; }
        .news-sent-fill { height: 100%; border-radius: 3px; transition: width 1s ease; }
        .news-sent-fill.bull { background: linear-gradient(90deg,#10B981,#34D399); }
        .news-sent-fill.bear { background: linear-gradient(90deg,#EF4444,#F87171); }
        .news-sent-fill.neutral { background: linear-gradient(90deg,#FBBF24,#FCD34D); }
        .news-sent-pct { font-size: 11px; font-weight: 700; width: 28px; text-align: right; color: #CBD5E1; }

        /* Popular / ads card */
        .news-promo-card {
            background: rgba(15,23,42,0.9);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 6px; padding: 10px 12px;
            flex-shrink: 0;
        }
        .news-promo-label { font-size: 11px; color: #475569; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700; }
        .news-promo-item {
            display: flex; flex-direction: column; gap: 4px;
            padding: 8px 10px; border-radius: 6px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 5px;
        }
        .news-promo-item:last-child { margin-bottom: 0; }
        .news-promo-name { font-size: 13px; font-weight: 800; color: #fff; }
        .news-promo-desc { font-size: 10px; color: #64748B; line-height: 1.3; }
        .news-promo-cta {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 4px;
            background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.25);
            color: #818CF8; font-size: 10px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; align-self: flex-start; text-decoration: none;
        }
        .news-promo-cta:hover { background: rgba(99,102,241,0.25); color: #fff; }

        /* Bybit — фирменный жёлто-чёрный */
        .news-promo-item.bybit {
            background: linear-gradient(135deg, rgba(247,197,19,0.08) 0%, rgba(0,0,0,0.2) 100%);
            border: 1px solid rgba(247,197,19,0.2);
        }
        .news-promo-item.bybit .news-promo-name { color: #F7C513; }
        .news-promo-item.bybit .news-promo-desc { color: #94A3B8; }
        .news-promo-item.bybit .news-promo-cta {
            background: rgba(247,197,19,0.12);
            border: 1px solid rgba(247,197,19,0.3);
            color: #F7C513;
        }
        .news-promo-item.bybit .news-promo-cta:hover {
            background: rgba(247,197,19,0.22);
            color: #fff;
        }

        /* Binance — фирменный золотой */
        .news-promo-item.binance {
            background: linear-gradient(135deg, rgba(243,186,47,0.08) 0%, rgba(0,0,0,0.2) 100%);
            border: 1px solid rgba(243,186,47,0.2);
        }
        .news-promo-item.binance .news-promo-name { color: #F3BA2F; }
        .news-promo-item.binance .news-promo-desc { color: #94A3B8; }
        .news-promo-item.binance .news-promo-cta {
            background: rgba(243,186,47,0.12);
            border: 1px solid rgba(243,186,47,0.3);
            color: #F3BA2F;
        }
        .news-promo-item.binance .news-promo-cta:hover {
            background: rgba(243,186,47,0.22);
            color: #fff;
        }

        /* Sources */
        .news-sources-wrap { display: flex; gap: 5px; flex-wrap: wrap; }
        .news-source-pill {
            display: flex; align-items: center; gap: 5px;
            font-size: 11px; padding: 4px 10px; border-radius: 6px;
            background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07);
            color: #94A3B8; cursor: pointer; transition: all 0.2s;
        }
        .news-source-pill:hover { background: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.2); color: #818CF8; }
        .news-source-pill .src-dot { width: 6px; height: 6px; border-radius: 50%; background: #6366F1; flex-shrink: 0; }

        /* mention rows */
        .news-mention-row { display: flex; align-items: center; gap: 7px; margin-bottom: 3px; }
        .news-mention-coin { font-size: 12px; font-weight: 600; color: #fff; width: 40px; flex-shrink: 0; }
        .news-mention-track { flex: 1; height: 4px; border-radius: 3px; background: rgba(255,255,255,0.06); overflow: hidden; }
        .news-mention-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg,#6366F1,#8B5CF6); transition: width 1s ease; }
        .news-mention-count { font-size: 11px; color: #475569; width: 46px; text-align: right; }

        /* ── Donate card ── */
        .donate-card { padding: 0 !important; overflow: hidden; }
        .donate-header {
            background: rgba(99,102,241,0.07);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            padding: 9px 12px 8px;
            text-align: center;
        }
        .donate-header-text { display: flex; flex-direction: column; gap: 1px; }
        .donate-header-line1 { font-size: 11px; font-weight: 500; color: #CBD5E1; }
        .donate-header-line2 { font-size: 12px; font-weight: 700; color: #fff; }
        .donate-subtitle { font-size: 10px; color: #475569; padding: 6px 10px 4px; }
        .donate-rows { display: flex; flex-direction: column; gap: 4px; padding: 0 8px 8px; }
        .donate-row {
            display: flex;
            align-items: center;
            gap: 7px;
            padding: 5px 7px;
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.05);
            transition: background 0.2s, border-color 0.2s;
        }
        .donate-coin-icon {
            width: 26px; height: 26px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        .donate-coin-icon svg { width: 26px; height: 26px; display: block; }
        .donate-coin-meta {
            display: flex;
            flex-direction: column;
            gap: 0px;
            flex-shrink: 0;
            min-width: 36px;
        }
        .donate-coin-name { font-size: 10px; font-weight: 700; color: #CBD5E1; line-height: 1.2; }
        .donate-coin-net  { font-size: 8.5px; color: #475569; line-height: 1.2; }
        .donate-addr-wrap {
            flex: 1;
            min-width: 0;
            font-family: 'Courier New', monospace;
            font-size: 9.5px;
            white-space: nowrap;
            overflow: hidden;
            -webkit-mask-image: linear-gradient(to right, black 60%, transparent 100%);
            mask-image: linear-gradient(to right, black 60%, transparent 100%);
        }
        .donate-addr-bold { font-weight: 700; color: #E2E8F0; }
        .donate-addr-dim  { color: #64748B; }
        .donate-copy-btn {
            flex-shrink: 0;
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.09);
            background: rgba(255,255,255,0.05);
            color: #94A3B8;
            font-size: 9.5px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: inherit;
        }
        .donate-copy-btn:hover { background: rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.3); color: #818CF8; }
        .donate-copy-btn.copied { background: rgba(16,185,129,0.12); border-color: rgba(16,185,129,0.3); color: #10B981; }
        .donate-row.copied-row { background: rgba(16,185,129,0.05); border-color: rgba(16,185,129,0.15); }

        .news-quick-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .news-quick-stat { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 6px; padding: 6px 8px; }
        .news-quick-label { font-size: 10px; color: #475569; margin-bottom: 2px; }
        .news-quick-val { font-size: 18px; font-weight: 800; line-height: 1; }
        .news-quick-sub { font-size: 10px; color: #475569; margin-top: 1px; }

        /* Skeleton */
        .news-skeleton {
            background: linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes shimmer { to { background-position: -200% 0; } }
        .news-skeleton-card {
            background: rgba(17,25,40,0.95); border: 1px solid rgba(255,255,255,0.07);
            border-radius: 8px; padding: 14px 16px 14px 19px; flex-shrink: 0;
        }

        /* Modal */
        .news-modal-overlay {
            position: fixed; inset: 0; z-index: 2000;
            background: rgba(5,10,20,0.82);
            backdrop-filter: blur(6px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .news-modal-overlay.open { opacity: 1; pointer-events: all; }
        .news-modal {
            width: min(1080px, calc(100vw - 40px));
            height: min(820px, calc(100vh - 40px));
            background: linear-gradient(135deg,#111928,#0F1728);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            display: flex; overflow: hidden;
            transform: scale(0.96) translateY(10px);
            transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
            position: relative;
        }
        .news-modal-overlay.open .news-modal { transform: scale(1) translateY(0); }
        .news-modal::before {
            content: ''; position: absolute;
            left: 0; top: 0; bottom: 0; width: 4px;
            background: linear-gradient(180deg,#6366F1,#8B5CF6);
        }
        .news-modal-left {
            flex: 1; padding: 26px 30px 26px 34px;
            overflow-y: auto; border-right: 1px solid rgba(255,255,255,0.05);
            display: flex; flex-direction: column; gap: 14px;
        }
        .news-modal-right {
            width: 320px; flex-shrink: 0; padding: 26px 22px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 14px;
        }
        .news-modal-close {
            position: absolute; top: 16px; right: 16px;
            width: 30px; height: 30px; border-radius: 50%;
            background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);
            color: #475569; font-size: 13px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; transition: all 0.2s;
        }
        .news-modal-close:hover { background: rgba(239,68,68,0.15); color: #EF4444; }
        .news-modal-source-row { display: flex; align-items: center; gap: 8px; }
        .news-modal-source { font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 6px; background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3); color: #818CF8; }
        .news-modal-time { font-size: 11px; color: #475569; }
        .news-modal-title { font-size: 24px; font-weight: 800; color: #fff; line-height: 1.35; }
        .news-modal-divider { height: 1px; background: rgba(255,255,255,0.06); }
        .news-modal-lead { font-size: 15px; font-weight: 600; color: #CBD5E1; line-height: 1.7; }
        .news-modal-body { font-size: 14px; color: #94A3B8; line-height: 1.8; }
        .news-modal-quote { border-left: 3px solid #6366F1; padding-left: 14px; }
        .news-modal-quote p { font-size: 12px; font-style: italic; color: #CBD5E1; line-height: 1.7; }
        .news-modal-section-title { font-size: 10px; font-weight: 700; color: #475569; letter-spacing: 0.1em; text-transform: uppercase; }
        .news-modal-related {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 6px; padding: 11px 13px; position: relative; overflow: hidden;
            cursor: pointer; transition: border-color 0.2s;
        }
        .news-modal-related::before { content:''; position:absolute; left:0;top:0;bottom:0;width:3px; }
        .news-modal-related.bull::before { background:#10B981; }
        .news-modal-related.bear::before { background:#EF4444; }
        .news-modal-related.neutral::before { background:#FBBF24; }
        .news-modal-related:hover { border-color: rgba(99,102,241,0.3); }
        .news-modal-related-title { font-size: 13px; font-weight: 600; color: #fff; line-height: 1.4; margin-bottom: 3px; }
        .news-modal-related-meta { font-size: 12px; color: #475569; }
        .news-modal-action {
            padding: 8px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.2s; text-decoration: none;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .news-modal-action.primary { background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3); color: #818CF8; }
        .news-modal-action.primary:hover { background: rgba(99,102,241,0.25); }
        .news-modal-action.secondary { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); color: #475569; }


        /* ════════════════════════════════════════════════════
           МОБИЛЬНАЯ АДАПТАЦИЯ — max-width: 768px
           ════════════════════════════════════════════════════ */
        @media (max-width: 768px) {

            /* ── Базовое ── */
            body {
                overflow: hidden !important;
                height: 100vh !important;
                padding: 0 !important;
            }

            /* ── Слайдер ── */
            .slider-wrapper { height: 100vh; }
            .slider-page {
                overflow-y: auto;
                overflow-x: hidden;
                padding: 12px 12px 56px !important;
                align-items: flex-start;
                -webkit-overflow-scrolling: touch;
            }

            /* ── Точки навигации ── */
            .slider-dot { width: 10px; height: 10px; }
            .slider-dot.active { width: 28px; }
            .slider-dots { bottom: 14px; }

            /* ════ СТРАНИЦА 1: КАЛЬКУЛЯТОР ════ */
            /* Как страница 2 — slider-page скроллится целиком */
            html, body { overflow-x: hidden !important; max-width: 100vw; }

            #slider-page-1 {
                padding: 12px 12px 56px !important;
                overflow-x: hidden !important;
                align-items: flex-start !important;
            }

            /* container — как page2-container: просто flex колонка, высота auto */
            .container {
                max-width: 100% !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                padding: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }

            .header { margin-bottom: 8px; padding-top: 0; }
            .logo { width: 34px; height: 34px; font-size: 15px; }
            .title h1 { font-size: 17px; }
            .title p { display: none; }

            /* content — убираем Grid полностью, делаем flex column как page2-grid */
            .content {
                display: flex !important;
                flex-direction: column !important;
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                min-height: 0 !important;
                overflow: visible !important;
                gap: 8px !important;
                grid-template-columns: unset !important;
                grid-template-rows: unset !important;
            }

            /* Все три колонки — полная ширина, высота auto, без overflow обрезания */
            .left-column,
            .calc-section,
            .results-section {
                width: 100% !important;
                height: auto !important;
                max-height: none !important;
                min-height: 0 !important;
                overflow: visible !important;
                flex: none !important;
            }

            /* Левая колонка */
            .left-column { gap: 8px; }
            .chart-column { padding: 12px; border-radius: 8px; overflow: visible !important; height: auto !important; }
            .chart-container { height: 180px !important; }
            .chart-loading { height: 180px !important; }
            .chart-title h3 { font-size: 13px; }
            .chart-header { flex-wrap: wrap; gap: 6px; }
            #ourChartControls { flex-wrap: wrap; gap: 4px; }
            .period-btn { padding: 4px 6px; font-size: 10px; }
            .chart-coin-bar { flex-wrap: wrap; gap: 6px; }
            .coin-select-trigger { white-space: nowrap; max-width: calc(100vw - 48px); overflow: hidden; text-overflow: ellipsis; }
            .current-price { font-size: 12px; }
            .price-change-badge { font-size: 10px; }
            .coin-dropdown { right: 0 !important; left: auto !important; max-width: calc(100vw - 24px); }

            /* RSI и Z-Score — рядом в две колонки */
            .metrics-col { gap: 6px; overflow: visible; height: auto !important; }
            .indicators-row { grid-template-columns: 1fr 1fr !important; gap: 8px; }
            .metric-card { padding: 10px 12px; border-radius: 6px; gap: 6px; height: auto !important; overflow: visible !important; }
            .metric-card-title { font-size: 11px; }
            .metric-big-value { font-size: 20px; min-width: 0 !important; }
            .zscore-value { min-width: 0 !important; }
            .rsi-badge { font-size: 9px; padding: 2px 7px; }
            .metric-hint { font-size: 10px; }
            .zscore-label { font-size: 10px; }
            .zscore-num { font-size: 11px; }

            /* Market Pulse Bar — две строки */
            .market-pulse-bar {
                height: auto !important;
                flex-direction: column !important;
                padding: 10px 12px !important;
                gap: 8px !important;
                align-items: flex-start !important;
            }
            .mp-divider { width: 100% !important; height: 1px !important; margin: 0 !important; }
            .mp-section { flex-wrap: wrap; gap: 5px; }
            .mp-value { font-size: 14px; }

            /* Мини-тикер — горизонтальный скролл */
            .mini-ticker-strip {
                overflow-x: auto !important;
                border-radius: 6px !important;
                -webkit-overflow-scrolling: touch;
            }
            .mini-ticker-item { flex: 0 0 auto; min-width: 90px; }

            /* Калькулятор */
            .calc-section {
                padding: 12px !important;
                border-radius: 8px !important;
                gap: 8px !important;
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
            }
            .tab-btn { font-size: 10px; padding: 6px 8px; }
            .section-header h2 { font-size: 14px; }
            .btn-add-buy { font-size: 10px; padding: 5px 10px; }
            .buys-section { overflow: visible !important; min-height: auto; padding: 12px; border-radius: 8px; }
            .buys-grid { overflow-y: visible !important; max-height: none !important; flex: none; }
            .buys-rows-scroll { overflow-y: visible !important; flex: none !important; max-height: none !important; }
            .buy-card { padding: 10px; border-radius: 6px; }
            .card-label { font-size: 12px; }
            .input-wrapper input { padding: 9px 11px; font-size: 13px; }
            .coins-hint { font-size: 9px; }
            .sell-inputs-row { flex-direction: column; gap: 8px; }
            .input-large input { padding: 12px 14px; font-size: 14px; }
            .input-large label { font-size: 14px; }
            #calcContent { overflow: visible !important; max-height: none !important; }

            /* Результаты */
            .results-section {
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
            }
            .results-scroll { overflow: visible !important; flex: none !important; height: auto !important; max-height: none !important; }
            .results-top { height: auto !important; }
            .main-result { padding: 14px 16px; border-radius: 8px; }
            .result-label { font-size: 11px; margin-bottom: 6px; }
            .result-amount { font-size: 28px; margin-bottom: 10px; }
            .result-stats { gap: 10px; padding-top: 10px; flex-wrap: wrap; }
            .stat-label { font-size: 9px; }
            .stat-value { font-size: 16px; }
            .average-info { padding: 10px 12px; border-radius: 6px; gap: 8px; }
            .avg-label { font-size: 10px; }
            .avg-value { font-size: 12px; }
            .progress-to-goal { padding: 12px; border-radius: 6px; margin-bottom: 8px; }
            .progress-title { font-size: 12px; }
            .progress-percent { font-size: 12px; }
            .tpsl-card { padding: 10px 12px; border-radius: 6px; gap: 8px; }
            .tpsl-title { font-size: 10px; }
            .tpsl-price { font-size: 11px; }

            /* ════ СТРАНИЦА 2: ИНДИКАТОРЫ ════ */
            /* Контейнер — скроллится вертикально */
            .page2-container {
                height: auto !important;
                overflow: visible !important;
                gap: 8px;
            }
            .page2-grid {
                column-count: 1 !important;
                overflow: visible !important;
                height: auto !important;
            }
            .page2-header {
                flex-wrap: wrap;
                gap: 8px;
                align-items: flex-start;
            }
            /* Дропдаун монеты — открывается влево чтобы не выходить за экран */
            #coinSelectWrapper2 {
                margin-right: 0 !important;
            }
            #coinDropdown2 {
                right: 0 !important;
                left: auto !important;
                width: 200px !important;
            }
            /* Сводка индикаторов — переносим под заголовок */
            #indSummary {
                width: 100%;
                flex-wrap: wrap;
            }
            .ind-card { padding: 8px 12px 8px 15px; border-radius: 8px; }
            .ind-card-title { font-size: 10px; }
            .ind-big-value { font-size: 18px; }
            .ind-sub-value { font-size: 10px; }
            .ind-badge { font-size: 10px; padding: 2px 7px; }
            .ind-row-label { font-size: 10px; }
            .ind-row-value { font-size: 11px; }
            .ind-hint { font-size: 9px; }

            /* ════ СТРАНИЦА 3: НОВОСТИ ════ */
            .page3-container { gap: 8px; height: auto !important; max-height: none !important; }
            .news-grid { flex: none !important; }
            .page3-header { gap: 8px; flex-wrap: wrap; }
            .page3-title { font-size: 16px; }
            .page3-subtitle { display: none; }

            /* Фильтры — горизонтальный скролл */
            .news-filters {
                gap: 4px;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 2px;
                -webkit-overflow-scrolling: touch;
            }
            .news-filter-btn { flex-shrink: 0; padding: 4px 10px; font-size: 10px; }

            /* Три колонки → одна вертикально */
            .news-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px;
                height: auto !important;
                overflow: visible !important;
            }
            /* Порядок: главные → лента → статистика */
            .news-col:nth-child(1) { order: 1; }
            .news-col:nth-child(2) { order: 2; }
            .news-col:nth-child(3) { order: 3; }

            .news-col { overflow: visible !important; height: auto !important; width: 100% !important; }
            .news-col-scroll {
                overflow-y: visible !important;
                max-height: none !important;
                flex: none !important;
                height: auto !important;
            }
            .news-feed-wrap {
                overflow-y: visible !important;
                flex: none !important;
                height: auto !important;
            }

            .news-card { padding: 11px 13px 11px 16px; border-radius: 8px; }
            .news-card-title-big { font-size: 15px; }
            .news-card-title { font-size: 13px; }
            .news-source { font-size: 11px; }
            .news-time { font-size: 11px; }
            .news-card-desc { font-size: 12px; }

            /* Статистика — 2 колонки по 2 ряда */
            .news-col:last-child .news-col-scroll {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .news-trends-row {
                grid-template-columns: 1fr !important;
            }
            .news-trends-smalls {
                flex-direction: column !important;
                gap: 6px !important;
            }
            .news-trends-smalls .news-trend-grid-card {
                flex: 1 !important;
                min-width: 0 !important;
                overflow: hidden !important;
            }
            .news-stat-label { font-size: 10px; margin-bottom: 7px; }
            .news-quick-val { font-size: 20px; }
            .news-mention-coin { font-size: 11px; width: 50px; }

            /* Пагинация */
            .news-pagination { padding: 8px 0 !important; }

            /* Модал — полный экран */
            .news-modal-overlay {
                align-items: flex-start !important;
                padding: 0 !important;
            }
            .news-modal {
                width: 100vw !important;
                height: 100vh !important;
                max-height: 100vh !important;
                border-radius: 0 !important;
                flex-direction: column !important;
                overflow-y: auto !important;
            }
            .news-modal-close {
                position: fixed !important;
                top: 12px !important;
                right: 12px !important;
                z-index: 10001 !important;
                width: 36px !important;
                height: 36px !important;
                font-size: 16px !important;
            }
            .news-modal-left {
                padding: 48px 12px 12px !important;
                border-right: none !important;
                border-bottom: 1px solid rgba(255,255,255,0.06);
                flex: none !important;
                overflow: visible !important;
            }
            .news-modal-right {
                width: 100% !important;
                padding: 12px !important;
                max-height: none !important;
                overflow: visible !important;
                flex: none !important;
            }
            .news-modal-title { font-size: 20px !important; }
            .news-modal-lead { font-size: 13px !important; }
        }

        /* ════ Совсем маленькие экраны ════ */
        @media (max-width: 390px) {
            .title h1 { font-size: 16px; }
            .result-amount { font-size: 24px; }
            .news-col:last-child .news-col-scroll {
                grid-template-columns: 1fr;
            }
        }


        /* ════════════════════════════════════════════════════
           БЕГУЩАЯ СТРОКА ЦЕН (TICKER)
           ════════════════════════════════════════════════════ */
        .price-ticker {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 36px;
            background: rgba(11,17,32,0.96);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(12px);
            z-index: 500;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        /* Градиентные маски по краям */
        .price-ticker::before,
        .price-ticker::after {
            content: '';
            position: absolute;
            top: 0; bottom: 0;
            width: 60px;
            z-index: 2;
            pointer-events: none;
        }
        .price-ticker::before {
            left: 0;
            background: linear-gradient(90deg, rgba(11,17,32,1) 0%, transparent 100%);
        }
        .price-ticker::after {
            right: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(11,17,32,1) 100%);
        }



        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0 12px;
            border-right: 1px solid rgba(255,255,255,0.05);
            cursor: default;
            flex-shrink: 0;
        }

        .ticker-symbol {
            font-size: 11px;
            font-weight: 700;
            color: #CBD5E1;
            letter-spacing: 0.03em;
        }

        .ticker-price {
            font-size: 11px;
            font-weight: 600;
            color: #fff;
        }

        .ticker-change {
            font-size: 10px;
            font-weight: 700;
            padding: 1px 5px;
            border-radius: 5px;
        }
        .ticker-change.up   { color: #10B981; background: rgba(16,185,129,0.12); }
        .ticker-change.down { color: #EF4444; background: rgba(239,68,68,0.12); }

        .ticker-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            object-fit: cover;
        }


        /* Тикер — оверлей поверх страницы, ничего не сдвигает.
           Только страница новостей получает padding-top чтобы тикер не перекрывал контент */
        body.has-ticker #slider-page-3 { padding-top: 48px !important; }

        /* На мобилке тикер меньше */
        @media (max-width: 768px) {
            .price-ticker { height: 30px; }
            .ticker-item { padding: 0 12px; }
            .ticker-symbol { font-size: 10px; }
            .ticker-price { font-size: 10px; }
            .ticker-change { font-size: 9px; }
            .ticker-icon { width: 13px; height: 13px; }

        }

        /* ════════════════════════════════════════════════════
           БЕГУЩАЯ СТРОКА ЦЕН (встроена в стр.3)
           ════════════════════════════════════════════════════ */
        .page3-ticker {
            width: 100%;
            height: 36px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            cursor: default;
        }

        /* Маски по краям */
        .page3-ticker::before,
        .page3-ticker::after {
            content: '';
            position: absolute;
            top: 0; bottom: 0;
            width: 56px;
            z-index: 2;
            pointer-events: none;
        }
        .page3-ticker::before {
            left: 0;
            background: linear-gradient(to right, #0d1424 0%, transparent 100%);
        }
        .page3-ticker::after {
            right: 0;
            background: linear-gradient(to left, #0d1424 0%, transparent 100%);
        }

        .page3-ticker:hover #tickerTrack {
            animation-play-state: paused;
        }

        @keyframes tickerRun {
            from { transform: translateX(0); }
            to   { transform: translateX(-50%); }
        }

        .ticker-item {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 0 12px;
            border-right: 1px solid rgba(255,255,255,0.05);
            height: 36px;
            flex-shrink: 0;
        }

        .ticker-icon {
            width: 15px; height: 15px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .ticker-symbol {
            font-size: 11px; font-weight: 700;
            color: #CBD5E1; letter-spacing: 0.03em;
        }
        .ticker-price {
            font-size: 11px; font-weight: 600; color: #fff;
        }
        .ticker-change {
            font-size: 10px; font-weight: 700;
            padding: 1px 5px; border-radius: 5px;
        }
        .ticker-change.up   { color: #10B981; background: rgba(16,185,129,0.13); }
        .ticker-change.down { color: #EF4444; background: rgba(239,68,68,0.13); }
        .ind-sum-pill { display:inline-flex;align-items:center;gap:3px;padding:2px 9px;border-radius: 8px;font-size:11px;font-weight:700;white-space:nowrap; }
        .ind-sum-pill.bull { background:rgba(16,185,129,0.12);color:#10B981;border:1px solid rgba(16,185,129,0.2); }
        .ind-sum-pill.bear { background:rgba(239,68,68,0.12);color:#EF4444;border:1px solid rgba(239,68,68,0.2); }
        .ind-sum-pill.neut { background:rgba(251,191,36,0.12);color:#FBBF24;border:1px solid rgba(251,191,36,0.2); }

        /* ══════════════════════════════════════════════
           ХАБ КАЛЬКУЛЯТОРОВ
           ══════════════════════════════════════════════ */
        .calc-hub {
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
            padding-right: 4px;
        }
        .calc-hub::-webkit-scrollbar { width: 3px; }
        .calc-hub::-webkit-scrollbar-track { background: transparent; }
        .calc-hub::-webkit-scrollbar-thumb { background: rgba(79,70,229,0.35); border-radius: 6px; }

        @keyframes hubFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .calc-hub-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            animation: hubFadeIn 0.3s ease;
        }

        /* ── Карточка ── */
        .calc-hub-card {
            background: rgba(11, 16, 28, 0.85);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 14px 14px 12px;
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            overflow: hidden;
        }
        /* цветная полоска сверху во всю ширину */
        .calc-hub-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: var(--card-accent, linear-gradient(90deg,#6366F1,#8B5CF6));
            border-radius: 8px 8px 0 0;
        }
        .calc-hub-card:hover {
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0,0,0,0.4);
        }

        .calc-hub-card-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        /* Иконка — скруглённый квадрат с градиентом */
        .calc-hub-icon {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--icon-bg);
            flex-shrink: 0;
        }
        .calc-hub-icon svg {
            width: 22px;
            height: 22px;
            stroke-width: 1.7;
        }

        .calc-hub-arrow {
            color: #2D3B52;
            font-size: 16px;
            line-height: 1;
            margin-top: 1px;
            transition: color 0.18s, transform 0.18s;
        }
        .calc-hub-card:hover .calc-hub-arrow {
            color: #64748B;
            transform: translate(2px, -2px);
        }

        .calc-hub-name {
            font-size: 13px;
            font-weight: 700;
            color: #E2E8F0;
            margin-bottom: 4px;
            line-height: 1.25;
            letter-spacing: -0.01em;
        }
        .calc-hub-desc {
            font-size: 11px;
            color: #3D5068;
            line-height: 1.5;
        }

        /* ── Шапка открытого калькулятора (кнопка назад + название) ── */
        .calc-header-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .calc-nav-back {
            flex-shrink: 0;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(0,0,0,0.25);
            color: #64748B;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.18s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .calc-nav-back:hover {
            color: #A5B4FC;
            border-color: rgba(99,102,241,0.45);
            background: rgba(99,102,241,0.1);
        }
        .calc-header-title {
            font-size: 16px;
            font-weight: 700;
            color: #E2E8F0;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calc-nav-reset {
            flex-shrink: 0;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: rgba(239,68,68,0.08);
            border: 1px solid rgba(239,68,68,0.15);
            color: #EF4444;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.18s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calc-nav-reset:hover {
            background: rgba(239,68,68,0.18);
            border-color: rgba(239,68,68,0.35);
        }

        /* Кнопка стратегии TP в калькуляторе риска */
        .risk-tp-strategy-btn {
            display: flex; align-items: center; justify-content: center; gap: 7px;
            width: 100%; margin-top: 12px;
            background: rgba(99,102,241,0.08);
            border: 1px solid rgba(99,102,241,0.2);
            border-radius: 6px;
            padding: 9px 10px;
            color: #818CF8; font-size: 12px; font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }
        .risk-tp-strategy-btn:hover { background: rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.35); }
        .risk-tp-strategy-btn.active {
            background: rgba(99,102,241,0.2);
            border-color: rgba(99,102,241,0.5);
            color: #A5B4FC;
        }
        .risk-tp-icon { font-size: 14px; }

        /* Заглушка */
        .calc-stub {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex: 1;
            min-height: 160px;
            width: 100%;
        }
        .calc-stub-icon {
            width: 48px; height: 48px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            font-size: 22px;
            opacity: 0.5;
        }
        .calc-stub-title {
            font-size: 14px;
            font-weight: 700;
            color: #475569;
        }
        .calc-stub-desc {
            font-size: 11px;
            color: #2D3B52;
            text-align: center;
            max-width: 180px;
            line-height: 1.6;
        }

        /* ── Иконка ? с тултипом ── */
        .ind-help {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(99,102,241,0.15);
            border: 1px solid rgba(99,102,241,0.25);
            color: #818CF8;
            font-size: 10px;
            font-weight: 800;
            cursor: help;
            flex-shrink: 0;
            transition: background 0.2s, border-color 0.2s;
            font-style: normal;
            line-height: 1;
        }
        .ind-help:hover {
            background: rgba(99,102,241,0.3);
            border-color: rgba(99,102,241,0.5);
        }

        /* Глобальный тултип — крепится к body, не обрезается */
        #indTooltip {
            position: fixed;
            z-index: 99999;
            width: 240px;
            background: #1E293B;
            border: 1px solid rgba(99,102,241,0.35);
            border-radius: 6px;
            padding: 11px 10px;
            font-size: 11px;
            font-weight: 400;
            color: #CBD5E1;
            line-height: 1.6;
            pointer-events: none;
            box-shadow: 0 16px 40px rgba(0,0,0,0.55);
            opacity: 0;
            transition: opacity 0.15s;
            white-space: normal;
        }
        #indTooltip.visible { opacity: 1; }


        /* ── Пагинация ленты новостей ── */
        .news-feed-wrap {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow-y: auto;
            gap: 0;
            padding-right: 2px;
            scrollbar-width: thin;
            scrollbar-color: #4F46E5 transparent;
        }
        .news-feed-wrap::-webkit-scrollbar { width: 4px; }
        .news-feed-wrap::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); border-radius: 6px; }
        .news-feed-wrap::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #4F46E5, #7C3AED); border-radius: 6px; }
        .news-feed-wrap::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #6366F1, #8B5CF6); }

        .news-pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 8px 0 6px;
            flex-shrink: 0;
        }
        .news-pg-btn {
            min-width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.08);
            background: rgba(255,255,255,0.03);
            color: #64748B;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 6px;
            transition: all 0.15s;
        }
        .news-pg-btn:hover { background: rgba(99,102,241,0.15); color: #818CF8; border-color: rgba(99,102,241,0.3); }
        .news-pg-btn.active { background: rgba(99,102,241,0.25); color: #A5B4FC; border-color: rgba(99,102,241,0.5); font-weight: 800; }
        .news-pg-btn:disabled { opacity: 0.3; cursor: default; }
        .news-pg-btn:disabled:hover { background: rgba(255,255,255,0.03); color: #64748B; border-color: rgba(255,255,255,0.08); }

    </style>
</head>
<body>
    <!-- Глобальный тултип для индикаторов -->
    <div id="indTooltip"></div>

    <!-- Стрелки навигации -->
    <button class="slider-arrow slider-arrow-left hidden" id="arrowLeft" aria-label="Назад">&#8592;</button>
    <button class="slider-arrow slider-arrow-right" id="arrowRight" aria-label="Вперёд">&#8594;</button>

    <!-- Точки навигации -->
    <div class="slider-dots">
        <div class="slider-dot active" data-page="0"></div>
        <div class="slider-dot" data-page="1"></div>
        <div class="slider-dot" data-page="2"></div>
    </div>

    <!-- Слайдер -->
    <div class="slider-wrapper slide-1" id="sliderWrapper">
    <!-- Страница 1 -->
    <div class="slider-page" id="slider-page-1">
    <div class="container">
        <div class="header">
            <div class="header-left">
                
                <div class="title">
                    <h1>Thinking Trader</h1>
                </div>
            </div>
            <!-- Языковой переключатель -->
            <div class="lang-selector" id="langSelector">
                <div class="lang-trigger" id="langTrigger">
                    <span class="lang-flag" id="langFlag">🇷🇺</span>
                    <span id="langCode">RU</span>
                    <span class="lang-arrow">▼</span>
                </div>
                <div class="lang-dropdown" id="langDropdown">
                    <div class="lang-option active" data-lang="en">
                        <span class="lang-flag">🇬🇧</span> EN
                    </div>
                    <div class="lang-option" data-lang="ru">
                        <span class="lang-flag">🇷🇺</span> RU
                    </div>
                </div>
            </div>
        </div>

        <div class="content">

            <!-- ══ ЛЕВАЯ КОЛОНКА ══ -->
            <div class="left-column">

            <!-- График -->
            <div class="chart-column">
                <div class="chart-header">
                    <div class="chart-title">
                        <h3 data-i18n="chartTitle">График цены</h3>
                        <div class="chart-source-toggle">
                            <button class="chart-source-btn active" id="btnOurChart">Custom</button>
                            <button class="chart-source-btn" id="btnTVChart">TradingView</button>
                        </div>
                    </div>
                    <div id="ourChartControls" style="display:flex;align-items:center;gap:8px;">
                        <div class="chart-period-buttons">
                            <button class="period-btn active" data-period="1">1Д</button>
                            <button class="period-btn" data-period="7">7Д</button>
                            <button class="period-btn" data-period="30">30Д</button>
                            <button class="period-btn" data-period="90">90Д</button>
                        </div>
                        <div class="chart-type-toggle">
                            <button class="chart-type-btn active" id="btnLine" title="Линия">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><polyline points="1,11 5,5 8,8 13,2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>
                            <button class="chart-type-btn" id="btnCandle" title="Свечи">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><rect x="2" y="4" width="3" height="6" rx="0.5" stroke="currentColor" stroke-width="1.5"/><line x1="3.5" y1="1" x2="3.5" y2="4" stroke="currentColor" stroke-width="1.5"/><line x1="3.5" y1="10" x2="3.5" y2="13" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="5" width="3" height="5" rx="0.5" stroke="currentColor" stroke-width="1.5"/><line x1="10.5" y1="2" x2="10.5" y2="5" stroke="currentColor" stroke-width="1.5"/><line x1="10.5" y1="10" x2="10.5" y2="13" stroke="currentColor" stroke-width="1.5"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <!-- Наш график -->
                    <div id="ourChartWrap" style="width:100%;height:100%;position:absolute;top:0;left:0;">
                        <div id="lwPriceChart" style="width:100%;height:100%;"></div>
                        <div class="chart-loading" id="chartLoading" data-i18n="chartLoading">Загрузка графика...</div>
                    </div>
                    <!-- TradingView -->
                    <div id="tvChartWrap" style="width:100%;height:100%;position:absolute;top:0;left:0;display:none;border-radius:16px;overflow:hidden;">
                        <div class="tradingview-widget-container" style="height:100%;">
                            <div class="tradingview-widget-container__widget" style="height:100%;"></div>
                            <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
                            {
                                "autosize": true,
                                "symbol": "BINANCE:BTCUSDT",
                                "interval": "D",
                                "timezone": "Europe/Moscow",
                                "theme": "dark",
                                "style": "1",
                                "locale": "ru",
                                "hide_top_toolbar": false,
                                "hide_legend": false,
                                "save_image": false,
                                "support_host": "https://www.tradingview.com",
                                "backgroundColor": "rgba(17, 25, 40, 1)",
                                "gridLineColor": "rgba(255, 255, 255, 0.04)",
                                "textColor": "#475569"
                            }
                            </script>
                        </div>
                    </div>
                </div>
                <div class="chart-coin-bar">
                    <div class="coin-select-wrapper" id="coinSelectWrapper">
                        <div class="coin-select-trigger" id="coinSelectTrigger">
                            <img id="selectedCoinIcon" src="" alt="">
                            <span id="selectedCoinName">Bitcoin (BTC)</span>
                            <span class="arrow">▼</span>
                        </div>
                        <!-- Desktop dropdown -->
                        <div class="coin-dropdown" id="coinDropdown">
                            <div class="coin-dropdown-search">
                                <span class="coin-dropdown-search-icon">🔍</span>
                                <input type="text" id="coinSearchDesktop" placeholder="Поиск монеты..." autocomplete="off">
                            </div>
                            <div class="coin-dropdown-list" id="coinDropdownList"></div>
                        </div>
                    </div>

                    <!-- Mobile bottom sheet (порталится к body через JS) -->
                    <div class="coin-sheet-overlay" id="coinSheetOverlay">
                        <div class="coin-sheet" id="coinSheet">
                            <div class="coin-sheet-handle"></div>
                            <div class="coin-sheet-header">
                                <span class="coin-sheet-title" data-i18n="coinSelectTitle">Выбор монеты</span>
                                <button class="coin-sheet-close" id="coinSheetClose">✕</button>
                            </div>
                            <div class="coin-sheet-search">
                                <span class="coin-dropdown-search-icon">🔍</span>
                                <input type="text" id="coinSearchMobile" placeholder="Поиск монеты..." autocomplete="off">
                            </div>
                            <div class="coin-sheet-list" id="coinSheetList"></div>
                        </div>
                    </div>
                    <span class="current-price" id="currentPrice">—</span>
                    <span class="price-change-badge" id="priceChangeBadge"></span>
                </div>
            </div>

                <!-- Мини-тикер полоска -->
                <div class="mini-ticker-strip" id="miniTickerStrip">
                    <div class="mini-ticker-item" data-ticker-idx="0">
                        <img class="mini-ticker-icon" src="" width="14" height="14" style="border-radius:50%;object-fit:cover;flex-shrink:0;display:none;">
                        <span class="mini-ticker-sym">BTC</span>
                        <span class="mini-ticker-price">—</span>
                        <span class="mini-ticker-chg">—</span>
                    </div>
                    <div class="mini-ticker-item" data-ticker-idx="1">
                        <img class="mini-ticker-icon" src="" width="14" height="14" style="border-radius:50%;object-fit:cover;flex-shrink:0;display:none;">
                        <span class="mini-ticker-sym">ETH</span>
                        <span class="mini-ticker-price">—</span>
                        <span class="mini-ticker-chg">—</span>
                    </div>
                    <div class="mini-ticker-item" data-ticker-idx="2">
                        <img class="mini-ticker-icon" src="" width="14" height="14" style="border-radius:50%;object-fit:cover;flex-shrink:0;display:none;">
                        <span class="mini-ticker-sym">SOL</span>
                        <span class="mini-ticker-price">—</span>
                        <span class="mini-ticker-chg">—</span>
                    </div>
                    <div class="mini-ticker-item" data-ticker-idx="3">
                        <img class="mini-ticker-icon" src="" width="14" height="14" style="border-radius:50%;object-fit:cover;flex-shrink:0;display:none;">
                        <span class="mini-ticker-sym">BNB</span>
                        <span class="mini-ticker-price">—</span>
                        <span class="mini-ticker-chg">—</span>
                    </div>
                    <div class="mini-ticker-item" data-ticker-idx="4">
                        <img class="mini-ticker-icon" src="" width="14" height="14" style="border-radius:50%;object-fit:cover;flex-shrink:0;display:none;">
                        <span class="mini-ticker-sym">XRP</span>
                        <span class="mini-ticker-price">—</span>
                        <span class="mini-ticker-chg">—</span>
                    </div>
                </div>

                <!-- Funding Rate + Open Interest -->
                <div class="market-pulse-bar" id="marketPulseBar">
                    <div class="mp-section" id="mpFunding">
                        <span class="mp-label">FUNDING</span>
                        <span class="mp-value" id="mpFundingValue">—</span>
                        <span class="mp-badge" id="mpFundingBadge"></span>
                        <span class="mp-sub" id="mpFundingTime"></span>
                    </div>
                    <div class="mp-divider"></div>
                    <div class="mp-section" id="mpOI">
                        <span class="mp-label">OPEN INTEREST</span>
                        <span class="mp-value mp-value-white" id="mpOIValue">—</span>
                        <span class="mp-badge" id="mpOIBadge"></span>
                        <span class="mp-sub" id="mpOISub"></span>
                    </div>
                </div>

                <!-- Индикаторы: RSI + Z-Score рядом -->
                <div class="indicators-row">

                <!-- RSI карточка -->
                <div class="metric-card" id="rsiBlock">
                    <div class="metric-card-header">
                        <div class="metric-card-title">
                            <span class="metric-icon">📊</span>
                            <span>RSI <span class="metric-period">(14)</span></span>
                        </div>
                        <span class="rsi-badge" id="rsiBadge">—</span>
                    </div>
                    <div class="metric-card-body">
                        <span class="metric-big-value" id="rsiValue">—</span>
                        <div class="metric-side">
                            <div class="rsi-track">
                                <div class="rsi-zone rsi-zone-low"></div>
                                <div class="rsi-zone rsi-zone-mid"></div>
                                <div class="rsi-zone rsi-zone-high"></div>
                                <div class="rsi-needle" id="rsiNeedle"></div>
                            </div>
                            <div class="rsi-labels">
                                <span>0</span><span>30</span><span>70</span><span>100</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-hint" id="rsiHint" data-i18n="loading">Загрузка...</div>
                </div>

                <!-- Z-Score карточка -->
                <div class="metric-card" id="zscoreBlock">
                    <div class="metric-card-header">
                        <div class="metric-card-title">
                            <span class="metric-icon">📐</span>
                            <span>Z-Score <span class="metric-period">(MA)</span></span>
                        </div>
                        <span class="rsi-badge" id="zscoreBadge">—</span>
                    </div>
                    <div class="metric-card-body">
                        <span class="metric-big-value" id="zscoreValue">—</span>
                        <div class="metric-side">
                            <div class="zscore-row">
                                <span class="zscore-label">MA</span>
                                <span class="zscore-num" id="zscoreMA">—</span>
                            </div>
                            <div class="zscore-row">
                                <span class="zscore-label" data-i18n="zscoreSigmaLabel">σ (откл.)</span>
                                <span class="zscore-num" id="zscoreSigma">—</span>
                            </div>
                            <div class="zscore-row">
                                <span class="zscore-label" data-i18n="zscoreReturnLabel">Возврат к MA</span>
                                <span class="zscore-num zscore-prob" id="zscoreProb">—</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-hint" id="zscoreHint" data-i18n="loading">Загрузка...</div>
                </div>

                </div><!-- /indicators-row -->

            </div><!-- /left-column -->

            <!-- ══ КОЛОНКА 2: Калькулятор ══ -->
            <div class="calc-section">

                <!-- ХАБ — стартовый экран -->
                <div id="calcHub" class="calc-hub">
                    <div class="calc-hub-grid">

                        <div class="calc-hub-card" data-calc="sell" style="--card-accent:linear-gradient(90deg,#6366F1,#818CF8);--icon-bg:linear-gradient(135deg,rgba(79,70,229,0.35),rgba(99,102,241,0.15))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#818CF8"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="calcTabSell">Спот</div>
                            <div class="calc-hub-desc" data-i18n="hubDescSell">Прибыль, средняя цена, TP/SL</div>
                        </div>

                        <div class="calc-hub-card" data-calc="compound" style="--card-accent:linear-gradient(90deg,#10B981,#34D399);--icon-bg:linear-gradient(135deg,rgba(16,185,129,0.3),rgba(52,211,153,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#34D399"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/><circle cx="12" cy="12" r="4"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNameCompound">Сложный %</div>
                            <div class="calc-hub-desc" data-i18n="hubDescCompound">Реинвестирование и рост</div>
                        </div>

                        <div class="calc-hub-card" data-calc="margin" style="--card-accent:linear-gradient(90deg,#F59E0B,#FCD34D);--icon-bg:linear-gradient(135deg,rgba(245,158,11,0.3),rgba(252,211,77,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#FCD34D"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="calcTabMargin">Маржа</div>
                            <div class="calc-hub-desc" data-i18n="hubDescMargin">Плечо, ликвидация, лонг/шорт</div>
                        </div>

                        <div class="calc-hub-card" data-calc="risk" style="--card-accent:linear-gradient(90deg,#EF4444,#F87171);--icon-bg:linear-gradient(135deg,rgba(239,68,68,0.3),rgba(248,113,113,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#F87171"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNameRisk">Риск на сделку</div>
                            <div class="calc-hub-desc" data-i18n="hubDescRisk">Размер позиции по % депозита</div>
                        </div>

                        <div class="calc-hub-card" data-calc="dca" style="--card-accent:linear-gradient(90deg,#06B6D4,#67E8F9);--icon-bg:linear-gradient(135deg,rgba(6,182,212,0.3),rgba(103,232,249,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#67E8F9"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-3.51"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="calcTabDca">DCA</div>
                            <div class="calc-hub-desc" data-i18n="hubDescDca">Средняя цена при докупках</div>
                        </div>

                        <div class="calc-hub-card" data-calc="breakeven" style="--card-accent:linear-gradient(90deg,#8B5CF6,#C4B5FD);--icon-bg:linear-gradient(135deg,rgba(139,92,246,0.3),rgba(196,181,253,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#C4B5FD"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNameBreakeven">Безубыток</div>
                            <div class="calc-hub-desc" data-i18n="hubDescBreakeven">Выход в ноль с комиссией</div>
                        </div>

                        <div class="calc-hub-card" data-calc="possize" style="--card-accent:linear-gradient(90deg,#F97316,#FCA67A);--icon-bg:linear-gradient(135deg,rgba(249,115,22,0.3),rgba(252,166,122,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#FCA67A"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNamePossize">Размер позиции</div>
                            <div class="calc-hub-desc" data-i18n="hubDescPossize">Монет по депозиту и плечу</div>
                        </div>

                        <div class="calc-hub-card" data-calc="funding" style="--card-accent:linear-gradient(90deg,#EC4899,#F9A8D4);--icon-bg:linear-gradient(135deg,rgba(236,72,153,0.3),rgba(249,168,212,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#F9A8D4"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNameFunding">Funding</div>
                            <div class="calc-hub-desc" data-i18n="hubDescFunding">Стоимость удержания фьючерса</div>
                        </div>

                        <div class="calc-hub-card" data-calc="converter" style="--card-accent:linear-gradient(90deg,#14B8A6,#5EEAD4);--icon-bg:linear-gradient(135deg,rgba(20,184,166,0.3),rgba(94,234,212,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#5EEAD4"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNameConverter">Конвертер</div>
                            <div class="calc-hub-desc" data-i18n="hubDescConverter">Крипта ↔ фиат по курсу</div>
                        </div>

                        <div class="calc-hub-card" data-calc="pnlgrid" style="--card-accent:linear-gradient(90deg,#84CC16,#BEF264);--icon-bg:linear-gradient(135deg,rgba(132,204,22,0.3),rgba(190,242,100,0.12))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#BEF264"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNamePnlgrid">PnL сетки</div>
                            <div class="calc-hub-desc" data-i18n="hubDescPnlgrid">Прибыль Grid-бота</div>
                        </div>

                        <div class="calc-hub-card" data-calc="savings" style="--card-accent:linear-gradient(90deg,#6366F1,#06B6D4);--icon-bg:linear-gradient(135deg,rgba(99,102,241,0.25),rgba(6,182,212,0.15))">
                            <div class="calc-hub-card-top">
                                <div class="calc-hub-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="#67E8F9"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                                </div>
                                <span class="calc-hub-arrow">↗</span>
                            </div>
                            <div class="calc-hub-name" data-i18n="hubNameSavings">Накопление</div>
                            <div class="calc-hub-desc" data-i18n="hubDescSavings">За сколько месяцев до цели</div>
                        </div>

                    </div>
                </div>

                <!-- КАЛЬКУЛЯТОР — показывается после выбора в хабе -->
                <div id="calcContent" style="display:none; flex-direction:column; gap:16px; flex:1; min-height:0; overflow:hidden;">

                <!-- Шапка: кнопка назад + название + сброс -->
                <div class="calc-header-row">
                    <button class="calc-nav-back" id="calcBackBtn" data-i18n-title="backToMenu" title="Назад к меню">←</button>
                    <span class="calc-header-title" id="calcHeaderTitle" data-i18n="calculator">Калькулятор</span>
                    <button class="calc-nav-reset" id="resetButton" data-i18n-title="reset" title="Сбросить">↻</button>
                </div>

                <!-- ВКЛАДКА: Продажа -->
                <div class="tab-content active" id="tab-sell">

                    <!-- 1. Панель цели: прибыль % и цена продажи -->
                    <div class="sell-goal-panel">
                        <div class="sell-goal-field">
                            <input type="text" id="profitPercent" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label for="profitPercent" data-i18n="labelProfitPct">Процент прибыли (%)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="sell-goal-divider">⇄</div>
                        <div class="sell-goal-field">
                            <input type="text" id="sellPrice" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label for="sellPrice" data-i18n="labelSellPrice">Цена продажи ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                    </div>

                    <!-- 2. Заголовок покупок -->
                    <div class="sell-buys-header">
                        <div class="sell-buys-label">
                            <span data-i18n="labelBuys">Покупки</span> <span class="sell-buys-count" id="entriesCount">1</span>
                        </div>
                        <button class="btn-add-buy" id="addBuyEntry" data-i18n="addEntry">+ Добавить</button>
                    </div>

                    <!-- 3. Строки покупок -->
                    <div class="buys-rows-scroll" id="buyEntries"></div>
                    <button class="risk-tp-strategy-btn" id="sellTpStrategyBtn">
                        <span class="risk-tp-icon">📊</span>
                        <span data-i18n="riskTpStrategyOff">Показать стратегию TP1/TP2/TP3</span>
                    </button>
                </div>

                <!-- ВКЛАДКА: Сложный % -->
                <div class="tab-content" id="tab-compound">
                    <div class="compound-mode-toggle">
                        <button class="compound-mode-btn active" id="compoundModeGrowth" data-i18n="compoundGrowthBtn">📈 Прогноз роста</button>
                        <button class="compound-mode-btn" id="compoundModeGoal" data-i18n="compoundGoalBtn">🎯 Достичь цели</button>
                    </div>
                    <div id="compoundGrowthMode">
                        <div class="sell-header">
                            <h3 data-i18n="compoundGrowthTitle">Прогноз роста</h3>
                            <p data-i18n="compoundGrowthSub">Реинвестирование с учётом рисков</p>
                        </div>
                        <div class="sell-inputs">
                            <div class="input-large">
                                <input type="text" id="compoundInvestment" inputmode="decimal" data-empty="true" placeholder=" ">
                                <label data-i18n="labelInvestment">Сумма инвестиций ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                            </div>
                            <div class="compound-row">
                                <div class="input-large">
                                    <input type="text" id="compoundRate" inputmode="decimal" data-empty="true" placeholder=" ">
                                    <label data-i18n="labelProfitRate">% прибыли</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                                </div>
                                <div class="input-large compound-loss">
                                    <input type="text" id="compoundLoss" inputmode="decimal" data-empty="true" placeholder=" ">
                                    <label data-i18n="labelLossRate">% убытка</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                                </div>
                            </div>
                            <div class="compound-row">
                                <div class="input-large">
                                    <input type="text" id="compoundTrades" inputmode="decimal" data-empty="true" placeholder=" ">
                                    <label data-i18n="labelTradesCount">Кол-во трейдов</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                                </div>
                                <div class="input-large">
                                    <input type="text" id="compoundWinRate" inputmode="decimal" data-empty="true" placeholder=" ">
                                    <label data-i18n="labelWinRate">% выигрышных</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                                </div>
                            </div>
                            <div class="input-large">
                                <input type="text" id="compoundFee" inputmode="decimal" data-empty="true" placeholder=" ">
                                <label data-i18n="labelFee">Комиссия биржи (%)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                            </div>
                        </div>
                    </div>
                    <div id="compoundGoalMode" style="display:none;">
                        <div class="sell-header">
                            <h3 data-i18n="compoundGoalTitle">Достичь цели</h3>
                            <p data-i18n="compoundGoalSub">Сколько трейдов нужно для цели</p>
                        </div>
                        <div class="sell-inputs">
                            <div class="compound-row">
                                <div class="input-large">
                                    <input type="text" id="goalFrom" inputmode="decimal" data-empty="true" placeholder=" ">
                                    <label data-i18n="labelGoalFrom">Начальный ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                                </div>
                                <div class="input-large">
                                    <input type="text" id="goalTo" inputmode="decimal" data-empty="true" placeholder=" ">
                                    <label data-i18n="labelGoalTo">Цель ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                                </div>
                            </div>
                            <div class="input-large">
                                <input type="text" id="goalRate" inputmode="decimal" data-empty="true" placeholder=" ">
                                <label data-i18n="labelGoalRate">Процент за трейд (%)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                            </div>
                        </div>
                        <div class="goal-table" id="goalTable" style="display:none;">
                            <div class="goal-table-title" data-i18n="goalTableTitle">Сколько трейдов при разных %</div>
                            <div class="goal-rows" id="goalRows"></div>
                            <div class="goal-note" data-i18n="goalNote">* идеальный сценарий, без комиссий и убытков</div>
                        </div>
                    </div>
                </div>

                <!-- ВКЛАДКА: Маржа -->
                <div class="tab-content" id="tab-margin">
                    <div class="sell-header">
                        <h3 data-i18n="marginTitle">Маржинальная торговля</h3>
                        <p data-i18n="marginSub">Плечо, вход и выход</p>
                    </div>
                    <div class="direction-toggle">
                        <button class="direction-btn long active" data-direction="long" id="marginLong">📈 Long</button>
                        <button class="direction-btn short" data-direction="short" id="marginShort">📉 Short</button>
                    </div>
                    <div class="sell-inputs">
                        <div class="input-large">
                            <input type="text" id="marginCollateral" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelCollateral">Залог ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="input-large">
                            <input type="text" id="marginLeverage" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelLeverage">Плечо (x)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="input-large">
                            <input type="text" id="marginEntry" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelEntryPrice">Цена входа ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="input-large">
                            <input type="text" id="marginExit" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelExitPrice">Цена выхода ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                    </div>
                    <button class="risk-tp-strategy-btn" id="marginTpStrategyBtn">
                        <span class="risk-tp-icon">📊</span>
                        <span data-i18n="riskTpStrategyOff">Показать стратегию TP1/TP2/TP3</span>
                    </button>
                </div>

                <!-- ЗАГЛУШКИ: новые калькуляторы -->
                <!-- ВКЛАДКА: Риск на сделку -->
                <div class="tab-content" id="tab-risk">
                    <div class="sell-header">
                        <h3 data-i18n="hubNameRisk">Риск на сделку</h3>
                        <p data-i18n="riskSub">Размер позиции по % депозита</p>
                    </div>
                    <div class="direction-toggle">
                        <button class="direction-btn long active" data-direction="long" id="riskLong">📈 Long</button>
                        <button class="direction-btn short" data-direction="short" id="riskShort">📉 Short</button>
                    </div>
                    <div class="sell-inputs">
                        <div class="input-large">
                            <input type="text" id="riskDeposit" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelDeposit">Депозит ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="input-large">
                            <input type="text" id="riskPercent" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelRiskPct">Риск (%)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="input-large">
                            <input type="text" id="riskEntry" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelEntryPrice">Цена входа ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="input-large">
                            <input type="text" id="riskStoploss" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelStoploss">Стоп-лосс ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                        <div class="input-large">
                            <input type="text" id="riskTakeprofit" inputmode="decimal" data-empty="true" placeholder=" ">
                            <label data-i18n="labelTakeprofit">Тейк-профит ($)</label>
                            <button class="input-clear-btn" tabindex="-1">✕</button>
                        </div>
                    </div>
                    <!-- Кнопка переключения стратегии -->
                    <button class="risk-tp-strategy-btn" id="riskTpStrategyBtn">
                        <span class="risk-tp-icon">📊</span>
                        <span data-i18n="riskTpStrategyOff">Показать стратегию TP1/TP2/TP3</span>
                    </button>
                </div>

                <div class="tab-content" id="tab-dca">
                    <div class="calc-stub">
                        <div class="calc-stub-icon">🔄</div>
                        <div class="calc-stub-title" data-i18n="calcTabDca">DCA</div>
                        <div class="calc-stub-desc" data-i18n="stubDescDca">Скоро появится. Средняя цена входа при нескольких докупках.</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-breakeven">
                    <div class="calc-stub">
                        <div class="calc-stub-icon">💲</div>
                        <div class="calc-stub-title" data-i18n="hubNameBreakeven">Безубыток</div>
                        <div class="calc-stub-desc" data-i18n="stubDescBreakeven">Скоро появится. Точка выхода в ноль с учётом комиссии биржи.</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-possize">
                    <div class="calc-stub">
                        <div class="calc-stub-icon">📐</div>
                        <div class="calc-stub-title" data-i18n="hubNamePossize">Размер позиции</div>
                        <div class="calc-stub-desc" data-i18n="stubDescPossize">Скоро появится. Количество монет по депозиту, цене и плечу.</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-funding">
                    <div class="calc-stub">
                        <div class="calc-stub-icon">💸</div>
                        <div class="calc-stub-title" data-i18n="hubNameFunding">Funding</div>
                        <div class="calc-stub-desc" data-i18n="stubDescFunding">Скоро появится. Стоимость удержания фьючерсной позиции.</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-converter">
                    <div class="calc-stub">
                        <div class="calc-stub-icon">🔁</div>
                        <div class="calc-stub-title" data-i18n="hubNameConverter">Конвертер</div>
                        <div class="calc-stub-desc" data-i18n="stubDescConverter">Скоро появится. Крипта ↔ фиат по актуальному курсу.</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-pnlgrid">
                    <div class="calc-stub">
                        <div class="calc-stub-icon">☰</div>
                        <div class="calc-stub-title" data-i18n="hubNamePnlgrid">PnL сетки</div>
                        <div class="calc-stub-desc" data-i18n="stubDescPnlgrid">Скоро появится. Расчёт прибыли Grid-бота по диапазону и шагу.</div>
                    </div>
                </div>

                <div class="tab-content" id="tab-savings">
                    <div class="calc-stub">
                        <div class="calc-stub-icon">🏠</div>
                        <div class="calc-stub-title" data-i18n="hubNameSavings">Накопление</div>
                        <div class="calc-stub-desc" data-i18n="stubDescSavings">Скоро появится. Сколько месяцев нужно для достижения цели.</div>
                    </div>
                </div>

                </div><!-- /calcContent -->

            </div>

            <!-- ══ КОЛОНКА 3: Результаты ══ -->
            <div class="results-section">
                <!-- Верхние блоки — всегда видны -->
                <div class="results-top">
                <div class="main-result" id="mainResult">
                    <!-- Результат: Продажа -->
                    <div class="result-block active" id="resultSell">
                        <div class="result-label" data-i18n="resultLabelSell">Итого на выходе</div>
                        <div class="result-amount" id="totalAmount">$0.00</div>
                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="statProfit">Прибыль</span>
                                <span class="stat-value" id="profitAmount">$0.00</span>
                                <span class="stat-value-rub" id="profitAmountRub"></span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="statYield">Доходность</span>
                                <span class="stat-value" id="profitPercentDisplay">0%</span>
                            </div>
                            <div class="avg-price">
                                <span data-i18n="avgEntryPrice">Средняя цена входа</span>
                                <span id="avgPrice">$0.00</span>
                            </div>
                        </div>
                        <!-- TP стратегия — появляется когда есть TP уровни -->
                        <div class="tp-strategy-row" id="tpStrategyRow" style="display:none;">
                            <div class="tp-strategy-divider"></div>
                            <div class="tp-strategy-body">
                                <div class="tp-strategy-left">
                                    <span class="tp-strategy-label" data-i18n="tpStrategyLabel">По стратегии TP</span>
                                    <span class="tp-strategy-hint">TP1×50% + TP2×30% + TP3×20%</span>
                                </div>
                                <div class="tp-strategy-right">
                                    <span class="tp-strategy-profit" id="tpStrategyProfit">—</span>
                                    <span class="tp-strategy-pct" id="tpStrategyPct">—</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Результат: Сложный % -->
                    <div class="result-block" id="resultCompound">
                        <div id="resultCompoundGrowth">
                            <div class="result-label" data-i18n="resultLabelCompound">Итоговый капитал</div>
                            <div class="result-amount" id="compoundTotalDisplay">$0.00</div>
                            <div class="result-stats">
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statInitial">Начальный</span>
                                    <span class="stat-value" id="compoundInitialDisplay">$0.00</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statProfit">Прибыль</span>
                                    <span class="stat-value positive" id="compoundProfitDisplay">+$0.00</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statYield">Доходность</span>
                                    <span class="stat-value positive" id="compoundROIDisplay">+0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statInRubles">В рублях</span>
                                    <span class="stat-value" id="compoundRubDisplay">₽0</span>
                                </div>
                            </div>
                        </div>
                        <div id="resultCompoundGoal" style="display:none;">
                            <div class="result-label" data-i18n="resultLabelGoal">Чтобы достичь цели</div>
                            <div class="result-amount" id="goalTradesDisplay">—</div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statStart">Старт</span>
                                    <span class="stat-value" id="goalFromDisplay">$0.00</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statGoal">Цель</span>
                                    <span class="stat-value positive" id="goalToDisplay">$0.00</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statGrowth">Рост</span>
                                    <span class="stat-value positive" id="goalGrowthDisplay">+0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statPerTrade">% за трейд</span>
                                    <span class="stat-value" id="goalRateDisplay">0%</span>
                                </div>
                        </div>
                    </div>
                    <!-- Результат: Маржа -->
                    <div class="result-block" id="resultMargin">
                        <div class="result-label" data-i18n="resultLabelLiq">Цена ликвидации</div>
                        <div class="result-amount" id="marginLiqPriceDisplay">$0.00</div>
                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="labelCollateral">Залог</span>
                                <span class="stat-value" id="marginCollateralDisplay">$0.00</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="statPosition">Позиция</span>
                                <span class="stat-value" id="marginPositionDisplay">$0.00</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="statToLiq">До ликвидации</span>
                                <span class="stat-value" id="marginDistanceDisplay">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="statRisk">Риск</span>
                                <span class="stat-value" id="marginRiskDisplay">—</span>
                            </div>
                        </div>
                        <div style="margin-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 12px;">
                            <div class="result-label" data-i18n="resultLabelTrade">Результат сделки</div>
                            <div class="result-stats" style="grid-template-columns: 1fr 1fr;">
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statTotal">Итого</span>
                                    <span class="stat-value" id="marginTotalDisplay">$0.00</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statProfit">Прибыль</span>
                                    <span class="stat-value" id="marginProfitDisplay">$0.00</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statRoiCollateral">Доходность (к залогу)</span>
                                    <span class="stat-value" id="marginRoiDisplay">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statPriceChange">Изменение цены</span>
                                    <span class="stat-value" id="marginPriceChangeDisplay">0%</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label" data-i18n="statInRubles">В рублях</span>
                                    <span class="stat-value" id="marginRubDisplay">₽0</span>
                                </div>
                            </div>
                        </div>
                        <!-- TP стратегия маржи -->
                        <div class="tp-strategy-row" id="marginTpStrategyRow" style="display:none;">
                            <div class="tp-strategy-divider"></div>
                            <div class="tp-strategy-body">
                                <div class="tp-strategy-left">
                                    <span class="tp-strategy-label" data-i18n="tpStrategyLabel">По стратегии TP</span>
                                    <span class="tp-strategy-hint">TP1×50% + TP2×30% + TP3×20%</span>
                                </div>
                                <div class="tp-strategy-right">
                                    <span class="tp-strategy-profit" id="marginTpStrategyProfit">—</span>
                                    <span class="tp-strategy-pct" id="marginTpStrategyPct">—</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Результат: Риск на сделку -->
                    <div class="result-block" id="resultRisk">
                        <div class="result-label" data-i18n="riskResultLabel">Размер позиции</div>
                        <div class="result-amount" id="riskPositionUsd">$0.00</div>
                        <div class="result-stats">
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="riskCoins">Монет</span>
                                <span class="stat-value" id="riskPositionCoins">0</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="riskDepositPct">% депозита</span>
                                <span class="stat-value" id="riskDepositPct">0%</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="riskAmount">Сумма риска</span>
                                <span class="stat-value negative" id="riskAmount">$0.00</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="riskReward">Потенц. прибыль</span>
                                <span class="stat-value positive" id="riskReward">$0.00</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="riskRR">RR</span>
                                <span class="stat-value" id="riskRR">—</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label" data-i18n="riskRiskPct">Риск от депозита</span>
                                <span class="stat-value" id="riskRiskPct">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Средние показатели — сразу под итогом -->
                <div class="average-info">
                    <div class="avg-item">
                        <span class="avg-label" data-i18n="avgPrice">Средняя цена</span>
                        <span class="avg-value" id="avgPositionPrice">$0.00</span>
                    </div>
                    <div class="avg-item">
                        <span class="avg-label" data-i18n="avgCoins">Всего монет</span>
                        <span class="avg-value" id="avgPositionCoins">0</span>
                    </div>
                    <div class="avg-item">
                        <span class="avg-label" data-i18n="avgInvested">Общий инвест</span>
                        <span class="avg-value" id="avgPositionInvested">$0.00</span>
                    </div>
                </div>
                </div><!-- /results-top -->

                <!-- Скроллируемая часть -->
                <div class="results-scroll">

                <!-- Прогресс бар -->
                <div class="progress-to-goal" id="progressToGoal">
                    <div class="progress-header">
                        <span class="progress-title">🎯 <span data-i18n="progressTitle">Прогресс до цели</span> <span id="goalPrice">$0</span></span>
                        <span class="progress-percent" id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" id="progressBarFill"></div>
                    </div>
                    <div class="progress-info" id="progressInfo" data-i18n="progressRemaining">Осталось: $0</div>
                </div>

                <!-- TP / SL / RR блок — появляется когда есть покупки -->
                <div class="tpsl-card" id="tpslCard">
                    <div class="tpsl-header">
                        <span class="tpsl-title" data-i18n="tpslTitle2">📈 Уровни выхода</span>
                        <span class="tpsl-rr" id="tpslRR">RR —</span>
                    </div>

                    <!-- Выбор желаемого RR -->
                    <div class="rr-selector">
                        <span class="rr-selector-label" data-i18n="rrLabel">Желаемый RR</span>
                        <div class="rr-btns">
                            <button class="rr-btn" data-rr="1">1:1</button>
                            <button class="rr-btn active" data-rr="2">1:2</button>
                            <button class="rr-btn" data-rr="3">1:3</button>
                            <button class="rr-btn" data-rr="4">1:4</button>
                        </div>
                    </div>

                    <div class="tpsl-levels">
                        <div class="tpsl-row tp-row">
                            <div class="tpsl-dot" style="background:#10B981"></div>
                            <span class="tpsl-lbl">TP1 <span class="tpsl-sub">50%</span></span>
                            <span class="tpsl-price" id="tp1Price">—</span>
                            <span class="tpsl-pct positive" id="tp1Pct">—</span>
                            <span class="tpsl-profit" id="tp1Profit">—</span>
                        </div>
                        <div class="tpsl-row tp-row">
                            <div class="tpsl-dot" style="background:#34D399"></div>
                            <span class="tpsl-lbl">TP2 <span class="tpsl-sub">30%</span></span>
                            <span class="tpsl-price" id="tp2Price">—</span>
                            <span class="tpsl-pct positive" id="tp2Pct">—</span>
                            <span class="tpsl-profit" id="tp2Profit">—</span>
                        </div>
                        <div class="tpsl-row tp-row">
                            <div class="tpsl-dot" style="background:#6EE7B7"></div>
                            <span class="tpsl-lbl">TP3 <span class="tpsl-sub">20%</span></span>
                            <span class="tpsl-price" id="tp3Price">—</span>
                            <span class="tpsl-pct positive" id="tp3Pct">—</span>
                            <span class="tpsl-profit" id="tp3Profit">—</span>
                        </div>
                        <div class="tpsl-divider"></div>
                        <div class="tpsl-row sl-row">
                            <div class="tpsl-dot" style="background:#EF4444"></div>
                            <span class="tpsl-lbl">Stop Loss</span>
                            <span class="tpsl-price" id="slPrice">—</span>
                            <span class="tpsl-pct negative" id="slPct">—</span>
                            <span class="tpsl-profit negative" id="slProfit">—</span>
                        </div>
                    </div>

                </div>

                <!-- Новость -->
                <div class="news-widget" id="newsWidget" style="opacity:0;">
                    <div class="nw-tags"><span class="nw-tag">📰 Загрузка новости...</span></div>
                </div>

                </div><!-- /results-scroll -->
            </div><!-- /results-section -->
        </div>
    </div>
    </div><!-- /slider-page-1 -->

    <!-- Страница 2: Индикаторы -->
    <div class="slider-page">
    <div class="page2-container">
        <div class="page2-header">
            
            <div>
                <div class="page2-title" data-i18n="page2Title">Технические индикаторы</div>
                <div class="page2-subtitle" data-i18n="page2Sub">Расширенный анализ рынка</div>
            </div>
            <!-- Выбор монеты на стр.2 — синхронизирован со стр.1 -->
            <div class="coin-select-wrapper" id="coinSelectWrapper2" style="margin-left:auto;margin-right:12px;position:relative;">
                <div class="coin-select-trigger" id="coinSelectTrigger2" style="cursor:pointer;">
                    <img id="selectedCoinIcon2" src="" alt="" style="width:20px;height:20px;border-radius:50%;">
                    <span id="selectedCoinName2">Bitcoin (BTC)</span>
                    <span class="arrow" style="margin-left:4px;font-size:10px;transition:transform 0.2s;">▼</span>
                </div>
                <div class="coin-dropdown" id="coinDropdown2" style="position:absolute;top:calc(100% + 6px);right:0;width:240px;">
                    <div class="coin-dropdown-search">
                        <span class="coin-dropdown-search-icon">🔍</span>
                        <input type="text" id="coinSearch2" placeholder="Поиск монеты...">
                    </div>
                    <div class="coin-dropdown-list" id="coinOptions2"></div>
                </div>
            </div>
            <div id="indSummary" style="display:flex;align-items:center;gap:6px;flex-shrink:0;">
                <div id="indSummaryPills" style="display:flex;align-items:center;gap:5px;">
                    <span style="font-size:11px;color:#475569" data-i18n="indLoading">⏳ Загрузка...</span>
                </div>
                <div style="width:1px;height:20px;background:rgba(255,255,255,0.08);margin:0 4px;flex-shrink:0;"></div>
                <span style="font-size:11px;color:#475569;white-space:nowrap;" data-i18n="indTotal">Итог:</span>
                <span id="indSummaryResult" style="font-size:13px;font-weight:800;color:#64748B;white-space:nowrap;">—</span>
            </div>
        </div>
        <div class="page2-grid">

            <!-- ATR -->
            <div class="ind-card" id="atrCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">📏</span>ATR <span class="ind-period">(14)</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="atrBadge">—</span>
                        <i class="ind-help" data-tipkey="tipATR" data-tip="Average True Range — средняя амплитуда движения цены за 14 свечей с учётом гэпов. Показывает волатильность рынка. Чем выше ATR — тем шире стоп-лосс нужно ставить.">?</i>
                    </div>
                </div>

                <!-- Основное значение -->
                <div class="atr-body">
                    <div class="atr-main">
                        <div class="atr-loading" id="atrLoading">
                            <div class="atr-spinner"></div>
                        </div>
                        <div class="atr-values" id="atrValues" style="display:none">
                            <div class="ind-value-row">
                                <span class="ind-big-value" id="atrValueUsd">—</span>
                                <span class="ind-sub-value" id="atrValuePct">—</span>
                            </div>
                            <!-- Мини-график ATR -->
                            <div class="atr-chart-wrap">
                                <canvas id="atrMiniChart" height="48"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Строки деталей -->
                <div class="ind-rows" id="atrRows" style="display:none">
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="atrVsAvgLabel">Волатильность vs норма</span>
                        <span class="ind-row-value" id="atrVsAvg">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="atrMinSlLabel">Мин SL (×1.5 ATR)</span>
                        <span class="ind-row-value" id="atrMinSl">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="atrRangeLabel">Макс / Мин за 14д</span>
                        <span class="ind-row-value" id="atrRange">—</span>
                    </div>
                </div>

                <div class="ind-hint" data-i18n="atrHint">Average True Range — амплитуда движения с учётом гэпов</div>
            </div>

            <!-- EMA 20/50 -->
            <div class="ind-card" id="emaCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">〰️</span>EMA <span class="ind-period">20 / 50</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="emaBadge">—</span>
                        <i class="ind-help" data-tipkey="tipEMA" data-tip="Exponential Moving Average — скользящие средние. Когда EMA20 пересекает EMA50 снизу вверх — сигнал на покупку (Golden Cross). Сверху вниз — сигнал на продажу (Death Cross).">?</i>
                    </div>
                </div>

                <!-- Сигнал -->
                <div class="ema-signal-wrap" id="emaSignalWrap" style="display:none">
                    <div class="ema-signal" id="emaSignal">
                        <span class="ema-signal-icon" id="emaSignalIcon">—</span>
                        <div>
                            <div class="ema-signal-label" id="emaSignalLabel">—</div>
                            <div class="ema-signal-sub" id="emaSignalSub">—</div>
                        </div>
                    </div>
                </div>

                <!-- Спиннер -->
                <div class="atr-loading" id="emaLoading">
                    <div class="atr-spinner"></div>
                </div>

                <!-- Значения EMA + позиция цены -->
                <div class="ind-rows" id="emaRows" style="display:none">
                    <div class="ind-row">
                        <span class="ind-row-label">EMA 20</span>
                        <span class="ind-row-value" id="emaVal20">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label">EMA 50</span>
                        <span class="ind-row-value" id="emaVal50">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="emaPriceVs20">Цена vs EMA 20</span>
                        <span class="ind-row-value" id="emaDist20">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="emaPriceVs50">Цена vs EMA 50</span>
                        <span class="ind-row-value" id="emaDist50">—</span>
                    </div>

                    <!-- Визуальная шкала позиции цены -->
                    <div class="ema-scale-wrap">
                        <div class="ema-scale-labels">
                            <span id="emaScaleLow">EMA 50</span>
                            <span data-i18n="scalePrice">Цена</span>
                            <span id="emaScaleHigh">EMA 20</span>
                        </div>
                        <div class="ema-scale-track">
                            <div class="ema-scale-zone" id="emaScaleZone"></div>
                            <div class="ema-scale-dot" id="emaScaleDot"></div>
                        </div>
                    </div>
                </div>

                <div class="ind-hint" data-i18n="emaHint">Golden Cross / Death Cross — ключевые сигналы разворота тренда</div>
            </div>

            <!-- Stochastic RSI -->
            <div class="ind-card" id="stochCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">🔀</span>Stoch RSI <span class="ind-period">(14,3,3)</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="stochBadge">—</span>
                        <i class="ind-help" data-tipkey="tipStoch" data-tip="Stochastic RSI — показывает перекупленность и перепроданность. Выше 80 — перекуплен, возможен откат. Ниже 20 — перепродан, возможен отскок. %K пересекает %D снизу — покупка.">?</i>
                    </div>
                </div>

                <!-- Спиннер -->
                <div class="atr-loading" id="stochLoading">
                    <div class="atr-spinner"></div>
                </div>

                <!-- Шкала 0–100 с двумя иглами %K и %D -->
                <div class="stoch-scale-wrap" id="stochScaleWrap" style="display:none">
                    <div class="stoch-scale-values">
                        <div class="stoch-kd">
                            <span class="stoch-k-dot"></span>
                            <span class="stoch-kd-label">%K</span>
                            <span class="stoch-kd-val" id="stochKVal">—</span>
                        </div>
                        <div class="stoch-kd">
                            <span class="stoch-d-dot"></span>
                            <span class="stoch-kd-label">%D</span>
                            <span class="stoch-kd-val" id="stochDVal">—</span>
                        </div>
                    </div>

                    <!-- Шкала -->
                    <div class="stoch-track">
                        <div class="stoch-zone stoch-zone-low"></div>
                        <div class="stoch-zone stoch-zone-mid"></div>
                        <div class="stoch-zone stoch-zone-high"></div>
                        <div class="stoch-needle stoch-needle-k" id="stochNeedleK"></div>
                        <div class="stoch-needle stoch-needle-d" id="stochNeedleD"></div>
                    </div>
                    <div class="stoch-scale-labels">
                        <span>0</span><span>20</span><span>50</span><span>80</span><span>100</span>
                    </div>
                </div>

                <!-- Сигнал пересечения -->
                <div class="ind-rows" id="stochRows" style="display:none">
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="rowSignal">Сигнал</span>
                        <span class="ind-row-value" id="stochSignal">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="rowZone">Зона</span>
                        <span class="ind-row-value" id="stochZone">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label">%K − %D</span>
                        <span class="ind-row-value" id="stochDiff">—</span>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="stochHint">%K пересекает %D снизу — покупка, сверху — продажа</div>
            </div>

            <!-- RSI Extended -->
            <div class="ind-card" id="rsiExtCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">📊</span>RSI <span class="ind-period" data-i18n="rsiExtPeriod">расширенный</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="rsiExtBadge">—</span>
                        <i class="ind-help" data-tipkey="tipRSI" data-tip="Relative Strength Index — индикатор силы тренда. Выше 70 — перекупленность. Ниже 30 — перепроданность. Дивергенция с ценой — сильный сигнал разворота.">?</i>
                    </div>
                </div>

                <!-- Спиннер -->
                <div class="atr-loading" id="rsiExtLoading">
                    <div class="atr-spinner"></div>
                </div>

                <!-- Три периода: 7, 14, 21 -->
                <div class="rsi-ext-wrap" id="rsiExtWrap" style="display:none">
                    <div class="rsi-ext-bars">

                        <!-- RSI 7 -->
                        <div class="rsi-ext-row">
                            <span class="rsi-ext-label">RSI 7</span>
                            <div class="rsi-ext-track">
                                <div class="rsi-ext-zone-os"></div>
                                <div class="rsi-ext-zone-mid"></div>
                                <div class="rsi-ext-zone-ob"></div>
                                <div class="rsi-ext-needle" id="rsiExt7Needle"></div>
                            </div>
                            <span class="rsi-ext-val" id="rsiExt7Val">—</span>
                        </div>

                        <!-- RSI 14 -->
                        <div class="rsi-ext-row">
                            <span class="rsi-ext-label">RSI 14</span>
                            <div class="rsi-ext-track">
                                <div class="rsi-ext-zone-os"></div>
                                <div class="rsi-ext-zone-mid"></div>
                                <div class="rsi-ext-zone-ob"></div>
                                <div class="rsi-ext-needle" id="rsiExt14Needle"></div>
                            </div>
                            <span class="rsi-ext-val" id="rsiExt14Val">—</span>
                        </div>

                        <!-- RSI 21 -->
                        <div class="rsi-ext-row">
                            <span class="rsi-ext-label">RSI 21</span>
                            <div class="rsi-ext-track">
                                <div class="rsi-ext-zone-os"></div>
                                <div class="rsi-ext-zone-mid"></div>
                                <div class="rsi-ext-zone-ob"></div>
                                <div class="rsi-ext-needle" id="rsiExt21Needle"></div>
                            </div>
                            <span class="rsi-ext-val" id="rsiExt21Val">—</span>
                        </div>
                    </div>

                    <!-- Метки зон -->
                    <div class="rsi-ext-zone-labels">
                        <span>0</span><span>30</span><span>50</span><span>70</span><span>100</span>
                    </div>
                </div>

                <!-- Строки -->
                <div class="ind-rows" id="rsiExtRows" style="display:none">
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="rowConsensus">Консенсус</span>
                        <span class="ind-row-value" id="rsiExtConsensus">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="rowDivergence">Дивергенция RSI 7/21</span>
                        <span class="ind-row-value" id="rsiExtDivergence">—</span>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="rsiExtHint">Три периода дают более надёжный сигнал чем один RSI</div>
            </div>

            <!-- Bollinger Bands -->
            <div class="ind-card" id="bbCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">〽️</span>Bollinger <span class="ind-period">(20, ±2σ)</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="bbBadge">—</span>
                        <i class="ind-help" data-tipkey="tipBB" data-tip="Полосы Боллинджера — каналы волатильности. Цена у верхней полосы — перекуплена. У нижней — перепродана. Сужение полос (сквиз) предвещает сильное движение.">?</i>
                    </div>
                </div>

                <!-- Спиннер -->
                <div class="atr-loading" id="bbLoading">
                    <div class="atr-spinner"></div>
                </div>

                <!-- Визуальная шкала BB -->
                <div class="bb-wrap" id="bbWrap" style="display:none">

                    <!-- %B — где цена внутри полос (0=нижняя, 1=верхняя) -->
                    <div class="bb-pctb-row">
                        <span class="bb-pctb-label">%B</span>
                        <span class="bb-pctb-val" id="bbPctBVal">—</span>
                    </div>
                    <div class="bb-track">
                        <div class="bb-zone-low"></div>
                        <div class="bb-zone-mid"></div>
                        <div class="bb-zone-high"></div>
                        <div class="bb-needle" id="bbNeedle"></div>
                    </div>
                    <div class="bb-track-labels">
                        <span data-i18n="bbLower">Нижняя</span><span>SMA 20</span><span data-i18n="bbUpper">Верхняя</span>
                    </div>

                    <!-- Ширина полос — индикатор сжатия/расширения -->
                    <div class="bb-bandwidth-row">
                        <span class="bb-bw-label" data-i18n="bbBandwidth">Ширина полос</span>
                        <div class="bb-bw-bar-wrap">
                            <div class="bb-bw-bar" id="bbBwBar"></div>
                        </div>
                        <span class="bb-bw-val" id="bbBwVal">—</span>
                    </div>
                </div>

                <!-- Строки -->
                <div class="ind-rows" id="bbRows" style="display:none">
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="bbUpperBand">Верхняя полоса</span>
                        <span class="ind-row-value" id="bbUpper">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label">SMA 20</span>
                        <span class="ind-row-value" id="bbMiddle">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="bbLowerBand">Нижняя полоса</span>
                        <span class="ind-row-value" id="bbLower">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="rowSignal">Сигнал</span>
                        <span class="ind-row-value" id="bbSignal">—</span>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="bbHint">Сжатие полос — затишье перед движением; касание — возможный разворот</div>
            </div>

            <!-- MACD -->
            <div class="ind-card" id="macdCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">〜</span>MACD <span class="ind-period">(12,26,9)</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="macdBadge">—</span>
                        <i class="ind-help" data-tipkey="tipMACD" data-tip="Moving Average Convergence Divergence — разница быстрой и медленной EMA. Пересечение сигнальной линии снизу вверх — покупка. Сверху вниз — продажа. Гистограмма показывает силу сигнала.">?</i>
                    </div>
                </div>

                <!-- Спиннер -->
                <div class="atr-loading" id="macdLoading">
                    <div class="atr-spinner"></div>
                </div>

                <!-- Сигнал -->
                <div class="ema-signal-wrap" id="macdSignalWrap" style="display:none">
                    <div class="ema-signal" id="macdSignalBox">
                        <div class="ema-signal-icon" id="macdSignalIcon"></div>
                        <div>
                            <div class="ema-signal-label" id="macdSignalLabel">—</div>
                            <div class="ema-signal-sub" id="macdSignalSub">—</div>
                        </div>
                    </div>
                </div>

                <!-- Мини-гистограмма -->
                <div class="macd-hist-wrap" id="macdHistWrap" style="display:none">
                    <canvas id="macdHistChart" height="72"></canvas>
                </div>

                <!-- Строки -->
                <div class="ind-rows" id="macdRows" style="display:none">
                    <div class="ind-row">
                        <span class="ind-row-label">MACD</span>
                        <span class="ind-row-value" id="macdLine">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="macdSignalLine">Сигнальная</span>
                        <span class="ind-row-value" id="macdSignalLine">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="macdHistogram">Гистограмма</span>
                        <span class="ind-row-value" id="macdHist">—</span>
                    </div>
                    <div class="ind-row">
                        <span class="ind-row-label" data-i18n="macdMomentum">Импульс</span>
                        <span class="ind-row-value" id="macdMomentum">—</span>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="macdHint">Пересечение MACD и сигнальной линии — ключевой сигнал входа</div>
            </div>

            <!-- Fear & Greed Index -->
            <div class="ind-card" id="fgCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">🧠</span>Fear & Greed</div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="fgBadge">—</span>
                        <i class="ind-help" data-tipkey="tipFG" data-tip="Индекс страха и жадности от 0 до 100. 0–25 — extreme fear (хорошее время для покупки). 75–100 — extreme greed (рынок перегрет). Составляется из волатильности, объёмов, соцсетей и опросов.">?</i>
                    </div>
                </div>

                <!-- Спиннер -->
                <div class="atr-loading" id="fgLoading">
                    <div class="atr-spinner"></div>
                </div>

                <!-- Спидометр -->
                <div class="fg-gauge-wrap" id="fgWrap" style="display:none">
                    <div class="fg-gauge-container">
                        <canvas id="fgCanvas" width="180" height="105"></canvas>
                        <div class="fg-gauge-center">
                            <div class="fg-value" id="fgValue">—</div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Williams %R -->
            <div class="ind-card" id="willrCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">⚡</span>Williams %R <span class="ind-period">(14)</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="willrBadge">—</span>
                        <i class="ind-help" data-tipkey="tipWillR" data-tip="Осциллятор Уильямса — показывает положение цены относительно максимума за период. Выше −20 — перекуплен. Ниже −80 — перепродан. Похож на Stochastic, но шкала инвертирована.">?</i>
                    </div>
                </div>

                <div class="atr-loading" id="willrLoading">
                    <div class="atr-spinner"></div>
                </div>

                <div id="willrContent" style="display:none">
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <!-- Большое значение -->
                        <div class="ind-value-row">
                            <span class="ind-big-value" id="willrValue">—</span>
                            <span class="ind-sub-value" id="willrZoneLabel">—</span>
                        </div>
                        <!-- Шкала -100..0 -->
                        <div style="display:flex;flex-direction:column;gap:4px;">
                            <div style="position:relative;height:7px;border-radius: 4px;display:flex;overflow:visible;">
                                <div style="width:20%;background:rgba(239,68,68,0.4);border-radius: 4px 0 0 4px;"></div>
                                <div style="width:60%;background:rgba(100,116,139,0.15);"></div>
                                <div style="width:20%;background:rgba(16,185,129,0.4);border-radius: 0 4px 4px 0;"></div>
                                <div class="stoch-needle stoch-needle-k" id="willrNeedle"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:10px;color:#475569;">
                                <span>−100</span><span>−80</span><span>−50</span><span>−20</span><span>0</span>
                            </div>
                        </div>
                        <div class="ind-rows">
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowZone">Зона</span>
                                <span class="ind-row-value" id="willrZone">—</span>
                            </div>
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowSignal">Сигнал</span>
                                <span class="ind-row-value" id="willrSignal">—</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="willrHint">−80 и ниже — перепродан, −20 и выше — перекуплен</div>
            </div>

            <!-- OBV -->
            <div class="ind-card" id="obvCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">📦</span>OBV <span class="ind-period" data-i18n="obvPeriod">объём</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="obvBadge">—</span>
                        <i class="ind-help" data-tipkey="tipOBV" data-tip="On-Balance Volume — накопленный объём. Растёт когда объём в дни роста превышает объём в дни падения. Подтверждает тренд: если цена и OBV растут вместе — тренд сильный.">?</i>
                    </div>
                </div>

                <!-- Спиннер -->
                <div class="atr-loading" id="obvLoading">
                    <div class="atr-spinner"></div>
                </div>

                <!-- Контент -->
                <div id="obvContent" style="display:none">
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <!-- Сигнал -->
                        <div class="ema-signal" id="obvSignalBox">
                            <div class="ema-signal-icon" id="obvSignalIcon"></div>
                            <div>
                                <div class="ema-signal-label" id="obvSignalLabel">—</div>
                                <div class="ema-signal-sub" id="obvSignalSub">—</div>
                            </div>
                        </div>
                        <!-- Мини-график OBV -->
                        <div class="atr-chart-wrap">
                            <canvas id="obvMiniChart" height="36"></canvas>
                        </div>
                        <!-- Строки -->
                        <div class="ind-rows">
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="obvTrend">Тренд OBV</span>
                                <span class="ind-row-value" id="obvTrend">—</span>
                            </div>
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowDivergenceShort">Дивергенция</span>
                                <span class="ind-row-value" id="obvDivergence">—</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="obvHint">Объём подтверждает движение — рост OBV при росте цены = сила тренда</div>
            </div>

            <!-- CCI -->
            <div class="ind-card" id="cciCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">🌀</span>CCI <span class="ind-period">(20)</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="cciBadge">—</span>
                        <i class="ind-help" data-tipkey="tipCCI" data-tip="Commodity Channel Index — показывает отклонение цены от среднего. Выше +100 — сильный бычий тренд или перекупленность. Ниже −100 — медвежий тренд или перепроданность.">?</i>
                    </div>
                </div>

                <div class="atr-loading" id="cciLoading">
                    <div class="atr-spinner"></div>
                </div>

                <div id="cciContent" style="display:none">
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <div class="ind-value-row">
                            <span class="ind-big-value" id="cciValue">—</span>
                            <span class="ind-sub-value" id="cciZoneLabel">—</span>
                        </div>
                        <!-- Шкала: -200 .. +200, зоны ±100 -->
                        <div style="display:flex;flex-direction:column;gap:4px;">
                            <div style="position:relative;height:7px;border-radius: 4px;display:flex;overflow:visible;">
                                <div style="width:25%;background:rgba(239,68,68,0.5);border-radius: 4px 0 0 4px;"></div>
                                <div style="width:25%;background:rgba(239,68,68,0.2);"></div>
                                <div style="width:25%;background:rgba(16,185,129,0.2);"></div>
                                <div style="width:25%;background:rgba(16,185,129,0.5);border-radius: 0 4px 4px 0;"></div>
                                <div class="stoch-needle stoch-needle-k" id="cciNeedle"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:10px;color:#475569;">
                                <span>−200</span><span>−100</span><span>0</span><span>+100</span><span>+200</span>
                            </div>
                        </div>
                        <div class="ind-rows">
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowZone">Зона</span>
                                <span class="ind-row-value" id="cciZone">—</span>
                            </div>
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowSignal">Сигнал</span>
                                <span class="ind-row-value" id="cciSignal">—</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="cciHint">Выше +100 — перекуплен, ниже −100 — перепродан, около 0 — норма</div>
            </div>

            <!-- VWAP -->
            <div class="ind-card" id="vwapCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">🏦</span>VWAP</div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="vwapBadge">—</span>
                        <i class="ind-help" data-tipkey="tipVWAP" data-tip="Volume Weighted Average Price — средняя цена с учётом объёма. Если цена выше VWAP — рынок бычий, институционалы покупали дороже средней. Ниже — медвежий. Ключевой уровень для внутридневной торговли.">?</i>
                    </div>
                </div>

                <div class="atr-loading" id="vwapLoading">
                    <div class="atr-spinner"></div>
                </div>

                <div id="vwapContent" style="display:none">
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <div class="ind-value-row">
                            <span class="ind-big-value" id="vwapValue">—</span>
                            <span class="ind-sub-value" id="vwapDiffLabel">—</span>
                        </div>
                        <!-- Мини-график цена vs VWAP -->
                        <div class="atr-chart-wrap">
                            <canvas id="vwapMiniChart" height="36"></canvas>
                        </div>
                        <div class="ind-rows">
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="vwapCurrentPrice">Текущая цена</span>
                                <span class="ind-row-value" id="vwapCurrentPrice">—</span>
                            </div>
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="vwapDeviation">Отклонение от VWAP</span>
                                <span class="ind-row-value" id="vwapDiff">—</span>
                            </div>
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowSignal">Сигнал</span>
                                <span class="ind-row-value" id="vwapSignal">—</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="vwapHint">Выше VWAP — покупатели контролируют рынок, ниже — продавцы</div>
            </div>

            <!-- MFI -->
            <div class="ind-card" id="mfiCard">
                <div class="ind-card-header">
                    <div class="ind-card-title"><span class="ind-icon">💸</span>MFI <span class="ind-period">(14)</span></div>
                    <div style="display:flex;align-items:center;gap:6px;">
                        <span class="ind-badge" id="mfiBadge">—</span>
                        <i class="ind-help" data-tipkey="tipMFI" data-tip="Money Flow Index — RSI с учётом объёма. Выше 80 — перекуплен, деньги выходят. Ниже 20 — перепродан, деньги входят. Дивергенция с ценой — сильный сигнал разворота.">?</i>
                    </div>
                </div>

                <div class="atr-loading" id="mfiLoading">
                    <div class="atr-spinner"></div>
                </div>

                <div id="mfiContent" style="display:none">
                    <div style="display:flex;flex-direction:column;gap:6px;">
                        <div class="ind-value-row">
                            <span class="ind-big-value" id="mfiValue">—</span>
                            <span class="ind-sub-value" id="mfiZoneLabel">—</span>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:4px;">
                            <div style="position:relative;height:7px;border-radius: 4px;display:flex;overflow:visible;">
                                <div style="width:20%;background:rgba(16,185,129,0.4);border-radius: 4px 0 0 4px;"></div>
                                <div style="width:60%;background:rgba(100,116,139,0.15);"></div>
                                <div style="width:20%;background:rgba(239,68,68,0.4);border-radius: 0 4px 4px 0;"></div>
                                <div class="stoch-needle stoch-needle-k" id="mfiNeedle"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:10px;color:#475569;">
                                <span>0</span><span>20</span><span>50</span><span>80</span><span>100</span>
                            </div>
                        </div>
                        <div class="ind-rows">
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowZone">Зона</span>
                                <span class="ind-row-value" id="mfiZone">—</span>
                            </div>
                            <div class="ind-row">
                                <span class="ind-row-label" data-i18n="rowSignal">Сигнал</span>
                                <span class="ind-row-value" id="mfiSignal">—</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ind-hint" data-i18n="mfiHint">RSI с учётом объёма — &lt;20 перепродан, &gt;80 перекуплен</div>
            </div>

        </div><!-- /page2-grid -->
    </div><!-- /page2-container -->
    </div><!-- /slider-page-2 -->


    <!-- ═══════════════════════════════════════════════════ -->
    <!-- СТРАНИЦА 3: НОВОСТИ                                -->
    <!-- ═══════════════════════════════════════════════════ -->
    <div class="slider-page" id="slider-page-3" style="padding:10px 70px 10px; padding-bottom: 44px !important; align-items: stretch;">
    <div class="page3-container">

        <!-- HEADER -->
        <div class="page3-header">
            
            <div>
                <div class="page3-title" data-i18n="page3Title">Крипто Новости</div>
                <div class="page3-subtitle" data-i18n="page3Sub">Актуальные события рынка</div>
            </div>
            <div class="page3-header-right">
                <div class="news-live-dot" id="newsLiveLabel" data-i18n="loading">Загрузка...</div>
                <button class="news-refresh-btn" id="newsRefreshBtn" data-i18n-title="refresh" title="Обновить">↻</button>
            </div>
        </div>

        <!-- БЕГУЩАЯ СТРОКА -->
        <div class="page3-ticker" id="priceTicker">
            <div class="page3-ticker-track" id="tickerTrack" style="display:inline-flex;align-items:center;height:36px;white-space:nowrap;animation:tickerRun 55s linear infinite;min-width:max-content;">
                <span style="color:#475569;font-size:11px;padding:0 16px" data-i18n="loadingPrices">Загрузка цен...</span>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="news-filters" id="newsTopicFilters">
            <span class="news-filter-label">Фильтр:</span>
            <button class="news-filter-btn active" data-nfilter="all" data-i18n="filterAll">Все</button>
            <button class="news-filter-btn" data-nfilter="bitcoin">Bitcoin</button>
            <button class="news-filter-btn" data-nfilter="ethereum">Ethereum</button>
            <button class="news-filter-btn" data-nfilter="solana">Solana</button>
            <button class="news-filter-btn bull" data-nfilter="bull" data-i18n="newsBullish">🐂 Бычьи</button>
            <button class="news-filter-btn bear" data-nfilter="bear" data-i18n="newsBearish">🐻 Медвежьи</button>
            <span class="news-filter-sep">|</span>
            <button class="news-source-btn" data-source="CoinDesk">CoinDesk</button>
            <button class="news-source-btn" data-source="Cointelegraph">Cointelegraph</button>
            <button class="news-source-btn" data-source="Decrypt">Decrypt</button>
            <button class="news-source-btn" data-source="The Block">The Block</button>
            <button class="news-source-btn" data-source="AMB Crypto">AMB Crypto</button>
            <button class="news-source-btn" data-source="CryptoSlate">CryptoSlate</button>
        </div>

        <!-- GRID 3 cols -->
        <div class="news-grid">

            <!-- COL 1: Featured + Trends -->
            <div class="news-col">
                <!-- Featured card — будет заполнен JS -->
                <div id="newsFeaturedCol" class="news-col-scroll"></div>
            </div>

            <!-- COL 2: Feed -->
            <div class="news-col">
                <div class="news-feed-header">
                    <div class="news-col-label" data-i18n="newsLatest">Последние новости</div>
                </div>
                <div class="news-feed-wrap" id="newsFeedWrap">
                    <div id="newsFeedCol" style="display:flex;flex-direction:column;gap:4px;"></div>
                </div>
                <div class="news-pagination" id="newsPagination" style="display:none;"></div>
            </div>

            <!-- COL 3: Right sidebar -->
            <div class="news-col">
                <div class="news-col-scroll">
                    <!-- Настроение рынка -->
                    <div class="news-stat-card">
                        <div class="news-stat-label" data-i18n="newsSentiment">Настроение рынка</div>
                        <div class="news-sent-row">
                            <span class="news-sent-name" data-i18n="newsBullish">🐂 Бычьи</span>
                            <div class="news-sent-track"><div class="news-sent-fill bull" id="nBullBar" style="width:0%"></div></div>
                            <span class="news-sent-pct" id="nBullPct">—</span>
                        </div>
                        <div class="news-sent-row">
                            <span class="news-sent-name" data-i18n="newsBearish">🐻 Медвежьи</span>
                            <div class="news-sent-track"><div class="news-sent-fill bear" id="nBearBar" style="width:0%"></div></div>
                            <span class="news-sent-pct" id="nBearPct">—</span>
                        </div>
                        <div class="news-sent-row" style="margin-bottom:10px">
                            <span class="news-sent-name" data-i18n="newsNeutral">⚡ Нейтральные</span>
                            <div class="news-sent-track"><div class="news-sent-fill neutral" id="nNeutralBar" style="width:0%"></div></div>
                            <span class="news-sent-pct" id="nNeutralPct">—</span>
                        </div>
                        <div style="font-size:10px;color:#475569;margin-bottom:8px"><span data-i18n="newsTotal">Всего</span>: <span style="color:#CBD5E1;font-weight:600" id="nTotalCount">—</span></div>
                        <div style="height:1px;background:rgba(255,255,255,0.06);margin-bottom:8px"></div>
                        <div style="font-size:11px;font-weight:700;color:#CBD5E1;margin-bottom:6px" data-i18n="newsToday">За сегодня</div>
                        <div class="news-quick-stats">
                            <div class="news-quick-stat">
                                <div class="news-quick-label" data-i18n="newsPositive">Позитивных</div>
                                <div class="news-quick-val" id="nStatPos" style="color:#10B981">—</div>
                                <div class="news-quick-sub" data-i18n="newsArticles">новостей</div>
                            </div>
                            <div class="news-quick-stat">
                                <div class="news-quick-label" data-i18n="newsNegative">Негативных</div>
                                <div class="news-quick-val" id="nStatNeg" style="color:#EF4444">—</div>
                                <div class="news-quick-sub" data-i18n="newsArticles">новостей</div>
                            </div>
                        </div>
                    </div>

                    <!-- Популярное / реклама -->
                    <div class="news-promo-card">
                        <div class="news-promo-label" data-i18n="newsPopular">Популярное</div>
                        <div class="news-promo-item bybit">
                            <div class="news-promo-name">⚡ ByBit</div>
                            <div class="news-promo-desc" data-i18n="promoBybit">Акция: рекомендуйте своим друзьям. Самая низкая ставка на рынке</div>
                            <a href="https://www.bybit.com/invite?ref=QO31EP" target="_blank" rel="noopener" class="news-promo-cta" data-i18n="promoRegister">Зарегистрироваться →</a>
                        </div>
                        <div class="news-promo-item binance">
                            <div class="news-promo-name">◈ Binance</div>
                            <div class="news-promo-desc" data-i18n="promoBinance">Самая выгодная покупка криптовалюты. Скидка на комиссию. Топовые активы</div>
                            <a href="https://www.binance.com/register?ref=38905316" target="_blank" rel="noopener" class="news-promo-cta" data-i18n="promoRegister">Зарегистрироваться →</a>
                        </div>
                    </div>

                    <!-- Поддержать проект -->
                    <div class="news-stat-card donate-card">
                        <div class="donate-header">
                            <div class="donate-header-text">
                                <span class="donate-header-line1">💛 <span data-i18n="donateHeader1">Сервис бесплатный и существует благодаря вам.</span></span>
                                <span class="donate-header-line2"><span data-i18n="donateHeader2">Спасибо за поддержку!</span> 😊</span>
                            </div>
                        </div>
                        <div class="donate-subtitle" data-i18n="donateSubtitle">Поддержать через кошелек:</div>
                        <div class="donate-rows">

                            <!-- BTC -->
                            <div class="donate-row">
                                <div class="donate-coin-icon">
                                    <svg viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="13" cy="13" r="13" fill="#F7931A"/>
                                        <path d="M17.5 11.2c.24-1.6-1-2.46-2.66-3.03l.54-2.18-1.33-.33-.53 2.12c-.35-.09-.71-.17-1.07-.25l.54-2.14-1.33-.33-.54 2.18c-.29-.07-.57-.13-.84-.2l-1.73-.43-.33 1.42s.98.22.96.24c.54.13.63.49.62.77l-1.5 6.02c-.06.15-.22.37-.57.29.01.02-.96-.24-.96-.24l-.66 1.52 1.63.41c.3.08.6.16.89.23l-.55 2.2 1.33.33.54-2.18c.36.1.72.19 1.07.28l-.54 2.17 1.33.33.55-2.19c2.27.43 3.97.26 4.69-1.8.58-1.65-.03-2.6-1.22-3.22.87-.2 1.52-.77 1.69-1.95zm-3.02 4.23c-.41 1.65-3.2.76-4.1.53l.73-2.93c.9.23 3.78.67 3.37 2.4zm.41-4.25c-.38 1.5-2.7.74-3.46.55l.66-2.66c.76.19 3.21.54 2.8 2.11z" fill="white"/>
                                    </svg>
                                </div>
                                <div class="donate-coin-meta">
                                    <span class="donate-coin-name">BTC</span>
                                    <span class="donate-coin-net">Bitcoin</span>
                                </div>
                                <div class="donate-addr-wrap">
                                    <span class="donate-addr-bold">bc1qezpu9t</span><span class="donate-addr-dim">zqxgr4hgvnzzkvurkn5mw8hyqmu0yx7u</span>
                                </div>
                                <button class="donate-copy-btn" data-address="bc1qezpu9tzqxgr4hgvnzzkvurkn5mw8hyqmu0yx7u">
                                    <span data-i18n="donateCopy">Скопировать</span>
                                </button>
                            </div>

                            <!-- ETH -->
                            <div class="donate-row">
                                <div class="donate-coin-icon">
                                    <svg viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="13" cy="13" r="13" fill="#627EEA"/>
                                        <path d="M13 4.5l-.1.35v11.4l.1.1 4.8-2.84L13 4.5z" fill="white" fill-opacity=".6"/>
                                        <path d="M13 4.5L8.2 13.51l4.8 2.84V4.5z" fill="white"/>
                                        <path d="M13 17.3l-.06.07v3.73l.06.18 4.8-6.76L13 17.3z" fill="white" fill-opacity=".6"/>
                                        <path d="M13 21.28v-3.98l-4.8-2.78L13 21.28z" fill="white"/>
                                        <path d="M13 16.35l4.8-2.84-4.8-2.18v5.02z" fill="white" fill-opacity=".2"/>
                                        <path d="M8.2 13.51l4.8 2.84v-5.02L8.2 13.51z" fill="white" fill-opacity=".6"/>
                                    </svg>
                                </div>
                                <div class="donate-coin-meta">
                                    <span class="donate-coin-name">ETH</span>
                                    <span class="donate-coin-net">ERC-20</span>
                                </div>
                                <div class="donate-addr-wrap">
                                    <span class="donate-addr-bold">0x33D362</span><span class="donate-addr-dim">63918d6C3a050C969ca070007De80657eC</span>
                                </div>
                                <button class="donate-copy-btn" data-address="0x33D36263918d6C3a050C969ca070007De80657eC">
                                    <span data-i18n="donateCopy">Скопировать</span>
                                </button>
                            </div>

                            <!-- USDT BEP-20 -->
                            <div class="donate-row">
                                <div class="donate-coin-icon">
                                    <svg viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="13" cy="13" r="13" fill="#26A17B"/>
                                        <path d="M14.56 13.93v-.01c-.08.01-.5.03-1.56.03-1.03 0-1.41-.02-1.54-.03v.01c-3.1-.14-5.41-.68-5.41-1.32s2.31-1.18 5.41-1.32v2.11c.13.01.53.03 1.55.03 1.22 0 1.49-.03 1.55-.03v-2.11c3.1.14 5.41.68 5.41 1.32s-2.31 1.18-5.41 1.32zm0-2.84V9.19h3.4V7H8.02v2.19h3.44v1.9C8.1 11.27 5.5 11.96 5.5 12.79s2.6 1.52 5.96 1.7v5.51h2.06v-5.51c3.36-.18 5.96-.87 5.96-1.7 0-.83-2.6-1.52-5.92-1.7z" fill="white"/>
                                    </svg>
                                </div>
                                <div class="donate-coin-meta">
                                    <span class="donate-coin-name">USDT</span>
                                    <span class="donate-coin-net">BEP-20</span>
                                </div>
                                <div class="donate-addr-wrap">
                                    <span class="donate-addr-bold">0x33D362</span><span class="donate-addr-dim">63918d6C3a050C969ca070007De80657eC</span>
                                </div>
                                <button class="donate-copy-btn" data-address="0x33D36263918d6C3a050C969ca070007De80657eC">
                                    <span data-i18n="donateCopy">Скопировать</span>
                                </button>
                            </div>

                            <!-- TON -->
                            <div class="donate-row">
                                <div class="donate-coin-icon">
                                    <svg viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="13" cy="13" r="13" fill="#0098EA"/>
                                        <path d="M18.28 8H7.72a1.25 1.25 0 00-1 1.98l4.64 6.54a2 2 0 003.27 0l4.65-6.54A1.25 1.25 0 0018.28 8zm-5.8 7.18L10.6 11.5h4.8L13 15.18zm-2.72-4.93h5.44L13 13.64 10.28 10.25z" fill="white"/>
                                    </svg>
                                </div>
                                <div class="donate-coin-meta">
                                    <span class="donate-coin-name">TON</span>
                                    <span class="donate-coin-net">TON</span>
                                </div>
                                <div class="donate-addr-wrap">
                                    <span class="donate-addr-bold">UQBD6Tsy</span><span class="donate-addr-dim">XBtzmcFf0dJV6I9m-yFDs4v7OAFnpzpGEnwe_WkW</span>
                                </div>
                                <button class="donate-copy-btn" data-address="UQBD6TsyXBtzmcFf0dJV6I9m-yFDs4v7OAFnpzpGEnwe_WkW">
                                    <span data-i18n="donateCopy">Скопировать</span>
                                </button>
                            </div>

                        </div>
                    </div>


                </div>
            </div>
        </div>

    </div><!-- /page3-container -->
    </div><!-- /slider-page-3 -->

    </div><!-- /slider-wrapper -->

    <script>
        const TRANSLATIONS = {
            ru: {
                // UI общее
                loading: 'Загрузка...', loadingPrices: 'Загрузка цен...', noData: 'Нет данных',
                refresh: 'Обновить', backToMenu: 'Назад к меню', reset: 'Сбросить',
                calculator: 'Калькулятор', coinSelectTitle: 'Выбор монеты',
                coinSearchPlaceholder: 'Поиск монеты...', coinNotFound: 'Ничего не найдено',

                // График
                chartTitle: 'График цены', chartLoading: 'Загрузка графика...',
                periodD1: '1Д', periodD7: '7Д', periodD30: '30Д', periodD90: '90Д',

                // Калькулятор — хаб
                calcTabSell: 'Спот', calcTabMargin: 'Маржа', calcTabDca: 'DCA',
                hubDescSell: 'Прибыль, средняя цена, TP/SL',
                hubNameCompound: 'Сложный %', hubDescCompound: 'Реинвестирование и рост',
                hubDescMargin: 'Плечо, ликвидация, лонг/шорт',
                hubNameRisk: 'Риск на сделку', hubDescRisk: 'Размер позиции по % депозита',
                riskSub: 'Размер позиции по % депозита',
                labelDeposit: 'Депозит ($)', labelRiskPct: 'Риск (%)',
                labelStoploss: 'Стоп-лосс ($)', labelTakeprofit: 'Тейк-профит ($)',
                riskResultLabel: 'Размер позиции',
                riskCoins: 'Монет', riskDepositPct: '% депозита',
                riskAmount: 'Сумма риска', riskReward: 'Потенц. прибыль',
                riskRR: 'RR', riskRiskPct: 'Риск от депозита',
                riskTpStrategyOff: 'Показать стратегию TP1/TP2/TP3',
                riskTpStrategyOn: 'Скрыть стратегию TP1/TP2/TP3',
                hubDescDca: 'Средняя цена при докупках',
                hubNameBreakeven: 'Безубыток', hubDescBreakeven: 'Выход в ноль с комиссией',
                hubNamePossize: 'Размер позиции', hubDescPossize: 'Монет по депозиту и плечу',
                hubNameFunding: 'Funding', hubDescFunding: 'Стоимость удержания фьючерса',
                hubNameConverter: 'Конвертер', hubDescConverter: 'Крипта ↔ фиат по курсу',
                hubNamePnlgrid: 'PnL сетки', hubDescPnlgrid: 'Прибыль Grid-бота',
                hubNameSavings: 'Накопление', hubDescSavings: 'За сколько месяцев до цели',

                // Заглушки
                stubDescRisk: 'Скоро появится. Расчёт размера позиции по % от депозита и stop-loss.',
                stubDescDca: 'Скоро появится. Средняя цена входа при нескольких докупках.',
                stubDescBreakeven: 'Скоро появится. Точка выхода в ноль с учётом комиссии биржи.',
                stubDescPossize: 'Скоро появится. Количество монет по депозиту, цене и плечу.',
                stubDescFunding: 'Скоро появится. Стоимость удержания фьючерсной позиции.',
                stubDescConverter: 'Скоро появится. Крипта ↔ фиат по актуальному курсу.',
                stubDescPnlgrid: 'Скоро появится. Расчёт прибыли Grid-бота по диапазону и шагу.',
                stubDescSavings: 'Скоро появится. Сколько месяцев нужно для достижения цели.',

                // Форма продажи
                addEntry: '+ Добавить', labelProfitPct: 'Процент прибыли (%)',
                labelSellPrice: 'Цена продажи ($)', labelBuys: 'Покупки',
                labelAmount: 'Сумма ($)', labelPrice: 'Цена ($)',

                // Сложный %
                compoundGrowthBtn: '📈 Прогноз роста', compoundGoalBtn: '🎯 Достичь цели',
                compoundGrowthTitle: 'Прогноз роста', compoundGrowthSub: 'Реинвестирование с учётом рисков',
                compoundGoalTitle: 'Достичь цели', compoundGoalSub: 'Сколько трейдов нужно для цели',
                labelInvestment: 'Сумма инвестиций ($)', labelProfitRate: '% прибыли',
                labelLossRate: '% убытка', labelTradesCount: 'Кол-во трейдов',
                labelWinRate: '% выигрышных', labelFee: 'Комиссия биржи (%)',
                labelGoalFrom: 'Начальный ($)', labelGoalTo: 'Цель ($)', labelGoalRate: 'Процент за трейд (%)',
                goalAt: 'При', goalPerTrade: 'за трейд',
                goalTableTitle: 'Сколько трейдов при разных %',
                goalNote: '* идеальный сценарий, без комиссий и убытков',

                // Маржа
                marginTitle: 'Маржинальная торговля', marginSub: 'Плечо, вход и выход',
                labelCollateral: 'Залог ($)', labelLeverage: 'Плечо (x)',
                labelEntryPrice: 'Цена входа ($)', labelExitPrice: 'Цена выхода ($)',
                entryLabel: 'Вход', liqLabel: 'Ликвидация',
                avgBuyLabel: 'Средняя покупка', sellPriceLabel: 'Цена продажи',
                exitLabel: 'Цена выхода', stopLossLabel: 'Stop Loss', takeProfitLabel: 'Take Profit',

                // Результаты
                resultLabelSell: 'Итого на выходе', resultLabelCompound: 'Итоговый капитал',
                resultLabelGoal: 'Чтобы достичь цели', resultLabelLiq: 'Цена ликвидации',
                resultLabelTrade: 'Результат сделки',
                statProfit: 'Прибыль', statYield: 'Доходность', statInitial: 'Начальный',
                statInRubles: 'В рублях', statStart: 'Старт', statGoal: 'Цель',
                statGrowth: 'Рост', statPerTrade: '% за трейд',
                statPosition: 'Позиция', statToLiq: 'До ликвидации', statRisk: 'Риск',
                statTotal: 'Итого', statRoiCollateral: 'Доходность (к залогу)',
                statPriceChange: 'Изменение цены',
                avgEntryPrice: 'Средняя цена входа',
                avgPrice: 'Средняя цена', avgCoins: 'Всего монет', avgInvested: 'Общий инвест',
                tpStrategyLabel: 'По стратегии TP',
                progressTitle: 'Прогресс до цели', progressRemaining: 'Осталось: $0',
                progressEnterSell: 'Введите цену продажи', progressEnterExit: 'Введите цену выхода',
                goalAchieved: 'Цель достигнута!',
                remaining: 'Осталось',

                // TP/SL
                tpslTitle: 'TP / SL', tpslTitle2: '📈 Уровни выхода',
                rrLabel: 'Желаемый RR', tpslHint: 'SL рассчитан из TP1 и желаемого RR',

                // Страница 2
                page2Title: 'Технические индикаторы', page2Sub: 'Расширенный анализ рынка',
                indLoading: '⏳ Загрузка...', indTotal: 'Итог:',
                coinSearch2Placeholder: 'Поиск монеты...',

                // Индикаторы — общие
                rowSignal: 'Сигнал', rowZone: 'Зона', rowConsensus: 'Консенсус',
                rowDivergence: 'Дивергенция RSI 7/21', rowDivergenceShort: 'Дивергенция',
                scalePrice: 'Цена',

                // ATR
                atrVsAvgLabel: 'Волатильность vs норма', atrMinSlLabel: 'Мин SL (×1.5 ATR)',
                atrRangeLabel: 'Макс / Мин за 14д',
                atrHint: 'Average True Range — амплитуда движения с учётом гэпов',
                ofPrice: 'от цены', volHigh: 'Высокая', volLow: 'Низкая', volModerate: 'Умеренная',

                // EMA
                emaPriceVs20: 'Цена vs EMA 20', emaPriceVs50: 'Цена vs EMA 50',
                emaHint: 'Golden Cross / Death Cross — ключевые сигналы разворота тренда',
                emaGoldenSub: 'EMA 20 пересекла EMA 50 снизу вверх', emaDeathSub: 'EMA 20 пересекла EMA 50 сверху вниз',
                emaCorrection: 'Коррекция', emaNeutralSub: 'EMA 20 и EMA 50 близко — нет чёткого тренда',

                // Stoch RSI
                stochHint: '%K пересекает %D снизу — покупка, сверху — продажа',
                bullCross: 'Бычье пересечение', bearCross: 'Медвежье пересечение',
                above: 'выше', below: 'ниже',

                // RSI Extended
                rsiExtPeriod: 'расширенный',
                rsiExtHint: 'Три периода дают более надёжный сигнал чем один RSI',

                // Bollinger
                bbLower: 'Нижняя', bbUpper: 'Верхняя', bbBandwidth: 'Ширина полос',
                bbUpperBand: 'Верхняя полоса', bbLowerBand: 'Нижняя полоса',
                bbHint: 'Сжатие полос — затишье перед движением; касание — возможный разворот',
                bbAboveUpper: 'Цена выше верхней полосы', bbBelowLower: 'Цена ниже нижней полосы',
                bbNearUpper: 'Цена у верхней полосы', bbNearLower: 'Цена у нижней полосы',
                bbSqueeze: 'Сжатие', bbInside: 'Внутри полос',

                // MACD
                macdSignalLine: 'Сигнальная', macdHistogram: 'Гистограмма', macdMomentum: 'Импульс',
                macdHint: 'Пересечение MACD и сигнальной линии — ключевой сигнал входа',
                bullishCross: 'Бычье пересечение', bearishCross: 'Медвежье пересечение',
                bullishMomentum: 'Бычий импульс', bearishMomentum: 'Медвежий импульс',
                macdAboveSignal: 'MACD выше сигнальной линии', macdBelowSignal: 'MACD ниже сигнальной линии',
                macdCrossUp: 'MACD пересёк сигнальную снизу вверх', macdCrossDown: 'MACD пересёк сигнальную сверху вниз',

                // Williams %R
                willrHint: '−80 и ниже — перепродан, −20 и выше — перекуплен',

                // OBV
                obvPeriod: 'объём', obvTrend: 'Тренд OBV',
                obvHint: 'Объём подтверждает движение — рост OBV при росте цены = сила тренда',
                obvBullAccum: 'Бычье накопление', obvBearDist: 'Медвежье распределение',
                obvBullDiv: 'Бычья дивергенция', obvBearDiv: 'Медвежья дивергенция',
                obvDivergence: 'Дивергенция',
                obvRisingPriceUp: 'OBV растёт вместе с ценой — тренд подтверждён',
                obvFallingPriceDown: 'OBV падает вместе с ценой — давление продавцов',
                obvRisingPriceDown: 'OBV растёт, цена падает — возможный разворот вверх',
                obvFallingPriceUp: 'OBV падает, цена растёт — возможный разворот вниз',

                // CCI
                cciHint: 'Выше +100 — перекуплен, ниже −100 — перепродан, около 0 — норма',
                cciAboveAvg: 'Цена выше среднего', cciBelowAvg: 'Цена ниже среднего',
                noSignal: 'Нет чёткого сигнала',

                // VWAP
                vwapCurrentPrice: 'Текущая цена', vwapDeviation: 'Отклонение от VWAP',
                vwapHint: 'Выше VWAP — покупатели контролируют рынок, ниже — продавцы',
                aboveVwap: 'Цена выше VWAP', belowVwap: 'Цена ниже VWAP',

                // MFI
                mfiHint: 'RSI с учётом объёма — <20 перепродан, >80 перекуплен',

                // Общие сигналы
                overbought: 'Перекуплен', oversold: 'Перепродан',
                overboughtZone: 'Перекуплен', oversoldZone: 'Перепродан',
                overboughtShort: 'Перекуплен', oversoldShort: 'Перепродан',
                neutral: 'Нейтрально', neutralZone: 'Нейтральная зона',
                bullish: 'Бычий', bearish: 'Медвежий',
                badgeBullish2: 'Бычий', badgeBearish2: 'Медвежий',
                reversalUp: '↑ Возможен разворот вверх', reversalDown: '↓ Возможен разворот вниз',
                awaitNeutral: 'Ждём выхода из нейтральной зоны',

                // RSI/ZScore hints
                zscoreSigmaLabel: 'σ (откл.)', zscoreReturnLabel: 'Возврат к MA', hintCorrection: 'Возможна коррекция', hintUnclear: 'Направление неопределённо',
                zFarBelowMA: 'Сильно ниже СС', zBelowMA: 'Ниже скользящей средней',
                zFarAboveMA: 'Сильно выше СС', zAboveMA: 'Выше скользящей средней', zNearMA: 'Около СС',
                zHintFarBelow: 'Сильная недооценённость — исторически дно',
                zHintBelow: 'Ниже средней — возможна покупка',
                zHintFarAbove: 'Сильная переоценённость — риск коррекции',
                zHintAbove: 'Выше средней — осторожно',
                zHintNear: 'В норме — цена у средних значений',

                // Тултипы (подсказки ?)
                tipATR:   'Average True Range — средняя амплитуда движения цены за 14 свечей с учётом гэпов. Показывает волатильность рынка. Чем выше ATR — тем шире стоп-лосс нужно ставить.',
                tipEMA:   'Exponential Moving Average — скользящие средние. Когда EMA20 пересекает EMA50 снизу вверх — сигнал на покупку (Golden Cross). Сверху вниз — сигнал на продажу (Death Cross).',
                tipStoch: 'Stochastic RSI — показывает перекупленность и перепроданность. Выше 80 — перекуплен, возможен откат. Ниже 20 — перепродан, возможен отскок. %K пересекает %D снизу — покупка.',
                tipRSI:   'Relative Strength Index — индикатор силы тренда. Выше 70 — перекупленность. Ниже 30 — перепроданность. Дивергенция с ценой — сильный сигнал разворота.',
                tipBB:    'Полосы Боллинджера — каналы волатильности. Цена у верхней полосы — перекуплена. У нижней — перепродана. Сужение полос (сквиз) предвещает сильное движение.',
                tipMACD:  'Moving Average Convergence Divergence — разница быстрой и медленной EMA. Пересечение сигнальной линии снизу вверх — покупка. Сверху вниз — продажа. Гистограмма показывает силу сигнала.',
                tipFG:    'Индекс страха и жадности от 0 до 100. 0–25 — extreme fear (хорошее время для покупки). 75–100 — extreme greed (рынок перегрет). Составляется из волатильности, объёмов, соцсетей и опросов.',
                tipWillR: 'Осциллятор Уильямса — показывает положение цены относительно максимума за период. Выше −20 — перекуплен. Ниже −80 — перепродан. Похож на Stochastic, но шкала инвертирована.',
                tipOBV:   'On-Balance Volume — накопленный объём. Растёт когда объём в дни роста превышает объём в дни падения. Подтверждает тренд: если цена и OBV растут вместе — тренд сильный.',
                tipCCI:   'Commodity Channel Index — показывает отклонение цены от среднего. Выше +100 — сильный бычий тренд или перекупленность. Ниже −100 — медвежий тренд или перепроданность.',
                tipVWAP:  'Volume Weighted Average Price — средняя цена с учётом объёма. Если цена выше VWAP — рынок бычий, институционалы покупали дороже средней. Ниже — медвежий. Ключевой уровень для внутридневной торговли.',
                tipMFI:   'Money Flow Index — RSI с учётом объёма. Выше 80 — перекуплен, деньги выходят. Ниже 20 — перепродан, деньги входят. Дивергенция с ценой — сильный сигнал разворота.', fgFear: 'Страх', fgNeutral: 'Нейтрально',
                fgGreed: 'Жадность', fgExtGreed: 'Сильная жадность',
                fgBadgeFear: 'Страх', fgBadgeGreed: 'Жадность',
                fgExtFear: 'Сильный страх',
                emaCorrectionSub: 'EMA 20 и EMA 50 двигаются навстречу — возможна коррекция',
                hintReversalUp: 'Цена далеко ниже средней — возможен разворот вверх',
                ofInvestment: 'от инвестиций',
                chartError: 'Не удалось загрузить график',
                trades: 'сделок',

                // Уровни графика
                riskLow: 'Низкий', riskMedium: 'Средний', riskHigh: 'Высокий', riskCritical: 'Критический',

                // Индикаторы сводка
                indBullish: '🟢 Бычий', indBearish: '🔴 Медвежий', indNeutral: '◼ Нейтрально',

                // Новости (страница 3)
                page3Title: 'Крипто Новости', page3Sub: 'Актуальные события рынка',
                filterAll: 'Все',
                newsTitle: 'Новости', newsTrends: '🔥 Тренды', newsLatest: 'Последние новости',
                newsSentiment: 'Настроение рынка',
                newsBullish: '🐂 Бычьи', newsBearish: '🐻 Медвежьи', newsNeutral: '⚡ Нейтральные',
                newsToday: 'За сегодня', newsPositive: 'Позитивных', newsNegative: 'Негативных',
                newsTotal: 'Всего', newsArticles: 'новостей',
                newsMentions: 'Топ упоминаний', newsSources: 'Источники',
                donateHeader1: 'Сервис бесплатный и существует благодаря вам.',
                donateHeader2: 'Спасибо за поддержку!',
                donateSubtitle: 'Поддержать через кошелек:',
                donateCopy: 'Скопировать', donateCopied: '✓ Скопировано',
                fundingLongsPay: 'Лонги платят', fundingShortsPay: 'Шорты платят', fundingNeutral: 'Нейтрально',
                fundingIn: 'через', fundingH: 'ч', fundingM: 'м',
                timeJustNow: 'только что',
                newsReadMore: 'Читать далее →', newsPopular: 'Популярное', newsAllNews: 'Все новости ↗',
                promoBybit: 'Акция: рекомендуйте своим друзьям. Самая низкая ставка на рынке',
                promoBinance: 'Самая выгодная покупка криптовалюты. Скидка 0%. Топовые активы',
                promoRegister: 'Зарегистрироваться →',
                badgeBullish: '🐂 Бычий', badgeBearish: '🐻 Медвежий', badgeNeutral: '⚡ Нейтрально',
                badgeMain: '🔥 Главная новость',
                newsModalSentiment: 'Сентимент',
                timeMinAgo: 'мин назад', timeHAgo: 'ч назад', timeDayAgo: 'дн назад',
                newsFeedLoading: 'Загрузка...', newsFeedError: 'Ошибка загрузки',
            },
            en: {
                // UI общее
                loading: 'Loading...', loadingPrices: 'Loading prices...', noData: 'No data',
                refresh: 'Refresh', backToMenu: 'Back to menu', reset: 'Reset',
                calculator: 'Calculator', coinSelectTitle: 'Select coin',
                coinSearchPlaceholder: 'Search coin...', coinNotFound: 'Nothing found',

                // График
                chartTitle: 'Price Chart', chartLoading: 'Loading chart...',
                periodD1: '1D', periodD7: '7D', periodD30: '30D', periodD90: '90D',

                // Калькулятор — хаб
                calcTabSell: 'Spot', calcTabMargin: 'Margin', calcTabDca: 'DCA',
                hubDescSell: 'Profit, avg price, TP/SL',
                hubNameCompound: 'Compound %', hubDescCompound: 'Reinvestment & growth',
                hubDescMargin: 'Leverage, liquidation, long/short',
                hubNameRisk: 'Trade Risk', hubDescRisk: 'Position size by % of deposit',
                riskSub: 'Position size by % of deposit',
                labelDeposit: 'Deposit ($)', labelRiskPct: 'Risk (%)',
                labelStoploss: 'Stop-loss ($)', labelTakeprofit: 'Take-profit ($)',
                riskResultLabel: 'Position Size',
                riskCoins: 'Coins', riskDepositPct: '% of deposit',
                riskAmount: 'Risk amount', riskReward: 'Potential profit',
                riskRR: 'RR', riskRiskPct: 'Risk of deposit',
                riskTpStrategyOff: 'Show TP1/TP2/TP3 strategy',
                riskTpStrategyOn: 'Hide TP1/TP2/TP3 strategy',
                hubDescDca: 'Average price on top-ups',
                hubNameBreakeven: 'Breakeven', hubDescBreakeven: 'Zero-exit with fee',
                hubNamePossize: 'Position Size', hubDescPossize: 'Coins by deposit & leverage',
                hubNameFunding: 'Funding', hubDescFunding: 'Futures holding cost',
                hubNameConverter: 'Converter', hubDescConverter: 'Crypto ↔ fiat by rate',
                hubNamePnlgrid: 'Grid PnL', hubDescPnlgrid: 'Grid bot profit',
                hubNameSavings: 'Savings', hubDescSavings: 'Months until goal',

                // Заглушки
                stubDescRisk: 'Coming soon. Position size calculation by % of deposit and stop-loss.',
                stubDescDca: 'Coming soon. Average entry price across multiple buys.',
                stubDescBreakeven: 'Coming soon. Break-even exit point including exchange fee.',
                stubDescPossize: 'Coming soon. Number of coins by deposit, price and leverage.',
                stubDescFunding: 'Coming soon. Cost of holding a futures position.',
                stubDescConverter: 'Coming soon. Crypto ↔ fiat at current rate.',
                stubDescPnlgrid: 'Coming soon. Grid bot profit by range and step.',
                stubDescSavings: 'Coming soon. Months needed to reach your goal.',

                // Форма продажи
                addEntry: '+ Add', labelProfitPct: 'Profit percent (%)',
                labelSellPrice: 'Sell price ($)', labelBuys: 'Buys',
                labelAmount: 'Amount ($)', labelPrice: 'Price ($)',

                // Сложный %
                compoundGrowthBtn: '📈 Growth forecast', compoundGoalBtn: '🎯 Reach goal',
                compoundGrowthTitle: 'Growth Forecast', compoundGrowthSub: 'Reinvestment with risk adjustment',
                compoundGoalTitle: 'Reach Goal', compoundGoalSub: 'How many trades to reach target',
                labelInvestment: 'Investment amount ($)', labelProfitRate: 'Profit %',
                labelLossRate: 'Loss %', labelTradesCount: 'Number of trades',
                labelWinRate: 'Win rate %', labelFee: 'Exchange fee (%)',
                labelGoalFrom: 'Starting ($)', labelGoalTo: 'Target ($)', labelGoalRate: 'Percent per trade (%)',
                goalAt: 'At', goalPerTrade: 'per trade',
                goalTableTitle: 'Trades needed at different %',
                goalNote: '* ideal scenario, no fees or losses',

                // Маржа
                marginTitle: 'Margin Trading', marginSub: 'Leverage, entry and exit',
                labelCollateral: 'Collateral ($)', labelLeverage: 'Leverage (x)',
                labelEntryPrice: 'Entry price ($)', labelExitPrice: 'Exit price ($)',
                entryLabel: 'Entry', liqLabel: 'Liquidation',
                avgBuyLabel: 'Avg. Buy', sellPriceLabel: 'Sell Price',
                exitLabel: 'Exit Price', stopLossLabel: 'Stop Loss', takeProfitLabel: 'Take Profit',

                // Результаты
                resultLabelSell: 'Total on exit', resultLabelCompound: 'Final capital',
                resultLabelGoal: 'To reach goal', resultLabelLiq: 'Liquidation price',
                resultLabelTrade: 'Trade result',
                statProfit: 'Profit', statYield: 'Return', statInitial: 'Initial',
                statInRubles: 'In RUB', statStart: 'Start', statGoal: 'Goal',
                statGrowth: 'Growth', statPerTrade: '% per trade',
                statPosition: 'Position', statToLiq: 'To liquidation', statRisk: 'Risk',
                statTotal: 'Total', statRoiCollateral: 'ROI (vs collateral)',
                statPriceChange: 'Price change',
                avgEntryPrice: 'Average entry price',
                avgPrice: 'Avg price', avgCoins: 'Total coins', avgInvested: 'Total invested',
                tpStrategyLabel: 'By TP strategy',
                progressTitle: 'Progress to goal', progressRemaining: 'Remaining: $0',
                progressEnterSell: 'Enter sell price', progressEnterExit: 'Enter exit price',
                goalAchieved: 'Goal achieved!',
                remaining: 'Remaining',

                // TP/SL
                tpslTitle: 'TP / SL', tpslTitle2: '📈 Exit levels',
                rrLabel: 'Target RR', tpslHint: 'SL calculated from TP1 and target RR',

                // Страница 2
                page2Title: 'Technical Indicators', page2Sub: 'Advanced market analysis',
                indLoading: '⏳ Loading...', indTotal: 'Total:',
                coinSearch2Placeholder: 'Search coin...',

                // Индикаторы — общие
                rowSignal: 'Signal', rowZone: 'Zone', rowConsensus: 'Consensus',
                rowDivergence: 'Divergence RSI 7/21', rowDivergenceShort: 'Divergence',
                scalePrice: 'Price',

                // ATR
                atrVsAvgLabel: 'Volatility vs norm', atrMinSlLabel: 'Min SL (×1.5 ATR)',
                atrRangeLabel: 'Max / Min over 14d',
                atrHint: 'Average True Range — price movement amplitude including gaps',
                ofPrice: 'of price', volHigh: 'High', volLow: 'Low', volModerate: 'Moderate',

                // EMA
                emaPriceVs20: 'Price vs EMA 20', emaPriceVs50: 'Price vs EMA 50',
                emaHint: 'Golden Cross / Death Cross — key trend reversal signals',
                emaGoldenSub: 'EMA 20 crossed EMA 50 upward', emaDeathSub: 'EMA 20 crossed EMA 50 downward',
                emaCorrection: 'Correction', emaNeutralSub: 'EMA 20 and EMA 50 are close — no clear trend',

                // Stoch RSI
                stochHint: '%K crosses %D from below — buy, from above — sell',
                bullCross: 'Bullish cross', bearCross: 'Bearish cross',
                above: 'above', below: 'below',

                // RSI Extended
                rsiExtPeriod: 'extended',
                rsiExtHint: 'Three periods give a more reliable signal than a single RSI',

                // Bollinger
                bbLower: 'Lower', bbUpper: 'Upper', bbBandwidth: 'Bandwidth',
                bbUpperBand: 'Upper band', bbLowerBand: 'Lower band',
                bbHint: 'Band squeeze — calm before a move; touch — possible reversal',
                bbAboveUpper: 'Price above upper band', bbBelowLower: 'Price below lower band',
                bbNearUpper: 'Price near upper band', bbNearLower: 'Price near lower band',
                bbSqueeze: 'Squeeze', bbInside: 'Inside bands',

                // MACD
                macdSignalLine: 'Signal', macdHistogram: 'Histogram', macdMomentum: 'Momentum',
                macdHint: 'MACD and signal line crossover — key entry signal',
                bullishCross: 'Bullish cross', bearishCross: 'Bearish cross',
                bullishMomentum: 'Bullish momentum', bearishMomentum: 'Bearish momentum',
                macdAboveSignal: 'MACD above signal line', macdBelowSignal: 'MACD below signal line',
                macdCrossUp: 'MACD crossed signal upward', macdCrossDown: 'MACD crossed signal downward',

                // Williams %R
                willrHint: '−80 and below — oversold, −20 and above — overbought',

                // OBV
                obvPeriod: 'volume', obvTrend: 'OBV trend',
                obvHint: 'Volume confirms movement — OBV rising with price = trend strength',
                obvBullAccum: 'Bullish accumulation', obvBearDist: 'Bearish distribution',
                obvBullDiv: 'Bullish divergence', obvBearDiv: 'Bearish divergence',
                obvDivergence: 'Divergence',
                obvRisingPriceUp: 'OBV rising with price — trend confirmed',
                obvFallingPriceDown: 'OBV falling with price — selling pressure',
                obvRisingPriceDown: 'OBV rising, price falling — possible reversal up',
                obvFallingPriceUp: 'OBV falling, price rising — possible reversal down',

                // CCI
                cciHint: 'Above +100 — overbought, below −100 — oversold, near 0 — normal',
                cciAboveAvg: 'Price above average', cciBelowAvg: 'Price below average',
                noSignal: 'No clear signal',

                // VWAP
                vwapCurrentPrice: 'Current price', vwapDeviation: 'Deviation from VWAP',
                vwapHint: 'Above VWAP — buyers control market, below — sellers',
                aboveVwap: 'Price above VWAP', belowVwap: 'Price below VWAP',

                // MFI
                mfiHint: 'Volume-weighted RSI — <20 oversold, >80 overbought',

                // Общие сигналы
                overbought: 'Overbought', oversold: 'Oversold',
                overboughtZone: 'Overbought', oversoldZone: 'Oversold',
                overboughtShort: 'Overbought', oversoldShort: 'Oversold',
                neutral: 'Neutral', neutralZone: 'Neutral zone',
                bullish: 'Bullish', bearish: 'Bearish',
                badgeBullish2: 'Bullish', badgeBearish2: 'Bearish',
                reversalUp: '↑ Possible reversal up', reversalDown: '↓ Possible reversal down',
                awaitNeutral: 'Waiting for breakout from neutral zone',

                // RSI/ZScore hints
                zscoreSigmaLabel: 'σ (std dev)', zscoreReturnLabel: 'Return to MA', hintCorrection: 'Possible correction', hintUnclear: 'Direction unclear',
                zFarBelowMA: 'Far below MA', zBelowMA: 'Below moving average',
                zFarAboveMA: 'Far above MA', zAboveMA: 'Above moving average', zNearMA: 'Near MA',
                zHintFarBelow: 'Strongly undervalued — historically a bottom',
                zHintBelow: 'Below average — possible buy',
                zHintFarAbove: 'Strongly overvalued — correction risk',
                zHintAbove: 'Above average — caution',
                zHintNear: 'Normal — price near average values',

                // Тултипы (подсказки ?)
                tipATR:   'Average True Range — average price movement amplitude over 14 candles including gaps. Shows market volatility. The higher the ATR, the wider the stop-loss should be.',
                tipEMA:   'Exponential Moving Average — moving averages. When EMA20 crosses EMA50 upward — buy signal (Golden Cross). Downward — sell signal (Death Cross).',
                tipStoch: 'Stochastic RSI — shows overbought and oversold conditions. Above 80 — overbought, possible pullback. Below 20 — oversold, possible bounce. %K crosses %D from below — buy.',
                tipRSI:   'Relative Strength Index — trend strength indicator. Above 70 — overbought. Below 30 — oversold. Divergence with price — strong reversal signal.',
                tipBB:    'Bollinger Bands — volatility channels. Price near upper band — overbought. Near lower — oversold. Band squeeze predicts a strong move.',
                tipMACD:  'Moving Average Convergence Divergence — difference between fast and slow EMA. Signal line crossover upward — buy. Downward — sell. Histogram shows signal strength.',
                tipFG:    'Fear & Greed Index from 0 to 100. 0–25 — extreme fear (good time to buy). 75–100 — extreme greed (market overheated). Composed of volatility, volume, social media and surveys.',
                tipWillR: 'Williams %R oscillator — shows price position relative to period high. Above −20 — overbought. Below −80 — oversold. Similar to Stochastic but inverted scale.',
                tipOBV:   'On-Balance Volume — cumulative volume. Rises when volume on up days exceeds volume on down days. Confirms trend: if price and OBV rise together — trend is strong.',
                tipCCI:   'Commodity Channel Index — shows price deviation from average. Above +100 — strong bullish trend or overbought. Below −100 — bearish trend or oversold.',
                tipVWAP:  'Volume Weighted Average Price — average price weighted by volume. If price is above VWAP — market is bullish, institutions bought above average. Below — bearish. Key level for intraday trading.',
                tipMFI:   'Money Flow Index — RSI weighted by volume. Above 80 — overbought, money leaving. Below 20 — oversold, money entering. Divergence with price — strong reversal signal.', fgFear: 'Fear', fgNeutral: 'Neutral',
                fgGreed: 'Greed', fgExtGreed: 'Extreme Greed',
                fgBadgeFear: 'Fear', fgBadgeGreed: 'Greed',
                fgExtFear: 'Extreme Fear',
                emaCorrectionSub: 'EMA 20 and EMA 50 converging — possible correction',
                hintReversalUp: 'Price is far below average — possible reversal up',
                ofInvestment: 'of investment',
                chartError: 'Failed to load chart',
                trades: 'trades',

                // Уровни графика
                riskLow: 'Low', riskMedium: 'Medium', riskHigh: 'High', riskCritical: 'Critical',

                // Индикаторы сводка
                indBullish: '🟢 Bullish', indBearish: '🔴 Bearish', indNeutral: '◼ Neutral',

                // Новости (страница 3)
                page3Title: 'Crypto News', page3Sub: 'Latest market events',
                filterAll: 'All',
                newsTitle: 'News', newsTrends: '🔥 Trends', newsLatest: 'Latest News',
                newsSentiment: 'Market Sentiment',
                newsBullish: '🐂 Bullish', newsBearish: '🐻 Bearish', newsNeutral: '⚡ Neutral',
                newsToday: 'Today', newsPositive: 'Positive', newsNegative: 'Negative',
                newsTotal: 'Total', newsArticles: 'articles',
                newsMentions: 'Top mentions', newsSources: 'Sources',
                donateHeader1: 'This service is free and exists thanks to you.',
                donateHeader2: 'Thank you for your support!',
                donateSubtitle: 'Support via wallet:',
                donateCopy: 'Copy', donateCopied: '✓ Copied',
                fundingLongsPay: 'Longs pay', fundingShortsPay: 'Shorts pay', fundingNeutral: 'Neutral',
                fundingIn: 'in', fundingH: 'h', fundingM: 'm',
                timeJustNow: 'just now',
                newsReadMore: 'Read more →', newsPopular: 'Popular', newsAllNews: 'All news ↗',
                promoBybit: 'Promotion: refer your friends. Lowest rate on the market',
                promoBinance: 'Best crypto exchange. 0% discount. Top assets',
                promoRegister: 'Register →',
                badgeBullish: '🐂 Bullish', badgeBearish: '🐻 Bearish', badgeNeutral: '⚡ Neutral',
                badgeMain: '🔥 Top Story',
                newsModalSentiment: 'Sentiment',
                timeMinAgo: 'min ago', timeHAgo: 'h ago', timeDayAgo: 'd ago',
                newsFeedLoading: 'Loading...', newsFeedError: 'Load error',
            }
        };

        let currentLang = localStorage.getItem('cryptopro_lang') || 'en';

        // Shorthand: get translation string by key
        function t(key) {
            return (TRANSLATIONS[currentLang] || TRANSLATIONS.ru)[key] || key;
        }
        // Список монет и иконок
        const COINS = [
            { id: 'bitcoin',              name: 'Bitcoin',           symbol: 'BTC'  },
            { id: 'ethereum',             name: 'Ethereum',          symbol: 'ETH'  },
            { id: 'binancecoin',          name: 'Binance Coin',      symbol: 'BNB'  },
            { id: 'solana',               name: 'Solana',            symbol: 'SOL'  },
            { id: 'ripple',               name: 'XRP',               symbol: 'XRP'  },
            { id: 'cardano',              name: 'Cardano',           symbol: 'ADA'  },
            { id: 'avalanche-2',          name: 'Avalanche',         symbol: 'AVAX' },
            { id: 'dogecoin',             name: 'Dogecoin',          symbol: 'DOGE' },
            { id: 'polkadot',             name: 'Polkadot',          symbol: 'DOT'  },
            { id: 'matic-network',        name: 'Polygon',           symbol: 'MATIC'},
            { id: 'shiba-inu',            name: 'Shiba Inu',         symbol: 'SHIB' },
            { id: 'tron',                 name: 'TRON',              symbol: 'TRX'  },
            { id: 'litecoin',             name: 'Litecoin',          symbol: 'LTC'  },
            { id: 'chainlink',            name: 'Chainlink',         symbol: 'LINK' },
            { id: 'uniswap',              name: 'Uniswap',           symbol: 'UNI'  },
            { id: 'stellar',              name: 'Stellar',           symbol: 'XLM'  },
            { id: 'monero',               name: 'Monero',            symbol: 'XMR'  },
            { id: 'ethereum-classic',     name: 'Ethereum Classic',  symbol: 'ETC'  },
            { id: 'near',                 name: 'NEAR Protocol',     symbol: 'NEAR' },
            { id: 'cosmos',               name: 'Cosmos',            symbol: 'ATOM' },
            { id: 'algorand',             name: 'Algorand',          symbol: 'ALGO' },
            { id: 'vechain',              name: 'VeChain',           symbol: 'VET'  },
            { id: 'internet-computer',    name: 'Internet Computer', symbol: 'ICP'  },
            { id: 'aptos',                name: 'Aptos',             symbol: 'APT'  },
            { id: 'arbitrum',             name: 'Arbitrum',          symbol: 'ARB'  },
            { id: 'optimism',             name: 'Optimism',          symbol: 'OP'   },
            { id: 'filecoin',             name: 'Filecoin',          symbol: 'FIL'  },
            { id: 'the-sandbox',          name: 'The Sandbox',       symbol: 'SAND' },
            { id: 'decentraland',         name: 'Decentraland',      symbol: 'MANA' },
            { id: 'aave',                 name: 'Aave',              symbol: 'AAVE' },
            { id: 'pepe',                 name: 'Pepe',              symbol: 'PEPE' },
            { id: 'sui',                  name: 'Sui',               symbol: 'SUI'  },
            { id: 'toncoin',              name: 'Toncoin',           symbol: 'TON'  },
            { id: 'fetch-ai',             name: 'Fetch.ai',          symbol: 'FET'  },
            { id: 'injective-protocol',   name: 'Injective',         symbol: 'INJ'  },
            { id: 'render-token',         name: 'Render',            symbol: 'RNDR' },
            { id: 'sei-network',          name: 'Sei',               symbol: 'SEI'  },
            { id: 'worldcoin-wld',        name: 'Worldcoin',         symbol: 'WLD'  },
            { id: 'bonk',                 name: 'Bonk',              symbol: 'BONK' },
            { id: 'floki',                name: 'Floki',             symbol: 'FLOKI'},
            { id: 'kaspa',                name: 'Kaspa',             symbol: 'KAS'  },
            { id: 'jupiter-exchange-solana', name: 'Jupiter',        symbol: 'JUP'  },
            { id: 'celestia',             name: 'Celestia',          symbol: 'TIA'  },
            { id: 'starknet',             name: 'Starknet',          symbol: 'STRK' },
            { id: 'mantle',               name: 'Mantle',            symbol: 'MNT'  },
            { id: 'immutable-x',          name: 'Immutable',         symbol: 'IMX'  },
            { id: 'blur',                 name: 'Blur',              symbol: 'BLUR' },
            { id: 'maker',                name: 'Maker',             symbol: 'MKR'  },
            { id: 'lido-dao',             name: 'Lido DAO',          symbol: 'LDO'  },
            { id: 'curve-dao-token',      name: 'Curve',             symbol: 'CRV'  },
        ];

        // Маппинг CoinGecko ID → символ Binance для TradingView
        const TV_SYMBOLS = {
            'bitcoin':                'BINANCE:BTCUSDT',
            'ethereum':               'BINANCE:ETHUSDT',
            'binancecoin':            'BINANCE:BNBUSDT',
            'solana':                 'BINANCE:SOLUSDT',
            'ripple':                 'BINANCE:XRPUSDT',
            'cardano':                'BINANCE:ADAUSDT',
            'avalanche-2':            'BINANCE:AVAXUSDT',
            'dogecoin':               'BINANCE:DOGEUSDT',
            'polkadot':               'BINANCE:DOTUSDT',
            'matic-network':          'BINANCE:MATICUSDT',
            'shiba-inu':              'BINANCE:SHIBUSDT',
            'tron':                   'BINANCE:TRXUSDT',
            'litecoin':               'BINANCE:LTCUSDT',
            'chainlink':              'BINANCE:LINKUSDT',
            'uniswap':                'BINANCE:UNIUSDT',
            'stellar':                'BINANCE:XLMUSDT',
            'monero':                 'BINANCE:XMRUSDT',
            'ethereum-classic':       'BINANCE:ETCUSDT',
            'near':                   'BINANCE:NEARUSDT',
            'cosmos':                 'BINANCE:ATOMUSDT',
            'algorand':               'BINANCE:ALGOUSDT',
            'vechain':                'BINANCE:VETUSDT',
            'internet-computer':      'BINANCE:ICPUSDT',
            'aptos':                  'BINANCE:APTUSDT',
            'arbitrum':               'BINANCE:ARBUSDT',
            'optimism':               'BINANCE:OPUSDT',
            'filecoin':               'BINANCE:FILUSDT',
            'the-sandbox':            'BINANCE:SANDUSDT',
            'decentraland':           'BINANCE:MANAUSDT',
            'aave':                   'BINANCE:AAVEUSDT',
            'pepe':                   'BINANCE:PEPEUSDT',
            'sui':                    'BINANCE:SUIUSDT',
            'toncoin':                'BINANCE:TONUSDT',
            'fetch-ai':               'BINANCE:FETUSDT',
            'injective-protocol':     'BINANCE:INJUSDT',
            'render-token':           'BINANCE:RENDERUSDT',
            'sei-network':            'BINANCE:SEIUSDT',
            'worldcoin-wld':          'BINANCE:WLDUSDT',
            'bonk':                   'BINANCE:BONKUSDT',
            'floki':                  'BINANCE:FLOKIUSDT',
            'kaspa':                  'BINANCE:KASUSDT',
            'jupiter-exchange-solana':'BINANCE:JUPUSDT',
            'celestia':               'BINANCE:TIAUSDT',
            'starknet':               'BINANCE:STRKUSDT',
            'mantle':                 'BINANCE:MNTUSDT',
            'immutable-x':            'BINANCE:IMXUSDT',
            'blur':                   'BINANCE:BLURUSDT',
            'maker':                  'BINANCE:MKRUSDT',
            'lido-dao':               'BINANCE:LDOUSDT',
            'curve-dao-token':        'BINANCE:CRVUSDT',
        };

        function updateTVChart(coinId) {
            const symbol = TV_SYMBOLS[coinId] || 'BINANCE:BTCUSDT';
            const wrap = document.getElementById('tvChartWrap');
            // Удаляем старый виджет
            wrap.innerHTML = '';
            // Создаём новый контейнер
            const container = document.createElement('div');
            container.className = 'tradingview-widget-container';
            container.style.height = '100%';
            const widget = document.createElement('div');
            widget.className = 'tradingview-widget-container__widget';
            widget.style.height = '100%';
            container.appendChild(widget);
            const script = document.createElement('script');
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                autosize: true,
                symbol,
                interval: 'D',
                timezone: 'Europe/Moscow',
                theme: 'dark',
                style: '1',
                locale: currentLang === 'ru' ? 'ru' : 'en',
                hide_top_toolbar: false,
                hide_legend: false,
                save_image: false,
                support_host: 'https://www.tradingview.com',
                backgroundColor: 'rgba(17, 25, 40, 1)',
                gridLineColor: 'rgba(255, 255, 255, 0.04)',
                textColor: '#475569',
            });
            container.appendChild(script);
            wrap.appendChild(container);
        }

        const ICONS = {
            'bitcoin':                'https://assets.coingecko.com/coins/images/1/small/bitcoin.png',
            'ethereum':               'https://assets.coingecko.com/coins/images/279/small/ethereum.png',
            'binancecoin':            'https://assets.coingecko.com/coins/images/825/small/bnb-icon2_2x.png',
            'solana':                 'https://assets.coingecko.com/coins/images/4128/small/solana.png',
            'ripple':                 'https://assets.coingecko.com/coins/images/44/small/xrp-symbol-white-128.png',
            'cardano':                'https://assets.coingecko.com/coins/images/975/small/cardano.png',
            'avalanche-2':            'https://assets.coingecko.com/coins/images/12559/small/Avalanche_Circle_RedWhite_Trans.png',
            'dogecoin':               'https://assets.coingecko.com/coins/images/5/small/dogecoin.png',
            'polkadot':               'https://assets.coingecko.com/coins/images/12171/small/polkadot.png',
            'matic-network':          'https://assets.coingecko.com/coins/images/4713/small/matic-token-icon.png',
            'shiba-inu':              'https://assets.coingecko.com/coins/images/11939/small/shiba.png',
            'tron':                   'https://assets.coingecko.com/coins/images/1094/small/tron-logo.png',
            'litecoin':               'https://assets.coingecko.com/coins/images/2/small/litecoin.png',
            'chainlink':              'https://assets.coingecko.com/coins/images/877/small/chainlink-new-logo.png',
            'uniswap':                'https://assets.coingecko.com/coins/images/12504/small/uniswap-uni.png',
            'stellar':                'https://assets.coingecko.com/coins/images/100/small/Stellar_symbol_black_RGB.png',
            'monero':                 'https://assets.coingecko.com/coins/images/69/small/monero_logo.png',
            'ethereum-classic':       'https://assets.coingecko.com/coins/images/453/small/ethereum-classic-logo.png',
            'near':                   'https://assets.coingecko.com/coins/images/10365/small/near.jpg',
            'cosmos':                 'https://assets.coingecko.com/coins/images/1481/small/cosmos_hub.png',
            'algorand':               'https://assets.coingecko.com/coins/images/4380/small/download.png',
            'vechain':                'https://assets.coingecko.com/coins/images/1167/small/VeChain-Logo-768x768.png',
            'internet-computer':      'https://assets.coingecko.com/coins/images/14495/small/Internet_Computer_logo.png',
            'aptos':                  'https://assets.coingecko.com/coins/images/26455/small/aptos_round.png',
            'arbitrum':               'https://assets.coingecko.com/coins/images/16547/small/photo_2023-03-29_18.09.09.jpeg',
            'optimism':               'https://assets.coingecko.com/coins/images/25244/small/Optimism.png',
            'filecoin':               'https://assets.coingecko.com/coins/images/12817/small/filecoin.png',
            'the-sandbox':            'https://assets.coingecko.com/coins/images/12129/small/sandbox_logo.jpg',
            'decentraland':           'https://assets.coingecko.com/coins/images/9343/small/Decentraland-MANA.png',
            'aave':                   'https://assets.coingecko.com/coins/images/12645/small/AAVE.png',
            'pepe':                   'https://assets.coingecko.com/coins/images/29850/small/pepe-token.jpeg',
            'sui':                    'https://assets.coingecko.com/coins/images/26375/small/sui_asset.jpeg',
            'toncoin':                'https://assets.coingecko.com/coins/images/17980/small/ton_symbol.png',
            'fetch-ai':               'https://assets.coingecko.com/coins/images/5681/small/Fetch.jpg',
            'injective-protocol':     'https://assets.coingecko.com/coins/images/12882/small/Secondary_Symbol.png',
            'render-token':           'https://assets.coingecko.com/coins/images/11636/small/rndr.png',
            'sei-network':            'https://assets.coingecko.com/coins/images/28205/small/Sei_Logo_-_Transparent.png',
            'worldcoin-wld':          'https://assets.coingecko.com/coins/images/31069/small/worldcoin.jpeg',
            'bonk':                   'https://assets.coingecko.com/coins/images/28600/small/bonk.jpg',
            'floki':                  'https://assets.coingecko.com/coins/images/16746/small/PNG_image.png',
            'kaspa':                  'https://assets.coingecko.com/coins/images/25751/small/kaspa-icon-exchanges.png',
            'jupiter-exchange-solana':'https://assets.coingecko.com/coins/images/34188/small/jup.png',
            'celestia':               'https://assets.coingecko.com/coins/images/31967/small/tia.jpg',
            'starknet':               'https://assets.coingecko.com/coins/images/26433/small/starknet.png',
            'mantle':                 'https://assets.coingecko.com/coins/images/30980/small/token-logo.png',
            'immutable-x':            'https://assets.coingecko.com/coins/images/17233/small/imx.png',
            'blur':                   'https://assets.coingecko.com/coins/images/28453/small/blur.png',
            'maker':                  'https://assets.coingecko.com/coins/images/1364/small/Mark_Maker.png',
            'lido-dao':               'https://assets.coingecko.com/coins/images/13573/small/Lido_DAO.png',
            'curve-dao-token':        'https://assets.coingecko.com/coins/images/12124/small/Curve.png',
        };

        // Состояние
        let selectedCoin = COINS[0];
        let entryCount = 0;
        let isUpdatingFromPercent = false;
        let isUpdatingFromPrice = false;
        let lwChart      = null;   // Lightweight Charts instance
        let lwSeries     = null;   // активная серия (area или candlestick)
        let lwLevelLines = [];     // массив priceLine объектов
        let currentPeriod = 1;
        let usdToRub = 77;
        let currentCoinPrice = null;
        let marginDirection = 'long'; // 'long' or 'short'
        let riskTpStrategyMode   = false;
        let sellTpStrategyMode   = false;
        let marginTpStrategyMode = false;

        // DOM элементы
        const buyEntriesContainer = document.getElementById('buyEntries');
        const sellPriceInput = document.getElementById('sellPrice');
        const profitPercentInput = document.getElementById('profitPercent');
        const entriesCountEl = document.getElementById('entriesCount');
        const addButton = document.getElementById('addBuyEntry');
        const resetButton = document.getElementById('resetButton');
        const currentPriceSpan = document.getElementById('currentPrice');
        const priceChangeBadge = document.getElementById('priceChangeBadge');
        const lwChartContainer = document.getElementById('lwPriceChart');
        const chartLoading = document.getElementById('chartLoading');
        const periodButtons = document.querySelectorAll('.period-btn');
        const avgPositionPrice = document.getElementById('avgPositionPrice');
        const avgPositionCoins = document.getElementById('avgPositionCoins');
        const avgPositionInvested = document.getElementById('avgPositionInvested');
        // ── Coin Selector ──────────────────────────────────
        const trigger = document.getElementById('coinSelectTrigger');
        const dropdown = document.getElementById('coinDropdown');
        const dropdownList = document.getElementById('coinDropdownList');
        const coinSearchDesktop = document.getElementById('coinSearchDesktop');
        const selIcon = document.getElementById('selectedCoinIcon');
        const selName = document.getElementById('selectedCoinName');
        const wrapper = document.getElementById('coinSelectWrapper');

        // Bottom sheet elements — move overlay to body for proper stacking
        const sheetOverlay = document.getElementById('coinSheetOverlay');
        const sheet = document.getElementById('coinSheet');
        const coinSearchMobile = document.getElementById('coinSearchMobile');
        const sheetList = document.getElementById('coinSheetList');
        const sheetClose = document.getElementById('coinSheetClose');
        document.body.appendChild(sheetOverlay);

        const isMobile = () => window.innerWidth <= 768;

        // Build coin list into a given container, filtered by query
        function renderCoinOptions(container, query, onSelect) {
            const q = (query || '').toLowerCase().trim();
            const filtered = COINS.filter(c =>
                !q || c.name.toLowerCase().includes(q) || c.symbol.toLowerCase().includes(q)
            );
            container.innerHTML = '';
            if (!filtered.length) {
                container.innerHTML = `<div class="coin-dropdown-empty">${t('coinNotFound')}</div>`;
                return;
            }
            filtered.forEach(coin => {
                const opt = document.createElement('div');
                opt.className = 'coin-option' + (coin.id === selectedCoin.id ? ' selected' : '');
                opt.innerHTML = `
                    <img src="${ICONS[coin.id]}" alt="${coin.symbol}" onerror="this.style.display='none'">
                    <div class="coin-option-info">
                        <span class="coin-option-name">${coin.name}</span>
                        <span class="coin-option-symbol">${coin.symbol}</span>
                    </div>
                `;
                opt.addEventListener('click', () => onSelect(coin, opt, container));
                container.appendChild(opt);
            });
        }

        function selectCoin(coin) {
            selectedCoin = coin;
            selIcon.src = ICONS[coin.id];
            selName.textContent = `${coin.name} (${coin.symbol})`;
            // Синхронизируем дропдаун стр.2
            const icon2 = document.getElementById('selectedCoinIcon2');
            const name2 = document.getElementById('selectedCoinName2');
            if (icon2) icon2.src = ICONS[coin.id] || '';
            if (name2) name2.textContent = `${coin.name} (${coin.symbol})`;
            priceChangeBadge.className = 'price-change-badge';
            priceChangeBadge.textContent = '';
            window._tpslChartPrices = null;
            window._ema90closes = null;
            _indCache = null; // сброс кэша индикаторов при смене монеты
            updateTVChart(coin.id);
            updateCurrentPrice();
            // Загружаем кэш один раз — все индикаторы возьмут данные из него
            ensureIndCache(coin.id).then(() => {
                loadATR();
                loadEMA().then(() => {
                    loadStochRSI();
                    loadRSIExt();
                    loadBB();
                    loadMACD();
                    loadWilliamsR();
                    loadOBV();
                    loadCCI();
                    loadVWAP();
                    loadMFI();
                    scheduleIndSummaryUpdate();
                });
            });
            // Обновляем Funding Rate и OI для новой монеты
            if (typeof loadMarketPulse === 'function') {
                const bar = document.getElementById('marketPulseBar');
                if (bar) bar.style.display = 'flex';
                setTimeout(loadMarketPulse, 300);
            }
        }

        // ── Desktop dropdown ──
        function buildDropdown(q) {
            renderCoinOptions(dropdownList, q, (coin, opt, container) => {
                container.querySelectorAll('.coin-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                closeDropdown();
                selectCoin(coin);
            });
        }

        function openDropdown() {
            if (isMobile()) { openSheet(); return; }
            dropdown.classList.add('open');
            trigger.classList.add('open');
            coinSearchDesktop.value = '';
            buildDropdown('');
            setTimeout(() => coinSearchDesktop.focus(), 50);
        }
        function closeDropdown() {
            dropdown.classList.remove('open');
            trigger.classList.remove('open');
        }

        coinSearchDesktop.addEventListener('input', () => buildDropdown(coinSearchDesktop.value));
        coinSearchDesktop.addEventListener('click', e => e.stopPropagation());

        trigger.addEventListener('click', e => {
            e.stopPropagation();
            dropdown.classList.contains('open') ? closeDropdown() : openDropdown();
        });
        document.addEventListener('click', e => {
            if (!wrapper.contains(e.target)) closeDropdown();
        });

        // ── Mobile bottom sheet ──
        function openSheet() {
            sheetOverlay.classList.add('open');
            // tiny delay so overlay renders first, then animate sheet in
            requestAnimationFrame(() => requestAnimationFrame(() => sheet.classList.add('open')));
            coinSearchMobile.value = '';
            buildSheet('');
            setTimeout(() => coinSearchMobile.focus(), 350);
        }
        function closeSheet() {
            sheet.classList.remove('open');
            setTimeout(() => sheetOverlay.classList.remove('open'), 380);
        }

        function buildSheet(q) {
            renderCoinOptions(sheetList, q, (coin, opt, container) => {
                container.querySelectorAll('.coin-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                closeSheet();
                selectCoin(coin);
            });
        }

        coinSearchMobile.addEventListener('input', () => buildSheet(coinSearchMobile.value));
        sheetClose.addEventListener('click', closeSheet);
        sheetOverlay.addEventListener('click', e => { if (e.target === sheetOverlay) closeSheet(); });

        // Swipe down to close sheet
        let sheetTouchY = 0;
        sheet.addEventListener('touchstart', e => { sheetTouchY = e.touches[0].clientY; }, { passive: true });
        sheet.addEventListener('touchend', e => {
            if (e.changedTouches[0].clientY - sheetTouchY > 60) closeSheet();
        }, { passive: true });
        const progressToGoal = document.getElementById('progressToGoal');
        const goalPriceEl = document.getElementById('goalPrice');
        const progressPercent = document.getElementById('progressPercent');
        const progressBarFill = document.getElementById('progressBarFill');
        const progressInfo = document.getElementById('progressInfo');

        // Элементы результата продажи
        const totalAmountEl = document.getElementById('totalAmount');
        const profitAmountEl = document.getElementById('profitAmount');
        const profitAmountRubEl = document.getElementById('profitAmountRub');
        const profitPercentDisplayEl = document.getElementById('profitPercentDisplay');
        const avgPriceEl = document.getElementById('avgPrice');

        // Compound элементы
        const compoundInvestmentInput = document.getElementById('compoundInvestment');
        const compoundRateInput = document.getElementById('compoundRate');
        const compoundLossInput = document.getElementById('compoundLoss');
        const compoundTradesInput = document.getElementById('compoundTrades');
        const compoundWinRateInput = document.getElementById('compoundWinRate');
        const compoundFeeInput = document.getElementById('compoundFee');
        const compoundTotalDisplay = document.getElementById('compoundTotalDisplay');
        const compoundInitialDisplay = document.getElementById('compoundInitialDisplay');
        const compoundProfitDisplay = document.getElementById('compoundProfitDisplay');
        const compoundROIDisplay = document.getElementById('compoundROIDisplay');
        const compoundRubDisplay = document.getElementById('compoundRubDisplay');
        // Goal mode элементы
        const goalFromInput = document.getElementById('goalFrom');
        const goalToInput = document.getElementById('goalTo');
        const goalRateInput = document.getElementById('goalRate');
        const goalTradesDisplay = document.getElementById('goalTradesDisplay');
        const goalFromDisplay = document.getElementById('goalFromDisplay');
        const goalToDisplay = document.getElementById('goalToDisplay');
        const goalGrowthDisplay = document.getElementById('goalGrowthDisplay');
        const goalRateDisplay = document.getElementById('goalRateDisplay');
        const goalTable = document.getElementById('goalTable');
        const goalRows = document.getElementById('goalRows');
        let compoundMode = 'growth'; // 'growth' | 'goal'

        // Margin элементы
        const marginCollateralInput = document.getElementById('marginCollateral');
        const marginLeverageInput = document.getElementById('marginLeverage');
        const marginEntryInput = document.getElementById('marginEntry');
        const marginExitInput = document.getElementById('marginExit');
        const riskDepositInput    = document.getElementById('riskDeposit');
        const riskPercentInput    = document.getElementById('riskPercent');
        const riskEntryInput      = document.getElementById('riskEntry');
        const riskStoplossInput   = document.getElementById('riskStoploss');
        const riskTakeprofitInput = document.getElementById('riskTakeprofit');
        const marginLongBtn = document.getElementById('marginLong');
        const marginShortBtn = document.getElementById('marginShort');
        const marginLiqPriceDisplay = document.getElementById('marginLiqPriceDisplay');
        const marginCollateralDisplay = document.getElementById('marginCollateralDisplay');
        const marginPositionDisplay = document.getElementById('marginPositionDisplay');
        const marginDistanceDisplay = document.getElementById('marginDistanceDisplay');
        const marginRiskDisplay = document.getElementById('marginRiskDisplay');
        const marginTotalDisplay = document.getElementById('marginTotalDisplay');
        const marginProfitDisplay = document.getElementById('marginProfitDisplay');
        const marginRoiDisplay = document.getElementById('marginRoiDisplay');
        const marginPriceChangeDisplay = document.getElementById('marginPriceChangeDisplay');
        const marginRubDisplay = document.getElementById('marginRubDisplay');

        // Блоки результатов
        const resultBlocks = {
            sell: document.getElementById('resultSell'),
            compound: document.getElementById('resultCompound'),
            margin: document.getElementById('resultMargin'),
            risk: document.getElementById('resultRisk')
        };

        // ════════════════════════════════════════════════════
        // ХАБ КАЛЬКУЛЯТОРОВ
        // ════════════════════════════════════════════════════

        const calcHub       = document.getElementById('calcHub');
        const calcContent   = document.getElementById('calcContent');
        const calcBackBtn   = document.getElementById('calcBackBtn');
        const calcHeaderTitle = document.getElementById('calcHeaderTitle');
        const tabContents   = document.querySelectorAll('.tab-content');

        const CALC_NAMES = {
            sell: 'calcTabSell', compound: 'hubNameCompound', margin: 'calcTabMargin',
            risk: 'hubNameRisk', dca: 'calcTabDca', breakeven: 'hubNameBreakeven',
            possize: 'hubNamePossize', funding: 'hubNameFunding', converter: 'hubNameConverter',
            pnlgrid: 'hubNamePnlgrid', savings: 'hubNameSavings',
        };

        function openCalc(name) {
            calcHub.style.display = 'none';
            calcContent.style.display = 'flex';

            tabContents.forEach(c => c.classList.remove('active'));
            const tab = document.getElementById(`tab-${name}`);
            if (tab) tab.classList.add('active');

            calcHeaderTitle.textContent = CALC_NAMES[name] ? (typeof t === 'function' ? t(CALC_NAMES[name]) : CALC_NAMES[name]) : name;

            Object.values(resultBlocks).forEach(block => block.classList.remove('active'));
            if (resultBlocks[name]) resultBlocks[name].classList.add('active');

            // Если открываем продажу и строк ещё нет — добавляем первую
            if (name === 'sell' && buyEntriesContainer.querySelectorAll('.buy-row').length === 0) {
                initializeEmpty();
            }

            redrawChartLevels();
            updateTPSL();
        }

        document.querySelectorAll('.calc-hub-card').forEach(card => {
            card.addEventListener('click', () => openCalc(card.dataset.calc));
        });

        calcBackBtn.addEventListener('click', () => {
            calcContent.style.display = 'none';
            calcHub.style.display = 'flex';
        });

        // Форматирование чисел
        function rawValue(str) {
            return str.replace(/\s/g, '').replace(',', '.');
        }

        function formatInput(str) {
            const clean = rawValue(str);
            if (clean === '' || clean === '.' || clean === '-') return clean;
            const parts = clean.split('.');
            const intPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '\u00A0');
            return parts.length > 1 ? intPart + '.' + parts[1] : intPart;
        }

        function getNumericValue(input) {
            return parseFloat(rawValue(input.value)) || 0;
        }

        function attachFormatter(input) {
            input.addEventListener('input', () => {
                const pos = input.selectionStart;
                const oldLen = input.value.length;
                const raw = rawValue(input.value);
                const cleaned = raw.replace(/[^0-9.\-]/g, '');
                const formatted = formatInput(cleaned);
                input.value = formatted;
                input.dataset.empty = formatted === '' ? 'true' : 'false';
                const newLen = input.value.length;
                const newPos = pos + (newLen - oldLen);
                try { input.setSelectionRange(newPos, newPos); } catch (e) { }
            });

            input.addEventListener('blur', () => {
                const num = getNumericValue(input);
                if (num !== 0) {
                    const formatted = formatInput(num.toFixed(2));
                    input.value = formatted;
                    input.dataset.empty = 'false';
                }
            });

            input.addEventListener('focus', () => {
                input.dataset.empty = input.value === '' ? 'true' : 'false';
            });
        }

        // Применяем форматтеры
        attachFormatter(sellPriceInput);
        attachFormatter(profitPercentInput);
        attachFormatter(compoundInvestmentInput);
        attachFormatter(compoundRateInput);
        attachFormatter(compoundLossInput);
        attachFormatter(compoundTradesInput);
        attachFormatter(compoundWinRateInput);
        attachFormatter(compoundFeeInput);
        attachFormatter(goalFromInput);
        attachFormatter(goalToInput);
        attachFormatter(goalRateInput);
        attachFormatter(marginCollateralInput);
        attachFormatter(marginLeverageInput);
        attachFormatter(marginEntryInput);
        attachFormatter(marginExitInput);
        attachFormatter(riskDepositInput);
        attachFormatter(riskPercentInput);
        attachFormatter(riskEntryInput);
        attachFormatter(riskStoplossInput);
        attachFormatter(riskTakeprofitInput);

        // Курс USD/RUB
        async function fetchUsdToRub() {
            try {
                const r = await fetch('/api/rub');
                const d = await r.json();
                if (d.tether?.rub) usdToRub = d.tether.rub;
            } catch { }
        }

        function formatRub(usdAmount) {
            const rub = usdAmount * usdToRub;
            return '₽\u00A0' + Math.round(rub).toLocaleString('ru-RU');
        }

        selIcon.src = ICONS[selectedCoin.id];
        selName.textContent = `${selectedCoin.name} (${selectedCoin.symbol})`;

        // ── Синхронизация дропдауна страницы 2 ──────────────
        function syncPage2Selector(coin) {
            const icon2 = document.getElementById('selectedCoinIcon2');
            const name2 = document.getElementById('selectedCoinName2');
            if (icon2) icon2.src = ICONS[coin.id] || '';
            if (name2) name2.textContent = `${coin.name} (${coin.symbol})`;
        }

        function renderCoinOptions2(query) {
            const container = document.getElementById('coinOptions2');
            if (!container) return;
            const q = (query || '').toLowerCase();
            const filtered = COINS.filter(c =>
                c.name.toLowerCase().includes(q) || c.symbol.toLowerCase().includes(q)
            );
            container.innerHTML = filtered.map(coin => `
                <div class="coin-option${coin.id === selectedCoin.id ? ' selected' : ''}" data-id="${coin.id}">
                    <img src="${ICONS[coin.id] || ''}" onerror="this.style.display='none'">
                    <div class="coin-option-info">
                        <span class="coin-option-name">${coin.name}</span>
                        <span class="coin-option-symbol">${coin.symbol}</span>
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.coin-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    const coin = COINS.find(c => c.id === opt.dataset.id);
                    if (!coin) return;
                    selectCoin(coin);
                    closeDropdown2();
                });
            });
        }

        function syncPage1Selector(coin) {
            // Обновляем иконку и название в дропдауне стр.1
            if (selIcon) selIcon.src = ICONS[coin.id] || '';
            if (selName) selName.textContent = `${coin.name} (${coin.symbol})`;
        }

        function openDropdown2() {
            const dd = document.getElementById('coinDropdown2');
            const trigger = document.getElementById('coinSelectTrigger2');
            if (!dd) return;
            dd.classList.add('open');
            const arrow = trigger?.querySelector('.arrow');
            if (arrow) arrow.style.transform = 'rotate(180deg)';
            renderCoinOptions2('');
            setTimeout(() => document.getElementById('coinSearch2')?.focus(), 50);
        }

        function closeDropdown2() {
            const dd = document.getElementById('coinDropdown2');
            const trigger = document.getElementById('coinSelectTrigger2');
            if (!dd) return;
            dd.classList.remove('open');
            const arrow = trigger?.querySelector('.arrow');
            if (arrow) arrow.style.transform = '';
        }

        document.getElementById('coinSelectTrigger2')?.addEventListener('click', e => {
            e.stopPropagation();
            const dd = document.getElementById('coinDropdown2');
            dd?.classList.contains('open') ? closeDropdown2() : openDropdown2();
        });

        document.getElementById('coinSearch2')?.addEventListener('input', e => {
            renderCoinOptions2(e.target.value);
        });

        document.addEventListener('click', e => {
            if (!document.getElementById('coinSelectWrapper2')?.contains(e.target)) {
                closeDropdown2();
            }
        });

        // Синхронизируем при старте
        syncPage2Selector(selectedCoin);

        // Патчим selectCoin чтобы всегда синхронизировал оба дропдауна
        const _origSelectCoin = selectCoin;
        // Переопределяем через обёртку
        window._syncPage2OnSelect = true;
        buildDropdown('');

        // Период графика
        periodButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                periodButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = parseInt(btn.dataset.period);
                loadChartData();
            });
        });

        // Карточки покупок
        function createBuyEntry(index) {
            const entry = document.createElement('div');
            entry.className = 'buy-row';
            entry.innerHTML = `
                <div class="buy-row-num">${index}</div>
                <div class="buy-row-field">
                    <input type="text" class="amount-input" inputmode="decimal" data-empty="true" placeholder=" ">
                    <label>${t('labelAmount')}</label>
                    <button class="input-clear-btn" tabindex="-1">✕</button>
                </div>
                <div class="buy-row-field">
                    <input type="text" class="price-input" inputmode="decimal" data-empty="true" placeholder=" ">
                    <label>${t('labelPrice')}</label>
                    <button class="input-clear-btn" tabindex="-1">✕</button>
                </div>
                <div class="buy-row-coins zero" data-coins>0</div>
                <button class="buy-row-remove" title="${t('remove')}">×</button>
            `;

            // Скрываем кнопку удаления у первой записи
            const removeBtn = entry.querySelector('.buy-row-remove');
            if (index === 1) removeBtn.style.display = 'none';
            removeBtn.addEventListener('click', e => {
                e.stopPropagation();
                entry.remove();
                updateEntryNumbers();
                calculateSell();
                calculateCompound();
                calculateMargin();
            });

            const amountInput = entry.querySelector('.amount-input');
            const priceInput  = entry.querySelector('.price-input');
            const coinsEl     = entry.querySelector('[data-coins]');

            attachFormatter(amountInput);
            attachFormatter(priceInput);

            function updateCoins() {
                const amt   = parseFloat(amountInput.value.replace(/\s/g,'').replace(',','.')) || 0;
                const price = parseFloat(priceInput.value.replace(/\s/g,'').replace(',','.')) || 0;
                if (amt > 0 && price > 0) {
                    const coins = amt / price;
                    coinsEl.textContent = coins.toFixed(6).replace(/\.?0+$/, '') || '0';
                    coinsEl.classList.remove('zero');
                } else {
                    coinsEl.textContent = '0';
                    coinsEl.classList.add('zero');
                }
            }

            entry.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    updateCoins();
                    calculateSell();
                    calculateCompound();
                    calculateMargin();
                    if (!isUpdatingFromPercent) updatePercentFromPrice();
                });
            });

            return entry;
        }

        function initializeEmpty() {
            buyEntriesContainer.appendChild(createBuyEntry(1));
            entryCount = 1;
            updateEntryNumbers();
            calculateSell();
            calculateCompound();
            calculateMargin();
        }

        addButton.addEventListener('click', () => {
            entryCount++;
            buyEntriesContainer.appendChild(createBuyEntry(entryCount));
            updateEntryNumbers();
            calculateSell();
            calculateCompound();
            calculateMargin();
        });

        resetButton.addEventListener('click', () => {
            buyEntriesContainer.innerHTML = '';
            sellPriceInput.value = '';
            sellPriceInput.dataset.empty = 'true';
            profitPercentInput.value = '';
            profitPercentInput.dataset.empty = 'true';
            compoundInvestmentInput.value = '';
            compoundInvestmentInput.dataset.empty = 'true';
            compoundRateInput.value = '';
            compoundRateInput.dataset.empty = 'true';
            compoundLossInput.value = '';
            compoundLossInput.dataset.empty = 'true';
            compoundTradesInput.value = '';
            compoundTradesInput.dataset.empty = 'true';
            compoundWinRateInput.value = '';
            compoundWinRateInput.dataset.empty = 'true';
            compoundFeeInput.value = '';
            compoundFeeInput.dataset.empty = 'true';
            goalFromInput.value = '';
            goalFromInput.dataset.empty = 'true';
            goalToInput.value = '';
            goalToInput.dataset.empty = 'true';
            goalRateInput.value = '';
            goalRateInput.dataset.empty = 'true';
            marginCollateralInput.value = '';
            marginCollateralInput.dataset.empty = 'true';
            marginLeverageInput.value = '';
            marginLeverageInput.dataset.empty = 'true';
            marginEntryInput.value = '';
            marginEntryInput.dataset.empty = 'true';
            marginExitInput.value = '';
            marginExitInput.dataset.empty = 'true';
            riskDepositInput.value = '';
            riskDepositInput.dataset.empty = 'true';
            riskPercentInput.value = '';
            riskPercentInput.dataset.empty = 'true';
            riskEntryInput.value = '';
            riskEntryInput.dataset.empty = 'true';
            riskStoplossInput.value = '';
            riskStoplossInput.dataset.empty = 'true';
            riskTakeprofitInput.value = '';
            riskTakeprofitInput.dataset.empty = 'true';
            riskDirection = 'long';
            document.getElementById('riskLong').classList.add('active', 'long');
            document.getElementById('riskShort').classList.remove('active', 'short');
            riskTpStrategyMode = false;
            riskTpStrategyBtn.classList.remove('active');
            riskTpStrategyBtnSpan.dataset.i18n = 'riskTpStrategyOff';
            riskTpStrategyBtnSpan.textContent = t('riskTpStrategyOff');
            window._riskCoins = 0; window._riskEntry = 0; window._riskUsd = 0;
            document.getElementById('riskPositionUsd').textContent   = '$0.00';
            document.getElementById('riskPositionCoins').textContent = '0';
            document.getElementById('riskDepositPct').textContent    = '0%';
            document.getElementById('riskAmount').textContent        = '$0.00';
            document.getElementById('riskReward').textContent        = '$0.00';
            document.getElementById('riskRR').textContent            = '—';
            document.getElementById('riskRiskPct').textContent       = '0%';
            entryCount = 0;
            initializeEmpty();
            document.getElementById('tpStrategyRow').style.display = 'none';
            // Сбрасываем блок уровней выхода
            ['tp1Price','tp2Price','tp3Price'].forEach(id => document.getElementById(id).textContent = '—');
            ['tp1Pct','tp2Pct','tp3Pct'].forEach(id => document.getElementById(id).textContent = '—');
            ['tp1Profit','tp2Profit','tp3Profit'].forEach(id => document.getElementById(id).textContent = '—');
            document.getElementById('slPrice').textContent = '—';
            document.getElementById('slPct').textContent = '—';
            document.getElementById('slProfit').textContent = '—';
            document.getElementById('tpslRR').textContent = 'RR —';
            redrawChartLevels();
        });

        function updateEntryNumbers() {
            const rows = buyEntriesContainer.querySelectorAll('.buy-row');
            rows.forEach((row, idx) => {
                row.querySelector('.buy-row-num').textContent = idx + 1;
                const rb = row.querySelector('.buy-row-remove');
                if (rb) rb.style.display = rows.length === 1 ? 'none' : 'flex';
            });
            entriesCountEl.textContent = rows.length;
            entryCount = rows.length;
        }

        function formatNumber(num) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/,/g, '\u00A0');
        }
        function formatCoins(num) {
            return num.toLocaleString('en-US', { minimumFractionDigits: 6, maximumFractionDigits: 8 }).replace(/,/g, '\u00A0');
        }

        // Progress bar
        function updateProgressBar() {
            const activeTab = document.querySelector('.tab-content.active')?.id?.replace('tab-','');

            let targetPrice, startPrice;

            if (activeTab === 'margin') {
                targetPrice = getNumericValue(marginExitInput);
                startPrice  = getNumericValue(marginEntryInput);
            } else {
                targetPrice = getNumericValue(sellPriceInput);
                const cards = buyEntriesContainer.querySelectorAll('.buy-row');
                let totalInvested = 0, totalCoins = 0;
                cards.forEach(card => {
                    const amount = getNumericValue(card.querySelector('.amount-input'));
                    const price  = getNumericValue(card.querySelector('.price-input'));
                    if (amount > 0 && price > 0) { totalInvested += amount; totalCoins += amount / price; }
                });
                startPrice = totalCoins > 0 ? totalInvested / totalCoins : 0;
            }

            if (!currentCoinPrice || !targetPrice) {
                goalPriceEl.textContent = `—`;
                progressPercent.textContent = `—`;
                progressBarFill.style.width = `0%`;
                progressBarFill.classList.remove('success');
                progressInfo.textContent = activeTab === 'margin' ? t('progressEnterExit') : t('progressEnterSell');
                return;
            }

            const effectiveStart = startPrice > 0 ? startPrice : currentCoinPrice;
            const range   = targetPrice - effectiveStart;
            const current = currentCoinPrice - effectiveStart;
            const percent = range > 0
                ? Math.min(Math.max((current / range) * 100, 0), 100)
                : currentCoinPrice >= targetPrice ? 100 : 0;

            goalPriceEl.textContent = `$${formatNumber(targetPrice)}`;
            progressPercent.textContent = `${percent.toFixed(0)}%`;
            progressBarFill.style.width = `${percent}%`;

            if (currentCoinPrice >= targetPrice) {
                progressBarFill.classList.add('success');
                progressInfo.textContent = `🎉 ${t('goalAchieved')}`;
            } else {
                progressBarFill.classList.remove('success');
                const remaining = targetPrice - currentCoinPrice;
                progressInfo.textContent = `${t('remaining')}: $${formatNumber(remaining)}`;
            }
        }

        // Расчёт для продажи
        function calculateSell() {
            const cards = buyEntriesContainer.querySelectorAll('.buy-row');
            let totalInvested = 0, totalCoins = 0;

            cards.forEach(card => {
                const amount = getNumericValue(card.querySelector('.amount-input'));
                const price = getNumericValue(card.querySelector('.price-input'));
                const coinsSpan = card.querySelector('[data-coins]');
                if (amount > 0 && price > 0) {
                    const coins = amount / price;
                    coinsSpan.textContent = coins.toFixed(8);
                    coinsSpan.classList.remove('zero');
                    totalInvested += amount;
                    totalCoins += coins;
                } else {
                    coinsSpan.textContent = '0';
                    coinsSpan.classList.add('zero');
                }
            });

            if (totalInvested > 0 && totalCoins > 0) {
                avgPositionPrice.textContent = `$${formatNumber(totalInvested / totalCoins)}`;
                avgPositionCoins.textContent = formatCoins(totalCoins);
                avgPositionInvested.textContent = `$${formatNumber(totalInvested)}`;
            } else {
                avgPositionPrice.textContent = '$0.00';
                avgPositionCoins.textContent = '0';
                avgPositionInvested.textContent = '$0.00';
            }

            const sellPrice = getNumericValue(sellPriceInput);
            if (!totalInvested || !totalCoins || !sellPrice) {
                totalAmountEl.textContent = '$0.00';
                profitAmountEl.textContent = '$0.00';
                profitAmountEl.className = 'stat-value';
                profitAmountRubEl.textContent = '';
                profitAmountRubEl.className = 'stat-value-rub';
                profitPercentDisplayEl.textContent = '0%';
                profitPercentDisplayEl.className = 'stat-value';
                avgPriceEl.textContent = '$0.00';
                updateProgressBar();
                updateTPSL();
                return;
            }

            const avgBuyPrice = totalInvested / totalCoins;
            const totalAmount = totalCoins * sellPrice;
            const profitAmount = totalAmount - totalInvested;
            const profitPct = (profitAmount / totalInvested) * 100;
            const isPos = profitAmount >= 0;
            const profitSign = isPos ? '+' : '-';

            totalAmountEl.textContent = `$${formatNumber(totalAmount)}`;
            avgPriceEl.textContent = `$${formatNumber(avgBuyPrice)}`;

            const absProfitUsd = Math.abs(profitAmount);
            profitAmountEl.textContent = `${profitSign}$${formatNumber(absProfitUsd)}`;
            profitAmountEl.className = `stat-value ${isPos ? 'positive' : 'negative'}`;
            profitPercentDisplayEl.textContent = `${profitSign}${Math.abs(profitPct).toFixed(2)}%`;
            profitPercentDisplayEl.className = `stat-value ${isPos ? 'positive' : 'negative'}`;

            if (currentLang === 'ru') {
                profitAmountRubEl.textContent = `${profitSign}${formatRub(absProfitUsd)}`;
                profitAmountRubEl.className = `stat-value-rub ${isPos ? 'positive' : 'negative'}`;
            } else {
                profitAmountRubEl.textContent = '';
                profitAmountRubEl.className = 'stat-value-rub';
            }

            updateProgressBar();
            redrawChartLevels();
            updateTPSL();
        }

        // Compound Interest — переключение режимов
        document.getElementById('compoundModeGrowth').addEventListener('click', () => {
            compoundMode = 'growth';
            document.getElementById('compoundModeGrowth').classList.add('active');
            document.getElementById('compoundModeGoal').classList.remove('active');
            document.getElementById('compoundGrowthMode').style.display = 'block';
            document.getElementById('compoundGoalMode').style.display = 'none';
            document.getElementById('resultCompoundGrowth').style.display = 'block';
            document.getElementById('resultCompoundGoal').style.display = 'none';
            calculateCompound();
        });

        document.getElementById('compoundModeGoal').addEventListener('click', () => {
            compoundMode = 'goal';
            document.getElementById('compoundModeGoal').classList.add('active');
            document.getElementById('compoundModeGrowth').classList.remove('active');
            document.getElementById('compoundGoalMode').style.display = 'block';
            document.getElementById('compoundGrowthMode').style.display = 'none';
            document.getElementById('resultCompoundGoal').style.display = 'block';
            document.getElementById('resultCompoundGrowth').style.display = 'none';
            calculateCompound();
        });

        compoundInvestmentInput.addEventListener('input', calculateCompound);
        compoundRateInput.addEventListener('input', calculateCompound);
        compoundLossInput.addEventListener('input', calculateCompound);
        compoundTradesInput.addEventListener('input', calculateCompound);
        compoundWinRateInput.addEventListener('input', calculateCompound);
        compoundFeeInput.addEventListener('input', calculateCompound);
        goalFromInput.addEventListener('input', calculateCompound);
        goalToInput.addEventListener('input', calculateCompound);
        goalRateInput.addEventListener('input', calculateCompound);

        function calculateCompound() {
            if (compoundMode === 'growth') {
                calculateCompoundGrowth();
            } else {
                calculateCompoundGoal();
            }
        }

        function calculateCompoundGrowth() {
            const investment = getNumericValue(compoundInvestmentInput);
            const rate = getNumericValue(compoundRateInput);
            const loss = getNumericValue(compoundLossInput);
            const trades = getNumericValue(compoundTradesInput);
            const winRate = getNumericValue(compoundWinRateInput);
            const fee = getNumericValue(compoundFeeInput);

            if (!investment || !rate || !trades) {
                compoundTotalDisplay.textContent = '$0.00';
                compoundInitialDisplay.textContent = '$0.00';
                compoundProfitDisplay.textContent = '+$0.00';
                compoundROIDisplay.textContent = '+0%';
                compoundRubDisplay.textContent = '₽0';
                return;
            }

            // Если winRate и loss не заданы — классический compound
            let finalAmount = investment;
            const winRateFraction = winRate > 0 ? winRate / 100 : 1;
            const lossFraction = loss > 0 ? loss / 100 : 0;
            const feeFraction = fee > 0 ? fee / 100 : 0;

            for (let i = 0; i < trades; i++) {
                const isWin = Math.random() < winRateFraction;
                // Для детерминированного расчёта используем математическое ожидание
                // Каждый трейд: winRate% вероятность прибыли, остальное убыток
                // Применяем формулу через матожидание
                const winMultiplier = 1 + rate / 100 - feeFraction;
                const lossMultiplier = 1 - lossFraction - feeFraction;
                // матожидание одного трейда
                const expectedMultiplier = winRateFraction * winMultiplier + (1 - winRateFraction) * lossMultiplier;
                finalAmount *= expectedMultiplier;
            }

            // Если winRate не задан — используем простую формулу
            if (!winRate && !loss) {
                const rateDecimal = rate / 100;
                finalAmount = investment * Math.pow(1 + rateDecimal - feeFraction, trades);
            }

            const profit = finalAmount - investment;
            const roi = (profit / investment) * 100;
            const isPos = profit >= 0;
            const sign = isPos ? '+' : '-';

            compoundTotalDisplay.textContent = `$${formatNumber(finalAmount)}`;
            compoundInitialDisplay.textContent = `$${formatNumber(investment)}`;
            compoundProfitDisplay.textContent = `${sign}$${formatNumber(Math.abs(profit))}`;
            compoundProfitDisplay.className = `stat-value ${isPos ? 'positive' : 'negative'}`;
            compoundROIDisplay.textContent = `${sign}${Math.abs(roi).toFixed(2)}%`;
            compoundROIDisplay.className = `stat-value ${isPos ? 'positive' : 'negative'}`;
            compoundRubDisplay.textContent = formatRub(profit);
        }

        function calculateCompoundGoal() {
            const from = getNumericValue(goalFromInput);
            const to = getNumericValue(goalToInput);
            const rate = getNumericValue(goalRateInput);

            if (!from || !to || to <= from) {
                goalTradesDisplay.textContent = '—';
                goalFromDisplay.textContent = '$0.00';
                goalToDisplay.textContent = '$0.00';
                goalGrowthDisplay.textContent = '+0%';
                goalRateDisplay.textContent = '0%';
                goalTable.style.display = 'none';
                return;
            }

            // Кол-во трейдов при введённом %: n = log(to/from) / log(1 + rate/100)
            const tradesNeeded = rate > 0
                ? Math.ceil(Math.log(to / from) / Math.log(1 + rate / 100))
                : null;

            const growth = ((to - from) / from) * 100;

            goalFromDisplay.textContent = `$${formatNumber(from)}`;
            goalToDisplay.textContent = `$${formatNumber(to)}`;
            goalGrowthDisplay.textContent = `+${growth.toFixed(2)}%`;
            goalRateDisplay.textContent = rate > 0 ? `${rate}%` : '—';
            goalTradesDisplay.textContent = tradesNeeded ? `${tradesNeeded} ${t('trades')}` : '—';

            // Таблица с разными %
            const percents = [1, 2, 3, 5, 10, 15, 20];
            goalRows.innerHTML = '';
            percents.forEach(pct => {
                const n = Math.ceil(Math.log(to / from) / Math.log(1 + pct / 100));
                const isHighlight = pct >= 5;
                const row = document.createElement('div');
                row.className = 'goal-row';
                row.innerHTML = `
                    <span class="goal-row-label">${t('goalAt')} <strong>+${pct}%</strong> ${t('goalPerTrade')}</span>
                    <span class="goal-row-value ${isHighlight ? 'highlight' : ''}">${n} ${t('trades')}</span>
                `;
                goalRows.appendChild(row);
            });
            goalTable.style.display = 'block';
        }

        // Margin Trading (исправленные формулы)
        marginLongBtn.addEventListener('click', () => {
            marginDirection = 'long';
            marginLongBtn.classList.add('active', 'long');
            marginShortBtn.classList.remove('active', 'short');
            calculateMargin();
        });

        marginShortBtn.addEventListener('click', () => {
            marginDirection = 'short';
            marginShortBtn.classList.add('active', 'short');
            marginLongBtn.classList.remove('active', 'long');
            calculateMargin();
        });

        marginLeverageInput.addEventListener('input', calculateMargin);
        marginCollateralInput.addEventListener('input', calculateMargin);
        marginEntryInput.addEventListener('input', calculateMargin);
        marginExitInput.addEventListener('input', calculateMargin);

        function calculateMargin() {
            const collateral = getNumericValue(marginCollateralInput);
            const leverage = getNumericValue(marginLeverageInput);
            const entryPrice = getNumericValue(marginEntryInput);
            const exitPrice = getNumericValue(marginExitInput);

            marginCollateralDisplay.textContent = `$${formatNumber(collateral)}`;

            if (!collateral || !leverage || !entryPrice) {
                marginLiqPriceDisplay.textContent = '$0.00';
                marginPositionDisplay.textContent = '$0.00';
                marginDistanceDisplay.textContent = '0%';
                marginRiskDisplay.textContent = '—';
                marginTotalDisplay.textContent = '$0.00';
                marginProfitDisplay.textContent = '$0.00';
                marginRoiDisplay.textContent = '0%';
                marginPriceChangeDisplay.textContent = '0%';
                marginRubDisplay.textContent = '₽0';
                return;
            }

            const positionSize = collateral * leverage;
            marginPositionDisplay.textContent = `$${formatNumber(positionSize)}`;

            let liquidationPrice;
            if (marginDirection === 'long') {
                liquidationPrice = entryPrice * (1 - 1 / leverage);
            } else {
                liquidationPrice = entryPrice * (1 + 1 / leverage);
            }
            marginLiqPriceDisplay.textContent = `$${formatNumber(liquidationPrice)}`;

            const distance = (1 / leverage) * 100;
            marginDistanceDisplay.textContent = `${distance.toFixed(1)}%`;

            let risk = t('riskLow');
            if (distance < 5) risk = t('riskCritical');
            else if (distance < 15) risk = t('riskHigh');
            else if (distance < 30) risk = t('riskMedium');
            marginRiskDisplay.textContent = risk;

            if (exitPrice) {
                const quantity = positionSize / entryPrice;
                let profit;
                if (marginDirection === 'long') {
                    profit = quantity * exitPrice - positionSize;
                } else {
                    profit = positionSize - quantity * exitPrice;
                }
                const finalValue = collateral + profit;
                const roi = (profit / collateral) * 100;
                const isProfit = profit >= 0;
                const sign = isProfit ? '+' : '-';

                let priceChange;
                if (marginDirection === 'long') {
                    priceChange = ((exitPrice - entryPrice) / entryPrice) * 100;
                } else {
                    priceChange = ((entryPrice - exitPrice) / entryPrice) * 100;
                }
                const priceChangeSign = priceChange >= 0 ? '+' : '-';

                marginTotalDisplay.textContent = `$${formatNumber(finalValue)}`;
                marginProfitDisplay.textContent = `${sign}$${formatNumber(Math.abs(profit))}`;
                marginProfitDisplay.className = `stat-value ${isProfit ? 'positive' : 'negative'}`;
                marginRoiDisplay.textContent = `${sign}${Math.abs(roi).toFixed(2)}%`;
                marginRoiDisplay.className = `stat-value ${isProfit ? 'positive' : 'negative'}`;
                marginPriceChangeDisplay.textContent = `${priceChangeSign}${Math.abs(priceChange).toFixed(2)}%`;
                marginRubDisplay.textContent = formatRub(profit);
            } else {
                marginTotalDisplay.textContent = '$0.00';
                marginProfitDisplay.textContent = '$0.00';
                marginProfitDisplay.className = 'stat-value';
                marginRoiDisplay.textContent = '0%';
                marginRoiDisplay.className = 'stat-value';
                marginPriceChangeDisplay.textContent = '0%';
                marginRubDisplay.textContent = '₽0';
            }
            redrawChartLevels();
            updateTPSL();
            updateProgressBar();
        }

        // Синхронизация цены и процента
        sellPriceInput.addEventListener('input', () => {
            if (!isUpdatingFromPercent) updatePercentFromPrice();
            calculateSell();
        });
        profitPercentInput.addEventListener('input', () => {
            if (!isUpdatingFromPrice) updatePriceFromPercent();
            calculateSell();
        });

        function updatePercentFromPrice() {
            const cards = buyEntriesContainer.querySelectorAll('.buy-row');
            let ti = 0, tc = 0;
            cards.forEach(c => {
                const a = getNumericValue(c.querySelector('.amount-input'));
                const p = getNumericValue(c.querySelector('.price-input'));
                if (a > 0 && p > 0) { ti += a; tc += a / p; }
            });
            const sp = getNumericValue(sellPriceInput);
            if (ti > 0 && tc > 0 && sp > 0) {
                const pct = (((sp - ti / tc) / (ti / tc)) * 100).toFixed(2);
                isUpdatingFromPrice = true;
                profitPercentInput.value = formatInput(pct);
                profitPercentInput.dataset.empty = 'false';
                isUpdatingFromPrice = false;
            }
        }

        function updatePriceFromPercent() {
            const cards = buyEntriesContainer.querySelectorAll('.buy-row');
            let ti = 0, tc = 0;
            cards.forEach(c => {
                const a = getNumericValue(c.querySelector('.amount-input'));
                const p = getNumericValue(c.querySelector('.price-input'));
                if (a > 0 && p > 0) { ti += a; tc += a / p; }
            });
            const pct = getNumericValue(profitPercentInput);
            if (ti > 0 && tc > 0) {
                const sp = ((ti / tc) * (1 + pct / 100)).toFixed(2);
                isUpdatingFromPercent = true;
                sellPriceInput.value = formatInput(sp);
                sellPriceInput.dataset.empty = 'false';
                isUpdatingFromPercent = false;
            }
        }

        // API
        async function fetchCoinPrice(id) {
            try {
                const symbol = BINANCE_SYMBOLS[id];
                if (symbol) {
                    const r = await fetch(`/api/price?symbol=${symbol}`);
                    const d = await r.json();
                    return d.price ? parseFloat(d.price) : null;
                }
                // Fallback CoinGecko для монет без маппинга
                const r = await fetch(`/api/price?id=${id}`);
                const d = await r.json();
                return d[id]?.usd || null;
            } catch { return null; }
        }

        // ── RSI (14) ──────────────────────────────────────
        function calculateRSI(prices, period = 14) {
            const closes = prices.map(p => p[1]);
            if (closes.length < period + 1) return null;

            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                const diff = closes[i] - closes[i - 1];
                if (diff >= 0) gains += diff; else losses -= diff;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;

            for (let i = period + 1; i < closes.length; i++) {
                const diff = closes[i] - closes[i - 1];
                avgGain = (avgGain * (period - 1) + (diff > 0 ? diff : 0)) / period;
                avgLoss = (avgLoss * (period - 1) + (diff < 0 ? -diff : 0)) / period;
            }

            if (avgLoss === 0) return 100;
            const rs = avgGain / avgLoss;
            return Math.round(100 - (100 / (1 + rs)));
        }

        function updateRSI(prices) {
            const rsi = calculateRSI(prices);
            const needle   = document.getElementById('rsiNeedle');
            const valueEl  = document.getElementById('rsiValue');
            const badgeEl  = document.getElementById('rsiBadge');
            const hintEl   = document.getElementById('rsiHint');

            if (rsi === null) {
                valueEl.textContent = '—';
                hintEl.textContent  = t('noData');
                return;
            }

            valueEl.textContent = rsi;
            needle.style.left = `${rsi}%`;

            if (rsi < 30) {
                badgeEl.textContent = t('oversold');
                badgeEl.className   = 'rsi-badge oversold';
                hintEl.textContent  = `📈 ${t('hintReversalUp')}`;
                needle.style.background = '#10B981';
            } else if (rsi > 70) {
                badgeEl.textContent = t('overbought');
                badgeEl.className   = 'rsi-badge overbought';
                hintEl.textContent  = `📉 ${t('hintCorrection')}`;
                needle.style.background = '#EF4444';
            } else {
                badgeEl.textContent = t('neutral');
                badgeEl.className   = 'rsi-badge neutral';
                hintEl.textContent  = `➡️ ${t('hintUnclear')}`;
                needle.style.background = '#FBBF24';
            }
        }

        // ── Z-Score ───────────────────────────────────────
        function calculateZScore(prices) {
            const closes = prices.map(p => p[1]);
            if (closes.length < 2) return null;

            const ma = closes.reduce((a, b) => a + b, 0) / closes.length;
            const variance = closes.reduce((sum, p) => sum + Math.pow(p - ma, 2), 0) / closes.length;
            const sigma = Math.sqrt(variance);
            const currentPrice = closes[closes.length - 1];
            const zscore = sigma > 0 ? (currentPrice - ma) / sigma : 0;

            // Вероятность возврата к MA (упрощённая — чем дальше от MA, тем выше)
            const absZ = Math.abs(zscore);
            let prob;
            if (absZ < 1)      prob = 35;
            else if (absZ < 2) prob = 65;
            else if (absZ < 3) prob = 85;
            else               prob = 95;

            return { zscore: +zscore.toFixed(2), ma: +ma.toFixed(2), sigma: +sigma.toFixed(2), prob };
        }

        function updateZScore(prices) {
            const result = calculateZScore(prices);
            const valueEl = document.getElementById('zscoreValue');
            const badgeEl = document.getElementById('zscoreBadge');
            const hintEl  = document.getElementById('zscoreHint');
            const maEl    = document.getElementById('zscoreMA');
            const sigmaEl = document.getElementById('zscoreSigma');
            const probEl  = document.getElementById('zscoreProb');

            if (!result) {
                valueEl.textContent = '—';
                hintEl.textContent = t('noData');
                return;
            }

            const { zscore, ma, sigma, prob } = result;
            const fmt = n => `$${n.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;

            valueEl.textContent = (zscore >= 0 ? '+' : '') + zscore;
            maEl.textContent    = fmt(ma);
            sigmaEl.textContent = fmt(sigma);
            probEl.textContent  = prob + '%';

            if (zscore < -2) {
                badgeEl.textContent = t('zFarBelowMA');
                badgeEl.className   = 'rsi-badge oversold';
                hintEl.textContent  = `📈 ${t('zHintFarBelow')}`;
                valueEl.style.color = '#10B981';
            } else if (zscore < -1) {
                badgeEl.textContent = t('zBelowMA');
                badgeEl.className   = 'rsi-badge oversold';
                hintEl.textContent  = `📈 ${t('zHintBelow')}`;
                valueEl.style.color = '#34D399';
            } else if (zscore > 2) {
                badgeEl.textContent = t('zFarAboveMA');
                badgeEl.className   = 'rsi-badge overbought';
                hintEl.textContent  = `📉 ${t('zHintFarAbove')}`;
                valueEl.style.color = '#EF4444';
            } else if (zscore > 1) {
                badgeEl.textContent = t('zAboveMA');
                badgeEl.className   = 'rsi-badge overbought';
                hintEl.textContent  = `📉 ${t('zHintAbove')}`;
                valueEl.style.color = '#F87171';
            } else {
                badgeEl.textContent = t('zNearMA');
                badgeEl.className   = 'rsi-badge neutral';
                hintEl.textContent  = `➡️ ${t('zHintNear')}`;
                valueEl.style.color = '#FBBF24';
            }
        }

        // Маппинг CoinGecko ID → символ Binance (для графика)
        const BINANCE_SYMBOLS = {
            'bitcoin': 'BTCUSDT', 'ethereum': 'ETHUSDT', 'binancecoin': 'BNBUSDT',
            'solana': 'SOLUSDT', 'ripple': 'XRPUSDT', 'cardano': 'ADAUSDT',
            'avalanche-2': 'AVAXUSDT', 'dogecoin': 'DOGEUSDT', 'polkadot': 'DOTUSDT',
            'matic-network': 'MATICUSDT', 'shiba-inu': 'SHIBUSDT', 'tron': 'TRXUSDT',
            'litecoin': 'LTCUSDT', 'chainlink': 'LINKUSDT', 'uniswap': 'UNIUSDT',
            'stellar': 'XLMUSDT', 'monero': 'XMRUSDT', 'ethereum-classic': 'ETCUSDT',
            'near': 'NEARUSDT', 'cosmos': 'ATOMUSDT', 'algorand': 'ALGOUSDT',
            'vechain': 'VETUSDT', 'internet-computer': 'ICPUSDT', 'aptos': 'APTUSDT',
            'arbitrum': 'ARBUSDT', 'optimism': 'OPUSDT', 'filecoin': 'FILUSDT',
            'the-sandbox': 'SANDUSDT', 'decentraland': 'MANAUSDT', 'aave': 'AAVEUSDT',
            'pepe': 'PEPEUSDT', 'sui': 'SUIUSDT', 'toncoin': 'TONUSDT',
            'fetch-ai': 'FETUSDT', 'injective-protocol': 'INJUSDT',
            'render-token': 'RENDERUSDT', 'sei-network': 'SEIUSDT',
            'worldcoin-wld': 'WLDUSDT', 'bonk': 'BONKUSDT', 'floki': 'FLOKIUSDT',
            'kaspa': 'KASUSDT', 'jupiter-exchange-solana': 'JUPUSDT',
            'celestia': 'TIAUSDT', 'starknet': 'STRKUSDT', 'mantle': 'MNTUSDT',
            'immutable-x': 'IMXUSDT', 'blur': 'BLURUSDT', 'maker': 'MKRUSDT',
            'lido-dao': 'LDOUSDT', 'curve-dao-token': 'CRVUSDT',
        };

        // Период → интервал и лимит Binance klines
        async function loadChartData() {
            chartLoading.style.display = 'flex';
            const ohlc = await fetchOhlcData(selectedCoin.id, currentPeriod);
            rawOhlcCache = ohlc;
            
            if (ohlc && ohlc.length) {
                // Преобразуем свечи в цены закрытия для линейного графика
                const prices = ohlc.map(([t, o, h, l, c]) => [t, c]);
                rawPricesCache = prices;
                
                const lastPrice = prices[prices.length - 1][1];
                if (lastPrice && lastPrice > 0) {
                    currentCoinPrice = lastPrice;
                    currentPriceSpan.textContent = `$${lastPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                
                window._lastChartPrices = prices;
                createChart(prices);
                updateChangeBadge(prices);
                updateRSI(prices);
                updateZScore(prices);
                if (!window._tpslChartPrices) {
                    window._tpslChartPrices = prices;
                }
                updateTPSL();
                updateProgressBar();
                calculateMargin();
            } else {
                chartLoading.textContent = t('chartError');
                priceChangeBadge.className = 'price-change-badge';
            }
        }

        async function fetchChartData(id, days) {
            try {
                const symbol = BINANCE_SYMBOLS[id];
                if (!symbol) {
                    // Fallback на CoinGecko если монеты нет в маппинге
                    const r = await fetch(`/api/chart?id=${id}&days=${days}`);
                    const d = await r.json();
                    return d.prices || [];
                }
                
                // Интервалы Binance с большим количеством свечей
                let interval, limit;
                
                if (days <= 1) {
                    interval = '1d';  // 1Д = дневные свечи
                    limit = 200;       // максимум свечей
                } else if (days <= 7) {
                    interval = '1w';  // 7Д = недельные свечи
                    limit = 52;        // покажем последние 52 недели (год)
                } else if (days <= 30) {
                    interval = '1M';  // 30Д = месячные свечи
                    limit = 60;        // покажем последние 60 месяцев (5 лет)
                } else {
                    interval = '1M';  // 90Д = месячные свечи
                    limit = 60;        // тоже 5 лет для контекста
                }
                
                const r = await fetch(`/api/chart?symbol=${symbol}&interval=${interval}&limit=${limit}`);
                const d = await r.json();
                if (!Array.isArray(d)) return [];
                // Binance kline: [openTime, open, high, low, close, volume, ...]
                // Возвращаем в формате [[timestamp, price]] как CoinGecko
                return d.map(k => [k[0], parseFloat(k[4])]);
            } catch { return []; }
        }

        async function fetchOhlcData(id, days) {
            try {
                const symbol = BINANCE_SYMBOLS[id];
                if (!symbol) {
                    // Для CoinGecko - запрашиваем максимум данных
                    const effectiveDays = 365; // запрашиваем год данных для контекста
                    const r = await fetch(`/api/ohlc?id=${id}&days=${effectiveDays}`);
                    const data = await r.json();
                    return Array.isArray(data) ? data : [];
                }
                
                // Для Binance: выбираем интервал в зависимости от периода
                let interval, limit;
                
                if (days <= 1) {
                    interval = '1d';  // 1Д = дневные свечи
                    limit = 200;      // максимум свечей
                } else if (days <= 7) {
                    interval = '1w';  // 7Д = недельные свечи
                    limit = 1000;      // максимум свечей
                } else if (days <= 30) {
                    interval = '1M';  // 30Д = месячные свечи
                    limit = 1000;      // максимум свечей
                } else {
                    interval = '1M';  // 90Д = месячные свечи
                    limit = 1000;      // максимум свечей
                }
                
                const r = await fetch(`/api/ohlc?symbol=${symbol}&interval=${interval}&limit=${limit}`);
                const d = await r.json();
                if (!Array.isArray(d)) return [];
                return d.map(k => [k[0], parseFloat(k[1]), parseFloat(k[2]), parseFloat(k[3]), parseFloat(k[4])]);
            } catch { return []; }
        }

        function updateChangeBadge(prices) {
            if (!prices || prices.length < 2) {
                priceChangeBadge.className = 'price-change-badge';
                priceChangeBadge.textContent = '';
                return;
            }

            let first, last;
            last = prices[prices.length - 1][1];

            if (currentPeriod <= 1) {
                // 1Д — изменение только последней свечи (open → close)
                const lastOhlc = rawOhlcCache[rawOhlcCache.length - 1];
                if (lastOhlc) {
                    first = lastOhlc[1]; // open последней свечи
                } else {
                    first = prices[prices.length - 2][1];
                }
            } else {
                // 7Д/30Д/90Д — берём цену ровно N дней назад из массива
                const now = prices[prices.length - 1][0];
                const targetTime = now - currentPeriod * 24 * 60 * 60 * 1000;
                // Ищем ближайшую свечу к нужной дате
                let closest = prices[0];
                for (let i = 0; i < prices.length; i++) {
                    if (Math.abs(prices[i][0] - targetTime) < Math.abs(closest[0] - targetTime)) {
                        closest = prices[i];
                    }
                }
                first = closest[1];
            }

            const pct = ((last - first) / first) * 100;
            priceChangeBadge.textContent = `${pct >= 0 ? '▲ +' : '▼ '}${pct.toFixed(2)}%`;
            priceChangeBadge.className = `price-change-badge ${pct >= 0 ? 'positive' : 'negative'}`;
        }

        // Получить уровни для текущего активного таба
        function getChartLevels() {
            const activeTab = document.querySelector('.tab-content.active')?.id?.replace('tab-','');
            const levels = [];

            if (activeTab === 'sell') {
                const cards = buyEntriesContainer.querySelectorAll('.buy-row');
                let totalInvested = 0, totalCoins = 0;
                cards.forEach(card => {
                    const amount = getNumericValue(card.querySelector('.amount-input'));
                    const price  = getNumericValue(card.querySelector('.price-input'));
                    if (amount > 0 && price > 0) { totalInvested += amount; totalCoins += amount / price; }
                });
                const sellPrice = getNumericValue(sellPriceInput);
                if (totalInvested > 0 && totalCoins > 0) {
                    const avgEntry  = totalInvested / totalCoins;
                    levels.push({ price: avgEntry, color: '#10B981', label: t('avgBuyLabel'), dash: 0 });
                    if (sellTpStrategyMode) {
                        const targetPrice = sellPrice > 0 ? sellPrice : avgEntry * 1.1;
                        const step = (targetPrice - avgEntry) / 3;
                        const tp1  = avgEntry + step;
                        const tp2  = avgEntry + step * 2;
                        const tp3  = targetPrice;
                        const tp1Reward = tp1 - avgEntry;
                        const sl   = avgEntry - (tp1Reward > 0 ? tp1Reward / selectedRR : 0);
                        levels.push({ price: tp1, color: '#10B981', label: 'TP1',       dash: 1 });
                        levels.push({ price: tp2, color: '#34D399', label: 'TP2',       dash: 1 });
                        levels.push({ price: tp3, color: '#6EE7B7', label: 'TP3',       dash: 1 });
                        if (sl > 0 && sl < avgEntry) {
                            levels.push({ price: sl, color: '#EF4444', label: t('stopLossLabel'), dash: 1 });
                        }
                    } else if (sellPrice > 0) {
                        levels.push({ price: sellPrice, color: '#34D399', label: t('sellPriceLabel'), dash: 1 });
                    }
                }
            } else if (activeTab === 'margin') {
                const entry   = getNumericValue(marginEntryInput);
                const exit    = getNumericValue(marginExitInput);
                const liqText = marginLiqPriceDisplay.textContent.replace(/[^0-9.]/g, '');
                const liq     = parseFloat(liqText);
                const isShort = marginDirection === 'short';
                if (entry > 0) {
                    levels.push({ price: entry, color: '#10B981', label: t('entryLabel'), dash: 0 });
                    if (exit > 0 && marginTpStrategyMode) {
                        const step = (exit - entry) / 3;
                        const tp1  = entry + step;
                        const tp2  = entry + step * 2;
                        const tp3  = exit;
                        const tp1Reward = Math.abs(tp1 - entry);
                        const sl = isShort
                            ? entry + (tp1Reward / selectedRR)
                            : entry - (tp1Reward / selectedRR);
                        levels.push({ price: tp1, color: '#10B981', label: 'TP1',         dash: 1 });
                        levels.push({ price: tp2, color: '#34D399', label: 'TP2',         dash: 1 });
                        levels.push({ price: tp3, color: '#6EE7B7', label: 'TP3',         dash: 1 });
                        if (sl > 0) levels.push({ price: sl, color: '#EF4444', label: t('stopLossLabel'), dash: 1 });
                    } else if (exit > 0) {
                        levels.push({ price: exit, color: '#34D399', label: t('exitLabel'), dash: 1 });
                    }
                }
                if (liq > 0) {
                    levels.push({ price: liq, color: '#F97316', label: t('liqLabel'), dash: 2 });
                }
            } else if (activeTab === 'risk') {
                const entry      = getNumericValue(riskEntryInput);
                const stoploss   = getNumericValue(riskStoplossInput);
                const takeprofit = getNumericValue(riskTakeprofitInput);
                const isShort    = riskDirection === 'short';

                if (riskTpStrategyMode) {
                    // Стратегия TP — берём закешированные уровни из updateTPSL
                    if (entry > 0) levels.push({ price: entry, color: '#10B981', label: t('entryLabel'), dash: 0 });
                    if (stoploss > 0) levels.push({ price: stoploss, color: '#EF4444', label: t('stopLossLabel'), dash: 1 });
                    const lv = window._tpStrategyLevels;
                    if (lv) {
                        levels.push({ price: lv.tp1, color: '#10B981', label: 'TP1', dash: 1 });
                        levels.push({ price: lv.tp2, color: '#34D399', label: 'TP2', dash: 1 });
                        levels.push({ price: lv.tp3, color: '#6EE7B7', label: 'TP3', dash: 1 });
                    }
                } else {
                    // Простой режим — вход / стоп / TP
                    if (entry > 0) levels.push({ price: entry, color: '#10B981', label: t('entryLabel'), dash: 0 });
                    if (stoploss > 0) levels.push({ price: stoploss, color: '#EF4444', label: t('stopLossLabel'), dash: 1 });
                    if (takeprofit > 0 && (isShort ? takeprofit < entry : takeprofit > entry)) {
                        levels.push({ price: takeprofit, color: '#34D399', label: t('takeProfitLabel'), dash: 1 });
                    }
                }
            }
            return levels;
        }

        // ── Инициализация Lightweight Charts ───────────────────
        function initLWChart() {
            if (lwChart) { lwChart.remove(); lwChart = null; lwSeries = null; lwLevelLines = []; }

            lwChart = LightweightCharts.createChart(lwChartContainer, {
                width:  lwChartContainer.offsetWidth  || 400,
                height: lwChartContainer.offsetHeight || 260,
                layout: {
                    background:  { type: 'solid', color: 'transparent' },
                    textColor:   '#475569',
                    fontFamily:  "'Inter', -apple-system, sans-serif",
                    fontSize:    11,
                },
                grid: {
                    vertLines: { color: 'rgba(255,255,255,0.03)' },
                    horzLines: { color: 'rgba(255,255,255,0.04)' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                    vertLine: { color: 'rgba(255,255,255,0.25)', width: 1, style: 3 },
                    horzLine: { color: 'rgba(255,255,255,0.25)', width: 1, style: 3 },
                },
                rightPriceScale: {
                    borderColor:   'rgba(255,255,255,0.06)',
                    textColor:     '#475569',
                    scaleMargins:  { top: 0.1, bottom: 0.1 },
                },
                timeScale: {
                    borderColor:     'rgba(255,255,255,0.06)',
                    timeVisible:     false,
                    secondsVisible:  false,
                    fixLeftEdge:     false,  // меняем на false
                    fixRightEdge:    false,  // меняем на false
                    lockVisibleTimeRangeOnResize: true, // добавляем
                    rightBarStaysOnScroll: true, // добавляем
                    barSpacing: 12, // добавляем начальный отступ между барами
                },
                handleScroll: {
                    mouseWheel: true,
                    pressedMouseMove: true, // это включает перетаскивание мышкой
                    horzTouchDrag: true,
                    vertTouchDrag: true,
                },
                handleScale: {
                    mouseWheel: true,
                    pinch: true,
                    axisPressedMouseMove: {
                        time: true,
                        price: true,
                    },
                },
                localization: {
                    tickMarkFormatter: (time, tickType) => {
                        const MONTHS_RU = ['янв.','фев.','мар.','апр.','май','июн.','июл.','авг.','сен.','окт.','ноя.','дек.'];
                        const MONTHS_EN = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                        const date = new Date(time * 1000);
                        const m = date.getUTCMonth();
                        const y = date.getUTCFullYear();
                        if (date.getUTCMonth() === 0) return String(y);
                        return currentLang === 'ru' ? MONTHS_RU[m] : MONTHS_EN[m];
                    },
                },
            });

            // Адаптация при ресайзе
            const ro = new ResizeObserver(() => {
                if (lwChart && lwChartContainer.offsetWidth > 0) {
                    lwChart.applyOptions({
                        width:  lwChartContainer.offsetWidth,
                        height: lwChartContainer.offsetHeight || 260,
                    });
                }
            });
            ro.observe(lwChartContainer);
        }

        // ── Рисуем уровни через priceLine ──────────────────────
        function drawLWLevels() {
            if (!lwSeries || !lwChart) return;

            // Убираем старые
            lwLevelLines.forEach(l => { try { lwSeries.removePriceLine(l); } catch {} });
            lwLevelLines = [];

            const levels = getChartLevels();
            levels.forEach(({ price, color, label, dash }) => {
                if (!price || price <= 0) return;
                try {
                    const line = lwSeries.createPriceLine({
                        price,
                        color,
                        lineWidth:           2,
                        lineStyle:           dash,
                        axisLabelVisible:    true,
                        title:               label,
                        axisLabelColor:      color,
                        axisLabelTextColor:  '#fff',
                    });
                    lwLevelLines.push(line);
                } catch(e) { console.warn('priceLine error:', e); }
            });
        }

        // ── Создаём линейную серию (area) ─────────────────────
        let chartDisplayType = 'line'; // 'line' | 'candle'
        let rawPricesCache = [];       // кэш линейных данных
        let rawOhlcCache = [];         // кэш OHLC данных

        function createLWLine(prices) {
            if (lwSeries) { lwChart.removeSeries(lwSeries); lwSeries = null; }

            const values = prices.map(p => p[1]);
            const isPos  = values[values.length - 1] >= values[0];
            const color  = isPos ? '#10B981' : '#EF4444';

            lwSeries = lwChart.addAreaSeries({
                lineColor:        color,
                topColor:         isPos ? 'rgba(16,185,129,0.28)' : 'rgba(239,68,68,0.28)',
                bottomColor:      'rgba(0,0,0,0)',
                lineWidth:        2,
                priceLineVisible: false,
                crosshairMarkerVisible: true,
                crosshairMarkerRadius:  5,
            });

            const data = prices
                .map(([t, v]) => ({ time: Math.floor(t / 1000), value: v }))
                .sort((a, b) => a.time - b.time)
                .filter((d, i, arr) => i === 0 || d.time !== arr[i-1].time);

            lwSeries.setData(data);
        }

        function createLWCandles(ohlc) {
            if (lwSeries) { lwChart.removeSeries(lwSeries); lwSeries = null; }

            lwSeries = lwChart.addCandlestickSeries({
                upColor:          '#10B981',
                downColor:        '#EF4444',
                borderUpColor:    '#10B981',
                borderDownColor:  '#EF4444',
                wickUpColor:      '#10B981',
                wickDownColor:    '#EF4444',
                priceLineVisible: false,
            });

            const data = ohlc
                .map(([t, o, h, l, c]) => ({ time: Math.floor(t / 1000), open: o, high: h, low: l, close: c }))
                .sort((a, b) => a.time - b.time)
                .filter((d, i, arr) => i === 0 || d.time !== arr[i-1].time);

            lwSeries.setData(data);
        }

        // ── Основная функция createChart (вызывается из loadChartData) ─
        function createChart(prices) {
            chartLoading.style.display = 'none';
            if (!lwChart) initLWChart();
            if (chartDisplayType === 'candle' && rawOhlcCache.length) {
                createLWCandles(rawOhlcCache);
            } else {
                createLWLine(prices);
            }
            lwChart.timeScale().fitContent();
            // Прокручиваем правый край к текущему времени чтобы линии не выглядели сдвинутыми
            const nowSec = Math.floor(Date.now() / 1000);
            lwChart.timeScale().scrollToPosition(0, false);
            lwChart.timeScale().setVisibleRange({
                from: prices[0] ? Math.floor(prices[0][0] / 1000) : nowSec - 86400 * 7,
                to: nowSec
            });
            setTimeout(() => drawLWLevels(), 0);
        }

        // ── Перерисовка уровней (вызывается при изменении инпутов) ──
        function redrawChartLevels() {
            drawLWLevels();
        }

        // ════════════════════════════════════════════════════
        // КАЛЬКУЛЯТОР: Риск на сделку
        // ════════════════════════════════════════════════════
        let riskDirection = 'long';

        const riskTpStrategyBtn = document.getElementById('riskTpStrategyBtn');
        const riskTpStrategyBtnSpan = riskTpStrategyBtn.querySelector('[data-i18n]');

        riskTpStrategyBtn.addEventListener('click', () => {
            riskTpStrategyMode = !riskTpStrategyMode;
            riskTpStrategyBtn.classList.toggle('active', riskTpStrategyMode);
            riskTpStrategyBtnSpan.dataset.i18n = riskTpStrategyMode ? 'riskTpStrategyOn' : 'riskTpStrategyOff';
            riskTpStrategyBtnSpan.textContent = t(riskTpStrategyBtnSpan.dataset.i18n);
            redrawChartLevels();
            updateTPSL();
        });

        const sellTpStrategyBtn = document.getElementById('sellTpStrategyBtn');
        const sellTpStrategyBtnSpan = sellTpStrategyBtn.querySelector('[data-i18n]');
        sellTpStrategyBtn.addEventListener('click', () => {
            sellTpStrategyMode = !sellTpStrategyMode;
            sellTpStrategyBtn.classList.toggle('active', sellTpStrategyMode);
            sellTpStrategyBtnSpan.dataset.i18n = sellTpStrategyMode ? 'riskTpStrategyOn' : 'riskTpStrategyOff';
            sellTpStrategyBtnSpan.textContent = t(sellTpStrategyBtnSpan.dataset.i18n);
            redrawChartLevels();
            updateTPSL();
        });

        const marginTpStrategyBtn = document.getElementById('marginTpStrategyBtn');
        const marginTpStrategyBtnSpan = marginTpStrategyBtn.querySelector('[data-i18n]');
        marginTpStrategyBtn.addEventListener('click', () => {
            marginTpStrategyMode = !marginTpStrategyMode;
            marginTpStrategyBtn.classList.toggle('active', marginTpStrategyMode);
            marginTpStrategyBtnSpan.dataset.i18n = marginTpStrategyMode ? 'riskTpStrategyOn' : 'riskTpStrategyOff';
            marginTpStrategyBtnSpan.textContent = t(marginTpStrategyBtnSpan.dataset.i18n);
            redrawChartLevels();
            updateTPSL();
        });

        document.getElementById('riskLong').addEventListener('click', () => {
            riskDirection = 'long';
            document.getElementById('riskLong').classList.add('active', 'long');
            document.getElementById('riskShort').classList.remove('active', 'short');
            calculateRisk();
        });
        document.getElementById('riskShort').addEventListener('click', () => {
            riskDirection = 'short';
            document.getElementById('riskShort').classList.add('active', 'short');
            document.getElementById('riskLong').classList.remove('active', 'long');
            calculateRisk();
        });

        function calculateRisk() {
            const deposit    = getNumericValue(riskDepositInput);
            const riskPct    = getNumericValue(riskPercentInput);
            const entry      = getNumericValue(riskEntryInput);
            const stoploss   = getNumericValue(riskStoplossInput);
            const takeprofit = getNumericValue(riskTakeprofitInput);
            const isShort    = riskDirection === 'short';

            const posUsdEl   = document.getElementById('riskPositionUsd');
            const posCoinsEl = document.getElementById('riskPositionCoins');
            const depPctEl   = document.getElementById('riskDepositPct');
            const riskAmtEl  = document.getElementById('riskAmount');
            const rewardEl   = document.getElementById('riskReward');
            const rrEl       = document.getElementById('riskRR');
            const riskPctEl  = document.getElementById('riskRiskPct');

            // Для шорта стоп должен быть выше входа, для лонга — ниже
            const validStop = isShort ? stoploss > entry : stoploss > 0 && stoploss < entry;

            if (!deposit || !riskPct || !entry || !stoploss || !validStop) {
                posUsdEl.textContent   = '$0.00';
                posCoinsEl.textContent = '0';
                depPctEl.textContent   = '0%';
                riskAmtEl.textContent  = '$0.00';
                rewardEl.textContent   = '$0.00';
                rrEl.textContent       = '—';
                riskPctEl.textContent  = '0%';
                window._riskCoins     = 0;
                window._riskEntry     = 0;
                window._riskUsd       = 0;
                redrawChartLevels();
                updateTPSL();
                return;
            }

            const riskAmount    = deposit * (riskPct / 100);
            const riskPerCoin   = isShort ? stoploss - entry : entry - stoploss;
            const positionCoins = riskAmount / riskPerCoin;
            const positionUsd   = positionCoins * entry;
            const depositPct    = (positionUsd / deposit) * 100;

            // Кешируем для updateTPSL
            window._riskCoins = positionCoins;
            window._riskEntry = entry;
            window._riskUsd   = positionUsd;

            posUsdEl.textContent   = '$' + formatNumber(positionUsd);
            posCoinsEl.textContent = positionCoins.toFixed(6).replace(/\.?0+$/, '');
            depPctEl.textContent   = depositPct.toFixed(1) + '%';
            riskAmtEl.textContent  = '$' + formatNumber(riskAmount);
            riskPctEl.textContent  = riskPct.toFixed(2) + '%';

            if (takeprofit && (isShort ? takeprofit < entry : takeprofit > entry)) {
                const reward = positionCoins * Math.abs(takeprofit - entry);
                const rr     = reward / riskAmount;
                rewardEl.textContent = '+$' + formatNumber(reward);
                rrEl.textContent     = '1:' + rr.toFixed(2);
                rrEl.className       = 'stat-value ' + (rr >= 2 ? 'positive' : rr >= 1 ? '' : 'negative');
            } else {
                rewardEl.textContent = '—';
                rrEl.textContent     = '—';
                rrEl.className       = 'stat-value';
            }

            redrawChartLevels();
            updateTPSL();
        }

        [riskDepositInput, riskPercentInput, riskEntryInput, riskStoplossInput, riskTakeprofitInput].forEach(el => {
            el?.addEventListener('input', calculateRisk);
        });

        // ── RR выбор ──────────────────────────────────────
        let selectedRR = 2; // по умолчанию 1:2

        document.querySelectorAll('.rr-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.rr-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedRR = parseInt(btn.dataset.rr);
                updateTPSL();
                redrawChartLevels();
            });
        });

        // ── TP / SL / RR ──────────────────────────────────
        function updateTPSL() {
            const prices = window._tpslChartPrices;
            const activeTab = document.querySelector('.tab-content.active')?.id?.replace('tab-','');

            let avgEntry = 0, totalCoins = 0, totalInvested = 0;

            if (activeTab === 'risk') {
                if (!riskTpStrategyMode) {
                    document.getElementById('tpStrategyRow').style.display = 'none';
                    ['tp1Price','tp2Price','tp3Price'].forEach(id => document.getElementById(id).textContent = '—');
                    ['tp1Pct','tp2Pct','tp3Pct'].forEach(id => document.getElementById(id).textContent = '—');
                    ['tp1Profit','tp2Profit','tp3Profit'].forEach(id => document.getElementById(id).textContent = '—');
                    document.getElementById('slPrice').textContent = '—';
                    document.getElementById('slPct').textContent = '—';
                    document.getElementById('slProfit').textContent = '—';
                    document.getElementById('tpslRR').textContent = 'RR —';
                    return;
                }
                avgEntry      = window._riskEntry  || 0;
                totalCoins    = window._riskCoins  || 0;
                totalInvested = window._riskUsd    || 0;
            } else if (activeTab === 'margin') {
                if (!marginTpStrategyMode) {
                    document.getElementById('marginTpStrategyRow').style.display = 'none';
                    ['tp1Price','tp2Price','tp3Price'].forEach(id => document.getElementById(id).textContent = '—');
                    ['tp1Pct','tp2Pct','tp3Pct'].forEach(id => document.getElementById(id).textContent = '—');
                    ['tp1Profit','tp2Profit','tp3Profit'].forEach(id => document.getElementById(id).textContent = '—');
                    document.getElementById('slPrice').textContent = '—';
                    document.getElementById('slPct').textContent = '—';
                    document.getElementById('slProfit').textContent = '—';
                    document.getElementById('tpslRR').textContent = 'RR —';
                    return;
                }
                avgEntry = getNumericValue(marginEntryInput);
                const collateral = getNumericValue(marginCollateralInput);
                const leverage   = getNumericValue(marginLeverageInput);
                if (avgEntry > 0 && collateral > 0 && leverage > 0) {
                    const posSize = collateral * leverage;
                    totalCoins    = posSize / avgEntry;
                    totalInvested = collateral;
                }
            } else {
                if (!sellTpStrategyMode) {
                    document.getElementById('tpStrategyRow').style.display = 'none';
                    ['tp1Price','tp2Price','tp3Price'].forEach(id => document.getElementById(id).textContent = '—');
                    ['tp1Pct','tp2Pct','tp3Pct'].forEach(id => document.getElementById(id).textContent = '—');
                    ['tp1Profit','tp2Profit','tp3Profit'].forEach(id => document.getElementById(id).textContent = '—');
                    document.getElementById('slPrice').textContent = '—';
                    document.getElementById('slPct').textContent = '—';
                    document.getElementById('slProfit').textContent = '—';
                    document.getElementById('tpslRR').textContent = 'RR —';
                    return;
                }
                const cards = buyEntriesContainer.querySelectorAll('.buy-row');
                cards.forEach(card => {
                    const amount = getNumericValue(card.querySelector('.amount-input'));
                    const price  = getNumericValue(card.querySelector('.price-input'));
                    if (amount > 0 && price > 0) {
                        totalInvested += amount;
                        totalCoins    += amount / price;
                    }
                });
                avgEntry = totalInvested > 0 && totalCoins > 0 ? totalInvested / totalCoins : 0;
            }

            if (!avgEntry || !prices || prices.length < 2) {
                document.getElementById('tpStrategyRow').style.display = 'none';
                ['tp1Price','tp2Price','tp3Price'].forEach(id => document.getElementById(id).textContent = '—');
                ['tp1Pct','tp2Pct','tp3Pct'].forEach(id => document.getElementById(id).textContent = '—');
                ['tp1Profit','tp2Profit','tp3Profit'].forEach(id => document.getElementById(id).textContent = '—');
                document.getElementById('slPrice').textContent = '—';
                document.getElementById('slPct').textContent = '—';
                document.getElementById('slProfit').textContent = '—';
                document.getElementById('tpslRR').textContent = 'RR —';
                return;
            }

            const isShort = (activeTab === 'margin' && marginDirection === 'short') ||
                            (activeTab === 'risk'   && riskDirection   === 'short');

            let tp1, tp2, tp3;

            if (activeTab === 'risk') {
                const tp = getNumericValue(riskTakeprofitInput);
                const targetPrice = tp > 0 ? tp : avgEntry * (isShort ? 0.9 : 1.1);
                const step = (targetPrice - avgEntry) / 3;
                tp1 = avgEntry + step;
                tp2 = avgEntry + step * 2;
                tp3 = targetPrice;
            } else if (activeTab === 'margin') {
                // Для маржи: TP считаем из цены входа и выхода калькулятора
                const exitPrice = getNumericValue(marginExitInput);
                const targetPrice = exitPrice > 0 ? exitPrice : avgEntry * (isShort ? 0.9 : 1.1);
                const step = (targetPrice - avgEntry) / 3;
                tp1 = avgEntry + step;
                tp2 = avgEntry + step * 2;
                tp3 = targetPrice;
            } else {
                // Для продажи: равные шаги от средней цены входа до цены продажи
                const sellPrice = getNumericValue(sellPriceInput);
                const targetPrice = sellPrice > 0 ? sellPrice : avgEntry * 1.1;
                const step = (targetPrice - avgEntry) / 3;
                tp1 = avgEntry + step;
                tp2 = avgEntry + step * 2;
                tp3 = targetPrice;
            }

            const tp1Reward = isShort ? avgEntry - tp1 : tp1 - avgEntry;

            // Для риска берём реальный стоп из поля, для остальных считаем по RR
            let sl;
            if (activeTab === 'risk') {
                sl = getNumericValue(riskStoplossInput);
            } else {
                sl = isShort
                    ? avgEntry + (tp1Reward > 0 ? tp1Reward / selectedRR : 0)
                    : avgEntry - (tp1Reward > 0 ? tp1Reward / selectedRR : 0);
            }

            // Кешируем уровни стратегии для отрисовки на графике
            window._tpStrategyLevels = { tp1, tp2, tp3, sl, avgEntry, isShort };

            const fmt      = v => `$${v.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            const pct      = v => ((isShort ? avgEntry - v : v - avgEntry) / avgEntry * 100).toFixed(1);
            const fmtPct   = v => `${parseFloat(v) >= 0 ? '+' : ''}${v}%`;
            const profitAt = (tpPrice, share) => {
                const coins = totalCoins * share;
                return isShort
                    ? (avgEntry - tpPrice) * coins
                    : (tpPrice - avgEntry) * coins;
            };
            const fmtProfit = v => `${v >= 0 ? '+' : '-'}$${Math.abs(v).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            document.getElementById('tp1Price').textContent = fmt(tp1);
            document.getElementById('tp2Price').textContent = fmt(tp2);
            document.getElementById('tp3Price').textContent = fmt(tp3);
            document.getElementById('slPrice').textContent  = fmt(sl);

            document.getElementById('tp1Pct').textContent  = fmtPct(pct(tp1));
            document.getElementById('tp2Pct').textContent  = fmtPct(pct(tp2));
            document.getElementById('tp3Pct').textContent  = fmtPct(pct(tp3));
            document.getElementById('slPct').textContent   = `-${Math.abs(parseFloat(pct(sl))).toFixed(1)}%`;

            document.getElementById('tp1Profit').textContent = fmtProfit(profitAt(tp1, 0.5));
            document.getElementById('tp2Profit').textContent = fmtProfit(profitAt(tp2, 0.3));
            document.getElementById('tp3Profit').textContent = fmtProfit(profitAt(tp3, 0.2));

            if (sl > 0) {
                const slLoss = profitAt(sl, 1.0);
                const slProfitEl = document.getElementById('slProfit');
                slProfitEl.textContent = fmtProfit(slLoss);
                slProfitEl.className   = 'tpsl-profit negative';
                document.getElementById('slProfit').textContent = fmtProfit(slLoss);
            } else {
                document.getElementById('slProfit').textContent = '—';
            }

            // RR — показываем выбранный
            document.getElementById('tpslRR').textContent = `RR 1:${selectedRR}`;

            // Суммарная прибыль по стратегии TP
            const tp1Profit = (tp1 - avgEntry) * totalCoins * 0.5;
            const tp2Profit = (tp2 - avgEntry) * totalCoins * 0.3;
            const tp3Profit = (tp3 - avgEntry) * totalCoins * 0.2;
            const totalTpProfit = tp1Profit + tp2Profit + tp3Profit;
            const totalTpPct = (totalTpProfit / totalInvested * 100).toFixed(2);

            // Для маржи показываем в своём блоке, для остальных — в общем
            if (activeTab === 'margin') {
                const mRow = document.getElementById('marginTpStrategyRow');
                const mProfit = document.getElementById('marginTpStrategyProfit');
                const mPct = document.getElementById('marginTpStrategyPct');
                if (totalTpProfit !== 0) {
                    mProfit.textContent = `${totalTpProfit >= 0 ? '+' : '-'}$${Math.abs(totalTpProfit).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    mPct.textContent = `${totalTpPct >= 0 ? '+' : ''}${totalTpPct}% ${t('ofInvestment')}`;
                    mRow.style.display = 'block';
                } else {
                    mRow.style.display = 'none';
                }
                document.getElementById('tpStrategyRow').style.display = 'none';
            } else {
                document.getElementById('marginTpStrategyRow') && (document.getElementById('marginTpStrategyRow').style.display = 'none');
                const strategyRow = document.getElementById('tpStrategyRow');
                const strategyProfit = document.getElementById('tpStrategyProfit');
                const strategyPct = document.getElementById('tpStrategyPct');
                if (totalTpProfit > 0) {
                    strategyProfit.textContent = `+$${totalTpProfit.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    strategyPct.textContent = `+${totalTpPct}% ${t('ofInvestment')}`;
                    strategyRow.style.display = 'block';
                } else {
                    strategyRow.style.display = 'none';
                }
            }

            // Перерисовываем график с уровнями если стратегия активна
            const activeTab2 = document.querySelector('.tab-content.active')?.id?.replace('tab-','');
            if ((activeTab2 === 'risk'   && riskTpStrategyMode)   ||
                (activeTab2 === 'sell'   && sellTpStrategyMode)   ||
                (activeTab2 === 'margin' && marginTpStrategyMode)) {
                redrawChartLevels();
            }
        }

        async function loadChartData() {
            chartLoading.style.display = 'flex';
            // Загружаем только OHLC данные (свечи)
            const ohlc = await fetchOhlcData(selectedCoin.id, currentPeriod);
            if (ohlc && ohlc.length) {
                // Преобразуем свечи в формат [timestamp, close] для линейного графика
                const prices = ohlc.map(([t, o, h, l, c]) => [t, c]);
                rawPricesCache = prices;
                rawOhlcCache = ohlc;

                // Обновляем текущую цену из последней свечи
                const lastPrice = prices[prices.length - 1][1];
                if (lastPrice && lastPrice > 0) {
                    currentCoinPrice = lastPrice;
                    currentPriceSpan.textContent = `$${lastPrice.toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}`;
                }

                window._lastChartPrices = prices;
                createChart(prices);          // создаёт график (линию или свечи) на основе chartDisplayType
                updateChangeBadge(prices);
                updateRSI(prices);
                updateZScore(prices);
                window._tpslChartPrices = prices;
                updateTPSL();
                updateProgressBar();
                calculateMargin();
            } else {
                chartLoading.textContent = t('chartError');
            }
        }

        // Переключатель источника графика (Наш / TradingView)
        document.getElementById('btnOurChart').addEventListener('click', () => {
            document.getElementById('btnOurChart').classList.add('active');
            document.getElementById('btnTVChart').classList.remove('active');
            document.getElementById('ourChartWrap').style.display = 'block';
            document.getElementById('tvChartWrap').style.display = 'none';
            document.getElementById('ourChartControls').style.display = 'flex';
            if (lwChart) lwChart.applyOptions({ width: document.getElementById('lwPriceChart').offsetWidth });
        });
        document.getElementById('btnTVChart').addEventListener('click', () => {
            document.getElementById('btnTVChart').classList.add('active');
            document.getElementById('btnOurChart').classList.remove('active');
            document.getElementById('ourChartWrap').style.display = 'none';
            document.getElementById('tvChartWrap').style.display = 'block';
            document.getElementById('ourChartControls').style.display = 'none';
        });

        // Переключатель тип графика
        document.getElementById('btnLine').addEventListener('click', () => {
            if (chartDisplayType === 'line') return;
            chartDisplayType = 'line';
            document.getElementById('btnLine').classList.add('active');
            document.getElementById('btnCandle').classList.remove('active');
            if (rawPricesCache.length) createChart(rawPricesCache);
        });
        document.getElementById('btnCandle').addEventListener('click', () => {
            if (chartDisplayType === 'candle') return;
            chartDisplayType = 'candle';
            document.getElementById('btnCandle').classList.add('active');
            document.getElementById('btnLine').classList.remove('active');
            if (rawPricesCache.length) createChart(rawPricesCache);
        });

        async function updateCurrentPrice() {
            currentPriceSpan.textContent = '⏳...';
            // Запускаем параллельно — точная цена и данные графика
            const [price] = await Promise.all([
                fetchCoinPrice(selectedCoin.id),
                loadChartData()
            ]);
            // Обновляем точной ценой если она пришла
            if (price && price > 0) {
                currentCoinPrice = price;
                currentPriceSpan.textContent = `$${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                updateProgressBar();
                calculateMargin();
            }
        }

        // ── ATR ───────────────────────────────────────────
        let atrMiniChartInst = null;

        async function fetchOHLC(id) {
            try {
                const symbol = BINANCE_SYMBOLS[id];
                if (symbol) {
                    const r = await fetch(`/api/ohlc?symbol=${symbol}&interval=1d&limit=14`);
                    const d = await r.json();
                    if (Array.isArray(d)) return d.map(k => [k[0], parseFloat(k[1]), parseFloat(k[2]), parseFloat(k[3]), parseFloat(k[4])]);
                }
                const r = await fetch(`/api/ohlc?id=${id}&days=14`);
                const d = await r.json();
                return Array.isArray(d) ? d : [];
            } catch { return []; }
        }

        function calcATR(ohlc) {
            // ohlc: [[ts, open, high, low, close], ...]
            if (!ohlc || ohlc.length < 2) return null;
            const trs = [];
            for (let i = 1; i < ohlc.length; i++) {
                const [, , high, low] = ohlc[i];
                const prevClose = ohlc[i - 1][4];
                const tr = Math.max(
                    high - low,
                    Math.abs(high - prevClose),
                    Math.abs(low - prevClose)
                );
                trs.push(tr);
            }
            // Simple average (Wilder's smoothing requires more history — fine for 14 periods)
            const period = Math.min(14, trs.length);
            const slice = trs.slice(-period);
            const atr = slice.reduce((s, v) => s + v, 0) / slice.length;
            const avg = trs.reduce((s, v) => s + v, 0) / trs.length;
            const maxTr = Math.max(...trs);
            const minTr = Math.min(...trs);
            return { atr, trs, avg, maxTr, minTr };
        }

        function renderATRMiniChart(trs) {
            const canvas = document.getElementById('atrMiniChart');
            if (!canvas) return;
            if (atrMiniChartInst) { atrMiniChartInst.destroy(); atrMiniChartInst = null; }
            const last14 = trs.slice(-14);
            const atrLine = last14.map((_, i, arr) => {
                // rolling average up to i+1
                const window = arr.slice(0, i + 1);
                return window.reduce((s, v) => s + v, 0) / window.length;
            });

            canvas.height = 36;
            atrMiniChartInst = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: atrLine.map((_, i) => i + 1),
                    datasets: [{
                        data: atrLine,
                        borderColor: '#6366F1',
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: (ctx) => {
                            const gradient = ctx.chart.ctx.createLinearGradient(0, 0, 0, 48);
                            gradient.addColorStop(0, 'rgba(99,102,241,0.3)');
                            gradient.addColorStop(1, 'rgba(99,102,241,0)');
                            return gradient;
                        },
                        tension: 0.4,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: false,
                    animation: { duration: 600 },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        function updateATRCard(result, currentPrice) {
            const badge   = document.getElementById('atrBadge');
            const valUsd  = document.getElementById('atrValueUsd');
            const valPct  = document.getElementById('atrValuePct');
            const vsAvg   = document.getElementById('atrVsAvg');
            const minSl   = document.getElementById('atrMinSl');
            const rangeEl = document.getElementById('atrRange');
            const loading = document.getElementById('atrLoading');
            const values  = document.getElementById('atrValues');
            const rows    = document.getElementById('atrRows');

            if (!result) {
                loading.style.display = 'flex';
                values.style.display = 'none';
                rows.style.display = 'none';
                badge.textContent = '—';
                badge.className = 'ind-badge';
                return;
            }

            loading.style.display = 'none';
            values.style.display = 'flex';
            rows.style.display = 'flex';

            const { atr, trs, avg, maxTr, minTr } = result;
            const pct = currentPrice ? (atr / currentPrice * 100) : 0;

            // Форматирование ATR в $
            const fmtPrice = v => v >= 1
                ? `$${v.toLocaleString('en-US', { maximumFractionDigits: 2 })}`
                : `$${v.toFixed(4)}`;

            valUsd.textContent = fmtPrice(atr);
            valPct.textContent = pct ? `${pct.toFixed(2)}% ${t('ofPrice')}` : '';

            // Волатильность vs историческое среднее
            const ratio = atr / avg;
            let volLabel, volClass;
            if (ratio > 1.3)       { volLabel = `🔥 ${t('volHigh')}`;   volClass = 'red'; }
            else if (ratio < 0.75) { volLabel = `😴 ${t('volLow')}`;    volClass = 'green'; }
            else                   { volLabel = `✅ ${t('volModerate')}`;  volClass = ''; }

            vsAvg.textContent = volLabel;
            vsAvg.className = `ind-row-value ${volClass}`;

            // Бейдж
            if (ratio > 1.3)       { badge.textContent = t('volHigh'); badge.className = 'ind-badge bearish'; }
            else if (ratio < 0.75) { badge.textContent = t('volLow');  badge.className = 'ind-badge bullish'; }
            else                   { badge.textContent = t('volModerate'); badge.className = 'ind-badge neutral'; }

            // Минимальный SL (1.5 × ATR)
            minSl.textContent = fmtPrice(atr * 1.5);

            // Диапазон ATR за период
            rangeEl.textContent = `${fmtPrice(maxTr)} / ${fmtPrice(minTr)}`;

            // Мини-график
            renderATRMiniChart(trs);
        }

        async function loadATR() {
            updateATRCard(null, currentCoinPrice);
            const cache = await ensureIndCache(selectedCoin.id);
            const ohlc = cache ? cache.ohlc : await fetchOHLC(selectedCoin.id);
            const result = calcATR(ohlc);
            updateATRCard(result, currentCoinPrice);
        }

        // ── EMA 20 / 50 ───────────────────────────────────
        function calcEMA(prices, period) {
            // prices: array of close values (numbers)
            if (prices.length < period) return null;
            const k = 2 / (period + 1);
            // seed = simple average of first `period` values
            let ema = prices.slice(0, period).reduce((s, v) => s + v, 0) / period;
            for (let i = period; i < prices.length; i++) {
                ema = prices[i] * k + ema * (1 - k);
            }
            return ema;
        }

        // ══ Единый кэш данных для индикаторов (Binance) ══════════
        // Один запрос покрывает все индикаторы: EMA, RSI, BB, MACD,
        // StochRSI, OBV, CCI, VWAP, MFI, WilliamsR, ATR
        let _indCache = null; // { closes, volumes, ohlc, ts } или null

        async function fetchIndData(id) {
            const symbol = BINANCE_SYMBOLS[id];
            if (symbol) {
                try {
                    // 90 дневных свечей: open, high, low, close, volume
                    const r = await fetch(`/api/indicators?symbol=${symbol}`);
                    const d = await r.json();
                    if (Array.isArray(d) && d.length >= 20) {
                        return {
                            closes:  d.map(k => parseFloat(k[4])),
                            volumes: d.map(k => parseFloat(k[5])),
                            ohlc:    d.map(k => [k[0], parseFloat(k[1]), parseFloat(k[2]), parseFloat(k[3]), parseFloat(k[4])]),
                            ts:      Date.now()
                        };
                    }
                } catch(e) { console.warn('Binance ind fetch error:', e); }
            }
            // Fallback: CoinGecko
            try {
                const [chartR, ohlcR] = await Promise.all([
                    fetch(`/api/chart?id=${id}&days=90`),
                    fetch(`/api/ohlc?id=${id}&days=30`)
                ]);
                const chartD = await chartR.json();
                const ohlcD  = await ohlcR.json();
                return {
                    closes:  (chartD.prices       || []).map(p => p[1]),
                    volumes: (chartD.total_volumes || []).map(v => v[1]),
                    ohlc:    Array.isArray(ohlcD) ? ohlcD : [],
                    ts:      Date.now()
                };
            } catch { return null; }
        }

        // Загружает кэш если его нет или он устарел (>5 мин)
        async function ensureIndCache(id) {
            if (_indCache && _indCache.id === id && Date.now() - _indCache.ts < 5 * 60 * 1000) {
                return _indCache;
            }
            const data = await fetchIndData(id);
            if (data) {
                _indCache = { ...data, id };
            }
            return _indCache;
        }

        async function fetchEMAData(id) {
            const cache = await ensureIndCache(id);
            return cache ? cache.closes : [];
        }

        function updateEMACard(closes, currentPrice) {
            const badge       = document.getElementById('emaBadge');
            const loading     = document.getElementById('emaLoading');
            const signalWrap  = document.getElementById('emaSignalWrap');
            const rows        = document.getElementById('emaRows');
            const signalIcon  = document.getElementById('emaSignalIcon');
            const signalLabel = document.getElementById('emaSignalLabel');
            const signalSub   = document.getElementById('emaSignalSub');
            const val20       = document.getElementById('emaVal20');
            const val50       = document.getElementById('emaVal50');
            const dist20      = document.getElementById('emaDist20');
            const dist50      = document.getElementById('emaDist50');
            const scaleLow    = document.getElementById('emaScaleLow');
            const scaleHigh   = document.getElementById('emaScaleHigh');
            const scaleDot    = document.getElementById('emaScaleDot');

            if (!closes || closes.length < 50) {
                loading.style.display = 'flex';
                signalWrap.style.display = 'none';
                rows.style.display = 'none';
                badge.textContent = '—';
                badge.className = 'ind-badge';
                return;
            }

            loading.style.display = 'none';
            signalWrap.style.display = 'block';
            rows.style.display = 'flex';

            const ema20 = calcEMA(closes, 20);
            const ema50 = calcEMA(closes, 50);
            const price = currentPrice || closes[closes.length - 1];

            const fmtP = v => v >= 1
                ? `$${v.toLocaleString('en-US', { maximumFractionDigits: 2 })}`
                : `$${v.toFixed(4)}`;
            const fmtDist = (p, e) => {
                const pct = ((p - e) / e * 100);
                const sign = pct >= 0 ? '+' : '';
                return `${sign}${pct.toFixed(2)}%`;
            };

            val20.textContent = fmtP(ema20);
            val50.textContent = fmtP(ema50);

            // Расстояние цены до EMA
            const d20pct = (price - ema20) / ema20 * 100;
            const d50pct = (price - ema50) / ema50 * 100;
            dist20.textContent = fmtDist(price, ema20);
            dist20.className = `ind-row-value ${d20pct >= 0 ? 'green' : 'red'}`;
            dist50.textContent = fmtDist(price, ema50);
            dist50.className = `ind-row-value ${d50pct >= 0 ? 'green' : 'red'}`;

            // Сигнал
            // SVG иконки сигналов
            const SVG_UP = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                <path d="M9 14V4M9 4L4 9M9 4L14 9" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            const SVG_DOWN = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                <path d="M9 4V14M9 14L4 9M9 14L14 9" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            const SVG_CORR = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                <path d="M4 9H14M14 9L10 5M14 9L10 13" stroke="#FBBF24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`;
            const SVG_NEUT = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                <path d="M5 6h8M5 12h8" stroke="#64748B" stroke-width="2" stroke-linecap="round"/>
            </svg>`;

            let svgIcon, iconBg, label, sub, badgeText, badgeClass, signalBg, signalBorder;

            if (ema20 > ema50 && price > ema20) {
                svgIcon = SVG_UP; iconBg = 'rgba(16,185,129,0.15)';
                label = 'Golden Cross'; sub = t('emaGoldenSub');
                badgeText = t('badgeBullish2'); badgeClass = 'ind-badge bullish';
                signalBg = 'rgba(16,185,129,0.06)'; signalBorder = 'rgba(16,185,129,0.15)';
            } else if (ema20 < ema50 && price < ema50) {
                svgIcon = SVG_DOWN; iconBg = 'rgba(239,68,68,0.15)';
                label = 'Death Cross'; sub = t('emaDeathSub');
                badgeText = t('badgeBearish2'); badgeClass = 'ind-badge bearish';
                signalBg = 'rgba(239,68,68,0.06)'; signalBorder = 'rgba(239,68,68,0.15)';
            } else if (ema20 > ema50 && price < ema20) {
                svgIcon = SVG_CORR; iconBg = 'rgba(251,191,36,0.15)';
                label = t('emaCorrection'); sub = t('emaCorrectionSub');
                badgeText = t('emaCorrection'); badgeClass = 'ind-badge neutral';
                signalBg = 'rgba(251,191,36,0.06)'; signalBorder = 'rgba(251,191,36,0.15)';
            } else {
                svgIcon = SVG_NEUT; iconBg = 'rgba(100,116,139,0.15)';
                label = t('neutral'); sub = t('emaNeutralSub');
                badgeText = t('neutral'); badgeClass = 'ind-badge neutral';
                signalBg = 'rgba(255,255,255,0.03)'; signalBorder = 'rgba(255,255,255,0.06)';
            }

            signalIcon.innerHTML = svgIcon;
            signalIcon.style.background = iconBg;
            signalLabel.textContent = label;
            signalSub.textContent = sub;
            const sigEl = document.getElementById('emaSignal');
            sigEl.style.background = signalBg;
            sigEl.style.borderColor = signalBorder;
            badge.textContent = badgeText;
            badge.className = badgeClass;

            // Шкала позиции цены между EMA
            const lo = Math.min(ema20, ema50);
            const hi = Math.max(ema20, ema50);
            scaleLow.textContent  = ema50 < ema20 ? 'EMA 50' : 'EMA 20';
            scaleHigh.textContent = ema50 < ema20 ? 'EMA 20' : 'EMA 50';

            // Диапазон шкалы: от lo-5% до hi+5%
            const pad = (hi - lo) * 0.5 + (hi - lo < price * 0.001 ? price * 0.02 : 0);
            const rangeMin = Math.min(lo, price) - pad;
            const rangeMax = Math.max(hi, price) + pad;
            const total = rangeMax - rangeMin;

            const dotPct   = ((price - rangeMin) / total * 100).toFixed(1);
            scaleDot.style.left = `${Math.max(2, Math.min(98, dotPct))}%`;
        }

        async function loadEMA() {
            updateEMACard(null, currentCoinPrice);
            const closes = await fetchEMAData(selectedCoin.id);
            window._ema90closes = closes; // кеш для StochRSI
            updateEMACard(closes, currentCoinPrice);
        }

        // ── Stochastic RSI ────────────────────────────────
        function calcRSISeries(closes, period = 14) {
            // Returns array of RSI values (same length as closes, first period-1 are null)
            const rsi = new Array(closes.length).fill(null);
            if (closes.length < period + 1) return rsi;

            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                const d = closes[i] - closes[i - 1];
                if (d > 0) gains += d; else losses -= d;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            rsi[period] = 100 - 100 / (1 + (avgLoss === 0 ? Infinity : avgGain / avgLoss));

            for (let i = period + 1; i < closes.length; i++) {
                const d = closes[i] - closes[i - 1];
                avgGain = (avgGain * (period - 1) + Math.max(d, 0)) / period;
                avgLoss = (avgLoss * (period - 1) + Math.max(-d, 0)) / period;
                rsi[i] = 100 - 100 / (1 + (avgLoss === 0 ? Infinity : avgGain / avgLoss));
            }
            return rsi;
        }

        function sma(arr, period) {
            const result = [];
            for (let i = 0; i < arr.length; i++) {
                if (i < period - 1) { result.push(null); continue; }
                const slice = arr.slice(i - period + 1, i + 1);
                if (slice.some(v => v === null)) { result.push(null); continue; }
                result.push(slice.reduce((s, v) => s + v, 0) / period);
            }
            return result;
        }

        function calcStochRSI(closes, rsiPeriod = 14, stochPeriod = 14, kPeriod = 3, dPeriod = 3) {
            const rsiSeries = calcRSISeries(closes, rsiPeriod).filter(v => v !== null);
            if (rsiSeries.length < stochPeriod) return null;

            // StochRSI raw
            const stochRaw = [];
            for (let i = stochPeriod - 1; i < rsiSeries.length; i++) {
                const window = rsiSeries.slice(i - stochPeriod + 1, i + 1);
                const lo = Math.min(...window);
                const hi = Math.max(...window);
                stochRaw.push(hi === lo ? 0 : (rsiSeries[i] - lo) / (hi - lo) * 100);
            }

            // %K = SMA(stochRaw, kPeriod)
            const kSeries = sma(stochRaw, kPeriod).filter(v => v !== null);
            // %D = SMA(%K, dPeriod)
            const dSeries = sma(kSeries, dPeriod).filter(v => v !== null);

            if (!kSeries.length || !dSeries.length) return null;

            const k = kSeries[kSeries.length - 1];
            const d = dSeries[dSeries.length - 1];
            const kPrev = kSeries[kSeries.length - 2] ?? k;
            const dPrev = dSeries[dSeries.length - 2] ?? d;

            return { k, d, kPrev, dPrev };
        }

        function updateStochCard(closes) {
            const badge   = document.getElementById('stochBadge');
            const loading = document.getElementById('stochLoading');
            const wrap    = document.getElementById('stochScaleWrap');
            const rows    = document.getElementById('stochRows');
            const kVal    = document.getElementById('stochKVal');
            const dVal    = document.getElementById('stochDVal');
            const needleK = document.getElementById('stochNeedleK');
            const needleD = document.getElementById('stochNeedleD');
            const signal  = document.getElementById('stochSignal');
            const zone    = document.getElementById('stochZone');
            const diff    = document.getElementById('stochDiff');

            if (!closes || closes.length < 40) {
                loading.style.display = 'flex';
                wrap.style.display = 'none';
                rows.style.display = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            const result = calcStochRSI(closes);
            if (!result) {
                loading.style.display = 'flex';
                wrap.style.display = 'none';
                rows.style.display = 'none';
                return;
            }

            loading.style.display = 'none';
            wrap.style.display = 'flex';
            rows.style.display = 'flex';

            const { k, d, kPrev, dPrev } = result;

            kVal.textContent = k.toFixed(1);
            dVal.textContent = d.toFixed(1);

            // Иглы на шкале (0–100 → 0–100%)
            needleK.style.left = `${Math.max(1, Math.min(99, k))}%`;
            needleD.style.left = `${Math.max(1, Math.min(99, d))}%`;

            // Зона
            let zoneText, zoneClass, badgeText, badgeClass;
            if (k > 80)      { zoneText = t('overboughtZone'); zoneClass = 'red';   badgeText = t('overboughtShort'); badgeClass = 'ind-badge bearish'; }
            else if (k < 20) { zoneText = t('oversoldZone');   zoneClass = 'green'; badgeText = t('oversoldShort');   badgeClass = 'ind-badge bullish'; }
            else             { zoneText = t('neutralZone');     zoneClass = '';      badgeText = t('neutral');          badgeClass = 'ind-badge neutral'; }

            zone.textContent = zoneText;
            zone.className = `ind-row-value ${zoneClass}`;
            badge.textContent = badgeText;
            badge.className = badgeClass;

            // Сигнал пересечения
            const crossUp   = kPrev <= dPrev && k > d;
            const crossDown = kPrev >= dPrev && k < d;
            let signalText, signalClass;
            if (crossUp)        { signalText = `▲ ${t('bullCross')}`; signalClass = 'green'; }
            else if (crossDown) { signalText = `▼ ${t('bearCross')}`; signalClass = 'red'; }
            else if (k > d)     { signalText = `%K ${t('above')} %D`; signalClass = 'green'; }
            else                { signalText = `%K ${t('below')} %D`; signalClass = 'red'; }

            signal.textContent = signalText;
            signal.className = `ind-row-value ${signalClass}`;

            // Разница %K − %D
            const diffVal = k - d;
            diff.textContent = `${diffVal >= 0 ? '+' : ''}${diffVal.toFixed(1)}`;
            diff.className = `ind-row-value ${diffVal >= 0 ? 'green' : 'red'}`;
        }

        async function loadStochRSI() {
            updateStochCard(null);
            // Переиспользуем данные EMA (90д) если уже есть, иначе запрашиваем
            let closes = window._ema90closes;
            if (!closes) {
                closes = await fetchEMAData(selectedCoin.id);
                window._ema90closes = closes;
            }
            updateStochCard(closes);
        }

        // ── RSI Расширенный ───────────────────────────────
        function updateRSIExtCard(closes) {
            const badge      = document.getElementById('rsiExtBadge');
            const loading    = document.getElementById('rsiExtLoading');
            const wrap       = document.getElementById('rsiExtWrap');
            const rows       = document.getElementById('rsiExtRows');
            const consensus  = document.getElementById('rsiExtConsensus');
            const divergence = document.getElementById('rsiExtDivergence');

            if (!closes || closes.length < 25) {
                loading.style.display = 'flex';
                wrap.style.display = 'none';
                rows.style.display = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            // Считаем RSI для трёх периодов
            const periods = [7, 14, 21];
            const rsiValues = {};
            periods.forEach(p => {
                const series = calcRSISeries(closes, p).filter(v => v !== null);
                rsiValues[p] = series.length ? series[series.length - 1] : null;
            });

            if (Object.values(rsiValues).some(v => v === null)) {
                loading.style.display = 'flex';
                wrap.style.display = 'none';
                rows.style.display = 'none';
                return;
            }

            loading.style.display = 'none';
            wrap.style.display = 'flex';
            rows.style.display = 'flex';

            // Цвет иглы по зоне
            function needleColor(v) {
                if (v > 70) return '#EF4444';
                if (v < 30) return '#10B981';
                return 'white';
            }

            periods.forEach(p => {
                const v = rsiValues[p];
                const needle = document.getElementById(`rsiExt${p}Needle`);
                const valEl  = document.getElementById(`rsiExt${p}Val`);
                needle.style.left = `${Math.max(1, Math.min(99, v))}%`;
                needle.style.background = needleColor(v);
                needle.style.boxShadow  = `0 0 6px ${needleColor(v)}88`;
                valEl.textContent = v.toFixed(1);
                valEl.style.color = needleColor(v);
            });

            // Консенсус — сколько из трёх в зоне перекупленности/перепроданности
            const ob = periods.filter(p => rsiValues[p] > 70).length;
            const os = periods.filter(p => rsiValues[p] < 30).length;
            let consensusText, consensusClass, badgeText, badgeClass;

            if (ob >= 2)      { consensusText = `${t('overboughtShort')} (${ob}/3)`; consensusClass = 'red';   badgeText = t('overboughtShort'); badgeClass = 'ind-badge bearish'; }
            else if (os >= 2) { consensusText = `${t('oversoldShort')} (${os}/3)`;   consensusClass = 'green'; badgeText = t('oversoldShort');   badgeClass = 'ind-badge bullish'; }
            else              { consensusText = t('neutral');                          consensusClass = '';      badgeText = t('neutral');          badgeClass = 'ind-badge neutral'; }

            consensus.textContent = consensusText;
            consensus.className = `ind-row-value ${consensusClass}`;
            badge.textContent = badgeText;
            badge.className = badgeClass;

            // Дивергенция RSI 7 vs RSI 21
            const div = rsiValues[7] - rsiValues[21];
            divergence.textContent = `${div >= 0 ? '+' : ''}${div.toFixed(1)}`;
            divergence.className = `ind-row-value ${div > 5 ? 'green' : div < -5 ? 'red' : ''}`;
        }

        async function loadRSIExt() {
            updateRSIExtCard(null);
            let closes = window._ema90closes;
            if (!closes) {
                closes = await fetchEMAData(selectedCoin.id);
                window._ema90closes = closes;
            }
            updateRSIExtCard(closes);
        }

        // ── Bollinger Bands ───────────────────────────────
        function calcBB(closes, period = 20, mult = 2) {
            if (closes.length < period) return null;
            const slice = closes.slice(-period);
            const sma   = slice.reduce((s, v) => s + v, 0) / period;
            const variance = slice.reduce((s, v) => s + (v - sma) ** 2, 0) / period;
            const std   = Math.sqrt(variance);
            const upper = sma + mult * std;
            const lower = sma - mult * std;
            const price = closes[closes.length - 1];
            // %B: 0 = нижняя полоса, 1 = верхняя, 0.5 = SMA
            const pctB  = upper !== lower ? (price - lower) / (upper - lower) : 0.5;
            // Bandwidth: (upper - lower) / sma * 100
            const bandwidth = (upper - lower) / sma * 100;
            return { upper, lower, middle: sma, pctB, bandwidth, std, price };
        }

        // Исторический диапазон bandwidth для нормировки полоски
        function calcBandwidthHistory(closes, period = 20, mult = 2) {
            const bws = [];
            for (let i = period; i <= closes.length; i++) {
                const sl  = closes.slice(i - period, i);
                const sma = sl.reduce((s, v) => s + v, 0) / period;
                const std = Math.sqrt(sl.reduce((s, v) => s + (v - sma) ** 2, 0) / period);
                bws.push((sma > 0 ? (mult * 2 * std) / sma * 100 : 0));
            }
            return bws;
        }

        function updateBBCard(closes, currentPrice) {
            const badge    = document.getElementById('bbBadge');
            const loading  = document.getElementById('bbLoading');
            const wrap     = document.getElementById('bbWrap');
            const rows     = document.getElementById('bbRows');
            const pctBVal  = document.getElementById('bbPctBVal');
            const needle   = document.getElementById('bbNeedle');
            const bwBar    = document.getElementById('bbBwBar');
            const bwVal    = document.getElementById('bbBwVal');
            const upper    = document.getElementById('bbUpper');
            const middle   = document.getElementById('bbMiddle');
            const lower    = document.getElementById('bbLower');
            const signal   = document.getElementById('bbSignal');

            if (!closes || closes.length < 20) {
                loading.style.display = 'flex';
                wrap.style.display = 'none';
                rows.style.display = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            const bb = calcBB(closes);
            if (!bb) return;

            // Подставляем текущую цену если есть
            if (currentPrice) {
                bb.pctB = (bb.upper - bb.lower) > 0
                    ? (currentPrice - bb.lower) / (bb.upper - bb.lower)
                    : 0.5;
                bb.price = currentPrice;
            }

            loading.style.display = 'none';
            wrap.style.display = 'flex';
            rows.style.display = 'flex';

            const fmtP = v => v >= 1
                ? `$${v.toLocaleString('en-US', { maximumFractionDigits: 0 })}`
                : `$${v.toFixed(4)}`;

            // %B шкала (0–1 → 0–100%)
            const pctBPct = Math.max(0, Math.min(100, bb.pctB * 100));
            pctBVal.textContent = bb.pctB.toFixed(2);
            needle.style.left = `${pctBPct}%`;

            // Цвет иглы
            if (bb.pctB > 0.9)      { needle.style.background = '#EF4444'; needle.style.boxShadow = '0 0 6px #EF444488'; }
            else if (bb.pctB < 0.1) { needle.style.background = '#10B981'; needle.style.boxShadow = '0 0 6px #10B98188'; }
            else                    { needle.style.background = 'white';   needle.style.boxShadow = '0 0 5px rgba(0,0,0,0.5)'; }

            // Bandwidth
            const bwHistory = calcBandwidthHistory(closes);
            const bwMax = Math.max(...bwHistory);
            const bwMin = Math.min(...bwHistory);
            const bwNorm = bwMax > bwMin
                ? ((bb.bandwidth - bwMin) / (bwMax - bwMin) * 100).toFixed(0)
                : 50;
            bwBar.style.width = `${bwNorm}%`;
            bwVal.textContent = `${bb.bandwidth.toFixed(1)}%`;

            // Значения полос
            upper.textContent  = fmtP(bb.upper);
            middle.textContent = fmtP(bb.middle);
            lower.textContent  = fmtP(bb.lower);

            // Сигнал и бейдж
            let signalText, signalClass, badgeText, badgeClass;

            if (bb.pctB > 1)          { signalText = t('bbAboveUpper');  signalClass = 'red';   badgeText = t('overboughtShort');  badgeClass = 'ind-badge bearish'; }
            else if (bb.pctB < 0)     { signalText = t('bbBelowLower');   signalClass = 'green'; badgeText = t('oversoldShort');    badgeClass = 'ind-badge bullish'; }
            else if (bb.pctB > 0.8)   { signalText = t('bbNearUpper');    signalClass = 'red';   badgeText = t('overboughtShort');  badgeClass = 'ind-badge bearish'; }
            else if (bb.pctB < 0.2)   { signalText = t('bbNearLower');    signalClass = 'green'; badgeText = t('oversoldShort');    badgeClass = 'ind-badge bullish'; }
            else if (parseFloat(bwNorm) < 20) { signalText = `🔀 ${t('bbSqueeze')}`; signalClass = ''; badgeText = t('bbSqueeze'); badgeClass = 'ind-badge neutral'; }
            else                      { signalText = t('bbInside');        signalClass = '';      badgeText = t('neutral');          badgeClass = 'ind-badge neutral'; }

            signal.textContent = signalText;
            signal.className = `ind-row-value ${signalClass}`;
            badge.textContent = badgeText;
            badge.className = badgeClass;
        }

        async function loadBB() {
            updateBBCard(null, currentCoinPrice);
            let closes = window._ema90closes;
            if (!closes) {
                closes = await fetchEMAData(selectedCoin.id);
                window._ema90closes = closes;
            }
            updateBBCard(closes, currentCoinPrice);
        }

        // ── MACD ─────────────────────────────────────────
        let macdHistChartInst = null;

        function calcMACD(closes, fast = 12, slow = 26, signal = 9) {
            if (closes.length < slow + signal) return null;

            // EMA серии для fast и slow
            function emaFull(arr, period) {
                const k = 2 / (period + 1);
                const result = new Array(arr.length).fill(null);
                let seed = arr.slice(0, period).reduce((s, v) => s + v, 0) / period;
                result[period - 1] = seed;
                for (let i = period; i < arr.length; i++) {
                    seed = arr[i] * k + seed * (1 - k);
                    result[i] = seed;
                }
                return result;
            }

            const emaFast = emaFull(closes, fast);
            const emaSlow = emaFull(closes, slow);

            // MACD line = EMA(fast) - EMA(slow) — только там где оба не null
            const macdLine = closes.map((_, i) =>
                emaFast[i] !== null && emaSlow[i] !== null
                    ? emaFast[i] - emaSlow[i]
                    : null
            );

            // Signal line = EMA(9) от MACD line
            const macdValues = macdLine.filter(v => v !== null);
            const signalFull = emaFull(macdValues, signal);
            // Выравниваем обратно по длине
            const offset = macdLine.findIndex(v => v !== null);
            const signalLine = macdLine.map((v, i) => {
                if (v === null) return null;
                const idx = i - offset;
                return signalFull[idx] ?? null;
            });

            // Histogram
            const histogram = macdLine.map((v, i) =>
                v !== null && signalLine[i] !== null ? v - signalLine[i] : null
            );

            // Последние N баров для мини-графика
            const histValid = histogram.filter(v => v !== null);
            const last20 = histValid.slice(-20);

            const currentMACD   = macdLine.filter(v => v !== null).at(-1);
            const currentSignal = signalLine.filter(v => v !== null).at(-1);
            const currentHist   = histogram.filter(v => v !== null).at(-1);
            const prevHist      = histValid.at(-2) ?? currentHist;
            const prevMACD      = macdLine.filter(v => v !== null).at(-2) ?? currentMACD;
            const prevSignal    = signalLine.filter(v => v !== null).at(-2) ?? currentSignal;

            return { currentMACD, currentSignal, currentHist, prevHist, prevMACD, prevSignal, last20 };
        }

        function renderMACDHistogram(last20) {
            const canvas = document.getElementById('macdHistChart');
            if (!canvas) return;
            if (macdHistChartInst) { macdHistChartInst.destroy(); macdHistChartInst = null; }

            const colors = last20.map(v => v >= 0
                ? 'rgba(16,185,129,0.75)'
                : 'rgba(239,68,68,0.75)'
            );
            const borderColors = last20.map(v => v >= 0 ? '#10B981' : '#EF4444');

            macdHistChartInst = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: last20.map((_, i) => i),
                    datasets: [{
                        data: last20,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: 2,
                    }]
                },
                options: {
                    responsive: false,
                    animation: { duration: 500 },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: {
                            display: false,
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateMACDCard(closes) {
            const badge       = document.getElementById('macdBadge');
            const loading     = document.getElementById('macdLoading');
            const signalWrap  = document.getElementById('macdSignalWrap');
            const histWrap    = document.getElementById('macdHistWrap');
            const rows        = document.getElementById('macdRows');
            const signalIcon  = document.getElementById('macdSignalIcon');
            const signalLabel = document.getElementById('macdSignalLabel');
            const signalSub   = document.getElementById('macdSignalSub');
            const signalBox   = document.getElementById('macdSignalBox');
            const macdLine    = document.getElementById('macdLine');
            const sigLine     = document.getElementById('macdSignalLine');
            const histEl      = document.getElementById('macdHist');
            const momentum    = document.getElementById('macdMomentum');

            if (!closes || closes.length < 40) {
                loading.style.display = 'flex';
                signalWrap.style.display = 'none';
                histWrap.style.display = 'none';
                rows.style.display = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            const result = calcMACD(closes);
            if (!result) return;

            const { currentMACD, currentSignal, currentHist, prevHist, prevMACD, prevSignal, last20 } = result;

            loading.style.display = 'none';
            signalWrap.style.display = 'block';
            histWrap.style.display = 'block';
            rows.style.display = 'flex';

            // SVG иконки (те же что у EMA)
            const SVG_UP   = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 14V4M9 4L4 9M9 4L14 9" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const SVG_DOWN = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 4V14M9 14L4 9M9 14L14 9" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            const SVG_NEUT = `<svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M5 6h8M5 12h8" stroke="#64748B" stroke-width="2" stroke-linecap="round"/></svg>`;

            const crossUp   = prevMACD <= prevSignal && currentMACD > currentSignal;
            const crossDown = prevMACD >= prevSignal && currentMACD < currentSignal;
            const bullish   = currentMACD > currentSignal;

            let svgIcon, iconBg, label, sub, badgeText, badgeClass, sigBg, sigBorder;

            if (crossUp) {
                svgIcon = SVG_UP; iconBg = 'rgba(16,185,129,0.15)';
                label = t('bullishCross'); sub = t('macdCrossUp');
                badgeText = t('bullish'); badgeClass = 'ind-badge bullish';
                sigBg = 'rgba(16,185,129,0.06)'; sigBorder = 'rgba(16,185,129,0.2)';
            } else if (crossDown) {
                svgIcon = SVG_DOWN; iconBg = 'rgba(239,68,68,0.15)';
                label = t('bearishCross'); sub = t('macdCrossDown');
                badgeText = t('bearish'); badgeClass = 'ind-badge bearish';
                sigBg = 'rgba(239,68,68,0.06)'; sigBorder = 'rgba(239,68,68,0.2)';
            } else if (bullish) {
                svgIcon = SVG_UP; iconBg = 'rgba(16,185,129,0.1)';
                label = t('bullishMomentum'); sub = t('macdAboveSignal');
                badgeText = t('bullish'); badgeClass = 'ind-badge bullish';
                sigBg = 'rgba(16,185,129,0.04)'; sigBorder = 'rgba(16,185,129,0.12)';
            } else {
                svgIcon = SVG_DOWN; iconBg = 'rgba(239,68,68,0.1)';
                label = t('bearishMomentum'); sub = t('macdBelowSignal');
                badgeText = t('bearish'); badgeClass = 'ind-badge bearish';
                sigBg = 'rgba(239,68,68,0.04)'; sigBorder = 'rgba(239,68,68,0.12)';
            }

            signalIcon.innerHTML = svgIcon;
            signalIcon.style.background = iconBg;
            signalLabel.textContent = label;
            signalSub.textContent = sub;
            signalBox.style.background = sigBg;
            signalBox.style.borderColor = sigBorder;
            badge.textContent = badgeText;
            badge.className = badgeClass;

            // Форматирование (MACD в единицах цены, может быть малым)
            const fmt = v => {
                const abs = Math.abs(v);
                const str = abs >= 100 ? v.toFixed(1)
                          : abs >= 1   ? v.toFixed(2)
                          : v.toFixed(4);
                return (v >= 0 ? '+' : '') + str;
            };

            macdLine.textContent = fmt(currentMACD);
            macdLine.className = `ind-row-value ${currentMACD >= 0 ? 'green' : 'red'}`;
            sigLine.textContent = fmt(currentSignal);
            sigLine.className = `ind-row-value ${currentSignal >= 0 ? 'green' : 'red'}`;
            histEl.textContent = fmt(currentHist);
            histEl.className = `ind-row-value ${currentHist >= 0 ? 'green' : 'red'}`;

            // Импульс — гистограмма растёт или падает
            const growing = Math.abs(currentHist) > Math.abs(prevHist);
            const momText = currentHist >= 0
                ? (growing ? '↑ Усиливается вверх' : '↓ Ослабевает вверх')
                : (growing ? '↓ Усиливается вниз'  : '↑ Ослабевает вниз');
            momentum.textContent = momText;
            momentum.className = `ind-row-value ${currentHist >= 0 ? 'green' : 'red'}`;

            // Гистограмма
            renderMACDHistogram(last20);
        }

        async function loadMACD() {
            updateMACDCard(null);
            let closes = window._ema90closes;
            if (!closes) {
                closes = await fetchEMAData(selectedCoin.id);
                window._ema90closes = closes;
            }
            updateMACDCard(closes);
        }


        // ── Williams %R ───────────────────────────────────
        function calcWilliamsR(ohlc, period = 14) {
            // ohlc: [[ts, open, high, low, close], ...]
            if (!ohlc || ohlc.length < period) return null;
            const results = [];
            for (let i = period - 1; i < ohlc.length; i++) {
                const slice = ohlc.slice(i - period + 1, i + 1);
                const highestHigh = Math.max(...slice.map(c => c[2]));
                const lowestLow   = Math.min(...slice.map(c => c[3]));
                const close       = ohlc[i][4];
                const wr = highestHigh === lowestLow
                    ? -50
                    : ((highestHigh - close) / (highestHigh - lowestLow)) * -100;
                results.push(wr);
            }
            return results[results.length - 1];
        }

        function updateWilliamsRCard(value) {
            const loading = document.getElementById('willrLoading');
            const cnt     = document.getElementById('willrContent');
            const badge   = document.getElementById('willrBadge');

            if (value === null || value === undefined) {
                loading.style.display = 'flex';
                cnt.style.display     = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            loading.style.display = 'none';
            cnt.style.display     = 'block';

            document.getElementById('willrValue').textContent = value.toFixed(1);

            // Зона
            let zoneText, zoneClass, badgeText, badgeClass, signalText, signalClass;
            if (value <= -80) {
                zoneText = t('oversold'); zoneClass = 'green';
                badgeText = t('oversold'); badgeClass = 'ind-badge bullish';
                signalText = t('reversalUp'); signalClass = 'green';
            } else if (value >= -20) {
                zoneText = t('overbought'); zoneClass = 'red';
                badgeText = t('overbought'); badgeClass = 'ind-badge bearish';
                signalText = t('reversalDown'); signalClass = 'red';
            } else {
                zoneText = t('neutralZone'); zoneClass = '';
                badgeText = t('neutral'); badgeClass = 'ind-badge neutral';
                signalText = t('awaitNeutral'); signalClass = '';
            }

            document.getElementById('willrZoneLabel').textContent = zoneText;
            document.getElementById('willrZone').textContent  = zoneText;
            document.getElementById('willrZone').className    = `ind-row-value ${zoneClass}`;
            document.getElementById('willrSignal').textContent = signalText;
            document.getElementById('willrSignal').className   = `ind-row-value ${signalClass}`;
            badge.textContent = badgeText; badge.className = badgeClass;

            // Иголка: value от -100 до 0 → позиция 0%..100%
            const pct = ((value + 100) / 100) * 100;
            document.getElementById('willrNeedle').style.left = `${Math.max(0, Math.min(100, pct))}%`;
        }

        async function loadWilliamsR() {
            updateWilliamsRCard(null);
            try {
                const cache = await ensureIndCache(selectedCoin.id);
                if (!cache || cache.ohlc.length < 14) throw new Error('Not enough data');
                const value = calcWilliamsR(cache.ohlc, 14);
                if (value === null) throw new Error('Calc failed');
                updateWilliamsRCard(value);
            } catch(e) {
                console.warn('Williams %R error:', e);
                document.getElementById('willrLoading').innerHTML =
                    '<div style="font-size:11px;color:#475569;text-align:center">' + t('noData') + '</div>';
            }
        }

        // ── OBV (On-Balance Volume) ───────────────────────────
        let obvMiniChartInst = null;

        function calcOBV(closes, volumes) {
            if (closes.length < 2 || volumes.length < 2) return null;
            const obv = [0];
            for (let i = 1; i < closes.length; i++) {
                if (closes[i] > closes[i-1])      obv.push(obv[i-1] + volumes[i]);
                else if (closes[i] < closes[i-1]) obv.push(obv[i-1] - volumes[i]);
                else                               obv.push(obv[i-1]);
            }
            return obv;
        }

        function renderOBVChart(obvArr) {
            const canvas = document.getElementById('obvMiniChart');
            if (!canvas) return;
            if (obvMiniChartInst) { obvMiniChartInst.destroy(); obvMiniChartInst = null; }
            const last20 = obvArr.slice(-20);
            const rising = last20[last20.length-1] > last20[0];
            const color  = rising ? '#10B981' : '#EF4444';
            canvas.height = 36;
            obvMiniChartInst = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: last20.map((_, i) => i),
                    datasets: [{
                        data: last20,
                        borderColor: color,
                        borderWidth: 2,
                        fill: true,
                        backgroundColor: (ctx) => {
                            const g = ctx.chart.ctx.createLinearGradient(0, 0, 0, 36);
                            g.addColorStop(0, rising ? 'rgba(16,185,129,0.25)' : 'rgba(239,68,68,0.25)');
                            g.addColorStop(1, 'rgba(0,0,0,0)');
                            return g;
                        },
                        tension: 0.4,
                        pointRadius: 0,
                    }]
                },
                options: {
                    responsive: false,
                    animation: { duration: 600 },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        function updateOBVCard(data) {
            const loading = document.getElementById('obvLoading');
            const cnt     = document.getElementById('obvContent');
            const badge   = document.getElementById('obvBadge');

            if (!data) {
                loading.style.display = 'flex';
                cnt.style.display     = 'none';
                badge.textContent = '—';
                badge.className   = 'ind-badge';
                return;
            }

            const { obv, closes } = data;
            loading.style.display = 'none';
            cnt.style.display     = 'block';

            // Тренд OBV — сравниваем первую и вторую половину последних 20 баров
            const last20obv    = obv.slice(-20);
            const last20closes = closes.slice(-20);
            const obvSlope  = last20obv[last20obv.length-1] - last20obv[0];
            const priceSlope = last20closes[last20closes.length-1] - last20closes[0];

            const obvUp    = obvSlope > 0;
            const priceUp  = priceSlope > 0;
            const diverges = obvUp !== priceUp;

            // Сигнал
            const iconEl  = document.getElementById('obvSignalIcon');
            const labelEl = document.getElementById('obvSignalLabel');
            const subEl   = document.getElementById('obvSignalSub');

            if (obvUp && priceUp) {
                iconEl.innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="12" fill="rgba(16,185,129,0.15)"/><path d="M7 13l3 3 7-7" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                labelEl.textContent = t('obvBullAccum');
                subEl.textContent   = t('obvRisingPriceUp');
                badge.textContent = t('bullish'); badge.className = 'ind-badge bullish';
            } else if (!obvUp && !priceUp) {
                iconEl.innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="12" fill="rgba(239,68,68,0.15)"/><path d="M7 11l5 5 5-5" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
                labelEl.textContent = t('obvBearDist');
                subEl.textContent   = t('obvFallingPriceDown');
                badge.textContent = t('bearish'); badge.className = 'ind-badge bearish';
            } else if (obvUp && !priceUp) {
                iconEl.innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="12" fill="rgba(251,191,36,0.15)"/><path d="M12 8v8M8 12h8" stroke="#FBBF24" stroke-width="2" stroke-linecap="round"/></svg>`;
                labelEl.textContent = t('obvBullDiv');
                subEl.textContent   = t('obvRisingPriceDown');
                badge.textContent = t('obvDivergence'); badge.className = 'ind-badge neutral';
            } else {
                iconEl.innerHTML = `<svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="12" fill="rgba(251,191,36,0.15)"/><path d="M12 8v8M8 12h8" stroke="#FBBF24" stroke-width="2" stroke-linecap="round"/></svg>`;
                labelEl.textContent = t('obvBearDiv');
                subEl.textContent   = t('obvFallingPriceUp');
                badge.textContent = t('obvDivergence'); badge.className = 'ind-badge neutral';
            }

            // Тренд строка
            const trendEl = document.getElementById('obvTrend');
            trendEl.textContent = obvUp ? '↑ ' + t('bullish') : '↓ ' + t('bearish');
            trendEl.className   = `ind-row-value ${obvUp ? 'green' : 'red'}`;

            // Дивергенция строка
            const divEl = document.getElementById('obvDivergence');
            divEl.textContent = diverges ? `⚠️ ${t('obvDivergence')}` : `✅ ${t('obvBullAccum').split(' ')[0]}`;
            divEl.className   = `ind-row-value ${diverges ? 'red' : 'green'}`;

            renderOBVChart(obv);
        }

        async function loadOBV() {
            updateOBVCard(null);
            try {
                const cache = await ensureIndCache(selectedCoin.id);
                if (!cache || cache.closes.length < 10) throw new Error('Not enough data');
                const obv = calcOBV(cache.closes, cache.volumes);
                if (!obv) throw new Error('Calc failed');
                updateOBVCard({ obv, closes: cache.closes });
            } catch(e) {
                console.warn('OBV error:', e);
                document.getElementById('obvLoading').innerHTML =
                    '<div style="font-size:11px;color:#475569;text-align:center">' + t('noData') + '</div>';
            }
        }

        // ── CCI (Commodity Channel Index) ─────────────────────
        function calcCCI(ohlc, period = 20) {
            // ohlc: [[ts, open, high, low, close], ...]
            if (!ohlc || ohlc.length < period) return null;
            const slice = ohlc.slice(-period);
            const typicals = slice.map(c => (c[2] + c[3] + c[4]) / 3);
            const sma = typicals.reduce((a, b) => a + b, 0) / period;
            const meanDev = typicals.reduce((a, b) => a + Math.abs(b - sma), 0) / period;
            if (meanDev === 0) return 0;
            const lastTypical = typicals[typicals.length - 1];
            return (lastTypical - sma) / (0.015 * meanDev);
        }

        function updateCCICard(value) {
            const loading = document.getElementById('cciLoading');
            const cnt     = document.getElementById('cciContent');
            const badge   = document.getElementById('cciBadge');

            if (value === null || value === undefined) {
                loading.style.display = 'flex';
                cnt.style.display     = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            loading.style.display = 'none';
            cnt.style.display     = 'block';

            document.getElementById('cciValue').textContent = value.toFixed(1);

            let zoneText, zoneClass, badgeText, badgeClass, signalText, signalClass;
            if (value <= -100) {
                zoneText = t('oversold'); zoneClass = 'green';
                badgeText = t('oversold'); badgeClass = 'ind-badge bullish';
                signalText = t('reversalUp'); signalClass = 'green';
            } else if (value >= 100) {
                zoneText = t('overbought'); zoneClass = 'red';
                badgeText = t('overbought'); badgeClass = 'ind-badge bearish';
                signalText = t('reversalDown'); signalClass = 'red';
            } else if (value > 0) {
                zoneText = t('bullish') + ' zone'; zoneClass = 'green';
                badgeText = t('bullish'); badgeClass = 'ind-badge bullish';
                signalText = t('cciAboveAvg'); signalClass = 'green';
            } else {
                zoneText = t('bearish') + ' zone'; zoneClass = 'red';
                badgeText = t('bearish'); badgeClass = 'ind-badge bearish';
                signalText = t('cciBelowAvg'); signalClass = 'red';
            }

            document.getElementById('cciZoneLabel').textContent = zoneText;
            document.getElementById('cciZone').textContent  = zoneText;
            document.getElementById('cciZone').className    = `ind-row-value ${zoneClass}`;
            document.getElementById('cciSignal').textContent = signalText;
            document.getElementById('cciSignal').className   = `ind-row-value ${signalClass}`;
            badge.textContent = badgeText; badge.className = badgeClass;

            // Шкала -200..+200 → 0%..100%
            const clamped = Math.max(-200, Math.min(200, value));
            const pct = ((clamped + 200) / 400) * 100;
            document.getElementById('cciNeedle').style.left = `${pct}%`;
        }

        async function loadCCI() {
            updateCCICard(null);
            try {
                const cache = await ensureIndCache(selectedCoin.id);
                if (!cache || cache.ohlc.length < 20) throw new Error('Not enough data');
                const value = calcCCI(cache.ohlc, 20);
                if (value === null) throw new Error('Calc failed');
                updateCCICard(value);
            } catch(e) {
                console.warn('CCI error:', e);
                document.getElementById('cciLoading').innerHTML =
                    '<div style="font-size:11px;color:#475569;text-align:center">' + t('noData') + '</div>';
            }
        }

        // ── VWAP (Volume Weighted Average Price) ─────────────
        let vwapMiniChartInst = null;

        function calcVWAP(prices, volumes) {
            // prices: close prices, volumes: daily volumes
            if (!prices.length || !volumes.length) return null;
            let cumPV = 0, cumV = 0;
            for (let i = 0; i < prices.length; i++) {
                cumPV += prices[i] * volumes[i];
                cumV  += volumes[i];
            }
            return cumV ? cumPV / cumV : null;
        }

        function renderVWAPChart(prices, vwap) {
            const canvas = document.getElementById('vwapMiniChart');
            if (!canvas) return;
            if (vwapMiniChartInst) { vwapMiniChartInst.destroy(); vwapMiniChartInst = null; }
            const last20p = prices.slice(-20);
            const labels  = last20p.map((_, i) => i);
            const vwapLine = last20p.map(() => vwap);
            const aboveColor = 'rgba(16,185,129,0.8)';
            const belowColor = 'rgba(239,68,68,0.8)';
            const lastPrice  = last20p[last20p.length - 1];
            canvas.height = 36;
            vwapMiniChartInst = new Chart(canvas, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            data: last20p,
                            borderColor: lastPrice >= vwap ? aboveColor : belowColor,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                        },
                        {
                            data: vwapLine,
                            borderColor: 'rgba(99,102,241,0.7)',
                            borderWidth: 1.5,
                            borderDash: [4, 3],
                            fill: false,
                            tension: 0,
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: false,
                    animation: { duration: 600 },
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: { x: { display: false }, y: { display: false } }
                }
            });
        }

        function updateVWAPCard(data) {
            const loading = document.getElementById('vwapLoading');
            const cnt     = document.getElementById('vwapContent');
            const badge   = document.getElementById('vwapBadge');

            if (!data) {
                loading.style.display = 'flex';
                cnt.style.display     = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            const { vwap, prices, currentPrice } = data;
            loading.style.display = 'none';
            cnt.style.display     = 'block';

            const fmt = v => v >= 1
                ? `$${v.toLocaleString('en-US', { maximumFractionDigits: 2 })}`
                : `$${v.toFixed(4)}`;

            document.getElementById('vwapValue').textContent = fmt(vwap);

            const diff    = currentPrice - vwap;
            const diffPct = (diff / vwap) * 100;
            const above   = diff >= 0;

            document.getElementById('vwapDiffLabel').textContent  = above ? t('aboveVwap') : t('belowVwap');
            document.getElementById('vwapCurrentPrice').textContent = fmt(currentPrice);

            const diffEl = document.getElementById('vwapDiff');
            diffEl.textContent = `${above ? '+' : ''}${diffPct.toFixed(2)}%`;
            diffEl.className   = `ind-row-value ${above ? 'green' : 'red'}`;

            const sigEl = document.getElementById('vwapSignal');
            if (above) {
                sigEl.textContent = '↑ ' + t('aboveVwap');
                sigEl.className   = 'ind-row-value green';
                badge.textContent = t('bullish'); badge.className = 'ind-badge bullish';
            } else {
                sigEl.textContent = '↓ ' + t('belowVwap');
                sigEl.className   = 'ind-row-value red';
                badge.textContent = t('bearish'); badge.className = 'ind-badge bearish';
            }

            renderVWAPChart(prices, vwap);
        }

        async function loadVWAP() {
            updateVWAPCard(null);
            try {
                const cache = await ensureIndCache(selectedCoin.id);
                if (!cache || cache.closes.length < 5) throw new Error('Not enough data');
                const vwap         = calcVWAP(cache.closes, cache.volumes);
                const currentPrice = cache.closes[cache.closes.length - 1];
                if (!vwap) throw new Error('Calc failed');
                updateVWAPCard({ vwap, prices: cache.closes, currentPrice });
            } catch(e) {
                console.warn('VWAP error:', e);
                document.getElementById('vwapLoading').innerHTML =
                    '<div style="font-size:11px;color:#475569;text-align:center">' + t('noData') + '</div>';
            }
        }

        // ── MFI (Money Flow Index) ────────────────────────────
        function calcMFI(ohlc, volumes, period = 14) {
            // ohlc: [[ts, open, high, low, close], ...]
            if (!ohlc || ohlc.length < period + 1 || !volumes || volumes.length < period + 1) return null;
            const typicals = ohlc.map((c, i) => ({
                tp: (c[2] + c[3] + c[4]) / 3,
                vol: volumes[i]
            }));
            const slice = typicals.slice(-period - 1);
            let posFlow = 0, negFlow = 0;
            for (let i = 1; i < slice.length; i++) {
                const mf = slice[i].tp * slice[i].vol;
                if (slice[i].tp > slice[i-1].tp)      posFlow += mf;
                else if (slice[i].tp < slice[i-1].tp) negFlow += mf;
            }
            if (negFlow === 0) return 100;
            const mfr = posFlow / negFlow;
            return 100 - (100 / (1 + mfr));
        }

        function updateMFICard(value) {
            const loading = document.getElementById('mfiLoading');
            const cnt     = document.getElementById('mfiContent');
            const badge   = document.getElementById('mfiBadge');

            if (value === null || value === undefined) {
                loading.style.display = 'flex';
                cnt.style.display     = 'none';
                badge.textContent = '—'; badge.className = 'ind-badge';
                return;
            }

            loading.style.display = 'none';
            cnt.style.display     = 'block';

            document.getElementById('mfiValue').textContent = value.toFixed(1);

            let zoneText, zoneClass, badgeText, badgeClass, signalText, signalClass;
            if (value <= 20) {
                zoneText = t('oversold'); zoneClass = 'green';
                badgeText = t('oversold'); badgeClass = 'ind-badge bullish';
                signalText = t('reversalUp'); signalClass = 'green';
            } else if (value >= 80) {
                zoneText = t('overbought'); zoneClass = 'red';
                badgeText = t('overbought'); badgeClass = 'ind-badge bearish';
                signalText = t('reversalDown'); signalClass = 'red';
            } else {
                zoneText = t('neutralZone'); zoneClass = '';
                badgeText = t('neutral'); badgeClass = 'ind-badge neutral';
                signalText = t('noSignal'); signalClass = '';
            }

            document.getElementById('mfiZoneLabel').textContent  = zoneText;
            document.getElementById('mfiZone').textContent       = zoneText;
            document.getElementById('mfiZone').className         = `ind-row-value ${zoneClass}`;
            document.getElementById('mfiSignal').textContent     = signalText;
            document.getElementById('mfiSignal').className       = `ind-row-value ${signalClass}`;
            badge.textContent = badgeText; badge.className = badgeClass;

            const pct = Math.max(0, Math.min(100, value));
            document.getElementById('mfiNeedle').style.left = `${pct}%`;
        }

        async function loadMFI() {
            updateMFICard(null);
            try {
                const cache = await ensureIndCache(selectedCoin.id);
                if (!cache || cache.ohlc.length < 15) throw new Error('Not enough data');
                const n = Math.min(cache.ohlc.length, cache.volumes.length);
                const value = calcMFI(cache.ohlc.slice(-n), cache.volumes.slice(-n), 14);
                if (value === null) throw new Error('Calc failed');
                updateMFICard(value);
            } catch(e) {
                console.warn('MFI error:', e);
                document.getElementById('mfiLoading').innerHTML =
                    '<div style="font-size:11px;color:#475569;text-align:center">' + t('noData') + '</div>';
            }
        }

        // ── Fear & Greed Index ────────────────────────────
        function drawFGGauge(canvas, value) {
            const W = canvas.width;
            const H = canvas.height;
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, W, H);

            const cx = W / 2;
            const cy = H - 10;
            const trackW = 16;
            const r = W / 2 - trackW / 2 - 6;

            const segments = [
                { from: 0,  to: 25,  color: '#EF4444' },
                { from: 25, to: 45,  color: '#F97316' },
                { from: 45, to: 55,  color: '#FBBF24' },
                { from: 55, to: 75,  color: '#84CC16' },
                { from: 75, to: 100, color: '#10B981' },
            ];

            // Background arc
            ctx.beginPath();
            ctx.arc(cx, cy, r, Math.PI, 0, false);
            ctx.lineWidth = trackW;
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineCap = 'butt';
            ctx.stroke();

            // Colored segments — minimal gap only at zone boundaries
            const gapRad = 0.018;
            segments.forEach(({ from, to, color }) => {
                const aFrom = Math.PI + (from / 100) * Math.PI + (from === 0 ? 0 : gapRad);
                const aTo   = Math.PI + (to / 100) * Math.PI   - (to === 100 ? 0 : gapRad);
                ctx.beginPath();
                ctx.arc(cx, cy, r, aFrom, aTo, false);
                ctx.lineWidth = trackW;
                ctx.strokeStyle = color;
                ctx.lineCap = 'butt';
                ctx.stroke();
            });

            // Dot indicator on the arc
            const seg = segments.find(s => value >= s.from && value <= s.to) || segments[0];
            const dotColor = seg.color;
            const dotAngle = Math.PI + (value / 100) * Math.PI;
            const dotX = cx + Math.cos(dotAngle) * r;
            const dotY = cy + Math.sin(dotAngle) * r;
            const dotR = 8;

            // Glow
            ctx.save();
            ctx.shadowColor = dotColor;
            ctx.shadowBlur = 14;
            ctx.beginPath();
            ctx.arc(dotX, dotY, dotR, 0, Math.PI * 2);
            ctx.fillStyle = dotColor;
            ctx.fill();
            ctx.restore();

            // White inner dot
            ctx.beginPath();
            ctx.arc(dotX, dotY, dotR - 3.5, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
        }

        function fgClassify(v) {
            if (v <= 24) return { label: t('fgExtFear'),  badgeText: t('fgBadgeFear'), badgeClass: 'ind-badge bearish' };
            if (v <= 44) return { label: t('fgFear'),     badgeText: t('fgBadgeFear'), badgeClass: 'ind-badge bearish' };
            if (v <= 55) return { label: t('fgNeutral'),  badgeText: t('fgNeutral'),   badgeClass: 'ind-badge neutral' };
            if (v <= 75) return { label: t('fgGreed'),    badgeText: t('fgBadgeGreed'),badgeClass: 'ind-badge bullish' };
            return             { label: t('fgExtGreed'),  badgeText: t('fgBadgeGreed'),badgeClass: 'ind-badge bullish' };
        }

        function fgValWithLabel(v) {
            if (v === null || v === undefined) return '—';
            return `${v} — ${fgClassify(v).label}`;
        }

        async function loadFearGreed() {
            const loading = document.getElementById('fgLoading');
            const wrap    = document.getElementById('fgWrap');
            const badge   = document.getElementById('fgBadge');
            loading.style.display = 'flex';
            wrap.style.display    = 'none';
            badge.textContent = '—'; badge.className = 'ind-badge';

            try {
                const r = await fetch('/api/feargreed');
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                const d = await r.json();
                const data = d?.data;
                if (!data || !data.length) throw new Error('No data');

                const today = parseInt(data[0].value);
                if (isNaN(today)) throw new Error('Bad value');

                // Спидометр
                const canvas = document.getElementById('fgCanvas');
                canvas.width = 180;
                canvas.height = 105;
                drawFGGauge(canvas, today);

                document.getElementById('fgValue').textContent = today;
                const cls = fgClassify(today);
                badge.textContent = cls.badgeText;
                badge.className   = cls.badgeClass;

                // Цвет цифры
                const colors = ['#EF4444','#EF4444','#FBBF24','#84CC16','#10B981'];
                const ci = today <= 24 ? 0 : today <= 44 ? 1 : today <= 55 ? 2 : today <= 75 ? 3 : 4;
                document.getElementById('fgValue').style.color = colors[ci];

                loading.style.display = 'none';
                wrap.style.display    = 'flex';

            } catch(e) {
                console.warn('FearGreed error:', e);
                loading.innerHTML = '<div style="font-size:11px;color:#475569;text-align:center">' + t('noData') + '</div>';
            }
        }



        
        // ── Сводка индикаторов ────────────────────────────
        const _BADGE_IDS = ['atrBadge','emaBadge','stochBadge','rsiExtBadge','bbBadge','macdBadge','fgBadge','willrBadge','obvBadge','cciBadge','vwapBadge','mfiBadge'];
        function updateIndSummary() {
            let bull = 0, bear = 0, neut = 0;
            _BADGE_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.className.includes('bullish')) bull++;
                else if (el.className.includes('bearish')) bear++;
                else if (el.className.includes('neutral')) neut++;
            });
            const pillsEl = document.getElementById('indSummaryPills');
            const resultEl = document.getElementById('indSummaryResult');
            if (!pillsEl || !resultEl) return;
            const total = bull + bear + neut;
            if (total === 0) return;
            let html = '';
            if (bull > 0) html += `<span class="ind-sum-pill bull">▲ ${bull} ${t('bullish').toLowerCase()}</span>`;
            if (bear > 0) html += `<span class="ind-sum-pill bear">▼ ${bear} ${t('bearish').toLowerCase()}</span>`;
            if (neut > 0) html += `<span class="ind-sum-pill neut">◆ ${neut} ${t('neutral').toLowerCase()}</span>`;
            pillsEl.innerHTML = html;
            if (bear > bull && bear >= neut)       { resultEl.textContent = t('indBearish'); resultEl.style.color = '#EF4444'; }
            else if (bull > bear && bull >= neut)  { resultEl.textContent = t('indBullish');  resultEl.style.color = '#10B981'; }
            else                                    { resultEl.textContent = t('indNeutral'); resultEl.style.color = '#FBBF24'; }
        }
        function scheduleIndSummaryUpdate() {
            setTimeout(updateIndSummary, 1000);
            setTimeout(updateIndSummary, 3000);
            setTimeout(updateIndSummary, 6000);
        }

        window.addEventListener('load', async () => {
            await fetchUsdToRub();
            updateCurrentPrice();
            loadATR();
            loadEMA();
            loadStochRSI();
            loadRSIExt();
            loadBB();
            loadMACD();
            loadWilliamsR();
            loadOBV();
            loadCCI();
            loadVWAP();
            loadMFI();
            loadFearGreed();
            scheduleIndSummaryUpdate();
        });

        // ═══════════════════════════════════

        // ── Slider Logic ──────────────────────────────────
        const slider = document.getElementById('sliderWrapper');
        const dots = document.querySelectorAll('.slider-dot');
        const arrowLeft = document.getElementById('arrowLeft');
        const arrowRight = document.getElementById('arrowRight');
        let currentPage = 0;
        const totalPages = 3;

        function goToPage(page) {
            if (page < 0 || page >= totalPages) return;
            currentPage = page;
            slider.classList.remove('slide-1', 'slide-2', 'slide-3');
            slider.classList.add(`slide-${page + 1}`);
            dots.forEach((d, i) => d.classList.toggle('active', i === page));
            arrowLeft.classList.toggle('hidden', page === 0);
            arrowRight.classList.toggle('hidden', page === totalPages - 1);

        }

        arrowLeft.addEventListener('click', () => goToPage(currentPage - 1));
        arrowRight.addEventListener('click', () => goToPage(currentPage + 1));
        dots.forEach(d => d.addEventListener('click', () => goToPage(+d.dataset.page)));

        // Keyboard
        document.addEventListener('keydown', e => {
            if (e.key === 'ArrowLeft') goToPage(currentPage - 1);
            if (e.key === 'ArrowRight') goToPage(currentPage + 1);
        });

        // Touch swipe — только горизонтальный, не мешает вертикальному скроллу
        let touchStartX = 0, touchStartY = 0, touchLocked = false;
        document.addEventListener('touchstart', e => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            touchLocked = false;
        }, { passive: true });
        document.addEventListener('touchmove', e => {
            if (touchLocked) return;
            const dx = Math.abs(e.touches[0].clientX - touchStartX);
            const dy = Math.abs(e.touches[0].clientY - touchStartY);
            // Если движение больше горизонтальное — блокируем вертикальный скролл
            if (dx > dy && dx > 10) {
                touchLocked = true;
            }
        }, { passive: true });
        document.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - touchStartX;
            const dy = e.changedTouches[0].clientY - touchStartY;
            // Свайп только если горизонталь > 60px И больше вертикали в 1.5 раза
            if (Math.abs(dx) > 60 && Math.abs(dx) > Math.abs(dy) * 1.5) {
                goToPage(dx < 0 ? currentPage + 1 : currentPage - 1);
            }
        }, { passive: true });



        // ═══════════════════════════════════════════════════════
        // НОВОСТИ — Страница 3
        // ═══════════════════════════════════════════════════════

        const RSS2JSON = 'https://api.rss2json.com/v1/api.json?rss_url=';
        const RSS_FEEDS = [
            { name: 'CoinDesk',      url: 'https://www.coindesk.com/arc/outboundfeeds/rss/' },
            { name: 'Cointelegraph', url: 'https://cointelegraph.com/rss' },
            { name: 'Decrypt',       url: 'https://decrypt.co/feed' },
            { name: 'The Block',     url: 'https://www.theblock.co/rss.xml' },
            { name: 'AMB Crypto',    url: 'https://ambcrypto.com/feed/' },
            { name: 'CryptoSlate',   url: 'https://cryptoslate.com/feed/' },
        ];

        const MYMEMORY = 'https://api.mymemory.translated.net/get';

        let newsAllItems   = [];
        let newsFilter     = 'all';
        let newsSourceFilter = 'all';
        let newsSeenIds    = new Set();
        let newsLoaded     = false;
        let translateCache = {};
        let newsReadIds    = new Set();
        try { newsReadIds = new Set(JSON.parse(localStorage.getItem('newsRead') || '[]')); } catch(e) {}

        // ── Классификация сентимента по ключевым словам ───────
        const BULL_KW = ['surge','rally','bull','soar','gain','rise','ath','record','adoption','etf','approve','launch','upgrade','buy','купил','рост','пробил','рекорд','приток'];
        const BEAR_KW = ['crash','drop','fall','hack','exploit','ban','lawsuit','sec','penalty','bear','liquidat','outflow','scam','fraud','warning','risk','падение','обвал','взлом','запрет'];

        function classifySentiment(text) {
            const t = text.toLowerCase();
            let b = 0, br = 0;
            BULL_KW.forEach(w => { if (t.includes(w)) b++; });
            BEAR_KW.forEach(w => { if (t.includes(w)) br++; });
            return b > br ? 'bull' : br > b ? 'bear' : 'neutral';
        }

        const COIN_MAP = {
            'bitcoin|\\bbtc\\b': 'BTC', 'ethereum|\\beth\\b': 'ETH',
            'solana|\\bsol\\b': 'SOL',  '\\bxrp\\b|ripple': 'XRP',
            '\\bbnb\\b|binance': 'BNB', 'cardano|\\bada\\b': 'ADA',
            'dogecoin|\\bdoge\\b': 'DOGE', 'avalanche|\\bavax\\b': 'AVAX',
            '\\bdefi\\b': 'DeFi', '\\bnft\\b': 'NFT',
            '\\betf\\b': 'ETF',   '\\bsec\\b': 'SEC',
        };

        function extractTags(text) {
            const t = text.toLowerCase();
            const tags = [];
            for (const [pat, tag] of Object.entries(COIN_MAP)) {
                if (new RegExp(pat).test(t) && !tags.includes(tag)) tags.push(tag);
            }
            return tags.slice(0, 4);
        }

        function newsTimeAgo(dateStr) {
            const diff = (Date.now() - new Date(dateStr)) / 1000;
            if (diff < 60)    return t('timeJustNow');
            if (diff < 3600)  return `${Math.floor(diff/60)} ${t('timeMinAgo')}`;
            if (diff < 86400) return `${Math.floor(diff/3600)} ${t('timeHAgo')}`;
            return `${Math.floor(diff/86400)} ${t('timeDayAgo')}`;
        }

        function newsSentLabel(s) {
            if (s === 'bull') return t('badgeBullish');
            if (s === 'bear') return t('badgeBearish');
            return t('badgeNeutral');
        }

        function newsTruncate(str, n) {
            return str && str.length > n ? str.slice(0, n) + '…' : (str || '');
        }

        function newsMarkRead(id) {
            newsReadIds.add(id);
            try { localStorage.setItem('newsRead', JSON.stringify([...newsReadIds])); } catch(e) {}
        }

        function cleanHTML(html) {
            const d = document.createElement('div');
            d.innerHTML = html || '';
            return d.textContent.replace(/\s+/g, ' ').trim();
        }

        // ── Перевод через MyMemory ────────────────────────────
        async function translateText(text) {
            if (!text || text.length < 3) return text;
            if (translateCache[text]) return translateCache[text];
            if (/[а-яёА-ЯЁ]{3,}/.test(text)) return text; // уже русский
            try {
                const r = await fetch(`/api/translate?text=${encodeURIComponent(text.slice(0,400))}`, {signal: AbortSignal.timeout(8000)});
                const d = await r.json();
                const result = d?.translation || d?.responseData?.translatedText;
                if (result && result !== text && !result.includes('INVALID')) {
                    translateCache[text] = result;
                    return result;
                }
            } catch(e) {}
            return text;
        }

        async function translateBatch(items) {
            const CHUNK = 5;
            // Переводим заголовки
            for (let i = 0; i < items.length; i += CHUNK) {
                const chunk = items.slice(i, i + CHUNK);
                const translated = await Promise.all(chunk.map(n => translateText(n.title)));
                translated.forEach((t, j) => { items[i + j].title = t; });
            }
            // Переводим описания для первых 6 (featured + немного ленты)
            const withDesc = items.filter(n => n.desc).slice(0, 6);
            for (let i = 0; i < withDesc.length; i += CHUNK) {
                const chunk = withDesc.slice(i, i + CHUNK);
                const translated = await Promise.all(chunk.map(n => translateText(n.desc.slice(0, 400))));
                translated.forEach((t, j) => { chunk[j].desc = t; });
            }
            return items;
        }

        // ── Загрузка одного RSS ────────────────────────────────
        async function fetchOneFeed(feed) {
            const url = `/api/news?url=${encodeURIComponent(feed.url)}`;
            const r = await fetch(url, { signal: AbortSignal.timeout(8000) });
            if (!r.ok) return [];
            const d = await r.json();
            if (d.status !== 'ok' || !d.items) return [];
            return d.items.map(item => {
                const rawDesc = cleanHTML(item.description || item.content || '');
                // Берём первые ~600 символов описания, убираем повторение заголовка
                const shortDesc = rawDesc.length > 20 ? rawDesc.slice(0, 600) : '';
                return {
                    id:        item.link || item.guid,
                    title:     cleanHTML(item.title),
                    titleOrig: cleanHTML(item.title),
                    desc:      shortDesc,
                    link:      item.link,
                    source:    feed.name,
                    domain:    feed.url.replace(/https?:\/\/(www\.)?/, '').split('/')[0],
                    date:      item.pubDate,
                    sentiment: classifySentiment(cleanHTML(item.title) + ' ' + shortDesc),
                    tags:      extractTags(cleanHTML(item.title) + ' ' + shortDesc),
                    isNew:     false,
                };
            });
        }

        // ── Фильтрация ─────────────────────────────────────────
        function newsGetFiltered() {
            return newsAllItems.filter(n => {
                // Фильтр по источнику
                if (newsSourceFilter !== 'all' && n.source !== newsSourceFilter) return false;
                // Фильтр по теме/тональности
                if (newsFilter === 'bull')     return n.sentiment === 'bull';
                if (newsFilter === 'bear')     return n.sentiment === 'bear';
                if (newsFilter === 'bitcoin')  return n.tags.includes('BTC')  || /bitcoin/i.test(n.titleOrig);
                if (newsFilter === 'ethereum') return n.tags.includes('ETH')  || /ethereum/i.test(n.titleOrig);
                if (newsFilter === 'solana')   return n.tags.includes('SOL')  || /solana/i.test(n.titleOrig);
                return true;
            });
        }

        // ── Главная загрузка ──────────────────────────────────
        async function newsLoadAll(isRefresh) {
            if (!isRefresh) newsSetLoading();
            const btn = document.getElementById('newsRefreshBtn');
            const lbl = document.getElementById('newsLiveLabel');
            if (btn) btn.classList.add('spinning');
            if (lbl) lbl.textContent = t('loading');

            try {
                // Грузим все фиды параллельно
                const results = await Promise.allSettled(RSS_FEEDS.map(fetchOneFeed));
                let items = results.flatMap(r => r.status === 'fulfilled' ? r.value : []);

                // Дедупликация по заголовку
                const seen = new Set();
                items = items.filter(n => {
                    const key = n.titleOrig.slice(0, 60).toLowerCase();
                    if (seen.has(key)) return false;
                    seen.add(key); return true;
                });

                // Сортируем по дате
                items.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Отмечаем новые
                const prevIds = new Set(newsSeenIds);
                items.forEach(n => {
                    n.isNew = prevIds.size > 0 && !prevIds.has(n.id);
                    newsSeenIds.add(n.id);
                });

                // Переводим

                // Перевод отключён — новости на английском
                // items = await translateBatch(items);

                newsAllItems = items;
                if (lbl) lbl.textContent = `✅ ${items.length} news`;

                // Переводим заголовки если язык RU (асинхронно, с перерендером)
                if (currentLang === 'ru' && typeof translateNewsTitles === 'function') {
                    newsRender(); // сначала показываем английские
                    translateNewsTitles(newsAllItems).then(() => newsRender()); // переводим все
                } else {
                    newsRender();
                }
            } catch(e) {
                console.error('Новости: ошибка', e);
                if (lbl) lbl.textContent = `⚠ ${t('newsFeedError')}`;
            }

            if (btn) btn.classList.remove('spinning');
        }

        // ── Виджет новости на главной ────────────────────────
        let newsWidgetIdx = -1;
        let newsWidgetItems = [];

        async function loadNewsWidget() {
            // Если новости уже загружены страницей новостей — используем их
            if (newsAllItems.length) {
                newsWidgetItems = newsAllItems;
                showNewsWidget();
                return;
            }
            // Иначе загружаем один фид самостоятельно
            try {
                const feed = RSS_FEEDS[Math.floor(Math.random() * RSS_FEEDS.length)];
                const items = await fetchOneFeed(feed);
                if (items && items.length) {
                    newsWidgetItems = items;
                    showNewsWidget();
                }
            } catch(e) { console.warn('newsWidget load:', e); }
        }

        function showNewsWidget() {
            if (!newsWidgetItems.length) return;
            newsWidgetIdx = (newsWidgetIdx + 1) % newsWidgetItems.length;
            renderNewsWidget();
        }

        function renderNewsWidget() {
            if (!newsWidgetItems.length) return;
            const n = newsWidgetItems[newsWidgetIdx];
            const widget = document.getElementById('newsWidget');
            if (!widget) return;

            const displayTitle = (currentLang === 'ru' && n.titleRu) ? n.titleRu : (n.title || n.titleOrig);
            const displayDesc  = (currentLang === 'ru' && n.descRu)  ? n.descRu  : (n.desc || '');
            const sentLabel    = typeof newsSentLabel === 'function' ? newsSentLabel(n.sentiment) : '';
            const timeStr      = typeof newsTimeAgo === 'function' ? newsTimeAgo(n.date) : '';

            widget.style.opacity = '0';
            setTimeout(() => {
                widget.innerHTML = `
                    <div class="news-featured-badges">
                        <span class="news-feat-badge tag">${n.source || ''}</span>
                        <span class="news-feat-badge ${n.sentiment}">${sentLabel}</span>
                    </div>
                    <div class="news-featured-title" style="font-size:14px;margin-bottom:6px">${displayTitle}</div>
                    ${displayDesc ? `<div class="news-featured-desc" style="font-size:11px;margin-bottom:10px">${displayDesc.slice(0,160)}${displayDesc.length>160?'…':''}</div>` : ''}
                    <div style="display:flex;align-items:center;justify-content:space-between">
                        <div style="display:flex;gap:6px">
                            <button class="news-featured-btn nw-open-modal">${t('newsReadMore')}</button>
                            <button class="news-featured-btn nw-all-news" style="background:rgba(255,255,255,0.04);border-color:rgba(255,255,255,0.1);color:#64748B">${t('newsAllNews')}</button>
                        </div>
                        <span style="font-size:10px;color:#475569">${timeStr}</span>
                    </div>`;

                widget.style.cursor = 'pointer';
                widget.addEventListener('click', e => {
                    if (e.target.closest('.nw-all-news')) return;
                    if (typeof newsOpenModalByItem === 'function') newsOpenModalByItem(n);
                    else window.open(n.link, '_blank');
                }, { once: true });
                widget.querySelector('.nw-all-news').addEventListener('click', e => {
                    e.stopPropagation();
                    if (typeof goToPage === 'function') goToPage(2);
                });
                widget.style.opacity = '1';

                if (currentLang === 'ru' && !n.titleRu && typeof translateText === 'function') {
                    translateText(n.titleOrig || n.title).then(tr => {
                        if (tr) { n.titleRu = tr; const el = widget.querySelector('.news-featured-title'); if (el) el.textContent = tr; }
                    }).catch(() => {});
                }
                if (currentLang === 'ru' && !n.descRu && n.desc && typeof translateText === 'function') {
                    translateText(n.desc).then(tr => {
                        if (tr) { n.descRu = tr; const el = widget.querySelector('.news-featured-desc'); if (el) el.textContent = tr.slice(0,160) + (tr.length > 160 ? '…' : ''); }
                    }).catch(() => {});
                }
            }, 300);
        }

        // Обновление каждые 10 минут
        setInterval(showNewsWidget, 10 * 60 * 1000);
        // Загрузка при старте
        document.addEventListener('DOMContentLoaded', () => { setTimeout(loadNewsWidget, 2000); });

        // ── Рендер карточки ───────────────────────────────────
        function newsCardHTML(n, idx, isFeatured) {
            const read    = newsReadIds.has(n.id);
            const isNew   = n.isNew && !read;
            const opacity = read ? 'opacity:0.42;' : '';

            if (isFeatured) {
                // For the first card: large featured card, rest: trend items (handled in newsRenderFeatured)
                return '';
            }

            const sentLabel = newsSentLabel(n.sentiment);
            const sourceIco = n.source ? n.source[0] : '?';

            return `<div class="news-card ${n.sentiment}" data-newsidx="${idx}" style="${opacity}transition:opacity 0.3s">
                ${isNew ? `<div style="position:absolute;top:10px;right:14px;font-size:9px;font-weight:800;padding:2px 8px;border-radius: 6px;background:rgba(99,102,241,0.3);color:#818CF8;letter-spacing:0.06em">● NEW</div>` : ''}
                ${read  ? `<div class="news-read-badge" style="position:absolute;top:10px;right:14px;font-size:9px;color:#475569">✓ read</div>` : ''}
                <div class="news-card-meta">
                    <div class="news-card-source-ico">${sourceIco}</div>
                    <span class="news-source">${n.source}</span>
                    <span class="news-dot">·</span>
                    <span class="news-time">${newsTimeAgo(n.date)}</span>
                    <span class="news-sent-badge ${n.sentiment}">${sentLabel}</span>
                </div>
                <div class="news-card-title">${newsGetTitle ? newsGetTitle(n) : n.title}</div>
                <div class="news-card-footer">
                    ${n.tags[0] ? `<span class="news-tag-inline">${n.tags[0]}</span>` : ''}
                    <div class="news-card-stats">
                        ${n.views ? `<span class="news-card-stat">👁 ${n.views}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }

        function newsFeaturedCardHTML(n, idx) {
            const sentCls = n.sentiment;
            return `<div class="news-featured-card" data-newsidx="${idx}">
                <div class="news-featured-badges">
                    <span class="news-feat-badge main">${t('badgeMain')}</span>
                    ${n.tags[0] ? `<span class="news-feat-badge tag">${n.tags[0]}</span>` : ''}
                    <span class="news-feat-badge ${sentCls}">${newsSentLabel(sentCls)}</span>
                </div>
                <div class="news-featured-title">${newsGetTitle ? newsGetTitle(n) : n.title}</div>
                <div class="news-featured-desc">${n.desc ? n.desc.slice(0,180)+(n.desc.length>180?'…':'') : ''}</div>
                <button class="news-featured-btn">${t('newsReadMore')}</button>
            </div>`;
        }

        function newsBigCardHTML(n, idx) {
            return `<div class="news-big-card" data-newsidx="${idx}">
                <div class="news-trend-grid-meta">
                    <span class="news-trend-grid-source">${n.source}</span>
                    <span style="color:#334155;font-size:10px">·</span>
                    <span class="news-trend-grid-time">${newsTimeAgo(n.date)}</span>
                    <span class="news-trend-badge ${n.sentiment}" style="margin-left:auto">${newsSentLabel(n.sentiment)}</span>
                </div>
                <div class="news-big-card-title">${newsGetTitle ? newsGetTitle(n) : n.title}</div>
                <div class="news-big-card-desc">${n.desc ? n.desc.slice(0,100)+(n.desc.length>100?'…':'') : ''}</div>
                ${n.tags[0] ? `<div class="news-big-card-tag"><span class="news-trend-grid-tag">${n.tags[0]}</span></div>` : ''}
            </div>`;
        }

        function newsSmallTrendHTML(n, idx) {
            const sentColors = { bull: '#10B981', bear: '#EF4444', neutral: '#FBBF24' };
            const clr = sentColors[n.sentiment] || '#FBBF24';
            const tag = n.tags[0] || '';
            return `<div class="news-trend-grid-card" data-newsidx="${idx}" style="border-left-color:${clr}">
                <div class="news-trend-grid-meta">
                    <span class="news-trend-grid-source">${n.source}</span>
                    <span style="color:#334155;font-size:10px">·</span>
                    <span class="news-trend-grid-time">${newsTimeAgo(n.date)}</span>
                    <span class="news-trend-badge ${n.sentiment}" style="margin-left:auto">${newsSentLabel(n.sentiment)}</span>
                </div>
                <div class="news-trend-grid-title">${newsGetTitle ? newsGetTitle(n) : n.title}</div>
                ${tag ? `<div class="news-trend-grid-tag">${tag}</div>` : ''}
            </div>`;
        }

        function newsTrendsHTML(items) {
            if (!items.length) return '';
            // items: [big1, small1, small2, big2, small3, small4]
            const big1   = items[0];
            const small1 = items[1];
            const small2 = items[2];
            const big2   = items[3];
            const small3 = items[4];
            const small4 = items[5];
            return `<div class="news-trends-card">
                <div class="news-trends-header">
                    <div class="news-trends-title">${t('newsTrends')}</div>
                    <div class="news-trends-sort">≡ ${t('newsPopular')} ▾</div>
                </div>
                <div class="news-trends-row">
                    ${big1   ? newsBigCardHTML(big1,   1) : ''}
                    <div class="news-trends-smalls">
                        ${small1 ? newsSmallTrendHTML(small1, 2) : ''}
                        ${small2 ? newsSmallTrendHTML(small2, 3) : ''}
                    </div>
                </div>
                <div class="news-trends-row">
                    ${big2   ? newsBigCardHTML(big2,   4) : ''}
                    <div class="news-trends-smalls">
                        ${small3 ? newsSmallTrendHTML(small3, 5) : ''}
                        ${small4 ? newsSmallTrendHTML(small4, 6) : ''}
                    </div>
                </div>
            </div>`;
        }

        function newsAttachClicks(col, offset) {
            col.querySelectorAll('.news-card').forEach(card => {
                card.addEventListener('click', () => {
                    const filtered = newsGetFiltered();
                    const item = filtered[+card.dataset.newsidx];
                    if (!item) return;
                    newsMarkRead(item.id);
                    card.style.opacity = '0.42';
                    if (!card.querySelector('.news-read-badge')) {
                        const b = document.createElement('div');
                        b.className = 'news-read-badge';
                        b.style.cssText = 'position:absolute;top:10px;right:14px;font-size:9px;color:#475569';
                        b.textContent = '✓ read';
                        card.appendChild(b);
                        const nb = card.querySelector('[style*="NEW"]');
                        if (nb) nb.remove();
                    }
                    newsOpenModalByItem(item);
                });
            });
        }

        function newsRenderFeatured(items) {
            const col = document.getElementById('newsFeaturedCol');
            if (!col) return;
            if (!items.length) { col.innerHTML = '<div style="padding:30px;text-align:center;color:#475569;font-size:13px">'+t('noData')+'</div>'; return; }

            const featured = items[0];
            const trends = items.slice(1, 7);

            col.innerHTML = newsFeaturedCardHTML(featured, 0) + newsTrendsHTML(trends);

            col.querySelector('.news-featured-card')?.addEventListener('click', () => {
                const filtered = newsGetFiltered();
                if (!filtered[0]) return;
                newsMarkRead(filtered[0].id);
                newsOpenModalByItem(filtered[0]);
            });
            col.querySelectorAll('.news-big-card, .news-trend-grid-card').forEach(el => {
                el.addEventListener('click', () => {
                    const filtered = newsGetFiltered();
                    const item = filtered[+el.dataset.newsidx];
                    if (!item) return;
                    newsMarkRead(item.id);
                    newsOpenModalByItem(item);
                });
            });
        }

        const FEED_PER_PAGE = 12;
        let feedPage = 0;

        function newsRenderFeed(items) {
            const col  = document.getElementById('newsFeedCol');
            const pgEl = document.getElementById('newsPagination');
            if (!col) return;

            if (!items.length) {
                col.innerHTML = '<div style="padding:20px;text-align:center;color:#475569;font-size:13px">'+t('noData')+'</div>';
                if (pgEl) pgEl.style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(items.length / FEED_PER_PAGE);
            if (feedPage >= totalPages) feedPage = 0;

            const start  = feedPage * FEED_PER_PAGE;
            const chunk  = items.slice(start, start + FEED_PER_PAGE);

            col.innerHTML = chunk.map((n, i) => newsCardHTML(n, 7 + start + i, false)).join('');
            newsAttachClicks(col, start + 3);

            // Рендер пагинации
            if (pgEl) {
                if (totalPages <= 1) {
                    pgEl.style.display = 'none';
                } else {
                    pgEl.style.display = 'flex';
                    let html = `<button class="news-pg-btn" id="pgPrev" ${feedPage===0?'disabled':''}>‹</button>`;
                    for (let p = 0; p < totalPages; p++) {
                        html += `<button class="news-pg-btn ${p===feedPage?'active':''}" data-pg="${p}">${p+1}</button>`;
                    }
                    html += `<button class="news-pg-btn" id="pgNext" ${feedPage===totalPages-1?'disabled':''}>›</button>`;
                    pgEl.innerHTML = html;

                    pgEl.querySelectorAll('[data-pg]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            feedPage = +btn.dataset.pg;
                            newsRenderFeed(items);
                            // Скролл к верху ленты
                            document.getElementById('newsFeedWrap')?.scrollTo({ top: 0, behavior: 'smooth' });
                        });
                    });
                    pgEl.querySelector('#pgPrev')?.addEventListener('click', () => {
                        if (feedPage > 0) { feedPage--; newsRenderFeed(items); document.getElementById('newsFeedWrap')?.scrollTo({ top: 0, behavior: 'smooth' }); }
                    });
                    pgEl.querySelector('#pgNext')?.addEventListener('click', () => {
                        if (feedPage < totalPages-1) { feedPage++; newsRenderFeed(items); document.getElementById('newsFeedWrap')?.scrollTo({ top: 0, behavior: 'smooth' }); }
                    });
                }
            }
        }

        function newsRenderStats(items) {
            const bull    = items.filter(n => n.sentiment === 'bull').length;
            const bear    = items.filter(n => n.sentiment === 'bear').length;
            const neutral = items.filter(n => n.sentiment === 'neutral').length;
            const total   = items.length || 1;
            const bp = Math.round(bull/total*100), brp = Math.round(bear/total*100), np = Math.round(neutral/total*100);

            const s = (id, v) => { const el = document.getElementById(id); if(el) el.style.width = v+'%'; };
            const t = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
            s('nBullBar', bp); s('nBearBar', brp); s('nNeutralBar', np);
            t('nBullPct', bp+'%'); t('nBearPct', brp+'%'); t('nNeutralPct', np+'%');
            t('nTotalCount', items.length); t('nStatPos', bull); t('nStatNeg', bear);

            const coinCount = {};
            items.forEach(n => n.tags.forEach(tag => { coinCount[tag] = (coinCount[tag]||0)+1; }));
            const sorted = Object.entries(coinCount).sort((a,b)=>b[1]-a[1]).slice(0,6);
            const maxM = sorted[0]?.[1] || 1;
            const mc = document.getElementById('nMentionsCol');
            if (mc) mc.innerHTML = sorted.length ? sorted.map(([coin,cnt]) => `
                <div class="news-mention-row">
                    <span class="news-mention-coin">${coin}</span>
                    <div class="news-mention-track"><div class="news-mention-fill" style="width:${Math.round(cnt/maxM*100)}%"></div></div>
                    <span class="news-mention-count">${cnt} упом.</span>
                </div>`).join('') : '<div style="font-size:11px;color:#475569">' + t('noData') + '</div>';

            const sw = document.getElementById('nSourcesWrap');
            if (sw) {
                const sources = [...new Set(items.map(n=>n.source))];
                sw.innerHTML = sources.map(s=>`<span class="news-source-pill"><span class="src-dot"></span>${s}</span>`).join('');
            }
        }

        function newsRender() {
            const filtered = newsGetFiltered();
            newsRenderFeatured(filtered.slice(0, 7));
            newsRenderFeed(filtered.slice(7));
            newsRenderStats(filtered);
        }

        function newsSetLoading() {
            const sk = () => `<div class="news-skeleton-card">
                <div class="news-skeleton" style="height:11px;width:42%;margin-bottom:9px"></div>
                <div class="news-skeleton" style="height:15px;width:90%;margin-bottom:5px"></div>
                <div class="news-skeleton" style="height:15px;width:68%;margin-bottom:8px"></div>
                <div class="news-skeleton" style="height:10px;width:46%"></div>
            </div>`;
            const fc = document.getElementById('newsFeaturedCol');
            const fd = document.getElementById('newsFeedCol');
            if (fc) fc.innerHTML = sk()+sk()+sk();
            if (fd) fd.innerHTML = Array(6).fill(sk()).join('');
        }

        // ── Модальное окно ────────────────────────────────────
        function newsOpenModalByItem(n) {
            if (!n) return;
            const old = document.getElementById('newsModalOverlay');
            if (old) old.remove();

            const related = newsAllItems
                .filter(x => x.id !== n.id && (x.sentiment===n.sentiment || x.tags.some(t=>n.tags.includes(t))))
                .slice(0, 3);

            // Переводим desc и related если нужно, потом рендерим
            const doRender = () => {
                const displayTitle = (currentLang === 'ru' && n.titleRu) ? n.titleRu : n.title;
                const displayDesc  = (currentLang === 'ru' && n.descRu)  ? n.descRu  : n.desc;
                const noteText = currentLang === 'ru'
                    ? '📌 Это краткое описание из RSS-ленты. Полный текст — на сайте источника.'
                    : '📌 This is a brief summary from the RSS feed. Full text — on the source website.';

                const overlay = document.createElement('div');
                overlay.className = 'news-modal-overlay';
                overlay.id = 'newsModalOverlay';
                overlay.innerHTML = `
                    <div class="news-modal">
                        <button class="news-modal-close" id="newsModalClose">✕</button>
                        <div class="news-modal-left" id="newsModalLeft">
                            <div class="news-modal-source-row">
                                <span class="news-modal-source">${n.source}</span>
                                <span class="news-modal-time">${new Date(n.date).toLocaleString(currentLang === 'ru' ? 'ru-RU' : 'en-US',{day:'numeric',month:'long',hour:'2-digit',minute:'2-digit'})}</span>
                                <span class="news-sent-badge ${n.sentiment}" style="margin-left:auto">${newsSentLabel(n.sentiment)}</span>
                            </div>
                            <div class="news-modal-title">${displayTitle}</div>
                            ${displayTitle !== n.title ? `<div style="font-size:11px;color:#475569;margin-top:4px;font-style:italic">${n.title}</div>` : ''}
                            ${n.tags.length ? `<div class="news-tags" style="margin-top:8px">${n.tags.map(t=>`<span class="news-tag">${t}</span>`).join('')}</div>` : ''}
                            <div class="news-modal-divider"></div>
                            ${displayDesc ? `
                            <div class="news-modal-lead">${displayDesc}</div>
                            <div style="margin-top:4px;padding:12px 16px;background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.15);border-radius: 6px;font-size:12px;color:#64748B;line-height:1.5">
                                ${noteText}
                            </div>` : `
                            <div style="text-align:center;padding:24px 20px;display:flex;flex-direction:column;align-items:center;gap:12px">
                                <div style="font-size:40px">📰</div>
                                <div style="font-size:14px;color:#CBD5E1;font-weight:700">${t('noData')}</div>
                                <div style="font-size:12px;color:#64748B;max-width:300px;line-height:1.6">${t('newsReadMore').replace('→','')}</div>
                            </div>`}
                            <a href="${n.link}" target="_blank" class="news-modal-action primary" style="display:inline-flex;font-size:14px;padding:12px 28px;border-radius: 6px;align-self:flex-start">
                                🔗 ${n.source}
                            </a>
                            <div class="news-modal-divider" style="margin-top:auto"></div>
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:11px;color:#475569">${t('newsSources').replace(/s$/,'')}: <span style="color:#6366F1">${n.domain}</span></span>
                                <button class="news-modal-action secondary" id="newsCopyBtn" style="margin-left:auto">↗ Copy</button>
                            </div>
                        </div>
                        <div class="news-modal-right" id="newsModalRight">
                            <div class="news-modal-section-title">${t('newsModalSentiment')}</div>
                            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius: 6px;padding:14px">
                                <span class="news-sent-badge ${n.sentiment}" style="font-size:13px;padding:6px 16px;display:inline-block">${newsSentLabel(n.sentiment)}</span>
                                ${n.tags.length ? `<div style="margin-top:10px">${n.tags.map(tag=>`<span class="news-tag" style="display:inline-block;margin:2px">${tag}</span>`).join('')}</div>` : ''}
                            </div>
                            ${related.length ? `
                            <div class="news-modal-section-title">${t('newsLatest')}</div>
                            ${related.map((r,ri)=>`
                                <div class="news-modal-related ${r.sentiment}" data-ri="${ri}">
                                    <div class="news-modal-related-title">${(currentLang === 'ru' && r.titleRu) ? r.titleRu : r.title}</div>
                                    <div class="news-modal-related-meta">${r.source} · ${newsTimeAgo(r.date)}</div>
                                </div>`).join('')}` : ''}
                        </div>
                    </div>`;

                document.body.appendChild(overlay);
                requestAnimationFrame(() => overlay.classList.add('open'));

                document.getElementById('newsModalClose').addEventListener('click', newsCloseModal);
                overlay.addEventListener('click', e => { if (e.target === overlay) newsCloseModal(); });
                document.getElementById('newsCopyBtn')?.addEventListener('click', () => navigator.clipboard?.writeText(n.link));
                overlay.querySelectorAll('.news-modal-related[data-ri]').forEach(el => {
                    el.addEventListener('click', () => {
                        const item = related[+el.dataset.ri];
                        if (item) { newsMarkRead(item.id); newsOpenModalByItem(item); }
                    });
                });
            };

            // Показываем карточку сразу, переводим в фоне
            doRender();

            if (currentLang === 'ru') {
                const toTranslate = [];
                if (!n.titleRu && n.title) toTranslate.push(
                    translateViaLingva(n.title, 'ru').then(r => { n.titleRu = r; })
                );
                if (!n.descRu && n.desc) toTranslate.push(
                    translateViaLingva(n.desc, 'ru').then(r => { n.descRu = r; })
                );
                related.forEach(r => {
                    if (!r.titleRu && r.title) toTranslate.push(
                        translateViaLingva(r.title, 'ru').then(res => { r.titleRu = res; })
                    );
                });
                if (toTranslate.length) {
                    Promise.all(toTranslate).then(() => {
                        // Тихо обновляем текст если модалка ещё открыта
                        const modal = document.getElementById('newsModalOverlay');
                        if (!modal) return;
                        const titleEl = modal.querySelector('.news-modal-title');
                        const leadEl  = modal.querySelector('.news-modal-lead');
                        if (titleEl && n.titleRu) titleEl.textContent = n.titleRu;
                        if (leadEl  && n.descRu)  leadEl.textContent  = n.descRu;
                        modal.querySelectorAll('.news-modal-related[data-ri]').forEach(el => {
                            const r = related[+el.dataset.ri];
                            if (r?.titleRu) el.querySelector('.news-modal-related-title').textContent = r.titleRu;
                        });
                    });
                }
            }
        }

        function newsCloseModal() {
            const overlay = document.getElementById('newsModalOverlay');
            if (!overlay) return;
            overlay.classList.remove('open');
            setTimeout(() => overlay.remove(), 300);
        }

        document.addEventListener('keydown', e => { if (e.key === 'Escape') newsCloseModal(); });

        // ── Фильтры ───────────────────────────────────────────
        document.querySelectorAll('.news-filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.news-filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                newsFilter = btn.dataset.nfilter;
                // Кнопка "Все" сбрасывает и источник
                if (btn.dataset.nfilter === 'all') {
                    newsSourceFilter = 'all';
                    document.querySelectorAll('.news-source-btn').forEach(b => b.classList.remove('active'));
                }
                feedPage = 0;
                newsRender();
            });
        });

        document.querySelectorAll('.news-source-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.news-source-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                newsSourceFilter = btn.dataset.source;
                feedPage = 0;
                if (currentLang === 'ru' && typeof translateNewsTitles === 'function') {
                    translateNewsTitles(newsAllItems).then(() => newsRender());
                } else {
                    newsRender();
                }
            });
        });

        document.getElementById('newsRefreshBtn')?.addEventListener('click', () => newsLoadAll(true));

        // ── Lazy load при первом открытии страницы 3 ─────────
        const newsObserver = new MutationObserver(() => {
            if (!newsLoaded && document.getElementById('sliderWrapper').classList.contains('slide-3')) {
                newsLoaded = true;
                newsLoadAll();
            }
        });
        newsObserver.observe(document.getElementById('sliderWrapper'), { attributes: true, attributeFilter: ['class'] });

        // ── Автообновление каждые 5 минут ────────────────────
        setInterval(() => {
            if (document.getElementById('sliderWrapper').classList.contains('slide-3')) {
                newsLoadAll(true);
            }
        }, 5 * 60 * 1000);



        // ════════════════════════════════════════════════════
        // БЕГУЩАЯ СТРОКА ЦЕН
        // ════════════════════════════════════════════════════

        const TICKER_COINS = [
            'bitcoin','ethereum','solana','ripple','binancecoin',
            'cardano','dogecoin','avalanche-2','chainlink','polkadot',
            'uniswap','litecoin','tron','stellar','near',
        ];

        const TICKER_SYMBOLS = {
            'bitcoin':'BTC','ethereum':'ETH','solana':'SOL','ripple':'XRP',
            'binancecoin':'BNB','cardano':'ADA','dogecoin':'DOGE',
            'avalanche-2':'AVAX','chainlink':'LINK','polkadot':'DOT',
            'uniswap':'UNI','litecoin':'LTC','tron':'TRX','stellar':'XLM','near':'NEAR',
        };

        function formatTickerPrice(p) {
            if (p >= 1000) return '$' + p.toLocaleString('en-US', {maximumFractionDigits: 0});
            if (p >= 1)    return '$' + p.toFixed(2);
            return '$' + p.toFixed(4);
        }

        let _tickerCache = null;

        function buildTickerItemFromBinance(id, data) {
            const sym    = TICKER_SYMBOLS[id] || id.toUpperCase();
            const price  = parseFloat(data.lastPrice);
            const chg    = parseFloat(data.priceChangePercent);
            const priceStr = isNaN(price) ? '—' : formatTickerPrice(price);
            const chgStr   = isNaN(chg)   ? '—' : (chg >= 0 ? '+' : '') + chg.toFixed(2) + '%';
            const cls      = isNaN(chg)   ? '' : chg >= 0 ? 'up' : 'down';
            const arrow    = isNaN(chg)   ? '' : chg >= 0 ? '▲' : '▼';
            const icon     = ICONS[id] || '';
            return `<div class="ticker-item">
                ${icon ? `<img class="ticker-icon" src="${icon}" alt="${sym}" loading="lazy" onerror="this.style.display='none'">` : ''}
                <span class="ticker-symbol">${sym}</span>
                <span class="ticker-price">${priceStr}</span>
                <span class="ticker-change ${cls}">${arrow} ${chgStr}</span>
            </div>`;
        }

        function buildTickerPlaceholders() {
            return TICKER_COINS.map(id => {
                const sym = TICKER_SYMBOLS[id] || id.toUpperCase();
                return `<div class="ticker-item">
                    <span class="ticker-symbol">${sym}</span>
                    <span class="ticker-price" style="color:#475569">—</span>
                    <span class="ticker-change" style="color:#475569">—</span>
                </div>`;
            }).join('');
        }

        function renderTicker(html) {
            const track = document.getElementById('tickerTrack');
            if (!track || !html) return;
            track.innerHTML = html + html;
            track.style.animationPlayState = 'paused';
            track.offsetHeight;
            track.style.animationPlayState = '';
        }

        async function loadTicker() {
            try {
                // Binance: один запрос на все символы через bookTicker (цена)
                // + 24hrTicker для изменения — используем Promise.all для параллельности
                const symbols = TICKER_COINS
                    .map(id => BINANCE_SYMBOLS[id])
                    .filter(Boolean);

                // Binance /ticker/24hr?symbols=[...] — один запрос на все монеты
                const encoded = encodeURIComponent(JSON.stringify(symbols));
                const r = await fetch(
                    `/api/ticker?symbols=${encoded}`,
                    { signal: AbortSignal.timeout(5000) }
                );
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const tickers = await r.json();
                if (!Array.isArray(tickers) || !tickers.length) throw new Error('empty');

                // Строим map symbol → data
                const bySymbol = {};
                tickers.forEach(t => { bySymbol[t.symbol] = t; });

                const html = TICKER_COINS.map(id => {
                    const sym = BINANCE_SYMBOLS[id];
                    const data = sym && bySymbol[sym];
                    if (!data) return buildTickerPlaceholders().split('</div>')[0] + '</div>';
                    return buildTickerItemFromBinance(id, data);
                }).join('');

                _tickerCache = html;
                renderTicker(html);
            } catch(e) {
                console.warn('Ticker: ошибка загрузки', e);
                if (!_tickerCache) {
                    renderTicker(buildTickerPlaceholders());
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderTicker(buildTickerPlaceholders());
            loadTicker();
        });
        setInterval(loadTicker, 60 * 1000);

        // Автообновление графика каждую минуту
        setInterval(async () => {
            if (!lwSeries) return;
            try {
                const binanceSymbol = BINANCE_SYMBOLS[selectedCoin.id] || 'BTCUSDT';
                const r = await fetch(`/api/price?symbol=${binanceSymbol}`);
                if (!r.ok) return;
                const d = await r.json();
                const price = parseFloat(d.price || d.lastPrice || 0);
                if (!price) return;

                if (chartDisplayType === 'candle' && rawOhlcCache.length) {
                    // Свечной режим — обновляем последнюю свечу
                    const last = rawOhlcCache[rawOhlcCache.length - 1];
                    const [t, o, h, l, c] = last;
                    const newHigh = Math.max(h, price);
                    const newLow  = Math.min(l, price);
                    rawOhlcCache[rawOhlcCache.length - 1] = [t, o, newHigh, newLow, price];
                    lwSeries.update({
                        time:  Math.floor(t / 1000),
                        open:  o,
                        high:  newHigh,
                        low:   newLow,
                        close: price,
                    });

                } else if (chartDisplayType === 'line' && rawPricesCache.length) {
                    // Линейный режим — обновляем последнюю точку
                    const last = rawPricesCache[rawPricesCache.length - 1];
                    const t = last[0];
                    rawPricesCache[rawPricesCache.length - 1] = [t, price];
                    lwSeries.update({ time: Math.floor(t / 1000), value: price });
                }
            } catch(e) {}
        }, 60 * 1000);

        // ── Мини-тикер полоска ──────────────────────────────
        // 20 монет, 5 слотов, ротация каждые 8 сек со сдвигом
        const MINI_COINS = [
            {sym:'BTC',id:'BTCUSDT',icon:ICONS['bitcoin']},
            {sym:'ETH',id:'ETHUSDT',icon:ICONS['ethereum']},
            {sym:'SOL',id:'SOLUSDT',icon:ICONS['solana']},
            {sym:'BNB',id:'BNBUSDT',icon:ICONS['binancecoin']},
            {sym:'XRP',id:'XRPUSDT',icon:ICONS['ripple']},
            {sym:'ADA',id:'ADAUSDT',icon:ICONS['cardano']},
            {sym:'DOGE',id:'DOGEUSDT',icon:ICONS['dogecoin']},
            {sym:'AVAX',id:'AVAXUSDT',icon:ICONS['avalanche-2']},
            {sym:'LINK',id:'LINKUSDT',icon:ICONS['chainlink']},
            {sym:'DOT',id:'DOTUSDT',icon:ICONS['polkadot']},
            {sym:'NEAR',id:'NEARUSDT',icon:ICONS['near']},
            {sym:'UNI',id:'UNIUSDT',icon:ICONS['uniswap']},
            {sym:'PEPE',id:'PEPEUSDT',icon:ICONS['pepe']},
            {sym:'SUI',id:'SUIUSDT',icon:ICONS['sui']},
            {sym:'TON',id:'TONUSDT',icon:ICONS['toncoin']},
            {sym:'ARB',id:'ARBUSDT',icon:ICONS['arbitrum']},
            {sym:'INJ',id:'INJUSDT',icon:ICONS['injective-protocol']},
            {sym:'MKR',id:'MKRUSDT',icon:ICONS['maker']},
            {sym:'LDO',id:'LDOUSDT',icon:ICONS['lido-dao']},
            {sym:'TIA',id:'TIAUSDT',icon:ICONS['celestia']},
        ];
        let miniVisible = [0,1,2,3,4]; // текущий индекс монеты в каждом слоте

        function renderMiniSlot(el, idx) {
            const coin = MINI_COINS[idx];
            const d = (window._miniBySymbol || {})[coin.id];
            const iconEl  = el.querySelector('.mini-ticker-icon');
            const symEl   = el.querySelector('.mini-ticker-sym');
            const priceEl = el.querySelector('.mini-ticker-price');
            const chgEl   = el.querySelector('.mini-ticker-chg');
            if (iconEl) { iconEl.src = coin.icon || ''; iconEl.style.display = coin.icon ? 'inline' : 'none'; }
            symEl.textContent = coin.sym;
            if (d) {
                const p = parseFloat(d.lastPrice);
                priceEl.textContent = p >= 1000 ? '$'+Math.round(p).toLocaleString('en-US')
                                    : p >= 1    ? '$'+p.toFixed(2)
                                    : p >= 0.01 ? '$'+p.toFixed(4)
                                    :             '$'+p.toFixed(7);
                const chg = parseFloat(d.priceChangePercent);
                chgEl.textContent = (chg>=0?'+':'')+chg.toFixed(2)+'%';
                chgEl.className = 'mini-ticker-chg '+(chg>=0?'pos':'neg');
            } else {
                priceEl.textContent = '—';
                chgEl.textContent = '—';
                chgEl.className = 'mini-ticker-chg';
            }
        }

        function rotateMiniSlot(slotIdx) {
            const strip = document.getElementById('miniTickerStrip');
            if (!strip) return;
            const el = strip.querySelectorAll('.mini-ticker-item')[slotIdx];
            if (!el) return;
            miniVisible[slotIdx] = (miniVisible[slotIdx] + 5) % MINI_COINS.length;
            el.classList.add('updating');
            setTimeout(() => { renderMiniSlot(el, miniVisible[slotIdx]); el.classList.remove('updating'); }, 320);
        }

        function renderAllMiniSlots() {
            const strip = document.getElementById('miniTickerStrip');
            if (!strip) return;
            strip.querySelectorAll('.mini-ticker-item').forEach((el, i) => renderMiniSlot(el, miniVisible[i]));
        }

        async function loadMiniData() {
            try {
                const syms = MINI_COINS.map(c=>c.id);
                const enc = encodeURIComponent(JSON.stringify(syms));
                // сначала через сервер
                let data = null;
                try {
                    const r = await fetch('/api/ticker?symbols='+enc, {signal:AbortSignal.timeout(4000)});
                    if (r.ok) data = await r.json();
                } catch {}
                // fallback напрямую Binance
                if (!Array.isArray(data) || !data.length) {
                    const r2 = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols='+enc, {signal:AbortSignal.timeout(8000)});
                    if (r2.ok) data = await r2.json();
                }
                if (!Array.isArray(data)) return;
                window._miniBySymbol = {};
                data.forEach(t => { window._miniBySymbol[t.symbol] = t; });
                renderAllMiniSlots();
            } catch(e) { console.warn('miniTicker:', e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadMiniData();
            setInterval(loadMiniData, 30000);
            // ротация слотов со сдвигом 8 сек между слотами
            function scheduleSlot(i) {
                const delay = 10000 + Math.random() * 15000; // 10–25 сек случайно
                setTimeout(() => { rotateMiniSlot(i); scheduleSlot(i); }, delay);
            }
            for (let i = 0; i < 5; i++) {
                setTimeout(() => scheduleSlot(i), Math.random() * 8000); // разный старт
            }
            loadMarketPulse();
            setInterval(loadMarketPulse, 60000);
        });

        // ── Funding Rate + Open Interest ────────────────────
        function fmtOI(v) {
            if (v >= 1e9) return '$' + (v/1e9).toFixed(2) + 'B';
            if (v >= 1e6) return '$' + (v/1e6).toFixed(1) + 'M';
            return '$' + Math.round(v).toLocaleString('en-US');
        }

        async function loadMarketPulse() {
            const coin = typeof selectedCoin !== 'undefined' ? selectedCoin : { id: 'bitcoin' };
            const sym  = (typeof BINANCE_SYMBOLS !== 'undefined' && BINANCE_SYMBOLS[coin.id])
                       ? BINANCE_SYMBOLS[coin.id] : 'BTCUSDT';
            const symLabel = sym.replace('USDT', '');

            try {
                // Funding Rate + OI параллельно (OI — отдельный endpoint)
                const [frRes, tickRes, oiRes] = await Promise.all([
                    fetch(`https://fapi.binance.com/fapi/v1/fundingRate?symbol=${sym}&limit=1`, { signal: AbortSignal.timeout(5000) }),
                    fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${sym}`,         { signal: AbortSignal.timeout(5000) }),
                    fetch(`https://fapi.binance.com/fapi/v1/openInterest?symbol=${sym}`,        { signal: AbortSignal.timeout(5000) })
                ]);

                const bar = document.getElementById('marketPulseBar');

                // Funding Rate
                if (frRes.ok) {
                    const fr = await frRes.json();
                    const rate = parseFloat(fr[0]?.fundingRate || 0) * 100;
                    const lastTime = fr[0]?.fundingTime ? new Date(fr[0].fundingTime) : null;
                    // Следующее списание = последнее + 8 часов
                    const nextTime = lastTime ? new Date(lastTime.getTime() + 8 * 60 * 60 * 1000) : null;
                    const el    = document.getElementById('mpFundingValue');
                    const badge = document.getElementById('mpFundingBadge');
                    const sub   = document.getElementById('mpFundingTime');
                    const label = document.querySelector('#mpFunding .mp-label');
                    if (label) label.textContent = `FUNDING · ${symLabel}`;
                    if (el) {
                        el.textContent = (rate >= 0 ? '+' : '') + rate.toFixed(4) + '%';
                        el.style.color = rate > 0.005 ? '#10B981' : rate < -0.005 ? '#EF4444' : '#FBBF24';
                    }
                    if (badge) {
                        window._lastFundingRate = rate;
                        window._lastFundingNext = nextTime;
                        badge.textContent = rate > 0.005 ? t('fundingLongsPay') : rate < -0.005 ? t('fundingShortsPay') : t('fundingNeutral');
                        badge.className = 'mp-badge ' + (rate > 0.005 ? 'pos' : rate < -0.005 ? 'neg' : 'neu');
                    }
                    if (sub && nextTime) {
                        const diff = Math.max(0, Math.round((nextTime - Date.now()) / 60000));
                        const h = Math.floor(diff / 60), m = diff % 60;
                        sub.textContent = `${t('fundingIn')} ${h}${t('fundingH')} ${m}${t('fundingM')}`;
                    }
                }

                // Open Interest — из отдельного endpoint (в монетах) × цена из тикера
                if (oiRes.ok && tickRes.ok) {
                    const oi   = await oiRes.json();
                    const tick = await tickRes.json();
                    const oiCoins = parseFloat(oi.openInterest || 0);
                    const price   = parseFloat(tick.lastPrice || 1);
                    const oiUSD   = oiCoins * price;
                    const chgPct  = parseFloat(tick.priceChangePercent || 0);
                    const el    = document.getElementById('mpOIValue');
                    const badge = document.getElementById('mpOIBadge');
                    const sub   = document.getElementById('mpOISub');
                    const label = document.querySelector('#mpOI .mp-label');
                    if (label) label.textContent = `OPEN INTEREST · ${symLabel}`;
                    if (el)  el.textContent = fmtOI(oiUSD);
                    if (sub) sub.textContent = `Binance Perp`;
                    if (badge && oiUSD > 0) {
                        badge.textContent = chgPct >= 0 ? `↑ ${chgPct.toFixed(1)}% 24ч` : `↓ ${chgPct.toFixed(1)}% 24ч`;
                        badge.className = 'mp-badge ' + (chgPct >= 0 ? 'pos' : 'neg');
                    }
                }

                if (bar) bar.style.display = 'flex';
            } catch(e) {
                const bar = document.getElementById('marketPulseBar');
                if (bar) bar.style.display = 'none';
            }
        }



        const indTooltip = document.getElementById('indTooltip');
        let tooltipTimeout;

        document.querySelectorAll('.ind-help').forEach(el => {
            el.addEventListener('mouseenter', e => {
                const tip = el.dataset.tip;
                if (!tip || !indTooltip) return;
                indTooltip.textContent = tip;

                const rect = el.getBoundingClientRect();
                const tw = 240; // ширина тултипа

                // Позиция: снизу от иконки, выровнен вправо
                let left = rect.right - tw;
                let top  = rect.bottom + 8;

                // Не выходим за левый край
                if (left < 8) left = 8;
                // Не выходим за правый край
                if (left + tw > window.innerWidth - 8) left = window.innerWidth - tw - 8;
                // Не выходим за нижний край — показываем сверху
                if (top + 120 > window.innerHeight) top = rect.top - 120 - 8;

                indTooltip.style.left = left + 'px';
                indTooltip.style.top  = top  + 'px';

                clearTimeout(tooltipTimeout);
                indTooltip.classList.add('visible');
            });

            el.addEventListener('mouseleave', () => {
                tooltipTimeout = setTimeout(() => indTooltip?.classList.remove('visible'), 100);
            });
        });

        // ── Крестики очистки инпутов ──────────────────────
        document.addEventListener('click', e => {
            const btn = e.target.closest('.input-clear-btn');
            if (!btn) return;
            const wrapper = btn.closest('.input-wrapper, .input-large, .sell-goal-field, .buy-row-field');
            if (!wrapper) return;
            const input = wrapper.querySelector('input');
            if (!input) return;
            input.value = '';
            input.dataset.empty = 'true';
            input.dispatchEvent(new Event('input', { bubbles: true }));
            input.focus();
        });

        // ══ СИСТЕМА ПЕРЕВОДОВ ══════════════════════════════════

        function applyLang(lang) {
            currentLang = lang;
            localStorage.setItem('cryptopro_lang', lang);
            const tr = TRANSLATIONS[lang];

            // Флаг и код
            document.getElementById('langFlag').textContent = { ru: '🇷🇺', en: '🇬🇧' }[lang];
            document.getElementById('langCode').textContent = lang.toUpperCase();

            // Активная опция
            document.querySelectorAll('.lang-option').forEach(o => {
                o.classList.toggle('active', o.dataset.lang === lang);
            });

            // Применяем по data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                if (tr[key] !== undefined) el.textContent = tr[key];
            });

            // Тултипы индикаторов (data-tipkey)
            document.querySelectorAll('[data-tipkey]').forEach(el => {
                const key = el.dataset.tipkey;
                if (tr[key] !== undefined) el.dataset.tip = tr[key];
            });

            // Title атрибуты (data-i18n-title)
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.dataset.i18nTitle;
                if (tr[key] !== undefined) el.title = tr[key];
            });

            // Кнопки периода
            const periodMap = { 1: tr.periodD1, 7: tr.periodD7, 30: tr.periodD30, 90: tr.periodD90 };
            document.querySelectorAll('.period-btn').forEach(btn => {
                const p = parseInt(btn.dataset.period);
                if (periodMap[p]) btn.textContent = periodMap[p];
            });

            // Плейсхолдеры поиска монеты
            ['coinSearchDesktop','coinSearchMobile'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.placeholder = tr.coinSearchPlaceholder;
            });
            const cs2 = document.getElementById('coinSearch2');
            if (cs2) cs2.placeholder = tr.coinSearch2Placeholder || tr.coinSearchPlaceholder;

            // Перерендерим существующие buy-rows
            document.querySelectorAll('.buy-row').forEach(row => {
                const al = row.querySelector('.amount-input + label') || row.querySelector('label:first-of-type');
                const pl = row.querySelector('.price-input + label');
                if (al) al.textContent = tr.labelAmount;
                if (pl) pl.textContent = tr.labelPrice;
            });

            // Динамические JS-строки — обновляем индикаторы если они уже загружены
            scheduleIndSummaryUpdate && scheduleIndSummaryUpdate();

            // Обновляем funding badge при смене языка (без повторного запроса)
            const fundingBadge = document.getElementById('mpFundingBadge');
            const fundingSub   = document.getElementById('mpFundingTime');
            if (fundingBadge && window._lastFundingRate !== undefined) {
                const rate = window._lastFundingRate;
                fundingBadge.textContent = rate > 0.005 ? t('fundingLongsPay') : rate < -0.005 ? t('fundingShortsPay') : t('fundingNeutral');
            }
            if (fundingSub && window._lastFundingNext) {
                const diff = Math.max(0, Math.round((window._lastFundingNext - Date.now()) / 60000));
                const h = Math.floor(diff / 60), m = diff % 60;
                fundingSub.textContent = `${t('fundingIn')} ${h}${t('fundingH')} ${m}${t('fundingM')}`;
            }

            // Обновляем RSI и ZScore на странице 1 если данные уже есть
            if (typeof rawPricesCache !== 'undefined' && rawPricesCache.length) {
                updateRSI && updateRSI(rawPricesCache);
                updateZScore && updateZScore(rawPricesCache);
            }

            // Перезапускаем все индикаторы страницы 2 чтобы бейджи обновились
            if (window._ema90closes && window._ema90closes.length) {
                loadATR && loadATR();
                loadEMA && loadEMA().then(() => {
                    loadStochRSI && loadStochRSI();
                    loadRSIExt && loadRSIExt();
                    loadBB && loadBB();
                    loadMACD && loadMACD();
                    loadWilliamsR && loadWilliamsR();
                    loadOBV && loadOBV();
                    loadCCI && loadCCI();
                    loadVWAP && loadVWAP();
                    loadMFI && loadMFI();
                });
                loadFearGreed && loadFearGreed();
            }

            // Обновляем calcHeaderTitle если открыт калькулятор
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && calcContent && calcContent.style.display !== 'none') {
                const tabName = activeTab.id?.replace('tab-','');
                if (tabName && CALC_NAMES[tabName]) calcHeaderTitle.textContent = t(CALC_NAMES[tabName]);
            }

            // Перерендериваем новости с нужным языком
            if (typeof newsRender === 'function' && newsAllItems?.length) {
                if (lang === 'ru' && typeof translateNewsTitles === 'function') {
                    translateNewsTitles(newsAllItems).then(() => newsRender());
                } else {
                    newsRender();
                }
            }

            // Перерисовываем таблицу сложного % при смене языка
            typeof calculateCompoundGoal === 'function' && calculateCompoundGoal();

            // Обновляем подписи месяцев на графике
            if (typeof lwChart !== 'undefined' && lwChart) {
                const MONTHS_RU = ['янв.','фев.','мар.','апр.','май','июн.','июл.','авг.','сен.','окт.','ноя.','дек.'];
                const MONTHS_EN = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                lwChart.applyOptions({
                    localization: {
                        tickMarkFormatter: (time) => {
                            const date = new Date(time * 1000);
                            const m = date.getUTCMonth();
                            const y = date.getUTCFullYear();
                            if (m === 0) return String(y);
                            return lang === 'ru' ? MONTHS_RU[m] : MONTHS_EN[m];
                        },
                    },
                });
            }

            // Обновляем виджет новости на главной при смене языка
            typeof renderNewsWidget === 'function' && renderNewsWidget();

            // Скрываем/показываем строку с рублями в зависимости от языка
            const rubEl = document.getElementById('profitAmountRub');
            if (rubEl && lang === 'en' ) {
                rubEl.textContent = '';
                rubEl.className = 'stat-value-rub';
            }
            // При переключении на RU пересчитываем калькулятор чтобы рубли показались сразу
            if (lang === 'ru') {
                typeof calculateSell === 'function' && calculateSell();
            }
            const lbl = document.getElementById('newsLiveLabel');
            if (lbl && (lbl.textContent === 'Загрузка...' || lbl.textContent === 'Loading...')) {
                lbl.textContent = tr.loading;
            }
        }

        // Дропдаун
        const langSelector = document.getElementById('langSelector');
        document.getElementById('langTrigger').addEventListener('click', e => {
            e.stopPropagation();
            langSelector.classList.toggle('open');
        });
        document.querySelectorAll('.lang-option').forEach(opt => {
            opt.addEventListener('click', () => {
                applyLang(opt.dataset.lang);
                langSelector.classList.remove('open');
            });
        });
        document.addEventListener('click', () => langSelector?.classList.remove('open'));

        // Инициализация языка
        applyLang(currentLang);

        // ═══════════════════════════════════════════════════
        // ПЕРЕВОД НОВОСТЕЙ: Lingva Translate + localStorage кэш
        // ═══════════════════════════════════════════════════
        const NEWS_TRANS_CACHE_KEY = 'cryptopro_news_trans_v1';
        const NEWS_TRANS_MAX_AGE   = 7 * 24 * 60 * 60 * 1000; // 7 дней

        let newsTransCache = {};
        try {
            const raw = localStorage.getItem(NEWS_TRANS_CACHE_KEY);
            if (raw) newsTransCache = JSON.parse(raw);
        } catch {}

        function newsTransSave() {
            try { localStorage.setItem(NEWS_TRANS_CACHE_KEY, JSON.stringify(newsTransCache)); } catch {}
        }

        // Очищаем устаревшие записи из кэша
        (function newsTransClean() {
            const now = Date.now();
            let changed = false;
            for (const k in newsTransCache) {
                if (now - (newsTransCache[k].ts || 0) > NEWS_TRANS_MAX_AGE) {
                    delete newsTransCache[k]; changed = true;
                }
            }
            if (changed) newsTransSave();
        })();

        // Перевод одного текста через Lingva (бесплатный публичный Google Translate frontend)
        async function translateViaLingva(text, targetLang = 'ru') {
            if (!text || targetLang === 'en') return text;
            const cacheKey = `${targetLang}:${text.slice(0, 80)}`;
            if (newsTransCache[cacheKey]) return newsTransCache[cacheKey].t;

            // Пробуем несколько публичных инстансов Lingva
            const instances = [
                'https://lingva.ml',
                'https://lingva.thedaviddelta.com',
            ];
            const encoded = encodeURIComponent(text);
            for (const base of instances) {
                try {
                    const res = await fetch(`${base}/api/v1/en/${targetLang}/${encoded}`, { signal: AbortSignal.timeout(4000) });
                    if (!res.ok) continue;
                    const data = await res.json();
                    if (data.translation) {
                        newsTransCache[cacheKey] = { t: data.translation, ts: Date.now() };
                        newsTransSave();
                        return data.translation;
                    }
                } catch {}
            }
            return text; // fallback — оригинал
        }

        // Переводим заголовки новостей пачками по 5
        async function translateNewsTitles(items) {
            if (currentLang === 'en') return items;
            const needsTranslation = items.filter(n => n.title && !n.titleRu);
            for (let i = 0; i < needsTranslation.length; i += 5) {
                await Promise.all(
                    needsTranslation.slice(i, i + 5).map(async n => {
                        n.titleRu = await translateViaLingva(n.title, 'ru');
                    })
                );
            }
            return items;
        }

        // Получить заголовок новости с учётом языка
        function newsGetTitle(n) {
            return (currentLang === 'ru' && n.titleRu) ? n.titleRu : n.title;
        }

        // ── Donate: копирование адресов ──
        document.querySelectorAll('.donate-copy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const address = btn.dataset.address;
                if (!address) return;
                const doAction = () => {
                    const row = btn.closest('.donate-row');
                    const span = btn.querySelector('span');
                    btn.classList.add('copied');
                    row.classList.add('copied-row');
                    if (span) span.textContent = TRANSLATIONS[currentLang]?.donateCopied || '✓ Скопировано';
                    setTimeout(() => {
                        btn.classList.remove('copied');
                        row.classList.remove('copied-row');
                        if (span) span.textContent = TRANSLATIONS[currentLang]?.donateCopy || 'Скопировать';
                    }, 2000);
                };
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(address).then(doAction).catch(() => {
                        const ta = document.createElement('textarea');
                        ta.value = address; ta.style.cssText = 'position:fixed;opacity:0';
                        document.body.appendChild(ta); ta.select();
                        document.execCommand('copy'); document.body.removeChild(ta);
                        doAction();
                    });
                } else {
                    const ta = document.createElement('textarea');
                    ta.value = address; ta.style.cssText = 'position:fixed;opacity:0';
                    document.body.appendChild(ta); ta.select();
                    document.execCommand('copy'); document.body.removeChild(ta);
                    doAction();
                }
            });
        });

    </script>

</body>
</html>